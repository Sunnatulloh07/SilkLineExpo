<%- include('../partials/header', { title: title, lng: lng || 'uz', user: user }) %>
<%- include('../partials/sidebar', { user: user, currentPage: 'orders' }) %>

<!-- Enhanced CSS Imports - Professional B2B Orders Style -->
<link rel="stylesheet" href="/css/products-management-redesign.css">
<link rel="stylesheet" href="/css/products-table-view.css">
  <link rel="stylesheet" href="/css/orders-management.css">
  <link rel="stylesheet" href="/css/manufacturer-cards.css">
  <link rel="stylesheet" href="/css/manufacturer-theme.css">
  <link rel="stylesheet" href="/css/toast-notifications.css">
  <link rel="stylesheet" href="/css/modal-system.css">

<!-- Main Content -->
<main class="admin-main">
  <div class="admin-content">
    
    <!-- Professional B2B Orders Header -->
    <div class="orders-header animate-fade-in">
      <div class="orders-header-content">
        <div class="orders-title-section">
          <h1 class="orders-main-title">
            <i class="fas fa-clipboard-list"></i>
            Buyurtmalar Boshqaruvi
          </h1>
          <p class="orders-subtitle">Professional B2B buyurtmalar tizimi va bozor integratsiyasi</p>
        </div>
        <div class="orders-header-actions">
          <button class="orders-btn orders-btn-primary" id="exportOrdersBtn">
            <i class="fas fa-download"></i>
            Export Hisobot
          </button>
          <button class="orders-btn orders-btn-outline" id="bulkOrderActionsBtn">
            <i class="fas fa-tasks"></i>
            Ommaviy Amallar
          </button>
          <button class="orders-btn orders-btn-secondary" id="refreshOrdersBtn">
            <i class="fas fa-sync-alt"></i>
            Yangilash
          </button>
        </div>
      </div>
    </div>

    <!-- Professional B2B KPI Cards - Orders Analytics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-lg mb-lg">
      
      <!-- Total Orders -->
      <div class="stat-card primary animate-fade-in" data-kpi="totalOrders">
        <div class="stat-header">
          <h3 class="stat-title">Jami Buyurtmalar</h3>
          <div class="stat-icon primary">
            <i class="fas fa-shopping-cart"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="totalOrdersValue">
            <span class="loading-placeholder">...</span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend">Barcha buyurtmalar</span>
        </div>
      </div>

      <!-- Active Orders -->
      <div class="stat-card success animate-fade-in" data-kpi="activeOrders">
        <div class="stat-header">
          <h3 class="stat-title">Faol Buyurtmalar</h3>
          <div class="stat-icon success">
            <i class="fas fa-hourglass-half"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="activeOrdersValue">
            <span class="loading-placeholder">...</span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend">Jarayonda</span>
        </div>
      </div>

      <!-- Monthly Revenue -->
      <div class="stat-card info animate-fade-in" data-kpi="monthlyRevenue">
        <div class="stat-header">
          <h3 class="stat-title">Oylik Daromad</h3>
          <div class="stat-icon info">
            <i class="fas fa-chart-line"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="monthlyRevenueValue">
            <span class="loading-placeholder">...</span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend">Joriy oy</span>
        </div>
      </div>

      <!-- Pending Orders -->
      <div class="stat-card warning animate-fade-in" data-kpi="pendingOrders">
        <div class="stat-header">
          <h3 class="stat-title">Kutayotgan Buyurtmalar</h3>
          <div class="stat-icon warning">
            <i class="fas fa-clock"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="pendingOrdersValue">
            <span class="loading-placeholder">...</span>
          </span>
        </div>
        <div class="stat-change neutral">
          <i class="fas fa-arrow-right stat-change-icon"></i>
          <span class="metric-trend">Tasdiqlash kutilmoqda</span>
        </div>
      </div>

    </div>

    <!-- Professional Filters Container - Products Style -->
    <div class="products-filters-container">
      <div class="products-filters-header">
        <h3 class="products-filters-title">
          <i class="fas fa-filter"></i>
          Filtr va Qidiruv
        </h3>
        <div class="products-filters-actions">
          <button class="products-btn products-btn-sm products-btn-secondary" id="resetOrdersFiltersBtn">
            <i class="fas fa-undo"></i>
            Reset
          </button>
          <button class="products-btn products-btn-sm products-btn-outline" id="advancedOrdersFiltersBtn">
            <i class="fas fa-cog"></i>
            Kengaytirilgan
          </button>
        </div>
      </div>
      <div class="products-filters-body">
        <form id="ordersFiltersForm" class="products-filters-form">
          
          <!-- Search Input -->
          <div class="products-filter-group">
            <label class="products-filter-label">Qidiruv</label>
            <div class="products-search-wrapper">
              <i class="fas fa-search products-search-icon"></i>
              <input 
                type="text" 
                id="ordersSearchInput" 
                name="search" 
                placeholder="Buyurtma ID, mijoz nomi..."
                class="products-form-input search"
              >
            </div>
          </div>

          <!-- Status Filter -->
          <div class="products-filter-group">
            <label class="products-filter-label">Holat</label>
            <select name="status" id="statusFilter" class="products-form-select">
              <option value="">Barcha holatlar</option>
              <option value="pending">Kutayotgan</option>
              <option value="confirmed">Tasdiqlangan</option>
              <option value="processing">Jarayonda</option>
              <option value="manufacturing">Ishlab chiqarilmoqda</option>
              <option value="ready_to_ship">Jo'natishga tayyor</option>
              <option value="shipped">Jo'natilgan</option>
              <option value="delivered">Yetkazilgan</option>
              <option value="completed">Yakunlangan</option>
              <option value="cancelled">Bekor qilingan</option>
            </select>
          </div>

          <!-- Date Range Filter -->
          <div class="products-filter-group">
            <label class="products-filter-label">Sana oralig'i</label>
            <select name="dateRange" id="dateRangeFilter" class="products-form-select">
              <option value="">Barcha vaqt</option>
              <option value="today">Bugun</option>
              <option value="week">Bu hafta</option>
              <option value="month">Bu oy</option>
              <option value="quarter">Bu chorak</option>
              <option value="year">Bu yil</option>
              <option value="custom">Maxsus oraliq</option>
            </select>
          </div>

          <!-- Customer Filter -->
          <div class="products-filter-group">
            <label class="products-filter-label">Mijoz</label>
            <select name="customer" id="customerFilter" class="products-form-select">
              <option value="">Barcha mijozlar</option>
              <!-- Dynamically populated -->
            </select>
          </div>

          <!-- Amount Range Filter -->
          <div class="products-filter-group">
            <label class="products-filter-label">Summa oralig'i</label>
            <select name="amount" id="amountFilter" class="products-form-select">
              <option value="">Barcha summalar</option>
              <option value="0-1000">$0 - $1,000</option>
              <option value="1000-5000">$1,000 - $5,000</option>
              <option value="5000-10000">$5,000 - $10,000</option>
              <option value="10000-50000">$10,000 - $50,000</option>
              <option value="50000+">$50,000+</option>
            </select>
          </div>

          <!-- Sort Options -->
          <div class="products-filter-group">
            <label class="products-filter-label">Saralash</label>
            <select name="sortBy" id="ordersSortFilter" class="products-form-select">
              <option value="createdAt">Yaratilgan vaqt</option>
              <option value="totalAmount">Summa</option>
              <option value="status">Holat</option>
              <option value="buyer.companyName">Mijoz nomi</option>
            </select>
          </div>

          <!-- Sort Order -->
          <div class="products-filter-group">
            <label class="products-filter-label">Tartib</label>
            <select name="sortOrder" id="ordersSortOrderFilter" class="products-form-select">
              <option value="desc">Kamayish tartibida</option>
              <option value="asc">O'sish tartibida</option>
            </select>
          </div>
          
          <div class="products-filters-submit">
            <button type="submit" class="products-btn products-btn-primary" id="searchOrdersFiltersBtn">
              <i class="fas fa-search"></i>
              Qidiruv
            </button>
            <button type="button" class="products-btn products-btn-secondary" id="clearOrdersFiltersBtn">
              <i class="fas fa-times"></i>
              Tozalash
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Main Orders Container - Products Style -->
    <div class="products-main-container">
      <div class="products-content-header">
        <h3 class="products-content-title">
          <i class="fas fa-clipboard-list"></i>
          Buyurtmalar
          <span class="products-count" id="ordersCountText">Loading...</span>
        </h3>
        <div class="products-content-actions">
          <div class="products-view-toggle">
            <button class="products-view-btn" data-view="cards" title="Card ko'rinish" id="cardsViewBtn">
              <i class="fas fa-th"></i>
              <span>Cards</span>
            </button>
            <button class="products-view-btn active" data-view="table" title="Table ko'rinish" id="tableViewBtn">
              <i class="fas fa-list"></i>
              <span>Table</span>
            </button>
            <button class="products-view-btn" data-view="timeline" title="Timeline ko'rinish" id="timelineViewBtn">
              <i class="fas fa-history"></i>
              <span>Timeline</span>
            </button>
          </div>
          <button class="products-btn products-btn-sm products-btn-secondary" id="refreshOrdersBtn2">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </div>
      
    <% if (orders && orders.length > 0) { %>
      
      <!-- TABLE VIEW - Products Style -->
      <div class="products-view-container" id="tableView">
        <div class="products-table-container">
          <div class="products-table-header">
            <h4 class="products-table-title">
              <i class="fas fa-table"></i>
              Buyurtmalar jadvali
            </h4>
            <div class="products-table-actions">
              <button class="products-btn products-btn-sm products-btn-outline" id="selectAllOrdersBtn">
                <i class="fas fa-check-square"></i>
                Barchasini belgilash
              </button>
              <button class="products-btn products-btn-sm products-btn-secondary" id="bulkOrderActionsTableBtn">
                <i class="fas fa-tasks"></i>
                Ommaviy amallar
              </button>
            </div>
          </div>
          
          <div class="products-table-wrapper">
            <table class="products-table orders-table">
                        <thead>
              <tr>
                <th class="table-checkbox-col">
                  <input type="checkbox" id="selectAllOrders" class="table-checkbox">
                </th>
                <th class="order-id-col sortable" data-sort="orderNumber">
                  Buyurtma ID
                  <i class="fas fa-sort sort-icon"></i>
                </th>
                <th class="customer-col sortable" data-sort="buyer.companyName">
                  Mijoz
                  <i class="fas fa-sort sort-icon"></i>
                </th>
                <th class="date-col sortable" data-sort="createdAt">
                  Sana
                  <i class="fas fa-sort sort-icon"></i>
                </th>
                <th class="product-name-col">Mahsulot Nomi</th>
                <th class="quantity-col">Miqdori</th>
                <th class="amount-col sortable" data-sort="totalAmount">
                  Umumiy Summa
                  <i class="fas fa-sort sort-icon"></i>
                </th>
                <th class="status-col sortable" data-sort="status">
                  Holat
                  <i class="fas fa-sort sort-icon"></i>
                </th>
                <th class="actions-col">Amallar</th>
              </tr>
            </thead>
            <tbody>
              <% orders.forEach((order, index) => { %>
                <tr class="table-row" data-order-id="<%= order._id %>">
                  <td class="table-checkbox-col">
                    <input type="checkbox" class="table-checkbox order-checkbox" data-order-id="<%= order._id %>">
                  </td>
                  <td class="order-id-cell">
                    <div class="order-id-content">
                      <span class="order-number">#<%= order.orderNumber || order._id.toString().slice(-8).toUpperCase() %></span>
                      <div class="order-meta">
                        <span class="order-type badge-sm"><%= order.type || 'B2B' %></span>
                        <% if (order.items && order.items.length > 1) { %>
                          <button class="expand-order-btn" data-order-id="<%= order._id %>" title="<%= order.items.length %> ta mahsulotni ko'rish">
                            <i class="fas fa-chevron-down"></i>
                            +<%= order.items.length - 1 %>
                          </button>
                        <% } %>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="customer-cell">
                      <div class="customer-info">
                        <h4 class="customer-name"><%= order.buyer?.companyName || order.buyer?.name || 'N/A' %></h4>
                        <p class="customer-contact"><%= order.buyer?.email || 'Email mavjud emas' %></p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="date-cell">
                      <span class="order-date"><%= new Date(order.createdAt).toLocaleDateString('uz-UZ') %></span>
                      <span class="order-time"><%= new Date(order.createdAt).toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit' }) %></span>
                    </div>
                  </td>
                  <!-- Product Name (Main Product) -->
                  <td class="product-name-cell">
                    <div class="product-name-content">
                      <% 
                        // Get primary product (first item or most quantity)
                        const primaryItem = order.items && order.items.length > 0 ? 
                          order.items.reduce((prev, current) => (current.quantity > prev.quantity) ? current : prev) : 
                          null;
                        
                        // Product name with truncation logic
                        const productName = primaryItem?.product?.title || primaryItem?.product?.name || 'Mahsulot mavjud emas';
                        const truncatedName = productName.length > 50 ? productName.substring(0, 50) + '...' : productName;
                      %>
                      <% if (primaryItem) { %>
                        <span class="product-name" title="<%= productName %>">
                          <%= truncatedName %>
                        </span>
                        <% if (primaryItem.product?.category) { %>
                          <span class="product-category">
                            <i class="fas fa-tag"></i>
                            <%= primaryItem.product.category.name || primaryItem.product.category %>
                          </span>
                        <% } %>
                        <% if (order.items.length > 1) { %>
                          <span class="multiple-products-indicator">
                            <i class="fas fa-layer-group"></i>
                            +<%= order.items.length - 1 %> boshqa mahsulot
                          </span>
                        <% } %>
                      <% } else { %>
                        <span class="no-product">Mahsulot ma'lumoti yo'q</span>
                      <% } %>
                    </div>
                  </td>
                  
                  <!-- Quantity (Total) -->
                  <td class="quantity-cell">
                    <div class="quantity-content">
                      <% 
                        // Calculate total quantity for this order
                        const totalQuantity = order.items?.reduce((sum, item) => sum + (item.quantity || 0), 0) || 0;
                      %>
                      <span class="total-quantity"><%= totalQuantity %></span>
                      <span class="quantity-unit">dona</span>
                      <% if (order.items && order.items.length > 1) { %>
                        <span class="items-count">(<%= order.items.length %> mahsulot)</span>
                      <% } %>
                    </div>
                  </td>
                  
                  <!-- Total Amount -->
                  <td class="amount-cell">
                    <div class="amount-content">
                      <span class="total-amount">$<%= (order.totalAmount || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                      <span class="currency"><%= order.currency || 'USD' %></span>
                      <% if (primaryItem?.price) { %>
                        <span class="unit-price">@$<%= (primaryItem.price || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                      <% } %>
                    </div>
                  </td>
                  <td>
                    <span class="status-badge status-<%= order.status || 'pending' %>">
                      <%= order.status === 'pending' ? 'Kutayotgan' :
                          order.status === 'confirmed' ? 'Tasdiqlangan' :
                          order.status === 'processing' ? 'Jarayonda' :
                          order.status === 'manufacturing' ? 'Ishlab chiqarilmoqda' :
                          order.status === 'ready_to_ship' ? 'Jo\'natishga tayyor' :
                          order.status === 'shipped' ? 'Jo\'natilgan' :
                          order.status === 'delivered' ? 'Yetkazilgan' :
                          order.status === 'completed' ? 'Yakunlangan' :
                          order.status === 'cancelled' ? 'Bekor qilingan' :
                          'Noma\'lum holat' %>
                    </span>
                  </td>
                  <td class="actions-cell">
                    <div class="table-actions">
                      <button class="table-action-btn primary" data-action="view" data-order-id="<%= order._id %>" title="Batafsil ko'rish">
                        <i class="fas fa-eye"></i>
                      </button>
                      <div class="table-more-actions">
                        <button class="table-action-btn dropdown-toggle" title="Ko'proq amallar">
                          <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="table-more-menu hidden">
                          <!-- ASOSIY AMALLAR -->
                          <button class="table-more-item" data-action="edit" data-order-id="<%= order._id %>">
                            <i class="fas fa-edit"></i>
                            Tahrirlash
                          </button>
                          <button class="table-more-item" data-action="duplicate" data-order-id="<%= order._id %>">
                            <i class="fas fa-copy"></i>
                            Nusxalash
                          </button>
                          <div class="dropdown-divider"></div>
                          
                          <!-- HOLAT VA JARAYON -->
                          <button class="table-more-item" data-action="status-change" data-order-id="<%= order._id %>">
                            <i class="fas fa-exchange-alt"></i>
                            Holatni o'zgartirish
                          </button>
                          <button class="table-more-item" data-action="track-shipment" data-order-id="<%= order._id %>">
                            <i class="fas fa-shipping-fast"></i>
                            Yetkazib berishni kuzatish
                          </button>
                          <div class="dropdown-divider"></div>
                          
                          <!-- MULOQOT VA HUJJATLAR -->
                          <button class="table-more-item" data-action="communication" data-order-id="<%= order._id %>">
                            <i class="fas fa-comments"></i>
                            Mijoz bilan muloqot
                          </button>
                          <button class="table-more-item" data-action="add-note" data-order-id="<%= order._id %>">
                            <i class="fas fa-sticky-note"></i>
                            Izoh qo'shish
                          </button>
                          <button class="table-more-item" data-action="print-invoice" data-order-id="<%= order._id %>">
                            <i class="fas fa-file-invoice"></i>
                            Hisob-fakturani chop etish
                          </button>
                          <button class="table-more-item" data-action="download-documents" data-order-id="<%= order._id %>">
                            <i class="fas fa-download"></i>
                            Hujjatlarni yuklab olish
                          </button>
                          <div class="dropdown-divider"></div>
                          
                          <!-- XAVFLI AMALLAR -->
                          <button class="table-more-item warning" data-action="cancel" data-order-id="<%= order._id %>">
                            <i class="fas fa-ban"></i>
                            Buyurtmani bekor qilish
                          </button>
                          <button class="table-more-item warning" data-action="refund" data-order-id="<%= order._id %>">
                            <i class="fas fa-undo"></i>
                            Pulni qaytarish
                          </button>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <!-- Expandable Products Details (Hidden by default) -->
                <% if (order.items && order.items.length > 1) { %>
                  <tr class="order-details-row hidden" data-parent-order="<%= order._id %>">
                    <td colspan="9" class="order-details-cell">
                      <div class="order-products-expansion">
                        <h5 class="expansion-title">
                          <i class="fas fa-boxes"></i>
                          Barcha mahsulotlar (<%= order.items.length %> ta)
                        </h5>
                        <div class="products-breakdown">
                          <% order.items.forEach((item, itemIndex) => { %>
                            <div class="product-item" data-item-index="<%= itemIndex %>">
                              <div class="product-info">
                                <span class="product-name" title="<%= item.product?.title || item.product?.name || 'N/A' %>">
                                  <%= (item.product?.title || item.product?.name || 'Product').length > 40 ? 
                                      (item.product?.title || item.product?.name || 'Product').substring(0, 40) + '...' :
                                      (item.product?.title || item.product?.name || 'Product') %>
                                </span>
                                <% if (item.product?.category) { %>
                                  <span class="product-category">
                                    <i class="fas fa-tag"></i>
                                    <%= item.product.category.name || item.product.category %>
                                  </span>
                                <% } %>
                              </div>
                              <div class="product-quantity">
                                <span class="quantity"><%= item.quantity || 0 %> dona</span>
                              </div>
                              <div class="product-price">
                                <span class="unit-price">$<%= (item.price || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                <span class="subtotal">Jami: $<%= ((item.price || 0) * (item.quantity || 0)).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                              </div>
                            </div>
                          <% }); %>
                        </div>
                      </div>
                    </td>
                  </tr>
                <% } %>
                
              <% }); %>
            </tbody>
          </table>
          </div>
        </div>
      </div>

      <!-- CARDS VIEW - Products Style -->
      <div class="products-view-container hidden" id="cardsView">
        <div class="orders-cards-grid">
          <% orders.forEach((order, index) => { %>
            <div class="order-card card-fade-in" data-order-id="<%= order._id %>" data-animation-delay="<%= (index % 6) * 0.1 %>">
              
              <!-- Order Card Header -->
              <div class="order-card-header">
                <div class="order-card-id">
                  <h3 class="order-number">#<%= order.orderNumber || order._id.toString().slice(-8).toUpperCase() %></h3>
                  <span class="order-type"><%= order.type || 'B2B' %></span>
                </div>
                <div class="order-card-status">
                  <span class="status-badge status-<%= order.status || 'pending' %>">
                    <%= order.status === 'pending' ? 'Kutayotgan' :
                        order.status === 'confirmed' ? 'Tasdiqlangan' :
                        order.status === 'processing' ? 'Jarayonda' :
                        order.status === 'manufacturing' ? 'Ishlab chiqarilmoqda' :
                        order.status === 'ready_to_ship' ? 'Jo\'natishga tayyor' :
                        order.status === 'shipped' ? 'Jo\'natilgan' :
                        order.status === 'delivered' ? 'Yetkazilgan' :
                        order.status === 'completed' ? 'Yakunlangan' :
                        order.status === 'cancelled' ? 'Bekor qilingan' :
                        'Noma\'lum holat' %>
                  </span>
                </div>
              </div>

              <!-- Customer Info -->
              <div class="order-card-customer">
                <div class="customer-avatar">
                  <i class="fas fa-building"></i>
                </div>
                <div class="customer-details">
                  <h4 class="customer-name"><%= order.buyer?.companyName || order.buyer?.name || 'N/A' %></h4>
                  <p class="customer-contact"><%= order.buyer?.email || 'Email mavjud emas' %></p>
                </div>
              </div>

              <!-- Order Details -->
              <div class="order-card-details">
                <div class="order-detail-item">
                  <span class="detail-label">Sana:</span>
                  <span class="detail-value"><%= new Date(order.createdAt).toLocaleDateString('uz-UZ') %></span>
                </div>
                <div class="order-detail-item">
                  <span class="detail-label">Mahsulotlar:</span>
                  <span class="detail-value"><%= order.items?.length || 0 %> ta</span>
                </div>
                <div class="order-detail-item">
                  <span class="detail-label">Summa:</span>
                  <span class="detail-value amount">$<%= (order.totalAmount || 0).toLocaleString() %></span>
                </div>
              </div>

              <!-- Order Actions -->
              <div class="order-card-actions">
                <button class="card-action-btn btn-primary" data-action="view" data-order-id="<%= order._id %>">
                  <i class="fas fa-eye"></i>
                  <span>Ko'rish</span>
                </button>
                <button class="card-action-btn btn-secondary" data-action="communication" data-order-id="<%= order._id %>">
                  <i class="fas fa-comments"></i>
                  <span>Aloqa</span>
                </button>
                <div class="card-more-actions">
                  <button class="card-more-toggle" data-order-id="<%= order._id %>">
                    <i class="fas fa-ellipsis-h"></i>
                  </button>
                  <div class="card-more-menu hidden">
                    <!-- ASOSIY AMALLAR -->
                    <button class="card-more-item" data-action="edit" data-order-id="<%= order._id %>">
                      <i class="fas fa-edit"></i>
                      Tahrirlash
                    </button>
                    <button class="card-more-item" data-action="duplicate" data-order-id="<%= order._id %>">
                      <i class="fas fa-copy"></i>
                      Nusxalash
                    </button>
                    <div class="dropdown-divider"></div>
                    
                    <!-- HOLAT VA JARAYON -->
                    <button class="card-more-item" data-action="status-change" data-order-id="<%= order._id %>">
                      <i class="fas fa-exchange-alt"></i>
                      Holatni o'zgartirish
                    </button>
                    <button class="card-more-item" data-action="track-shipment" data-order-id="<%= order._id %>">
                      <i class="fas fa-shipping-fast"></i>
                      Yetkazib berishni kuzatish
                    </button>
                    <div class="dropdown-divider"></div>
                    
                    <!-- MULOQOT VA HUJJATLAR -->
                    <button class="card-more-item" data-action="add-note" data-order-id="<%= order._id %>">
                      <i class="fas fa-sticky-note"></i>
                      Izoh qo'shish
                    </button>
                    <button class="card-more-item" data-action="print-invoice" data-order-id="<%= order._id %>">
                      <i class="fas fa-file-invoice"></i>
                      Hisob-faktura
                    </button>
                    <button class="card-more-item" data-action="download-documents" data-order-id="<%= order._id %>">
                      <i class="fas fa-download"></i>
                      Hujjatlar
                    </button>
                    <div class="dropdown-divider"></div>
                    
                    <!-- XAVFLI AMALLAR -->
                    <button class="card-more-item danger" data-action="cancel" data-order-id="<%= order._id %>">
                      <i class="fas fa-ban"></i>
                      Buyurtmani bekor qilish
                    </button>
                    <button class="card-more-item danger" data-action="refund" data-order-id="<%= order._id %>">
                      <i class="fas fa-undo"></i>
                      Pulni qaytarish
                    </button>
                  </div>
                </div>
              </div>

            </div>
          <% }); %>
        </div>
      </div>

      <!-- TIMELINE VIEW - Products Style -->
      <div class="products-view-container hidden" id="timelineView">
        <div class="orders-timeline-container">
          <% 
            // Group orders by date for timeline view
            const groupedOrders = {};
            orders.forEach(order => {
              const date = new Date(order.createdAt).toDateString();
              if (!groupedOrders[date]) {
                groupedOrders[date] = [];
              }
              groupedOrders[date].push(order);
            });
          %>
          
          <% Object.entries(groupedOrders).forEach(([date, dateOrders]) => { %>
            <div class="timeline-date-group">
              <div class="timeline-date-header">
                <h3 class="timeline-date"><%= new Date(date).toLocaleDateString('uz-UZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></h3>
                <span class="timeline-count"><%= dateOrders.length %> buyurtma</span>
              </div>
              
              <div class="timeline-orders">
                <% dateOrders.forEach((order, index) => { %>
                  <div class="timeline-order-item">
                    <div class="timeline-order-time">
                      <%= new Date(order.createdAt).toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit' }) %>
                    </div>
                    <div class="timeline-order-content">
                      <div class="timeline-order-header">
                        <h4 class="timeline-order-id">#<%= order.orderNumber || order._id.toString().slice(-8).toUpperCase() %></h4>
                        <span class="status-badge status-<%= order.status || 'pending' %>">
                          <%= order.status === 'pending' ? 'Kutayotgan' : order.status === 'confirmed' ? 'Tasdiqlangan' : order.status %>
                        </span>
                      </div>
                      <div class="timeline-order-details">
                        <p><strong>Mijoz:</strong> <%= order.buyer?.companyName || order.buyer?.name || 'N/A' %></p>
                        <p><strong>Summa:</strong> $<%= (order.totalAmount || 0).toLocaleString() %></p>
                        <p><strong>Mahsulotlar:</strong> <%= order.items?.length || 0 %> ta</p>
                      </div>
                      <div class="timeline-order-actions">
                        <button class="timeline-action-btn" data-action="view" data-order-id="<%= order._id %>">
                          <i class="fas fa-eye"></i>
                          Ko'rish
                        </button>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            </div>
          <% }); %>
        </div>
      </div>
      
    </div> <!-- End products-main-container -->

    <% } else { %>
      <!-- Empty State -->
      <div class="orders-empty-state">
        <div class="empty-state-icon">
          <i class="fas fa-clipboard-list"></i>
        </div>
        <h3 class="empty-state-title">Buyurtmalar topilmadi</h3>
        <p class="empty-state-description">
          Hozircha buyurtmalar yo'q. Mijozlar mahsulotlaringizni ko'rib, buyurtma berishganlarida, ular shu yerda ko'rinadi.
        </p>
        <div class="empty-state-actions">
          <a href="/manufacturer/marketplace" class="orders-btn orders-btn-primary">
            <i class="fas fa-store"></i>
            Marketplace ga o'tish
          </a>
          <a href="/manufacturer/products" class="orders-btn orders-btn-secondary">
            <i class="fas fa-box"></i>
            Mahsulotlarni ko'rish
          </a>
        </div>
      </div>
    <% } %>

  </div>
</main>



<!-- Status Change Modal -->
<div class="modal-overlay" id="statusChangeModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Buyurtma Holatini O'zgartirish</h3>
      <button class="modal-close" id="closeStatusModal">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="statusChangeForm">
        <div class="form-group">
          <label>Yangi holat</label>
          <select id="newStatusSelect" class="form-control" required>
            <option value="">Holatni tanlang</option>
            <option value="pending">Kutayotgan</option>
            <option value="confirmed">Tasdiqlangan</option>
            <option value="processing">Jarayonda</option>
            <option value="manufacturing">Ishlab chiqarilmoqda</option>
            <option value="ready_to_ship">Jo'natishga tayyor</option>
            <option value="shipped">Jo'natilgan</option>
            <option value="delivered">Yetkazilgan</option>
            <option value="completed">Yakunlangan</option>
            <option value="cancelled">Bekor qilingan</option>
          </select>
        </div>
        <div class="form-group">
          <label>Izoh (ixtiyoriy)</label>
          <textarea id="statusChangeNote" class="form-control" rows="3" placeholder="Holat o'zgarishi sababi..."></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="orders-btn orders-btn-secondary" id="cancelStatusChange">Bekor qilish</button>
          <button type="submit" class="orders-btn orders-btn-primary">O'zgartirish</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11;">
  <!-- Toasts will be dynamically added here -->
</div>

<!-- Bootstrap 5 JavaScript -->
<script src="/assets/js/bootstrap.bundle.min.js"></script>

<!-- Dashboard Initialization - Theme & Core Functions -->
<script src="/js/manufacturer/dashboard-init.js"></script>

<!-- Real Data Loading Script -->
<script>
  // Load real orders statistics
  async function loadOrdersData() {
    try {
      console.log('📊 Loading real orders data...');
      
      const response = await fetch('/api/manufacturer/orders/stats', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getCookie('accessToken')}`
        },
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log('📊 Orders data received:', data);
        
        // Update KPI values
        updateOrdersKPIs(data);
        
      } else {
        console.error('❌ Failed to load orders data');
        // Use fallback static data
        updateOrdersKPIs({
          totalOrders: 0,
          activeOrders: 0,
          monthlyRevenue: 0,
          pendingOrders: 0
        });
      }
    } catch (error) {
      console.error('❌ Error loading orders data:', error);
      // Use fallback static data
      updateOrdersKPIs({
        totalOrders: 0,
        activeOrders: 0,
        monthlyRevenue: 0,
        pendingOrders: 0
      });
    }
  }

  // Update orders KPIs with real data
  function updateOrdersKPIs(data) {
    // Update Total Orders
    const totalOrdersElement = document.getElementById('totalOrdersValue');
    if (totalOrdersElement) {
      totalOrdersElement.innerHTML = data.totalOrders !== undefined ? data.totalOrders.toLocaleString() : '0';
    }
    
    // Update Active Orders
    const activeOrdersElement = document.getElementById('activeOrdersValue');
    if (activeOrdersElement) {
      activeOrdersElement.innerHTML = data.activeOrders !== undefined ? data.activeOrders.toLocaleString() : '0';
    }
    
    // Update Monthly Revenue
    const monthlyRevenueElement = document.getElementById('monthlyRevenueValue');
    if (monthlyRevenueElement) {
      const revenue = data.monthlyRevenue || 0;
      monthlyRevenueElement.innerHTML = '$' + revenue.toLocaleString();
    }
    
    // Update Pending Orders
    const pendingOrdersElement = document.getElementById('pendingOrdersValue');
    if (pendingOrdersElement) {
      pendingOrdersElement.innerHTML = data.pendingOrders !== undefined ? data.pendingOrders.toLocaleString() : '0';
    }
    
    console.log('✅ Orders KPIs updated with real data');
  }

  // Get cookie helper function
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  // Initialize orders page functionality
  document.addEventListener('DOMContentLoaded', function() {
    console.log('📋 Initializing Orders Management...');
    
    // Load real orders data
    loadOrdersData();
    
    console.log('✅ Orders Management initialized successfully');
  });
</script>

<!-- Professional Orders Management JavaScript -->
<script src="/js/manufacturer/orders-management.js"></script>

</body>
</html>
