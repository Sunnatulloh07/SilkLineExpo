<%- include('../partials/header', { title: title, lng: lng, user: user, t: t }) %>
<%- include('../partials/sidebar', { user: user, currentPage: 'orders', t: t }) %>

<!-- Enhanced CSS Imports - Professional B2B Orders Style -->
<link rel="stylesheet" href="/css/products-management-redesign.css">
<link rel="stylesheet" href="/css/products-table-view.css">
  <link rel="stylesheet" href="/css/orders-management.css">
  <link rel="stylesheet" href="/css/manufacturer-cards.css">
  <link rel="stylesheet" href="/css/manufacturer-theme.css">
  <link rel="stylesheet" href="/css/toast-notifications.css">
  <link rel="stylesheet" href="/css/modal-system.css">

<!-- Main Content -->
<main class="admin-main">
  <div class="admin-content">
    
    <!-- Professional B2B Orders Header -->
    <div class="orders-header animate-fade-in">
      <div class="orders-header-content">
        <div class="orders-title-section">
          <h1 class="orders-main-title">
            <i class="fas fa-clipboard-list"></i>
            <%= t('manufacturer.orders.header.title') %>
          </h1>
          <p class="orders-subtitle"><%= t('manufacturer.orders.header.subtitle') %></p>
        </div>
        <div class="orders-header-actions">
          <div class="orders-count-display">
            <span class="orders-total-count">0 buyurtma</span>
          </div>
          <button class="orders-btn orders-btn-primary" id="exportOrdersBtn">
            <i class="fas fa-download"></i>
            <%= t('manufacturer.orders.header.actions.export_report') %>
          </button>
          <button class="orders-btn orders-btn-secondary" id="refreshOrdersBtn">
            <i class="fas fa-sync-alt"></i>
            <%= t('manufacturer.orders.header.actions.refresh') %>
          </button>
        </div>
      </div>
    </div>

    <!-- Professional B2B KPI Cards - Orders Analytics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-lg mb-lg">
      
      <!-- Total Orders -->
      <div class="stat-card primary animate-fade-in" data-kpi="totalOrders">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.orders.kpi.total_orders') %></h3>
          <div class="stat-icon primary">
            <i class="fas fa-shopping-cart"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="totalOrdersValue">
            <span class="loading-placeholder"><%= t('manufacturer.orders.additional_labels.loading_dots') %></span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend"><%= t('manufacturer.orders.kpi.trends.all_orders') %></span>
        </div>
      </div>

      <!-- Active Orders -->
      <div class="stat-card success animate-fade-in" data-kpi="activeOrders">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.orders.kpi.active_orders') %></h3>
          <div class="stat-icon success">
            <i class="fas fa-hourglass-half"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="activeOrdersValue">
            <span class="loading-placeholder"><%= t('manufacturer.orders.additional_labels.loading_dots') %></span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend"><%= t('manufacturer.orders.kpi.trends.in_progress') %></span>
        </div>
      </div>

      <!-- Monthly Revenue -->
      <div class="stat-card info animate-fade-in" data-kpi="monthlyRevenue">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.orders.kpi.monthly_revenue') %></h3>
          <div class="stat-icon info">
            <i class="fas fa-chart-line"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="monthlyRevenueValue">
            <span class="loading-placeholder"><%= t('manufacturer.orders.additional_labels.loading_dots') %></span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend"><%= t('manufacturer.orders.kpi.trends.current_month') %></span>
        </div>
      </div>

      <!-- Pending Orders -->
      <div class="stat-card warning animate-fade-in" data-kpi="pendingOrders">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.orders.kpi.pending_orders') %></h3>
          <div class="stat-icon warning">
            <i class="fas fa-clock"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="pendingOrdersValue">
            <span class="loading-placeholder"><%= t('manufacturer.orders.additional_labels.loading_dots') %></span>
          </span>
        </div>
        <div class="stat-change neutral">
          <i class="fas fa-arrow-right stat-change-icon"></i>
          <span class="metric-trend"><%= t('manufacturer.orders.kpi.trends.awaiting_confirmation') %></span>
        </div>
      </div>

    </div>

    <!-- Professional Filters Container - Products Style -->
    <div class="products-filters-container">
      <div class="products-filters-header">
        <h3 class="products-filters-title">
          <i class="fas fa-filter"></i>
          <%= t('manufacturer.orders.filters.title') %>
        </h3>
      </div>
      <div class="products-filters-body">
        <form id="ordersFiltersForm" class="products-filters-form">
          
          <!-- Search Input -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.orders.filters.labels.search') %></label>
            <div class="products-search-wrapper">
              <i class="fas fa-search products-search-icon"></i>
              <input 
                type="text" 
                id="ordersSearchInput" 
                name="search" 
                placeholder="<%= t('manufacturer.orders.filters.placeholders.search') %>"
                class="products-form-input search"
              >
            </div>
          </div>

          <!-- Status Filter -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.orders.filters.labels.status') %></label>
            <select name="status" id="statusFilter" class="products-form-select">
              <option value=""><%= t('manufacturer.orders.filters.placeholders.all_statuses') %></option>
              <option value="pending"><%= t('manufacturer.orders.filters.status_options.pending') %></option>
              <option value="confirmed"><%= t('manufacturer.orders.filters.status_options.confirmed') %></option>
              <option value="processing"><%= t('manufacturer.orders.filters.status_options.processing') %></option>
              <option value="manufacturing"><%= t('manufacturer.orders.filters.status_options.manufacturing') %></option>
              <option value="ready_to_ship"><%= t('manufacturer.orders.filters.status_options.ready_to_ship') %></option>
              <option value="shipped"><%= t('manufacturer.orders.filters.status_options.shipped') %></option>
              <option value="delivered"><%= t('manufacturer.orders.filters.status_options.delivered') %></option>
              <option value="completed"><%= t('manufacturer.orders.filters.status_options.completed') %></option>
              <option value="cancelled"><%= t('manufacturer.orders.filters.status_options.cancelled') %></option>
            </select>
          </div>

          <!-- Date Range Filter -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.orders.additional_labels.date_range') %></label>
            <select name="dateRange" id="dateRangeFilter" class="products-form-select">
              <option value=""><%= t('manufacturer.orders.additional_labels.all_time') %></option>
              <option value="today"><%= t('manufacturer.orders.additional_labels.today') %></option>
              <option value="week"><%= t('manufacturer.orders.additional_labels.week') %></option>
              <option value="month"><%= t('manufacturer.orders.additional_labels.month') %></option>
              <option value="quarter"><%= t('manufacturer.orders.additional_labels.quarter') %></option>
              <option value="year"><%= t('manufacturer.orders.additional_labels.year') %></option>
              <option value="custom"><%= t('manufacturer.orders.additional_labels.custom') %></option>
            </select>
          </div>

          <!-- Customer Filter -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.orders.additional_labels.customer') %></label>
            <select name="customer" id="customerFilter" class="products-form-select">
              <option value=""><%= t('manufacturer.orders.additional_labels.all_customers') %></option>
              <!-- <%= t('manufacturer.orders.additional_labels.dynamically_populated') %> -->
            </select>
          </div>

          <!-- Amount Range Filter -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.orders.additional_labels.amount_range') %></label>
            <select name="amount" id="amountFilter" class="products-form-select">
              <option value=""><%= t('manufacturer.orders.additional_labels.all_amounts') %></option>
              <option value="0-1000">$0 - $1,000</option>
              <option value="1000-5000">$1,000 - $5,000</option>
              <option value="5000-10000">$5,000 - $10,000</option>
              <option value="10000-50000">$10,000 - $50,000</option>
              <option value="50000+">$50,000+</option>
            </select>
          </div>

          <!-- Sort Options -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.orders.additional_labels.sort_by') %></label>
            <select name="sortBy" id="ordersSortFilter" class="products-form-select">
              <option value="createdAt"><%= t('manufacturer.orders.additional_labels.created_at') %></option>
              <option value="totalAmount"><%= t('manufacturer.orders.additional_labels.total_amount') %></option>
              <option value="status"><%= t('manufacturer.orders.additional_labels.status') %></option>
              <option value="buyer.companyName"><%= t('manufacturer.orders.additional_labels.customer_name') %></option>
            </select>
          </div>

          <!-- Sort Order -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.orders.additional_labels.sort_order') %></label>
            <select name="sortOrder" id="ordersSortOrderFilter" class="products-form-select">
              <option value="desc"><%= t('manufacturer.orders.additional_labels.desc') %></option>
              <option value="asc"><%= t('manufacturer.orders.additional_labels.asc') %></option>
            </select>
          </div>
          
          <div class="products-filters-submit">
            <button type="submit" class="products-btn products-btn-primary" id="searchOrdersFiltersBtn">
              <i class="fas fa-search"></i>
              <%= t('manufacturer.orders.additional_labels.search') %>
            </button>
            <button type="button" class="products-btn products-btn-secondary" id="clearOrdersFiltersBtn">
              <i class="fas fa-times"></i>
              Tozalash
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Main Orders Container - Products Style -->
    <div class="products-main-container">
      <div class="products-content-header">
        <h3 class="products-content-title">
          <i class="fas fa-shopping-cart"></i>
          <%= t('manufacturer.orders.additional_labels.orders_table') %>
        </h3>
        <div class="products-content-actions">
          <div class="products-view-toggle">
            <button class="products-view-btn" data-view="cards" title="<%= t('manufacturer.orders.additional_labels.card_view') %>" id="cardsViewBtn">
              <i class="fas fa-th"></i>
              <span><%= t('manufacturer.orders.additional_labels.cards') %></span>
            </button>
            <button class="products-view-btn active" data-view="table" title="<%= t('manufacturer.orders.additional_labels.table_view') %>" id="tableViewBtn">
              <i class="fas fa-list"></i>
              <span><%= t('manufacturer.orders.additional_labels.table') %></span>
            </button>
            <button class="products-view-btn" data-view="timeline" title="<%= t('manufacturer.orders.additional_labels.timeline_view') %>" id="timelineViewBtn">
              <i class="fas fa-history"></i>
              <span><%= t('manufacturer.orders.additional_labels.timeline') %></span>
            </button>
          </div>
          <button class="products-btn products-btn-sm products-btn-secondary" id="refreshOrdersBtn2">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </div>
      
    <% if (orders && orders.length > 0) { %>
      
      <!-- TABLE VIEW - Products Style -->
      <div class="products-view-container" id="tableView">
        <div class="products-table-container">
          <div class="products-table-header">
            <h4 class="products-table-title">
              <i class="fas fa-table"></i>
              <%= t('manufacturer.orders.additional_labels.orders_table') %>
            </h4>
          </div>
          
          <div class="products-table-wrapper">
            <table class="products-table orders-table">
              <thead>
              <tr>
                <th class="table-checkbox-col">
                  <input type="checkbox" id="selectAllOrders" class="table-checkbox">
                </th>
                <th class="order-id-col sortable" data-sort="orderNumber">
                  <%= t('manufacturer.orders.additional_labels.order_id') %>
                  <i class="fas fa-sort sort-icon"></i>
                </th>
                <th class="customer-col sortable" data-sort="buyer.companyName">
                  <%= t('manufacturer.orders.additional_labels.customer') %>
                  <i class="fas fa-sort sort-icon"></i>
                </th>
                <th class="date-col sortable" data-sort="createdAt">
                  <%= t('manufacturer.orders.additional_labels.date') %>
                  <i class="fas fa-sort sort-icon"></i>
                </th>
                <th class="product-name-col"><%= t('manufacturer.orders.additional_labels.product_name') %></th>
                <th class="quantity-col"><%= t('manufacturer.orders.additional_labels.quantity') %></th>
                <th class="amount-col sortable" data-sort="totalAmount">
                  <%= t('manufacturer.orders.additional_labels.total_amount') %>
                  <i class="fas fa-sort sort-icon"></i>
                </th>
                <th class="status-col sortable" data-sort="status">
                  <%= t('manufacturer.orders.additional_labels.status') %>
                  <i class="fas fa-sort sort-icon"></i>
                </th>
                <th class="actions-col"><%= t('manufacturer.orders.additional_labels.actions') %></th>
              </tr>
            </thead>
            <tbody>
              <% orders.forEach((order, index) => { %>
                <tr class="table-row" data-order-id="<%= order._id %>">
                  <td class="table-checkbox-col">
                    <input type="checkbox" class="table-checkbox order-checkbox" data-order-id="<%= order._id %>">
                  </td>
                  <td class="order-id-cell">
                    <div class="order-id-content">
                      <span class="order-number"><%= t('manufacturer.orders.additional_labels.order_number_prefix') %><%= order.orderNumber || order._id.toString().slice(-8).toUpperCase() %></span>
                      <div class="order-meta">
                        <span class="order-type badge-sm"><%= order.type || t('manufacturer.orders.additional_labels.b2b_type') %></span>
                        <% if (order.items && order.items.length > 1) { %>
                          <button class="expand-order-btn" data-order-id="<%= order._id %>" title="<%= order.items.length %> <%= t('manufacturer.orders.js_messages.view_products_count') %>">
                            <i class="fas fa-chevron-down"></i>
                            <%= t('manufacturer.orders.additional_labels.plus_symbol') %><%= order.items.length - 1 %>
                          </button>
                        <% } %>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="customer-cell">
                      <div class="customer-info">
                        <h4 class="customer-name"><%= order.buyer?.companyName || order.buyer?.name || t('manufacturer.orders.additional_labels.na_value') %></h4>
                        <p class="customer-contact"><%= order.buyer?.email || t('manufacturer.orders.additional_labels.email_not_available') %></p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="date-cell">
                      <span class="order-date"><%= new Date(order.createdAt).toLocaleDateString('uz-UZ') %></span>
                      <span class="order-time"><%= new Date(order.createdAt).toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit' }) %></span>
                    </div>
                  </td>
                  <!-- Product Name (Main Product) -->
                  <td class="product-name-cell">
                    <div class="product-name-content">
                      <% 
                        // Get primary product (first item or most quantity)
                        const primaryItem = order.items && order.items.length > 0 ? 
                          order.items.reduce((prev, current) => (current.quantity > prev.quantity) ? current : prev) : 
                          null;
                        
                        // Product name with truncation logic
                        const productName = primaryItem?.product?.title || primaryItem?.product?.name || 'Mahsulot mavjud emas';
                        const truncatedName = productName.length > 50 ? productName.substring(0, 50) + '...' : productName;
                      %>
                      <% if (primaryItem) { %>
                        <span class="product-name" title="<%= productName %>">
                          <%= truncatedName %>
                        </span>
                        <% if (primaryItem.product?.category) { %>
                          <span class="product-category">
                            <i class="fas fa-tag"></i>
                            <%= primaryItem.product.category.name || primaryItem.product.category %>
                          </span>
                        <% } %>
                        <% if (order.items.length > 1) { %>
                          <span class="multiple-products-indicator">
                            <i class="fas fa-layer-group"></i>
                            <%= t('manufacturer.orders.additional_labels.plus_symbol') %><%= order.items.length - 1 %> <%= t('manufacturer.orders.additional_labels.boshqa_mahsulot') %>
                          </span>
                        <% } %>
                      <% } else { %>
                        <span class="no-product"><%= t('manufacturer.orders.additional_labels.no_product') %></span>
                      <% } %>
                    </div>
                  </td>
                  
                  <!-- Quantity (Total) -->
                  <td class="quantity-cell">
                    <div class="quantity-content">
                      <% 
                        // Calculate total quantity for this order
                        const totalQuantity = order.items?.reduce((sum, item) => sum + (item.quantity || 0), 0) || 0;
                      %>
                      <span class="total-quantity"><%= totalQuantity %></span>
                      <span class="quantity-unit"><%= t('manufacturer.orders.additional_labels.pieces') %></span>
                      <% if (order.items && order.items.length > 1) { %>
                        <span class="items-count">(<%= order.items.length %> <%= t('manufacturer.orders.additional_labels.products_count') %>)</span>
                      <% } %>
                    </div>
                  </td>
                  
                  <!-- Total Amount -->
                  <td class="amount-cell">
                    <div class="amount-content">
                      <span class="total-amount"><%= t('manufacturer.orders.additional_labels.currency_symbol') %><%= (order.totalAmount || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                      <span class="currency"><%= order.currency || t('manufacturer.orders.additional_labels.currency_usd') %></span>
                      <% if (primaryItem?.price) { %>
                        <span class="unit-price"><%= t('manufacturer.orders.additional_labels.unit_price_symbol') %><%= (primaryItem.price || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                      <% } %>
                    </div>
                  </td>
                  <td>
                    <span class="status-badge status-<%= order.status || 'pending' %>">
                      <%= order.status === 'pending' ? t('manufacturer.orders.additional_labels.status_pending_uz') :
                          order.status === 'confirmed' ? t('manufacturer.orders.additional_labels.status_confirmed_uz') :
                          order.status === 'processing' ? t('manufacturer.orders.additional_labels.status_processing_uz') :
                          order.status === 'manufacturing' ? t('manufacturer.orders.additional_labels.status_manufacturing_uz') :
                          order.status === 'ready_to_ship' ? t('manufacturer.orders.additional_labels.status_ready_to_ship_uz') :
                          order.status === 'shipped' ? t('manufacturer.orders.additional_labels.status_shipped_uz') :
                          order.status === 'delivered' ? t('manufacturer.orders.additional_labels.status_delivered_uz') :
                          order.status === 'completed' ? t('manufacturer.orders.additional_labels.status_completed_uz') :
                          order.status === 'cancelled' ? t('manufacturer.orders.additional_labels.status_cancelled_uz') :
                          t('manufacturer.orders.additional_labels.status_unknown_uz') %>
                    </span>
                  </td>
                  <td class="actions-cell">
                    <div class="table-actions">
                      <button class="table-action-btn primary" data-action="view" data-order-id="<%= order._id %>" title="<%= t('manufacturer.orders.additional_labels.view_details') %>">
                        <i class="fas fa-eye"></i>
                      </button>
                      <div class="table-more-actions">
                        <button class="table-action-btn dropdown-toggle" title="<%= t('manufacturer.orders.additional_labels.more_actions') %>">
                          <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="table-more-menu hidden">
                          <!-- <%= t('manufacturer.orders.additional_labels.main_actions') %> -->
                          <button class="table-more-item" onclick="window.location.href='/manufacturer/messages/order/<%= order._id %>'" data-order-id="<%= order._id %>">
                            <i class="fas fa-comments"></i>
                            <%= t('manufacturer.orders.additional_labels.customer_communication') %>
                          </button>
                          <button class="table-more-item" data-action="duplicate" data-order-id="<%= order._id %>">
                            <i class="fas fa-copy"></i>
                            <%= t('manufacturer.orders.additional_labels.duplicate') %>
                          </button>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <!-- Expandable Products Details (Hidden by default) -->
                <% if (order.items && order.items.length > 1) { %>
                  <tr class="order-details-row hidden" data-parent-order="<%= order._id %>">
                    <td colspan="9" class="order-details-cell">
                      <div class="order-products-expansion">
                        <h5 class="expansion-title">
                          <i class="fas fa-boxes"></i>
                          <%= t('manufacturer.orders.additional_labels.all_products') %> (<%= order.items.length %> <%= t('manufacturer.orders.additional_labels.products_count') %>)
                        </h5>
                        <div class="products-breakdown">
                          <% order.items.forEach((item, itemIndex) => { %>
                            <div class="product-item" data-item-index="<%= itemIndex %>">
                              <div class="product-info">
                                <span class="product-name" title="<%= item.product?.title || item.product?.name || t('manufacturer.orders.additional_labels.na_value') %>">
                                  <% 
                                    const itemProductName = item.product?.title || item.product?.name || t('manufacturer.orders.additional_labels.product_default');
                                    const itemTruncatedName = itemProductName.length > 40 ? itemProductName.substring(0, 40) + '...' : itemProductName;
                                  %>
                                  <%= itemTruncatedName %>
                                </span>
                                <% if (item.product?.category) { %>
                                  <span class="product-category">
                                    <i class="fas fa-tag"></i>
                                    <%= item.product.category.name || item.product.category %>
                                  </span>
                                <% } %>
                              </div>
                              <div class="product-quantity">
                                <span class="quantity"><%= item.quantity || 0 %> <%= t('manufacturer.orders.additional_labels.pieces') %></span>
                              </div>
                              <div class="product-price">
                                <span class="unit-price"><%= t('manufacturer.orders.additional_labels.currency_symbol') %><%= (item.price || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                <span class="subtotal"><%= t('manufacturer.orders.js_messages.total_label') %> <%= t('manufacturer.orders.additional_labels.currency_symbol') %><%= ((item.price || 0) * (item.quantity || 0)).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                              </div>
                            </div>
                          <% }); %>
                        </div>
                      </div>
                    </td>
                  </tr>
                <% } %>
                
              <% }); %>
            </tbody>
          </table>
          </div>
        </div>
      </div>

      <!-- CARDS VIEW - Products Style -->
      <div class="products-view-container hidden" id="cardsView">
        <div class="orders-cards-grid">
          <% orders.forEach((order, index) => { %>
            <div class="order-card card-fade-in" data-order-id="<%= order._id %>" data-animation-delay="<%= (index % 6) * 0.1 %>">
              
              <!-- Order Card Header -->
              <div class="order-card-header">
                <div class="order-card-id">
                  <h3 class="order-number"><%= t('manufacturer.orders.additional_labels.order_number_prefix') %><%= order.orderNumber || order._id.toString().slice(-8).toUpperCase() %></h3>
                  <span class="order-type"><%= order.type || t('manufacturer.orders.additional_labels.b2b_default') %></span>
                </div>
                <div class="order-card-status">
                  <span class="status-badge status-<%= order.status || 'pending' %>">
                    <%= order.status === 'pending' ? t('manufacturer.orders.additional_labels.status_pending_uz') :
                        order.status === 'confirmed' ? t('manufacturer.orders.additional_labels.status_confirmed_uz') :
                        order.status === 'processing' ? t('manufacturer.orders.additional_labels.status_processing_uz') :
                        order.status === 'manufacturing' ? t('manufacturer.orders.additional_labels.status_manufacturing_uz') :
                        order.status === 'ready_to_ship' ? t('manufacturer.orders.additional_labels.status_ready_to_ship_uz') :
                        order.status === 'shipped' ? t('manufacturer.orders.additional_labels.status_shipped_uz') :
                        order.status === 'delivered' ? t('manufacturer.orders.additional_labels.status_delivered_uz') :
                        order.status === 'completed' ? t('manufacturer.orders.additional_labels.status_completed_uz') :
                        order.status === 'cancelled' ? t('manufacturer.orders.additional_labels.status_cancelled_uz') :
                        t('manufacturer.orders.additional_labels.status_unknown_uz') %>
                  </span>
                </div>
              </div>

              <!-- Customer Info -->
              <div class="order-card-customer">
                <div class="customer-avatar">
                  <i class="fas fa-building"></i>
                </div>
                <div class="customer-details">
                  <h4 class="customer-name"><%= order.buyer?.companyName || order.buyer?.name || t('manufacturer.orders.additional_labels.na_value') %></h4>
                  <p class="customer-contact"><%= order.buyer?.email || t('manufacturer.orders.additional_labels.email_not_available') %></p>
                </div>
              </div>

              <!-- Order Details -->
              <div class="order-card-details">
                <div class="order-detail-item">
                  <span class="detail-label"><%= t('manufacturer.orders.additional_labels.date_label') %></span>
                  <span class="detail-value"><%= new Date(order.createdAt).toLocaleDateString('uz-UZ') %></span>
                </div>
                <div class="order-detail-item">
                  <span class="detail-label"><%= t('manufacturer.orders.additional_labels.products_label') %></span>
                  <span class="detail-value"><%= order.items?.length || 0 %> <%= t('manufacturer.orders.js_messages.pieces_short') %></span>
                </div>
                <div class="order-detail-item">
                  <span class="detail-label"><%= t('manufacturer.orders.additional_labels.amount_label') %></span>
                  <span class="detail-value amount">$<%= (order.totalAmount || 0).toLocaleString() %></span>
                </div>
              </div>

              <!-- Order Actions -->
              <div class="order-card-actions">
                <button class="card-action-btn btn-primary" data-action="view" data-order-id="<%= order._id %>">
                  <i class="fas fa-eye"></i>
                  <span><%= t('manufacturer.orders.additional_labels.view') %></span>
                </button>
                <button class="card-action-btn btn-secondary" onclick="window.location.href='/manufacturer/messages/order/<%= order._id %>'" data-order-id="<%= order._id %>">
                  <i class="fas fa-comments"></i>
                  <span><%= t('manufacturer.orders.additional_labels.communication') %></span>
                </button>
                <div class="card-more-actions">
                  <button class="card-more-toggle" data-order-id="<%= order._id %>">
                    <i class="fas fa-ellipsis-h"></i>
                  </button>
                  <div class="card-more-menu hidden">
                    <!-- <%= t('manufacturer.orders.additional_labels.main_actions') %> -->
                    <button class="card-more-item" onclick="window.location.href='/manufacturer/messages/order/<%= order._id %>'" data-order-id="<%= order._id %>">
                      <i class="fas fa-comments"></i>
                      <%= t('manufacturer.orders.additional_labels.customer_communication') %>
                    </button>
                    <button class="card-more-item" data-action="duplicate" data-order-id="<%= order._id %>">
                      <i class="fas fa-copy"></i>
                      <%= t('manufacturer.orders.additional_labels.duplicate') %>
                    </button>
                  </div>
                </div>
              </div>

            </div>
          <% }); %>
        </div>
      </div>

      <!-- TIMELINE VIEW - Products Style -->
      <div class="products-view-container hidden" id="timelineView">
        <div class="orders-timeline-container">
          <% 
            // Group orders by date for timeline view
            const groupedOrders = {};
            orders.forEach(order => {
              const date = new Date(order.createdAt).toDateString();
              if (!groupedOrders[date]) {
                groupedOrders[date] = [];
              }
              groupedOrders[date].push(order);
            });
          %>
          
          <% Object.entries(groupedOrders).forEach(([date, dateOrders]) => { %>
            <div class="timeline-date-group">
              <div class="timeline-date-header">
                <h3 class="timeline-date"><%= new Date(date).toLocaleDateString('uz-UZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></h3>
                <span class="timeline-count"><%= dateOrders.length %> <%= t('manufacturer.orders.additional_labels.orders_count') %></span>
              </div>
              
              <div class="timeline-orders">
                <% dateOrders.forEach((order, index) => { %>
                  <div class="timeline-order-item">
                    <div class="timeline-order-time">
                      <%= new Date(order.createdAt).toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit' }) %>
                    </div>
                    <div class="timeline-order-content">
                      <div class="timeline-order-header">
                        <h4 class="timeline-order-id"><%= t('manufacturer.orders.additional_labels.order_number_prefix') %><%= order.orderNumber || order._id.toString().slice(-8).toUpperCase() %></h4>
                        <span class="status-badge status-<%= order.status || 'pending' %>">
                          <%= order.status === 'pending' ? t('manufacturer.orders.additional_labels.status_pending_uz') : order.status === 'confirmed' ? t('manufacturer.orders.additional_labels.status_confirmed_uz') : order.status %>
                        </span>
                      </div>
                      <div class="timeline-order-details">
                        <p><strong><%= t('manufacturer.orders.additional_labels.customer_label') %></strong> <%= order.buyer?.companyName || order.buyer?.name || t('manufacturer.orders.additional_labels.na_value') %></p>
                        <p><strong><%= t('manufacturer.orders.additional_labels.amount_label') %></strong> $<%= (order.totalAmount || 0).toLocaleString() %></p>
                        <p><strong><%= t('manufacturer.orders.additional_labels.products_label') %></strong> <%= order.items?.length || 0 %> <%= t('manufacturer.orders.js_messages.pieces_short') %></p>
                      </div>
                      <div class="timeline-order-actions">
                        <button class="timeline-action-btn" data-action="view" data-order-id="<%= order._id %>">
                          <i class="fas fa-eye"></i>
                          <%= t('manufacturer.orders.additional_labels.view') %>
                        </button>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            </div>
          <% }); %>
        </div>
      </div>
      
    </div> <!-- <%= t('manufacturer.orders.additional_labels.end_products_container') %> -->

    <% } else { %>
      <!-- <%= t('manufacturer.orders.additional_labels.empty_state') %> -->
      <div class="orders-empty-state">
        <div class="empty-state-icon">
          <i class="fas fa-clipboard-list"></i>
        </div>
        <h3 class="empty-state-title"><%= t('manufacturer.orders.additional_labels.empty_title') %></h3>
        <p class="empty-state-description">
          <%= t('manufacturer.orders.additional_labels.empty_description') %>
        </p>
        <div class="empty-state-actions">
          <a href="/manufacturer/marketplace" class="orders-btn orders-btn-primary">
            <i class="fas fa-store"></i>
            <%= t('manufacturer.orders.additional_labels.marketplace_go') %>
          </a>
          <a href="/manufacturer/products" class="orders-btn orders-btn-secondary">
            <i class="fas fa-box"></i>
            <%= t('manufacturer.orders.additional_labels.view_products') %>
          </a>
        </div>
      </div>
    <% } %>

  </div>
</main>



<!-- <%= t('manufacturer.orders.additional_labels.status_change_modal') %> -->
<div class="modal-overlay" id="statusChangeModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title"><%= t('manufacturer.orders.additional_labels.modal_title') %></h3>
      <button class="modal-close" id="closeStatusModal">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="statusChangeForm">
        <div class="form-group">
          <label><%= t('manufacturer.orders.additional_labels.new_status_label') %></label>
          <select id="newStatusSelect" class="form-control" required>
            <option value=""><%= t('manufacturer.orders.additional_labels.select_status') %></option>
            <option value="pending"><%= t('manufacturer.orders.js_messages.status_pending') %></option>
            <option value="confirmed"><%= t('manufacturer.orders.js_messages.status_confirmed') %></option>
            <option value="processing"><%= t('manufacturer.orders.js_messages.status_processing') %></option>
            <option value="manufacturing"><%= t('manufacturer.orders.js_messages.status_manufacturing') %></option>
            <option value="ready_to_ship"><%= t('manufacturer.orders.js_messages.status_ready_to_ship') %></option>
            <option value="shipped"><%= t('manufacturer.orders.js_messages.status_shipped') %></option>
            <option value="delivered"><%= t('manufacturer.orders.js_messages.status_delivered') %></option>
            <option value="completed"><%= t('manufacturer.orders.js_messages.status_completed') %></option>
            <option value="cancelled"><%= t('manufacturer.orders.js_messages.status_cancelled') %></option>
          </select>
        </div>
        <div class="form-group">
          <label><%= t('manufacturer.orders.additional_labels.note_label') %></label>
          <textarea id="statusChangeNote" class="form-control" rows="3" placeholder="<%= t('manufacturer.orders.additional_labels.note_placeholder') %>"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="orders-btn orders-btn-secondary" id="cancelStatusChange"><%= t('manufacturer.orders.additional_labels.cancel') %></button>
          <button type="submit" class="orders-btn orders-btn-primary"><%= t('manufacturer.orders.additional_labels.change') %></button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- <%= t('manufacturer.orders.additional_labels.toast_container') %> -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11;">
  <!-- <%= t('manufacturer.orders.additional_labels.toasts_dynamic') %> -->
</div>

<!-- <%= t('manufacturer.orders.additional_labels.bootstrap_js') %> -->
<script src="/assets/js/bootstrap.bundle.min.js"></script>

<!-- <%= t('manufacturer.orders.additional_labels.dashboard_init') %> -->
<script src="/js/manufacturer/dashboard-init.js"></script>

<!-- <%= t('manufacturer.orders.additional_labels.real_data_script') %> -->
<script>
  // Load real orders statistics
  async function loadOrdersData() {
    try {
       
      const response = await fetch('/api/manufacturer/orders/stats', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getCookie('accessToken')}`
        },
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        const data = await response.json();
        
        // Update KPI values
        updateOrdersKPIs(data);
        
      } else {
        // <%= t('manufacturer.orders.additional_labels.use_fallback_data') %>
        updateOrdersKPIs({
          totalOrders: 0,
          activeOrders: 0,
          monthlyRevenue: 0,
          pendingOrders: 0
        });
      }
    } catch (error) {
      // <%= t('manufacturer.orders.additional_labels.use_fallback_data') %>
      updateOrdersKPIs({
        totalOrders: 0,
        activeOrders: 0,
        monthlyRevenue: 0,
        pendingOrders: 0
      });
    }
  }

  // Update orders KPIs with comprehensive real data
  function updateOrdersKPIs(data) {
    // Update Total Orders (includes ALL orders including cancelled)
    const totalOrdersElement = document.getElementById('totalOrdersValue');
    if (totalOrdersElement) {
      const totalOrders = data.data?.totalOrders || data.totalOrders || 0;
      totalOrdersElement.innerHTML = totalOrders.toLocaleString();
      
      // Add status breakdown tooltip
      if (data.data?.statusBreakdown) {
        const breakdown = data.data.statusBreakdown;
        const tooltipText = `
          Barcha buyurtmalar: ${totalOrders}
          • Faol: ${data.data.activeOrders || 0}
          • Bekor qilingan: ${breakdown.cancelled || 0}
          • Yakunlangan: ${(breakdown.completed || 0) + (breakdown.delivered || 0)}
        `;
        totalOrdersElement.title = tooltipText;
      }
    }
    
    // Update Active Orders (business-active orders)
    const activeOrdersElement = document.getElementById('activeOrdersValue');
    if (activeOrdersElement) {
      const activeOrders = data.data?.activeOrders || data.activeOrders || 0;
      activeOrdersElement.innerHTML = activeOrders.toLocaleString();
      
      // Add active orders breakdown
      if (data.data?.statusBreakdown) {
        const breakdown = data.data.statusBreakdown;
        const activeBreakdown = `
          Faol buyurtmalar: ${activeOrders}
          • Kutayotgan: ${breakdown.pending || 0}
          • Tasdiqlangan: ${breakdown.confirmed || 0}
          • Jarayonda: ${breakdown.processing || 0}
          • Ishlab chiqarilmoqda: ${breakdown.manufacturing || 0}
          • Jo'natishga tayyor: ${breakdown.readyToShip || 0}
          • Jo'natilgan: ${breakdown.shipped || 0}
        `;
        activeOrdersElement.title = activeBreakdown;
      }
    }
    
    // Update Monthly Revenue
    const monthlyRevenueElement = document.getElementById('monthlyRevenueValue');
    if (monthlyRevenueElement) {
      const revenue = data.data?.monthlyRevenue || data.monthlyRevenue || 0;
      monthlyRevenueElement.innerHTML = '<%= t("manufacturer.orders.additional_labels.currency_symbol") %>' + revenue.toLocaleString();
      
      // Add revenue breakdown
      if (data.data?.businessMetrics) {
        const metrics = data.data.businessMetrics;
        const revenueBreakdown = `
          Oylik daromad: $${revenue.toLocaleString()}
          • Faol daromad: $${(data.data.activeRevenue || 0).toLocaleString()}
          • Daromad samaradorligi: ${metrics.revenueEfficiency}%
        `;
        monthlyRevenueElement.title = revenueBreakdown;
      }
    }
    
    // Update Pending Orders
    const pendingOrdersElement = document.getElementById('pendingOrdersValue');
    if (pendingOrdersElement) {
      const pendingOrders = data.data?.statusBreakdown?.pending || data.pendingOrders || 0;
      pendingOrdersElement.innerHTML = pendingOrders.toLocaleString();
      
      // Add pending orders context
      if (data.data?.statusBreakdown) {
        const breakdown = data.data.statusBreakdown;
        const pendingContext = `
          Kutayotgan buyurtmalar: ${pendingOrders}
          • Tasdiqlash kutilmoqda
          • Jami faol: ${data.data.activeOrders || 0}
          • Bekor qilingan: ${breakdown.cancelled || 0}
        `;
        pendingOrdersElement.title = pendingContext;
      }
    }
    
    // Update orders count display in header/title
    updateOrdersCountDisplay(data);
  }
  
  // Update orders count display with comprehensive information
  function updateOrdersCountDisplay(data) {
    const totalOrders = data.data?.totalOrders || data.totalOrders || 0;
    const activeOrders = data.data?.activeOrders || data.activeOrders || 0;
    const cancelledOrders = data.data?.statusBreakdown?.cancelled || 0;
    
    // Update page title or header with comprehensive count
    const ordersCountElements = document.querySelectorAll('.orders-count-display, .orders-total-count');
    ordersCountElements.forEach(element => {
      if (totalOrders > 0) {
        element.innerHTML = `
          <span class="total-orders">${totalOrders} buyurtma</span>
          <span class="orders-breakdown">
            (${activeOrders} faol${cancelledOrders > 0 ? `, ${cancelledOrders} bekor qilingan` : ''})
          </span>
        `;
      } else {
        element.innerHTML = '0 buyurtma';
      }
    });
    
    // Update empty state message if needed
    if (totalOrders === 0) {
      const emptyState = document.querySelector('.orders-empty-state .empty-state-title');
      if (emptyState) {
        emptyState.textContent = 'Buyurtmalar topilmadi';
      }
    }
  }

  // Get cookie helper function
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  // Initialize orders page functionality
  document.addEventListener('DOMContentLoaded', function() {
   
    // Load real orders data
    loadOrdersData();
    
  });
</script>

<!-- <%= t('manufacturer.orders.additional_labels.i18n_init_script') %> -->
<script>
  // Initialize i18next translation system
  async function initializeTranslation() {
    try {
      // Get current language from cookies or default to 'uz'
      const currentLang = document.cookie
        .split('; ')
        .find(row => row.startsWith('i18next='))
        ?.split('=')[1] || 
        document.cookie
        .split('; ')
        .find(row => row.startsWith('selectedLanguage='))
        ?.split('=')[1] || 'uz';
      
      // Load translations from server
      const response = await fetch(`/api/language/${currentLang}`, {
        headers: { 'Accept': 'application/json' }
      });
      const result = response.ok ? await response.json() : {};
      const translations = result.data || {};
      
      await i18next
        .use(i18nextBrowserLanguageDetector)
        .init({
          fallbackLng: 'uz',
          debug: false,
          detection: {
            order: ['cookie', 'localStorage', 'navigator', 'htmlTag'],
            caches: ['cookie', 'localStorage']
          },
          resources: {
            [currentLang]: {
              translation: translations
            }
          }
        });
      
      // Set global translation function
      window.t = i18next.t.bind(i18next);
      
    } catch (error) {
      console.error('<%= t("manufacturer.orders.additional_labels.translation_init_failed") %>', error);
      // Fallback translation function
      window.t = function(key) {
        return key; // <%= t('manufacturer.orders.additional_labels.return_key_fallback') %>
      };
    }
  }
  
  // Initialize translation when page loads
  initializeTranslation();
</script>

<!-- <%= t('manufacturer.orders.additional_labels.i18next_system') %> -->
<script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>

<!-- <%= t('manufacturer.orders.additional_labels.header_management') %> -->
<script src="/js/manufacturer/manufacturer-header.js"></script>

<!-- <%= t('manufacturer.orders.additional_labels.orders_management_js') %> -->
<script src="/js/manufacturer/orders-management.js"></script>

</body>
</html>
