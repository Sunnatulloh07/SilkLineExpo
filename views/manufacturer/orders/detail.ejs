<%- include('../partials/header', { title: t('manufacturer.orders.detail.page_title'), lng: lng, user: user, t: t }) %>
<%- include('../partials/sidebar', { user: user, currentPage: 'orders', t: t }) %>

<!-- Enhanced CSS Imports - Professional Order Detail Page -->
<link rel="stylesheet" href="/css/products-management-redesign.css">
<link rel="stylesheet" href="/css/products-table-view.css">
<link rel="stylesheet" href="/css/orders-management.css">
<link rel="stylesheet" href="/css/order-detail.css">
<link rel="stylesheet" href="/css/order-comments.css">
<link rel="stylesheet" href="/css/manufacturer-cards.css">
<link rel="stylesheet" href="/css/manufacturer-dashboard.css">
<link rel="stylesheet" href="/css/manufacturer-theme.css">

<!-- ‚ú® PROFESSIONAL ORDER DETAIL DESIGN - DARK MODE COMPATIBLE ‚ú® -->
<style>
  /* NOW USING STANDARD VARIABLES FROM ORDERS PAGE - CONSISTENT THEMING */

  /* DISABLE ANIMATION CONFLICTS BUT KEEP STABLE LAYOUT */
  .order-detail-header,
  .order-detail-content,
  .animate-fade-in,
  .animate-slide-up {
    animation: none !important;
    opacity: 1 !important;
    transform: none !important;
    visibility: visible !important;
  }

  /* PROFESSIONAL ORDER DETAIL HEADER */
  .order-detail-header {
    background: var(--bg-elevated);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-lg);
    backdrop-filter: blur(10px);
    background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-secondary) 100%);
  }


  .breadcrumb-link {
    color: var(--text-muted);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    background: var(--bg-secondary);
    border: 1px solid var(--order-border-light);
  }

  .breadcrumb-link:hover {
    color: var(--color-primary);
    background: var(--color-primary);
    color: white;
    transform: translateY(-1px);
    box-shadow: var(--order-shadow-md);
  }

  .breadcrumb-separator {
    color: var(--text-muted);
    font-size: 0.75rem;
  }

  .breadcrumb-current {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.875rem;
  }

  .order-detail-title-section {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .order-detail-title {
    color: var(--text-primary);
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .order-detail-title i {
    color: var(--color-primary);
    font-size: 1.75rem;
  }

  .order-detail-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .order-detail-id {
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    font-size: 0.875rem;
    font-weight: 600;
  }

  .order-detail-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
  }

  /* KPI CARDS NOW USE STANDARD STAT-CARD CLASSES FROM ORDERS PAGE */

  /* MAIN CONTENT GRID */
  .order-main-grid {
    display: grid !important;
    grid-template-columns: 2fr 1fr !important;
    gap: 2rem !important;
    margin-bottom: 2rem !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  .order-main-left,
  .order-main-right {
    display: flex !important;
    flex-direction: column !important;
    gap: 1.5rem !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  /* PROFESSIONAL INFO CARDS */
  .info-card {
    background: var(--bg-elevated) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 16px !important;
    overflow: hidden !important;
    box-shadow: var(--order-shadow-md) !important;
    transition: all 0.3s ease !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
    animation: none !important;
    transform: none !important;
  }

  .info-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--color-primary);
  }

  .info-card-header {
    background: var(--bg-secondary) !important;
    border-bottom: 1px solid var(--border-color) !important;
    padding: 1.25rem !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
  }

  .info-card-title {
    color: var(--text-primary);
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .info-card-title i {
    color: var(--color-primary);
    font-size: 1rem;
  }

  .info-card-content {
    padding: 1.5rem !important;
    color: var(--text-secondary);
  }

  /* CUSTOMER PROFILE STYLING */
  .customer-profile {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
  }

  .customer-avatar-large {
    width: 64px;
    height: 64px;
    border-radius: 16px;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--order-primary-dark) 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    flex-shrink: 0;
  }

  .customer-details {
    flex: 1;
  }

  .customer-company {
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
  }

  .customer-contact-person {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin: 0 0 1rem 0;
  }

  .customer-contact-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .contact-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
  }

  .contact-item i {
    color: var(--text-muted);
    width: 16px;
    text-align: center;
  }

  /* MESSAGE AVATAR PLACEHOLDER */
  .message-avatar-placeholder {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--color-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  /* ORDER ITEMS SECTION STYLING */
  .order-items-section {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--order-shadow-md);
    margin-bottom: 2rem;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
    animation: none !important;
  }

  .products-table-header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .products-table-title {
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .products-table-title i {
    color: var(--color-primary);
    font-size: 1.125rem;
  }

  .items-count {
    color: var(--text-muted);
    font-weight: 500;
  }

  .products-table-wrapper {
    overflow-x: auto;
  }

  .products-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .products-table th {
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-weight: 600;
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.875rem;
  }

  .products-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--order-border-light);
    color: var(--text-secondary);
    vertical-align: top;
  }

  .products-table tr:hover {
    background: var(--bg-secondary);
  }

  .item-number {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: var(--color-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .product-info {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
  }

  .product-image {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
  }

  .product-thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-placeholder {
    width: 100%;
    height: 100%;
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
  }

  .product-title {
    color: var(--text-primary);
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    font-size: 0.875rem;
  }

  .product-description {
    color: var(--text-muted);
    font-size: 0.75rem;
    margin: 0;
    line-height: 1.4;
  }

  /* STATUS HISTORY TIMELINE */
  .status-history-section {
    background: var(--bg-elevated);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--order-shadow-md);
    margin-bottom: 2rem;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
    animation: none !important;
  }

  .history-header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    padding: 1.5rem;
  }

  .history-title {
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .history-title i {
    color: var(--color-primary);
    font-size: 1.125rem;
  }

  .timeline-container {
    padding: 2rem;
  }

  .timeline-item {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    position: relative;
  }

  .timeline-item:last-child {
    margin-bottom: 0;
  }

  .timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 20px;
    top: 48px;
    bottom: -2rem;
    width: 2px;
    background: var(--border-color);
  }

  .timeline-marker {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--color-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    flex-shrink: 0;
    position: relative;
    z-index: 1;
  }

  .timeline-content {
    flex: 1;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem;
  }

  .timeline-status {
    color: var(--text-primary);
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
  }

  .timeline-date {
    color: var(--text-muted);
    font-size: 0.75rem;
    font-weight: 500;
  }

  .timeline-user {
    color: var(--text-secondary);
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* NOTES SECTION */
  .notes-section {
    background: var(--bg-elevated);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--order-shadow-md);
    margin-bottom: 2rem;
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
    animation: none !important;
  }

  .notes-header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .notes-title {
    color: var(--text-primary);
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .notes-title i {
    color: var(--color-primary);
    font-size: 1.125rem;
  }

  .notes-container {
    padding: 2rem;
  }

  .note-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
  }

  .note-item:last-child {
    margin-bottom: 0;
  }

  .note-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .note-author {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .author-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--color-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .author-name {
    color: var(--text-primary);
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0;
  }

  .note-date {
    color: var(--text-muted);
    font-size: 0.75rem;
  }

  .note-content {
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .note-content p {
    margin: 0;
  }

  /* FORM ELEMENTS */
  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  .form-select,
  .form-input,
  .form-textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 0.875rem;
    transition: all 0.2s ease;
  }

  .form-select:focus,
  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  /* BUTTONS */
  .products-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    text-decoration: none;
  }

  .products-btn-primary {
    background: var(--color-primary);
    color: white;
  }

  .products-btn-primary:hover {
    background: var(--order-primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--order-shadow-md);
  }

  .products-btn-secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
  }

  .products-btn-secondary:hover {
    background: var(--border-color);
  }

  .products-btn-outline {
    background: transparent;
    color: var(--color-primary);
    border: 1px solid var(--color-primary);
  }

  .products-btn-outline:hover {
    background: var(--color-primary);
    color: white;
  }

  /* STATUS BADGES */
  .status-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .status-pending {
    background: rgba(251, 191, 36, 0.1);
    color: #f59e0b;
    border: 1px solid rgba(251, 191, 36, 0.2);
  }

  .status-confirmed {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.2);
  }

  .status-processing {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    border: 1px solid rgba(59, 130, 246, 0.2);
  }

  .status-manufacturing {
    background: rgba(168, 85, 247, 0.1);
    color: #a855f7;
    border: 1px solid rgba(168, 85, 247, 0.2);
  }

  .status-ready_to_ship {
    background: rgba(6, 182, 212, 0.1);
    color: #06b6d4;
    border: 1px solid rgba(6, 182, 212, 0.2);
  }

  .status-shipped {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  .status-delivered {
    background: rgba(34, 197, 94, 0.15);
    color: #16a34a;
    border: 1px solid rgba(34, 197, 94, 0.3);
  }

  .status-completed {
    background: rgba(34, 197, 94, 0.2);
    color: #15803d;
    border: 1px solid rgba(34, 197, 94, 0.4);
  }

  .status-cancelled {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.2);
  }

  /* PRIORITY BADGES */
  .priority-high {
    color: var(--order-error) !important;
  }

  .priority-medium {
    color: var(--order-warning) !important;
  }

  .priority-low {
    color: var(--order-success) !important;
  }

  /* PAYMENT STATUS */
  .payment-status {
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .payment-status.status-paid {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
  }

  .payment-status.status-pending {
    background: rgba(251, 191, 36, 0.1);
    color: #f59e0b;
  }

  .payment-status.status-failed {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }

  .payment-status.status-refunded {
    background: rgba(156, 163, 175, 0.1);
    color: #6b7280;
  }

  /* ITEM STATUS BADGES */
  .item-status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: capitalize;
  }

  .item-status-badge.status-pending {
    background: rgba(251, 191, 36, 0.1);
    color: #f59e0b;
  }

  .item-status-badge.status-confirmed {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
  }

  .item-status-badge.status-in_production {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
  }

  .item-status-badge.status-ready {
    background: rgba(6, 182, 212, 0.1);
    color: #06b6d4;
  }

  .item-status-badge.status-shipped {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
  }

  .item-status-badge.status-delivered {
    background: rgba(34, 197, 94, 0.15);
    color: #16a34a;
  }

  /* CATEGORY BADGE */
  .category-badge {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    border: 1px solid var(--border-color);
  }

  .category-badge i {
    font-size: 0.625rem;
  }

  /* SKU CODE */
  .sku-code {
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    border: 1px solid var(--border-color);
  }

  /* QUICK ACTION BUTTONS */
  .quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
  }


  .quick-action-btn:hover {
    background: var(--color-primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--order-shadow-md);
  }

  .quick-action-btn i {
    font-size: 1.25rem;
  }

  .quick-action-btn span {
    font-size: 0.75rem;
    font-weight: 600;
  }

  /* MODALS */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.hidden {
    display: none;
  }

  .modal-container {
    background: var(--bg-elevated);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    max-width: 500px;
    width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--order-shadow-xl);
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-secondary);
    border-radius: 16px 16px 0 0;
  }

  .modal-title {
    color: var(--text-primary);
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .modal-title i {
    color: var(--color-primary);
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.25rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s ease;
  }

  .modal-close:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

  .modal-content {
    padding: 1.5rem;
  }

  .modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    background: var(--bg-secondary);
    border-radius: 0 0 16px 16px;
  }

  /* EMPTY STATES */
  .empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-muted);
  }

  .empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .empty-state h4 {
    color: var(--text-secondary);
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
  }

  .empty-state p {
    margin: 0;
    font-size: 0.875rem;
  }

  .timeline-empty,
  .notes-empty {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
  }

  .timeline-empty i,
  .notes-empty i {
    font-size: 2rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .timeline-empty h4,
  .notes-empty h4 {
    color: var(--text-secondary);
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
  }

  .timeline-empty p,
  .notes-empty p {
    margin: 0;
    font-size: 0.875rem;
  }

  /* PRICE & QUANTITY STYLING */
  .quantity-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.125rem;
  }

  .quantity-value {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 1rem;
  }

  .quantity-unit {
    color: var(--text-muted);
    font-size: 0.75rem;
    font-weight: 500;
  }

  .price-info {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.125rem;
  }

  .unit-price {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.875rem;
  }

  .price-unit {
    color: var(--text-muted);
    font-size: 0.75rem;
    font-weight: 500;
  }

  .total-price {
    text-align: right;
  }

  .total-amount {
    color: var(--text-primary);
    font-weight: 700;
    font-size: 1rem;
  }

  /* ITEM ACTION BUTTONS */
  .item-actions {
    display: flex;
    gap: 0.375rem;
    justify-content: center;
  }

  .item-action-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: var(--bg-secondary);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.875rem;
  }

  .item-action-btn:hover {
    background: var(--color-primary);
    color: white;
    transform: translateY(-1px);
    box-shadow: var(--order-shadow-sm);
  }

  .item-action-btn.danger {
    color: var(--order-error);
    border-color: rgba(239, 68, 68, 0.2);
  }

  .item-action-btn.danger:hover {
    background: var(--order-error);
    color: white;
  }

  /* CARD ACTION BUTTONS */
  .card-actions {
    display: flex;
    gap: 0.5rem;
  }

  .card-action-btn {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: var(--bg-primary);
    color: var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.875rem;
  }

  .card-action-btn:hover {
    background: var(--color-primary);
    color: white;
    transform: translateY(-1px);
    box-shadow: var(--order-shadow-sm);
  }

  /* INFO GRID STYLING */
  .info-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .info-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .info-label {
    color: var(--text-muted);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .info-value {
    color: var(--text-primary);
    font-size: 0.875rem;
    font-weight: 600;
  }

  .order-number {
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    background: var(--bg-secondary);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    border: 1px solid var(--border-color);
  }

  .deadline-value {
    color: var(--order-warning);
    font-weight: 600;
  }

  .countdown-value {
    color: var(--order-info);
    font-weight: 600;
  }

  /* PAYMENT SUMMARY */
  .payment-summary {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .payment-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
  }

  .payment-row:not(:last-child) {
    border-bottom: 1px solid var(--order-border-light);
  }

  .payment-label {
    color: var(--text-muted);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .payment-value {
    color: var(--text-primary);
    font-size: 0.875rem;
    font-weight: 600;
    text-align: right;
  }

  .payment-row.total-row {
    border-top: 2px solid var(--border-color);
    padding-top: 1rem;
    margin-top: 0.5rem;
  }

  .total-amount {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
  }

  .total-amount small {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 500;
    margin-left: 0.25rem;
  }

  /* STATUS UPDATE SECTION */
  .status-current {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
  }

  .current-status-display {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .current-status-label {
    color: var(--text-secondary);
    font-size: 0.875rem;
    font-weight: 600;
  }

  .status-update-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .w-full {
    width: 100%;
  }

  /* PRIORITY BADGE */
  .priority-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .priority-badge.priority-high {
    background: rgba(239, 68, 68, 0.1);
    color: var(--order-error);
    border: 1px solid rgba(239, 68, 68, 0.2);
  }

  .priority-badge.priority-medium {
    background: rgba(251, 191, 36, 0.1);
    color: var(--order-warning);
    border: 1px solid rgba(251, 191, 36, 0.2);
  }

  .priority-badge.priority-low {
    background: rgba(34, 197, 94, 0.1);
    color: var(--order-success);
    border: 1px solid rgba(34, 197, 94, 0.2);
  }

  /* LOADING STATES */
  .loading-shimmer {
    background: linear-gradient(90deg, 
      var(--bg-secondary) 25%, 
      var(--border-color) 50%, 
      var(--bg-secondary) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
    height: 1em;
  }

  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  /* TOAST CONTAINER */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1100;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  /* RESPONSIVE DESIGN */
  @media (max-width: 1024px) {
    .order-main-grid {
      grid-template-columns: 1fr !important;
      gap: 1.5rem !important;
    }
    
    /* KPI cards now use standard grid classes */
    
    .order-detail-header {
      padding: 1.5rem;
    }
    
    .order-detail-title {
      font-size: 1.75rem;
    }
  }

  @media (max-width: 768px) {
    /* KPI cards responsive handled by grid utility classes */
    
    .order-detail-actions {
      flex-direction: column;
      width: 100%;
    }
    
    .order-detail-meta {
      flex-direction: column;
      align-items: flex-start;
    }

    .products-table-header {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }

    .timeline-container {
      padding: 1rem;
    }

    .notes-container {
      padding: 1rem;
    }
  }
</style>

<!-- Order Detail Variables for JavaScript -->
<script type="application/json" id="order-data"><%- JSON.stringify(order) %></script>
<script>
  
  // Load order data from JSON script tag
  try {
    const orderDataScript = document.getElementById('order-data');
    
    if (!orderDataScript) {
      throw new Error('Order data script element not found');
    }
    
    const rawData = orderDataScript.textContent;
    
    window.orderData = JSON.parse(rawData);
    window.currentOrderId = '<%= order._id %>';
 
  } catch (error) {
    console.error('‚ùå Error details:', error.message);
    window.orderData = {};
  }

</script>

<!-- Main Content -->
<main class="admin-main">
  <div class="admin-content">
    
         <!-- Order Detail Header -->
     <div class="order-detail-header">      
      <div class="order-detail-title-section">
        <h1 class="order-detail-title">
          <i class="fas fa-clipboard-list"></i>
          <%= t('manufacturer.orders.detail.header.title') %>
        </h1>
        <div class="order-detail-meta">
          <span class="order-detail-id">#<%= order.orderNumber || order._id.toString().slice(-8).toUpperCase() %></span>
          <span class="status-badge status-<%= order.status || 'pending' %>">
            <%= order.status === 'pending' ? 'üìã ' + t('manufacturer.orders.detail.timeline.status_labels.pending') :
                order.status === 'confirmed' ? '‚úÖ ' + t('manufacturer.orders.detail.timeline.status_labels.confirmed') :
                order.status === 'processing' ? '‚öôÔ∏è ' + t('manufacturer.orders.detail.timeline.status_labels.processing') :
                order.status === 'manufacturing' ? 'üè≠ ' + t('manufacturer.orders.detail.timeline.status_labels.manufacturing') :
                order.status === 'quality_check' ? 'üîç ' + t('manufacturer.orders.detail.timeline.status_labels.quality_check') :
                order.status === 'ready_to_ship' ? 'üì¶ ' + t('manufacturer.orders.detail.timeline.status_labels.ready_to_ship') :
                order.status === 'shipped' ? 'üöö ' + t('manufacturer.orders.detail.timeline.status_labels.shipped') :
                order.status === 'out_for_delivery' ? 'üèÉ‚Äç‚ôÇÔ∏è ' + t('manufacturer.orders.detail.timeline.status_labels.out_for_delivery') :
                order.status === 'delivered' ? 'üèÜ ' + t('manufacturer.orders.detail.timeline.status_labels.delivered') :
                order.status === 'completed' ? 'üíØ ' + t('manufacturer.orders.detail.timeline.status_labels.completed') :
                order.status === 'cancelled' ? '‚ùå ' + t('manufacturer.orders.detail.timeline.status_labels.cancelled') : '‚ùì ' + t('manufacturer.orders.detail.timeline.status_labels.unknown') %>
          </span>
        </div>
      </div>
      
      <div class="order-detail-actions">
        <button class="products-btn products-btn-outline" id="printOrderBtn">
          <i class="fas fa-print"></i>
          <%= t('manufacturer.orders.detail.actions.print') %>
        </button>
        <button class="products-btn products-btn-primary" id="contactCustomerBtn" data-order-id="<%= order._id %>">
          <i class="fas fa-comments"></i>
          <%= t('manufacturer.orders.detail.modals.communication.title') %>
        </button>
      </div>
    </div>

         <!-- Order Detail Content -->
     <div class="order-detail-content">
      

      <!-- Main Content Grid -->
      <div class="order-main-grid">
        
        <!-- Left Column -->
        <div class="order-main-left">
          
          <!-- Customer Information Card -->
          <div class="info-card customer-card">
            <div class="info-card-header">
              <h3 class="info-card-title">
                <i class="fas fa-building"></i>
                <%= t('manufacturer.orders.detail.customer_info.title') %>
              </h3>
              <div class="card-actions">
                <button class="card-action-btn" id="contactCustomerBtn" title="<%= t('manufacturer.orders.detail.tooltips.contact') %>">
                  <i class="fas fa-phone"></i>
                </button>
                <button class="card-action-btn" id="sendEmailBtn" title="<%= t('manufacturer.orders.detail.tooltips.send_email') %>">
                  <i class="fas fa-envelope"></i>
                </button>
              </div>
            </div>
            <div class="info-card-content">
              <div class="customer-profile">
                <div class="customer-avatar-large">
                  <% if (order.buyer?.companyLogo?.url) { %>
                    <img src="<%= order.buyer.companyLogo.url %>" alt="<%= order.buyer?.companyName || t('manufacturer.orders.detail.customer_info.logo_alt') %>" class="customer-logo">
                  <% } else { %>
                    <%= (order.buyer?.companyName || order.buyer?.name || t('manufacturer.orders.detail.customer_info.default_initial')).charAt(0).toUpperCase() %>
                  <% } %>
                </div>
                <div class="customer-details">
                  <h4 class="customer-company"><%= order.buyer?.companyName || t('manufacturer.orders.detail.customer_info.company_name') %></h4>
                  <p class="customer-contact-person"><%= order.buyer?.name || t('manufacturer.orders.detail.customer_info.contact_person') %></p>
                  
                  <div class="customer-contact-info">
                    <div class="contact-item">
                      <i class="fas fa-envelope"></i>
                      <span><%= order.buyer?.email || t('manufacturer.orders.detail.customer_info.email_placeholder') %></span>
                    </div>
                    <% if (order.buyer?.phone) { %>
                    <div class="contact-item">
                      <i class="fas fa-phone"></i>
                      <span><%= order.buyer.phone %></span>
                    </div>
                    <% } %>
                    <% if (order.buyer?.address) { %>
                    <div class="contact-item">
                      <i class="fas fa-map-marker-alt"></i>
                      <span><%= order.buyer.address %></span>
                    </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Order Information Card -->
          <div class="info-card order-info-card">
            <div class="info-card-header">
              <h3 class="info-card-title">
                <i class="fas fa-info-circle"></i>
                <%= t('manufacturer.orders.detail.order_info.title') %>
              </h3>
            </div>
            <div class="info-card-content">
              <div class="info-grid">
                <div class="info-row">
                  <div class="info-item">
                    <span class="info-label"><%= t('manufacturer.orders.detail.order_info.order_number') %></span>
                    <span class="info-value order-number" data-order-version="<%= order.__v || 0 %>">#<%= order.orderNumber || order._id.toString().slice(-8).toUpperCase() %></span>
                  </div>
                  <div class="info-item">
                    <span class="info-label"><%= t('manufacturer.orders.detail.order_info.type') %></span>
                    <span class="info-value"><%= order.type || t('manufacturer.orders.detail.order_info.type_default') %></span>
                  </div>
                </div>
                
                <div class="info-row">
                  <div class="info-item">
                    <span class="info-label"><%= t('manufacturer.orders.detail.order_info.created_date') %></span>
                    <span class="info-value"><%= new Date(order.createdAt).toLocaleDateString('uz-UZ') %></span>
                  </div>
                  <div class="info-item">
                    <span class="info-label"><%= t('manufacturer.orders.detail.order_info.created_time') %></span>
                    <span class="info-value"><%= new Date(order.createdAt).toLocaleTimeString('uz-UZ', {hour: '2-digit', minute: '2-digit'}) %></span>
                  </div>
                </div>
                
                <% if (order.specialInstructions) { %>
                <div class="info-row">
                  <div class="info-item full-width">
                    <span class="info-label"><%= t('manufacturer.orders.detail.order_info.special_instructions') %></span>
                    <span class="info-value special-instructions"><%= order.specialInstructions %></span>
                  </div>
                </div>
                <% } %>
                
                <% if (order.deadline) { %>
                <div class="info-row">
                  <div class="info-item">
                    <span class="info-label"><%= t('manufacturer.orders.detail.order_info.deadline') %></span>
                    <span class="info-value deadline-value"><%= new Date(order.deadline).toLocaleDateString('uz-UZ') %></span>
                  </div>
                  <div class="info-item">
                    <span class="info-label"><%= t('manufacturer.orders.detail.order_info.remaining_time') %></span>
                    <span class="info-value countdown-value">
                      <%= Math.ceil((new Date(order.deadline) - new Date()) / (1000 * 60 * 60 * 24)) %> <%= t('manufacturer.orders.detail.order_info.days') %>
                    </span>
                  </div>
                </div>
                <% } %>
                
                <div class="info-row">
                  <div class="info-item">
                    <span class="info-label"><%= t('manufacturer.orders.detail.priority.label') %></span>
                    <span class="info-value priority-badge priority-<%= order.priority || 'medium' %>">
                      <%= order.priority === 'high' ? t('manufacturer.orders.detail.priority.high') :
                          order.priority === 'medium' ? t('manufacturer.orders.detail.priority.medium') :
                          order.priority === 'low' ? t('manufacturer.orders.detail.priority.low') : t('manufacturer.orders.detail.priority.medium') %>
                    </span>
                  </div>
                  <div class="info-item">
                    <span class="info-label"><%= t('manufacturer.orders.detail.status_management.current_status_label') %></span>
                    <span class="info-value">
                      <span class="status-badge status-<%= order.status || 'pending' %>">
                        <%= order.status === 'pending' ? 'üìã ' + t('manufacturer.orders.detail.timeline.status_labels.pending') :
                            order.status === 'confirmed' ? '‚úÖ ' + t('manufacturer.orders.detail.timeline.status_labels.confirmed') :
                            order.status === 'processing' ? '‚öôÔ∏è ' + t('manufacturer.orders.detail.timeline.status_labels.processing') :
                            order.status === 'manufacturing' ? 'üè≠ ' + t('manufacturer.orders.detail.timeline.status_labels.manufacturing') :
                            order.status === 'quality_check' ? 'üîç ' + t('manufacturer.orders.detail.timeline.status_labels.quality_check') :
                            order.status === 'ready_to_ship' ? 'üì¶ ' + t('manufacturer.orders.detail.timeline.status_labels.ready_to_ship') :
                            order.status === 'shipped' ? 'üöö ' + t('manufacturer.orders.detail.timeline.status_labels.shipped') :
                            order.status === 'out_for_delivery' ? 'üèÉ‚Äç‚ôÇÔ∏è ' + t('manufacturer.orders.detail.timeline.status_labels.out_for_delivery') :
                            order.status === 'delivered' ? 'üèÜ ' + t('manufacturer.orders.detail.timeline.status_labels.delivered') :
                            order.status === 'completed' ? 'üíØ ' + t('manufacturer.orders.detail.timeline.status_labels.completed') :
                            order.status === 'cancelled' ? '‚ùå ' + t('manufacturer.orders.detail.timeline.status_labels.cancelled') : '‚ùì ' + t('manufacturer.orders.detail.timeline.status_labels.unknown') %>
                      </span>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Information Card -->
          <div class="info-card payment-info-card">
            <div class="info-card-header">
              <h3 class="info-card-title">
                <i class="fas fa-credit-card"></i>
                <%= t('manufacturer.orders.detail.payment.title') %>
              </h3>
            </div>
            <div class="info-card-content">
              <div class="payment-summary">
                <div class="payment-row">
                  <span class="payment-label"><%= t('manufacturer.orders.detail.order_info.payment_method') %>:</span>
                  <span class="payment-value"><%= order.paymentMethod || t('manufacturer.orders.detail.order_info.payment_method_default') %></span>
                </div>
                <div class="payment-row">
                  <span class="payment-label"><%= t('manufacturer.orders.detail.order_info.payment_status') %>:</span>
                  <span class="payment-value">
                    <span class="payment-status status-<%= order.paymentStatus || 'pending' %>">
                      <%= order.paymentStatus === 'paid' ? t('manufacturer.orders.detail.payment_status.paid') :
                          order.paymentStatus === 'pending' ? t('manufacturer.orders.detail.payment_status.pending') :
                          order.paymentStatus === 'failed' ? t('manufacturer.orders.detail.payment_status.failed') :
                          order.paymentStatus === 'refunded' ? t('manufacturer.orders.detail.payment_status.refunded') : t('manufacturer.orders.detail.payment_status.pending') %>
                    </span>
                  </span>
                </div>
                <div class="payment-row total-row">
                  <span class="payment-label"><%= t('manufacturer.orders.detail.order_info.total_amount') %>:</span>
                  <span class="payment-value total-amount">
                    $<%= (order.totalAmount || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                    <small><%= order.currency || t('manufacturer.orders.detail.order_info.currency_default') %></small>
                  </span>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Right Column -->
        <div class="order-main-right">
          
          <!-- Status Management Card -->
          <div class="info-card status-management-card">
            <div class="info-card-header">
              <h3 class="info-card-title">
                <i class="fas fa-tasks"></i>
                <%= t('manufacturer.orders.detail.status_management.title') %>
              </h3>
            </div>
            <div class="info-card-content">
              <div class="status-current">
                <div class="current-status-display">
                  <span class="current-status-label"><%= t('manufacturer.orders.detail.status_management.current_status_label') %></span>
                  <span class="status-badge status-<%= order.status || 'pending' %>">
                    <%= order.status === 'pending' ? t('manufacturer.orders.detail.timeline.status_labels.pending') :
                        order.status === 'confirmed' ? t('manufacturer.orders.detail.timeline.status_labels.confirmed') :
                        order.status === 'processing' ? t('manufacturer.orders.detail.timeline.status_labels.processing') :
                        order.status === 'manufacturing' ? t('manufacturer.orders.detail.timeline.status_labels.manufacturing') :
                        order.status === 'ready_to_ship' ? t('manufacturer.orders.detail.timeline.status_labels.ready_to_ship') :
                        order.status === 'shipped' ? t('manufacturer.orders.detail.timeline.status_labels.shipped') :
                        order.status === 'delivered' ? t('manufacturer.orders.detail.timeline.status_labels.delivered') :
                        order.status === 'completed' ? t('manufacturer.orders.detail.timeline.status_labels.completed') :
                        order.status === 'cancelled' ? t('manufacturer.orders.detail.timeline.status_labels.cancelled') : t('manufacturer.orders.detail.timeline.status_labels.unknown') %>
                  </span>
                </div>
              </div>
              
              <div class="status-update-section">
                <div class="form-group">
                  <label class="form-label"><%= t('manufacturer.orders.detail.status_management.change_status') %></label>
                  <select class="form-select status-select" id="orderStatusSelect" data-order-id="<%= order._id %>">
                    <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>
                      üìã <%= t('manufacturer.orders.detail.status_management.status_options.pending') %>
                    </option>
                    <option value="confirmed" <%= order.status === 'confirmed' ? 'selected' : '' %>>
                      ‚úÖ <%= t('manufacturer.orders.detail.status_management.status_options.confirmed') %>
                    </option>
                    <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>
                      ‚öôÔ∏è <%= t('manufacturer.orders.detail.status_management.status_options.processing') %>
                    </option>
                    <option value="manufacturing" <%= order.status === 'manufacturing' ? 'selected' : '' %>>
                      üè≠ <%= t('manufacturer.orders.detail.status_management.status_options.manufacturing') %>
                    </option>
                    <option value="quality_check" <%= order.status === 'quality_check' ? 'selected' : '' %>>
                      üîç <%= t('manufacturer.orders.detail.status_management.status_options.quality_check') %>
                    </option>
                    <option value="ready_to_ship" <%= order.status === 'ready_to_ship' ? 'selected' : '' %>>
                      üì¶ <%= t('manufacturer.orders.detail.status_management.status_options.ready_to_ship') %>
                    </option>
                    <option value="shipped" <%= order.status === 'shipped' ? 'selected' : '' %>>
                      üöö <%= t('manufacturer.orders.detail.status_management.status_options.shipped') %>
                    </option>
                    <option value="out_for_delivery" <%= order.status === 'out_for_delivery' ? 'selected' : '' %>>
                      üèÉ‚Äç‚ôÇÔ∏è <%= t('manufacturer.orders.detail.status_management.status_options.out_for_delivery') %>
                    </option>
                    <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>
                      üèÜ <%= t('manufacturer.orders.detail.status_management.status_options.delivered') %>
                    </option>
                    <option value="completed" <%= order.status === 'completed' ? 'selected' : '' %>>
                      üíØ <%= t('manufacturer.orders.detail.status_management.status_options.completed') %>
                    </option>
                    <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>
                      ‚ùå <%= t('manufacturer.orders.detail.status_management.status_options.cancelled') %>
                    </option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label"><%= t('manufacturer.orders.detail.status_management.status_note') %></label>
                  <textarea class="form-textarea" id="statusNote" rows="3" placeholder="<%= t('manufacturer.orders.detail.status_placeholder') %>"></textarea>
                </div>
                
                <div class="form-group">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="notifyCustomer" checked>
                    <label for="notifyCustomer" style="font-size: 0.875rem; margin: 0;"><%= t('manufacturer.orders.detail.status_management.notify_customer') %></label>
                  </div>
                </div>
                
                <button class="products-btn products-btn-primary w-full" id="updateStatusBtn" data-order-id="<%= order._id %>">
                  <i class="fas fa-sync-alt"></i>
                  <%= t('manufacturer.orders.detail.status_management.update_status') %>
                </button>
              </div>
            </div>
          </div>

          <!-- Quick Actions Card -->
          <div class="info-card quick-actions-card">
            <div class="info-card-header">
              <h3 class="info-card-title">
                <i class="fas fa-bolt"></i>
                <%= t('manufacturer.orders.detail.order_actions.title') %>
              </h3>
            </div>
            <div class="info-card-content">
              <div class="quick-actions-grid">
                <button class="quick-action-btn" id="addNoteBtn" data-order-id="<%= order._id %>">
                  <i class="fas fa-sticky-note"></i>
                  <span><%= t('manufacturer.orders.detail.order_actions.add_note') %></span>
                </button>
                
                <button class="quick-action-btn" id="contactCustomerBtn2">
                  <i class="fas fa-comments"></i>
                  <span><%= t('manufacturer.orders.detail.order_actions.contact_customer') %></span>
                </button>
                
                <button class="quick-action-btn" id="printOrderBtn2">
                  <i class="fas fa-print"></i>
                  <span><%= t('manufacturer.orders.detail.order_actions.print') %></span>
                </button>
                
                <!-- Simple Export Button -->
                <button class="quick-action-btn" id="exportOrderBtn" title="<%= t('manufacturer.orders.detail.tooltips.export_order') %>">
                  <i class="fas fa-download"></i>
                  <span><%= t('manufacturer.orders.detail.actions.export_pdf') %></span>
                </button>
                
                <button class="quick-action-btn" id="shareOrderBtn">
                  <i class="fas fa-share-alt"></i>
                  <span><%= t('manufacturer.orders.detail.actions.share') %></span>
                </button>
              </div>
            </div>
          </div>

        </div>

      </div>

      <!-- Order Items Section -->
      <div class="order-items-section">
        <div class="products-table-container">
          <div class="products-table-header">
            <h3 class="products-table-title">
              <i class="fas fa-boxes"></i>
                <%= t('manufacturer.orders.detail.order_products.title') %>
              <span class="items-count">(<%= order.items?.length || 0 %> <%= t('manufacturer.orders.detail.order_products.items_count') %>)</span>
            </h3>
            <div class="products-table-actions">
              <button class="products-btn products-btn-sm products-btn-outline" id="exportItemsBtn" title="<%= t('manufacturer.orders.detail.tooltips.export_items') %>">
                <i class="fas fa-download"></i>
                <%= t('manufacturer.orders.detail.actions.export_items') %>
              </button>
            </div>
          </div>
          
          <div class="products-table-wrapper">
            <table class="products-table order-items-table">
              <thead>
                <tr>
                  <th class="item-image-col">#</th>
                  <th class="item-product-col"><%= t('manufacturer.orders.detail.order_products.table.product') %></th>
                  <th class="item-sku-col"><%= t('manufacturer.orders.detail.order_products.table.sku') %></th>
                  <th class="item-category-col"><%= t('manufacturer.orders.detail.order_products.table.category') %></th>
                  <th class="item-quantity-col"><%= t('manufacturer.orders.detail.order_products.table.quantity') %></th>
                  <th class="item-price-col"><%= t('manufacturer.orders.detail.order_products.table.unit_price') %></th>
                  <th class="item-total-col"><%= t('manufacturer.orders.detail.order_products.table.total') %></th>
                  <th class="item-status-col"><%= t('manufacturer.orders.detail.order_products.table.status') %></th>
                </tr>
              </thead>
              <tbody>
                <% if (order.items && order.items.length > 0) { %>
                  <% order.items.forEach((item, index) => { %>
                    <tr class="item-row" data-item-id="<%= item._id %>" data-item-index="<%= index %>">
                      <td class="item-image-cell">
                        <div class="item-number">
                          <%= index + 1 %>
                        </div>
                      </td>
                      
                      <td class="item-product-cell">
                        <div class="product-info">
                          <div class="product-image">
                            <% 
                              let productImage = null;
                              if (item.product?.images) {
                                if (Array.isArray(item.product.images) && item.product.images.length > 0) {
                                  const firstImage = item.product.images[0];
                                  // Handle both object format {url: "..."} and string format
                                  if (typeof firstImage === 'object' && firstImage.url) {
                                    productImage = firstImage.url;
                                  } else if (typeof firstImage === 'string') {
                                    productImage = firstImage;
                                  }
                                } else if (typeof item.product.images === 'string') {
                                  productImage = item.product.images;
                                }
                              }
                              

                            %>
                            <% if (productImage) { %>
                              <img 
                                src="<%= productImage %>" 
                                alt="<%= item.product?.title || item.product?.name || t('manufacturer.orders.detail.products.alt_text') %>" 
                                class="product-thumbnail"
                                loading="lazy"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
                              >
                              <div class="product-placeholder" style="display: none;">
                                <i class="fas fa-image"></i>
                              </div>
                            <% } else { %>
                              <div class="product-placeholder">
                                <i class="fas fa-image"></i>
                              </div>
                            <% } %>
                          </div>
                          <div class="product-details">
                            <h4 class="product-title" title="<%= item.product?.title || item.product?.name || t('manufacturer.orders.detail.order_products.table.product_name_default') %>">
                              <%= (item.product?.title || item.product?.name || t('manufacturer.orders.detail.order_products.table.product_name_default')).length > 40 ? 
                                  (item.product?.title || item.product?.name || t('manufacturer.orders.detail.order_products.table.product_name_default')).substring(0, 40) + '...' :
                                  (item.product?.title || item.product?.name || t('manufacturer.orders.detail.order_products.table.product_name_default')) %>
                            </h4>
                            <p class="product-description">
                              <%= item.product?.description ? 
                                  (item.product.description.length > 60 ? item.product.description.substring(0, 60) + '...' : item.product.description) :
                                  t('manufacturer.orders.detail.order_products.table.product_description_default') %>
                            </p>
                          </div>
                        </div>
                      </td>
                      
                      <td class="item-sku-cell">
                        <span class="sku-code"><%= item.product?.sku || 'N/A' %></span>
                      </td>
                      
                      <td class="item-category-cell">
                        <span class="category-badge">
                          <i class="fas fa-tag"></i>
                          <%= item.product?.category?.name || item.product?.category || 'Kategoriya' %>
                        </span>
                      </td>
                      
                      <td class="item-quantity-cell">
                        <div class="quantity-info">
                          <span class="quantity-value"><%= item.quantity || 0 %></span>
                          <span class="quantity-unit"><%= t('manufacturer.orders.detail.order_products.table.quantity_unit') %></span>
                        </div>
                      </td>
                      
                      <td class="item-price-cell">
                        <div class="price-info">
                          <span class="unit-price">$<%= (item.price || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                          <span class="price-unit">/ <%= t('manufacturer.orders.detail.order_products.table.quantity_unit') %></span>
                        </div>
                      </td>
                      
                      <td class="item-total-cell">
                        <div class="total-price">
                          <span class="total-amount">$<%= ((item.price || 0) * (item.quantity || 0)).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                        </div>
                      </td>
                      
                      <td class="item-status-cell">
                        <span class="item-status-badge status-<%= item.status || 'pending' %>">
                          <%= item.status === 'pending' ? t('manufacturer.orders.detail.timeline.status_labels.pending') :
                              item.status === 'confirmed' ? t('manufacturer.orders.detail.timeline.status_labels.confirmed') :
                              item.status === 'in_production' ? t('manufacturer.orders.detail.item_status.in_production') :
                              item.status === 'ready' ? t('manufacturer.orders.detail.item_status.ready') :
                              item.status === 'shipped' ? t('manufacturer.orders.detail.timeline.status_labels.shipped') :
                              item.status === 'delivered' ? t('manufacturer.orders.detail.timeline.status_labels.delivered') : t('manufacturer.orders.detail.timeline.status_labels.pending') %>
                        </span>
                      </td>
                      

                    </tr>
                  <% }); %>
                <% } else { %>
                  <tr class="empty-row">
                    <td colspan="8" class="empty-cell">
                      <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h4><%= t('manufacturer.orders.detail.products.table.empty_state.title') %></h4>
                        <p><%= t('manufacturer.orders.detail.products.table.empty_state.description') %></p>
                      </div>
                    </td>
                  </tr>
                <% } %>
              </tbody>
              
              <!-- Order Summary Row -->
              <tfoot>
                <tr class="summary-row">
                  <td colspan="6" class="summary-label-cell">
                    <strong><%= t('manufacturer.orders.detail.order_products.table.summary') %></strong>
                  </td>
                  <td class="summary-total-cell">
                    <strong class="total-summary">
                      $<%= (order.totalAmount || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                    </strong>
                  </td>
                  <td class="summary-meta-cell">
                    <span class="currency-info"><%= order.currency || t('manufacturer.orders.detail.order_info.currency_default') %></span>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- Status History Timeline -->
      <div class="status-history-section">
        <div class="history-header">
          <h3 class="history-title">
            <i class="fas fa-history"></i>
                <%= t('manufacturer.orders.detail.timeline.title') %>
          </h3>
        </div>
        
        <div class="timeline-container">
          <% if (order.statusHistory && order.statusHistory.length > 0) { %>
            <% order.statusHistory.forEach((history, index) => { %>
              <div class="timeline-item">
                <div class="timeline-marker status-<%= history.status %>">
                  <i class="fas fa-circle"></i>
                </div>
                <div class="timeline-content">
                  <div class="timeline-header">
                    <h4 class="timeline-status">
                      <%= history.status === 'pending' ? t('manufacturer.orders.detail.timeline.status_labels.pending') :
                          history.status === 'confirmed' ? t('manufacturer.orders.detail.timeline.status_labels.confirmed') :
                          history.status === 'processing' ? t('manufacturer.orders.detail.timeline.status_labels.processing') :
                          history.status === 'manufacturing' ? t('manufacturer.orders.detail.timeline.status_labels.manufacturing') :
                          history.status === 'ready_to_ship' ? t('manufacturer.orders.detail.timeline.status_labels.ready_to_ship') :
                          history.status === 'shipped' ? t('manufacturer.orders.detail.timeline.status_labels.shipped') :
                          history.status === 'delivered' ? t('manufacturer.orders.detail.timeline.status_labels.delivered') :
                          history.status === 'completed' ? t('manufacturer.orders.detail.timeline.status_labels.completed') :
                          history.status === 'cancelled' ? t('manufacturer.orders.detail.timeline.status_labels.cancelled') : t('manufacturer.orders.detail.timeline.status_labels.unknown') %>
                    </h4>
                    <span class="timeline-date">
                      <%= new Date(history.timestamp).toLocaleString('uz-UZ') %>
                    </span>
                  </div>
                  <div class="timeline-meta">
                    <span class="timeline-user">
                      <i class="fas fa-user"></i>
                      <%= history.updatedBy?.name || history.updatedBy?.companyName || t('manufacturer.orders.detail.timeline.system_default') %>
                      <% if (history.updatedBy?.companyName && history.updatedBy?.companyName !== history.updatedBy?.name) { %>
                        <span class="company-name">(<%= history.updatedBy.companyName %>)</span>
                      <% } %>
                    </span>
                    <% if (history.note || history.notes) { %>
                      <p class="timeline-note"><%= history.note || history.notes %></p>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }); %>
          <% } else { %>
            <div class="timeline-empty">
              <i class="fas fa-clock"></i>
              <p><%= t('manufacturer.orders.detail.timeline.empty_state') %></p>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Communication Modal -->
    <div class="modal-overlay hidden" id="communicationModal">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-comments"></i>
            <%= t('manufacturer.orders.detail.modals.communication.title') %>
          </h3>
          <button class="modal-close" id="closeCommunicationModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-content">
          <form id="communicationForm">
            <div class="form-group">
              <label class="form-label"><%= t('manufacturer.orders.detail.modals.communication.message_type') %></label>
              <select class="form-select" id="messageType">
                <option value="status_update"><%= t('manufacturer.orders.detail.modals.communication.message_types.status_update') %></option>
                <option value="question"><%= t('manufacturer.orders.detail.modals.communication.message_types.question') %></option>
                <option value="information"><%= t('manufacturer.orders.detail.modals.communication.message_types.information') %></option>
                <option value="delay_notice"><%= t('manufacturer.orders.detail.modals.communication.message_types.delay_notice') %></option>
                <option value="quality_update"><%= t('manufacturer.orders.detail.modals.communication.message_types.quality_update') %></option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label"><%= t('manufacturer.orders.detail.modals.communication.subject') %></label>
              <input type="text" class="form-input" id="messageSubject" placeholder="<%= t('manufacturer.orders.detail.modals.communication.placeholders.subject') %>">
            </div>
            <div class="form-group">
              <label class="form-label"><%= t('manufacturer.orders.detail.modals.communication.content') %></label>
              <textarea class="form-textarea" id="messageContent" rows="6" placeholder="<%= t('manufacturer.orders.detail.modals.communication.placeholders.content') %>"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="products-btn products-btn-secondary" id="cancelCommunication"><%= t('manufacturer.orders.detail.modals.communication.actions.cancel') %></button>
          <button class="products-btn products-btn-primary" id="sendMessage">
            <i class="fas fa-paper-plane"></i>
            <%= t('manufacturer.orders.detail.modals.communication.actions.send') %>
          </button>
        </div>
      </div>
    </div>

    <!-- Add Note Modal - Marketplace Style (Working Pattern) -->
    <div class="modal-overlay" id="addNoteModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="noteModalTitle">
            <i class="fas fa-sticky-note"></i>
            <span id="noteModalTitleText"><%= t('manufacturer.orders.detail.modals.add_note.title') %></span>
          </h3>
          <button class="modal-close" id="closeNoteModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="noteForm">
            <!-- Hidden field for edit mode -->
            <input type="hidden" id="editingCommentId" value="">
            <!-- Comment Type Selection -->
            <div class="form-group">
              <label class="form-label"><%= t('manufacturer.orders.detail.comments.form.comment_type') %></label>
              <select class="form-select" id="commentType">
                <option value="general"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.general') %></option>
                <option value="status_update"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.status_update') %></option>
                <option value="quality_note"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.quality_note') %></option>
                <option value="delivery_note"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.delivery_note') %></option>
                <option value="payment_note"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.payment_note') %></option>
                <option value="internal_note"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.internal_note') %></option>
                <option value="customer_note"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.customer_note') %></option>
              </select>
            </div>

            <!-- Visibility Selection -->
            <div class="form-group">
              <label class="form-label"><%= t('manufacturer.orders.detail.comments.form.visibility') %></label>
              <select class="form-select" id="commentVisibility">
                <option value="public"><%= t('manufacturer.orders.detail.modals.add_note.visibility_options.public') %></option>
                <option value="internal"><%= t('manufacturer.orders.detail.modals.add_note.visibility_options.internal') %></option>
                <option value="customer"><%= t('manufacturer.orders.detail.modals.add_note.visibility_options.customer') %></option>
              </select>
            </div>

            <!-- Priority Selection -->
            <div class="form-group">
              <label class="form-label"><%= t('manufacturer.orders.detail.comments.form.priority') %></label>
              <select class="form-select" id="commentPriority">
                <option value="normal"><%= t('manufacturer.orders.detail.modals.add_note.priority_options.normal') %></option>
                <option value="low"><%= t('manufacturer.orders.detail.modals.add_note.priority_options.low') %></option>
                <option value="high"><%= t('manufacturer.orders.detail.modals.add_note.priority_options.high') %></option>
                <option value="urgent"><%= t('manufacturer.orders.detail.modals.add_note.priority_options.urgent') %></option>
              </select>
            </div>

            <!-- Comment Content -->
            <div class="form-group">
              <label class="form-label"><%= t('manufacturer.orders.detail.comments.form.content') %> <span class="text-danger">*</span></label>
              <textarea 
                class="form-textarea" 
                id="noteContent" 
                rows="6" 
                placeholder="<%= t('manufacturer.orders.detail.comments.form.content_placeholder') %>"
                maxlength="2000"
                required
              ></textarea>
              <small class="form-help">
                <span id="charCount">0</span>/2000 <%= t('manufacturer.orders.detail.comments.form.characters') %>
              </small>
            </div>

            <!-- Additional Options -->
            <div class="form-group">
              <div class="custom-checkbox-wrapper" style="margin-top: 1rem;">
                <label class="custom-checkbox">
                  <input type="checkbox" id="notifyCustomer" name="notifyCustomer">
                  <span class="checkmark"></span>
                  <span class="checkbox-label">
                    <i class="fas fa-bell" style="margin-right: 0.25rem; color: #007bff;"></i>
                    <%= t('manufacturer.orders.detail.modals.add_note.actions.notify_customer') %>
                  </span>
                </label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="products-btn products-btn-secondary" id="cancelNote" type="button">
            <i class="fas fa-times"></i>
            <%= t('manufacturer.orders.detail.modals.add_note.actions.cancel') %>
          </button>
          <button class="products-btn products-btn-primary" id="saveNote" type="submit">
            <i class="fas fa-save" id="saveNoteIcon"></i>
            <span class="btn-text" id="saveNoteText"><%= t('manufacturer.orders.detail.comments.form.save') %></span>
            <span class="btn-loading hidden">
              <i class="fas fa-spinner fa-spin"></i>
              <span id="saveLoadingText"><%= t('manufacturer.orders.detail.comments.form.saving') %></span>
            </span>
          </button>
        </div>
      </div>
    </div>

    <!-- Comments Display Section -->
    <div class="order-comments-section" id="orderCommentsSection">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-comments"></i>
          <%= t('manufacturer.orders.detail.comments.title') %> <span class="comments-count" id="commentsCount">(0)</span>
        </h3>
        <button class="products-btn products-btn-outline products-btn-sm" id="refreshCommentsBtn">
          <i class="fas fa-sync-alt"></i>
          <%= t('manufacturer.orders.detail.comments.actions.refresh') %>
        </button>
      </div>
      
      <div class="comments-filters">
        <select class="filter-select" id="filterByType">
          <option value=""><%= t('manufacturer.orders.detail.comments.filters.all_types') %></option>
          <option value="general"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.general') %></option>
          <option value="status_update"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.status_update') %></option>
          <option value="quality_note"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.quality_note') %></option>
          <option value="delivery_note"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.delivery_note') %></option>
          <option value="payment_note"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.payment_note') %></option>
          <option value="internal_note"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.internal_note') %></option>
          <option value="customer_note"><%= t('manufacturer.orders.detail.modals.add_note.comment_types.customer_note') %></option>
        </select>
        
        <select class="filter-select" id="filterByPriority">
          <option value=""><%= t('manufacturer.orders.detail.comments.filters.all_priority') %></option>
          <option value="urgent"><%= t('manufacturer.orders.detail.modals.add_note.priority_options.urgent') %></option>
          <option value="high"><%= t('manufacturer.orders.detail.modals.add_note.priority_options.high') %></option>
          <option value="normal"><%= t('manufacturer.orders.detail.modals.add_note.priority_options.normal') %></option>
          <option value="low"><%= t('manufacturer.orders.detail.modals.add_note.priority_options.low') %></option>
        </select>
      </div>

      <div class="comments-list" id="commentsList">
        <div class="loading-state" id="commentsLoading">
          <i class="fas fa-spinner fa-spin"></i>
          <%= t('manufacturer.orders.detail.comments.loading') %>
        </div>
        <div class="empty-state hidden" id="commentsEmpty">
          <i class="fas fa-comment-slash"></i>
          <p><%= t('manufacturer.orders.detail.comments.empty_state') %></p>
          <button class="products-btn products-btn-primary" id="addFirstComment">
            <i class="fas fa-plus"></i>
            <%= t('manufacturer.orders.detail.comments.add_first') %>
          </button>
        </div>
      </div>

      <div class="comments-pagination hidden" id="commentsPagination">
        <button class="products-btn products-btn-outline" id="loadMoreComments">
          <i class="fas fa-chevron-down"></i>
          <%= t('manufacturer.orders.detail.comments.actions.load_more') %>
        </button>
      </div>
    </div>

  </div>
</main>

<!-- Toast Notification Container -->
<div id="toast-container" class="toast-container"></div>

<!-- Marketplace Style Modal CSS -->
<style>
/* MARKETPLACE STYLE MODAL - WORKING PATTERN FROM PRODUCT PAGE */
.modal-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  background: rgba(0, 0, 0, 0.8) !important;
  backdrop-filter: blur(5px) !important;
  z-index: 999999 !important;
  display: none !important;
  align-items: center !important;
  justify-content: center !important;
  opacity: 0 !important;
  transition: all 0.3s ease !important;
}

.modal-overlay.active {
  display: flex !important;
  opacity: 1 !important;
}

.modal-overlay .modal-content {
  background: white;
  border-radius: 12px;
  width: 95%;
  max-width: 600px;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  transform: translateY(20px);
  transition: all 0.3s ease;
  position: relative;
}

.modal-overlay.active .modal-content {
  transform: translateY(0);
}

.modal-overlay .modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-overlay .modal-title {
  font-size: 20px;
  font-weight: 600;
  color: #111827;
  margin: 0;
}

.modal-overlay .modal-close {
  background: none;
  border: none;
  font-size: 20px;
  color: #6b7280;
  cursor: pointer;
  padding: 8px;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.modal-overlay .modal-close:hover {
  background: #f3f4f6;
  color: #374151;
}

.modal-overlay .modal-body {
  padding: 24px;
  max-height: 70vh;
  overflow-y: auto;
  overflow-x: hidden;
}

/* Professional Custom Checkbox */
.custom-checkbox {
  position: relative;
  display: flex;
  align-items: center;
  cursor: pointer;
  font-size: 14px;
  user-select: none;
  padding: 8px 0;
}

.custom-checkbox input[type="checkbox"] {
  position: absolute;
  opacity: 0;
  cursor: pointer;
  height: 0;
  width: 0;
}

.custom-checkbox .checkmark {
  position: relative;
  height: 20px;
  width: 20px;
  background-color: #fff;
  border: 2px solid #ddd;
  border-radius: 4px;
  margin-right: 12px;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.custom-checkbox:hover input ~ .checkmark {
  border-color: #007bff;
  background-color: #f8f9fa;
}

.custom-checkbox input:checked ~ .checkmark {
  background-color: #007bff;
  border-color: #007bff;
}

.custom-checkbox .checkmark:after {
  content: "";
  position: absolute;
  display: none;
  left: 6px;
  top: 2px;
  width: 6px;
  height: 10px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.custom-checkbox input:checked ~ .checkmark:after {
  display: block;
}

.custom-checkbox .checkbox-label {
  flex: 1;
  color: #333;
}

.custom-checkbox input:checked ~ .checkbox-label {
  color: #007bff;
  font-weight: 500;
}
</style>

<!-- Professional Unified Header Management -->
<script src="/js/manufacturer/manufacturer-header.js"></script>

<!-- Enhanced JavaScript -->
<script src="/js/manufacturer/toast-system.js"></script>
<script src="/js/manufacturer/modal-system.js"></script>
  <!-- Pass user data to frontend -->
  <script>
    window.currentUser = {
      userId: '<%= user?._id || user?.userId || "" %>',
      userType: '<%= user?.userType || "user" %>',
      role: '<%= user?.role || "" %>',
      companyId: '<%= user?.companyId || "" %>',
      companyName: '<%= user?.companyName || "" %>',
      name: '<%= user?.name || "" %>'
    };
  </script>
  
  <script src="/js/manufacturer/order-detail.js"></script>
  <script src="/js/manufacturer/order-comments.js"></script>

<%- include('../partials/footer') %>