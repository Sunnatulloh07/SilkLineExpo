<%- include('../partials/header', { title: title, lng: lng, user: user, t: t }) %>
<%- include('../partials/sidebar', { user: user, currentPage: 'products', t: t }) %>

<!-- Enhanced CSS Imports - Marketplace Style -->
<link rel="stylesheet" href="/css/products-management-redesign.css">
  <link rel="stylesheet" href="/css/products-table-view.css">
  <link rel="stylesheet" href="/css/products-card-view.css">
  <link rel="stylesheet" href="/css/products-marketplace-enhancements.css">
  <link rel="stylesheet" href="/css/manufacturer-cards.css">
  <link rel="stylesheet" href="/css/manufacturer-theme.css">
  <link rel="stylesheet" href="/css/toast-notifications.css">
  <link rel="stylesheet" href="/css/modal-system.css">

<!-- Main Content -->
<main class="admin-main">
  <div class="admin-content">
    
    <!-- Marketplace-Style Products Header -->
    <div class="products-header animate-fade-in">
      <div class="products-header-content">
        <div class="products-title-section">
          <h1 class="products-main-title">
            <i class="fas fa-store-alt"></i>
            <%= t('manufacturer.products.pageTitle') %>
          </h1>
          <p class="products-subtitle"><%= t('manufacturer.products.pageSubtitle') %></p>
        </div>
        <div class="products-header-actions">
          <button class="products-btn products-btn-primary" id="addProductBtn">
            <i class="fas fa-plus"></i>
            <%= t('manufacturer.products.actions.addProduct') %>
          </button>
          <button class="products-btn products-btn-outline" id="bulkActionsBtn">
            <i class="fas fa-tasks"></i>
            <%= t('manufacturer.products.actions.bulkActions') %>
          </button>
          <button class="products-btn products-btn-secondary" id="exportProductsBtn">
            <i class="fas fa-download"></i>
            <%= t('manufacturer.products.actions.export') %>
          </button>
        </div>
      </div>
    </div>

    <!-- Enhanced B2B KPI Cards - Dashboard Style (4 Cards) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-lg mb-lg">
      
      <!-- Total Products -->
      <div class="stat-card primary animate-fade-in" data-kpi="totalProducts">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.products.kpiCards.totalProducts') %></h3>
          <div class="stat-icon primary">
            <i class="fas fa-boxes"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="totalProductsValue">
            <span class="loading-placeholder">...</span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend"><%= t('manufacturer.products.kpiCards.allProducts') %></span>
        </div>
      </div>

      <!-- Active Products -->
      <div class="stat-card success animate-fade-in" data-kpi="activeProducts">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.products.kpiCards.activeProducts') %></h3>
          <div class="stat-icon success">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="activeProductsValue">
            <span class="loading-placeholder">...</span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend"><%= t('manufacturer.products.kpiCards.availableForSale') %></span>
        </div>
      </div>

      <!-- Marketplace Products -->
      <div class="stat-card info animate-fade-in" data-kpi="marketplaceProducts">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.products.kpiCards.marketplaceProducts') %></h3>
          <div class="stat-icon info">
            <i class="fas fa-store-alt"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="marketplaceProductsValue">
            <span class="loading-placeholder">...</span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend"><%= t('manufacturer.products.kpiCards.publicSales') %></span>
        </div>
      </div>

      <!-- Draft Products -->
      <div class="stat-card warning animate-fade-in" data-kpi="draftProducts">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.products.kpiCards.draftProducts') %></h3>
          <div class="stat-icon warning">
            <i class="fas fa-edit"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="draftProductsValue">
            <span class="loading-placeholder">...</span>
          </span>
        </div>
        <div class="stat-change neutral">
          <i class="fas fa-arrow-right stat-change-icon"></i>
          <span class="metric-trend"><%= t('manufacturer.products.kpiCards.inPreparation') %></span>
        </div>
      </div>

    </div>

    <!-- Professional Filters Container -->
    <div class="products-filters-container">
      <div class="products-filters-header">
        <h3 class="products-filters-title">
          <i class="fas fa-filter"></i>
          <%= t('manufacturer.products.filters.title') %>
        </h3>
      </div>
      <div class="products-filters-body">
        <form id="filtersForm" class="products-filters-form">
          
          <!-- Search Input -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.products.filters.search') %></label>
            <div class="products-search-wrapper">
              <i class="fas fa-search products-search-icon"></i>
              <input 
                type="text" 
                id="searchInput" 
                name="search" 
                placeholder="<%= t('manufacturer.products.filters.searchPlaceholder') %>"
                value="<%= filters.search || '' %>"
                class="products-form-input search"
              >
            </div>
          </div>

          <!-- Status Filter -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.products.filters.status') %></label>
            <select name="status" id="statusFilter" class="products-form-select">
              <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>><%= t('manufacturer.products.filters.allStatuses') %></option>
              <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>><%= t('manufacturer.products.filters.active') %></option>
              <option value="draft" <%= filters.status === 'draft' ? 'selected' : '' %>><%= t('manufacturer.products.filters.draft') %></option>
              <option value="inactive" <%= filters.status === 'inactive' ? 'selected' : '' %>><%= t('manufacturer.products.filters.inactive') %></option>
              <option value="discontinued" <%= filters.status === 'discontinued' ? 'selected' : '' %>><%= t('manufacturer.products.filters.discontinued') %></option>
            </select>
          </div>

          <!-- Category Filter -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.products.filters.category') %></label>
            <select name="category" id="categoryFilter" class="products-form-select">
              <option value="all"><%= t('manufacturer.products.filters.allCategories') %></option>
              <% if (categories && categories.length > 0) { %>
                <% categories.forEach(category => { %>
                  <option value="<%= category._id %>" <%= filters.category && filters.category.toString() === category._id.toString() ? 'selected' : '' %>>
                    <%= category.name %>
                  </option>
                <% }) %>
              <% } %>
            </select>
          </div>

                      <!-- Marketplace Status -->
            <div class="products-filter-group">
              <label class="products-filter-label"><%= t('manufacturer.products.filters.marketplace') %></label>
              <select name="marketplace" id="marketplaceFilter" class="products-form-select">
                <option value="all" <%= filters.marketplaceStatus === 'all' ? 'selected' : '' %>><%= t('manufacturer.products.filters.all') %></option>
                <option value="published" <%= filters.marketplaceStatus === 'published' ? 'selected' : '' %>><%= t('manufacturer.products.filters.published') %></option>
                <option value="unpublished" <%= filters.marketplaceStatus === 'unpublished' ? 'selected' : '' %>><%= t('manufacturer.products.filters.unpublished') %></option>
              </select>
            </div>

          <!-- Sort Options -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.products.filters.sortBy') %></label>
            <select name="sortBy" id="sortFilter" class="products-form-select">
              <option value="createdAt" <%= filters.sortBy === 'createdAt' ? 'selected' : '' %>><%= t('manufacturer.products.filters.createdAt') %></option>
              <option value="name" <%= filters.sortBy === 'name' ? 'selected' : '' %>><%= t('manufacturer.products.filters.name') %></option>
              <option value="analytics.views" <%= filters.sortBy === 'analytics.views' ? 'selected' : '' %>><%= t('manufacturer.products.filters.views') %></option>
              <option value="analytics.orders" <%= filters.sortBy === 'analytics.orders' ? 'selected' : '' %>><%= t('manufacturer.products.filters.orders') %></option>
              <option value="inventory.availableStock" <%= filters.sortBy === 'inventory.availableStock' ? 'selected' : '' %>><%= t('manufacturer.products.filters.inventory') %></option>
            </select>
          </div>

          <!-- Sort Order -->
          <div class="products-filter-group">
            <label class="products-filter-label"><%= t('manufacturer.products.filters.sortOrder') %></label>
            <select name="sortOrder" id="sortOrderFilter" class="products-form-select">
              <option value="desc" <%= filters.sortOrder === 'desc' ? 'selected' : '' %>><%= t('manufacturer.products.filters.sortOrderDesc') %></option>
              <option value="asc" <%= filters.sortOrder === 'asc' ? 'selected' : '' %>><%= t('manufacturer.products.filters.sortOrderAsc') %></option>
            </select>
          </div>
          
          <div class="products-filters-submit">
            <button type="submit" class="products-btn products-btn-primary" id="searchFiltersBtn">
              <i class="fas fa-search"></i>
              <%= t('manufacturer.products.filters.search') %>
            </button>
            <button type="button" class="products-btn products-btn-secondary" id="clearFiltersBtn">
              <i class="fas fa-times"></i>
              <%= t('manufacturer.products.filters.reset') %>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Main Products Container -->
    <div class="products-main-container">
      <div class="products-content-header">
        <h3 class="products-content-title">
          <i class="fas fa-box-open"></i>
          <%= t('manufacturer.products.productsList') %>
          <% if (pagination && pagination.totalItems) { %>
            <span class="products-count"><%= pagination.totalItems %> ta</span>
          <% } %>
        </h3>
        <div class="products-content-actions">
          <div class="products-view-toggle">
            <button class="products-view-btn" data-view="card" title="<%= t('manufacturer.products.viewToggle.card') %>">
              <i class="fas fa-th"></i>
              <span><%= t('manufacturer.products.viewToggle.cards') %></span>
            </button>
            <button class="products-view-btn active" data-view="table" title="<%= t('manufacturer.products.viewToggle.table') %>">
              <i class="fas fa-list"></i>
              <span><%= t('manufacturer.products.viewToggle.table') %></span>
            </button>
          </div>
          <button class="products-btn products-btn-sm products-btn-secondary" id="refreshProductsBtn">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </div>
      
      <% if (products && products.length > 0) { %>
        
        <!-- CARD VIEW -->
        <div class="products-view-container hidden" id="cardView">
          <div class="products-cards-grid">
            <% products.forEach((product, index) => { %>
              <div class="product-card card-fade-in" data-product-id="<%= product._id %>" data-animation-delay="<%= (index % 6) * 0.1 %>">
                
                <!-- Card Selection Checkbox -->
                <input type="checkbox" class="card-select-checkbox" data-product-id="<%= product._id %>">
                
                <!-- Product Image -->
                <div class="card-image-section">
                  <div class="card-product-image">
                    <% if (product.images && product.images.length > 0) { %>
                      <img 
                        src="<%= product.images[0].url %>" 
                        alt="<%= product.name %>"
                        class="card-product-img"
                        loading="lazy"
                        onerror="this.src='/images/placeholder-product.png'"
                      >
                    <% } else { %>
                      <div class="card-image-placeholder">
                        <i class="fas fa-image"></i>
                        <span><%= t('manufacturer.products.imagePlaceholder') %></span>
                      </div>
                    <% } %>
                  </div>
                  
                  <!-- Status Badges -->
                  <div class="card-badges">
                    <span class="card-status-badge status-<%= product.status %>">
                      <%= product.status === 'active' ? t('manufacturer.products.status.active') : 
                          product.status === 'draft' ? t('manufacturer.products.status.draft') : 
                          product.status === 'inactive' ? t('manufacturer.products.status.inactive') : t('manufacturer.products.status.discontinued') %>
                    </span>
                    <% if (product.visibility === 'public') { %>
                      <span class="card-marketplace-badge published">
                        <i class="fas fa-globe"></i>
                        <%= t('manufacturer.products.marketplace.published') %>
                      </span>
                    <% } %>
                    <% if (product.lowStock) { %>
                      <span class="card-stock-badge low-stock">
                        <i class="fas fa-exclamation-triangle"></i>
                        <%= t('manufacturer.products.stock.low') %>
                      </span>
                    <% } %>
                  </div>
                </div>

                <!-- Product Info -->
                <div class="card-product-info">
                  <div class="card-product-header">
                    <h3 class="card-product-title" title="<%= product.name %>">
                      <%= product.name %>
                    </h3>
                    <div class="card-product-id">ID: <%= product._id.toString().slice(-8).toUpperCase() %></div>
                  </div>

                  <div class="card-product-category">
                    <i class="fas fa-tag"></i>
                    <%= product.category ? product.category.name : t('manufacturer.products.noCategory') %>
                  </div>

                  <div class="card-product-description">
                    <%= product.shortDescription || (product.description ? product.description.substring(0, 100) + '...' : t('manufacturer.products.noDescription')) %>
                  </div>

                  <!-- Product Metrics -->
                  <div class="card-product-metrics">
                    <div class="card-metric-item">
                      <i class="fas fa-eye card-metric-icon"></i>
                      <span class="card-metric-value"><%= product.analytics?.views || 0 %></span>
                    </div>
                    <div class="card-metric-item">
                      <i class="fas fa-envelope card-metric-icon"></i>
                      <span class="card-metric-value"><%= product.analytics?.inquiries || 0 %></span>
                    </div>
                    <div class="card-metric-item">
                      <i class="fas fa-shopping-cart card-metric-icon"></i>
                      <span class="card-metric-value"><%= product.analytics?.orders || 0 %></span>
                    </div>
                    <div class="card-metric-item">
                      <i class="fas fa-warehouse card-metric-icon"></i>
                      <span class="card-metric-value"><%= product.inventory?.availableStock || 0 %></span>
                    </div>
                  </div>

                  <!-- Pricing Info -->
                  <div class="card-product-pricing">
                    <div class="card-price-main">
                      <span class="card-price-amount">
                        <%= (product.pricing?.basePrice || 0).toFixed(2) %> 
                        <% 
                          const currency = product.pricing?.currency || 'UZS';
                          const currencyText = currency === 'UZS' ? 'UZS' : 
                                              currency === 'USD' ? 'USD' : 
                                              currency === 'EUR' ? 'EUR' : 
                                              currency === 'CNY' ? 'CNY' : 
                                              currency === 'KZT' ? 'KZT' : currency;
                        %>
                        <%= currencyText %>
                      </span>
                      <span class="card-price-unit">
                        <% 
                          const unit = product.inventory?.unit || 'pieces';
                          const unitText = unit === 'pieces' ? 'dona' : 
                                         unit === 'kg' ? 'kg' : 
                                         unit === 'tons' ? 'tonna' : 
                                         unit === 'liters' ? 'litr' : 
                                         unit === 'meters' ? 'metr' : 
                                         unit === 'boxes' ? 'quti' : 
                                         unit === 'pallets' ? 'pallet' : unit;
                        %>
                        /<%= unitText %>
                      </span>
                    </div>
                    <div class="card-price-moq">
                      <%= t('manufacturer.products.minOrder') %>: <%= product.pricing?.minimumOrderQuantity || 1 %> 
                      <% 
                        const moqUnit = product.inventory?.unit || 'pieces';
                        const moqUnitText = moqUnit === 'pieces' ? 'dona' : 
                                           moqUnit === 'kg' ? 'kg' : 
                                           moqUnit === 'tons' ? 'tonna' : 
                                           moqUnit === 'liters' ? 'litr' : 
                                           moqUnit === 'meters' ? 'metr' : 
                                           moqUnit === 'boxes' ? 'quti' : 
                                           moqUnit === 'pallets' ? 'pallet' : moqUnit;
                      %>
                      <%= moqUnitText %>
                    </div>
                  </div>
                </div>

                <!-- Product Actions -->
                <div class="card-product-actions">
                  <div class="card-primary-actions">
                    <button class="card-action-btn btn-primary" data-action="edit" data-product-id="<%= product._id %>">
                      <i class="fas fa-edit"></i>
                      <span><%= t('manufacturer.products.actions.edit') %></span>
                    </button>
                    <button class="card-action-btn btn-secondary" data-action="analytics" data-product-id="<%= product._id %>">
                      <i class="fas fa-chart-line"></i>
                      <span><%= t('manufacturer.products.actions.analytics') %></span>
                    </button>
                  </div>
                  
                  <div class="card-secondary-actions">
                    <% if (product.visibility === 'public') { %>
                      <button class="card-marketplace-toggle unpublish" data-action="unpublish" data-product-id="<%= product._id %>">
                        <i class="fas fa-eye-slash"></i>
                        <span><%= t('manufacturer.products.actions.unpublish') %></span>
                      </button>
                    <% } else { %>
                      <button class="card-marketplace-toggle publish" data-action="publish" data-product-id="<%= product._id %>">
                        <i class="fas fa-globe"></i>
                        <span><%= t('manufacturer.products.actions.publish') %></span>
                      </button>
                    <% } %>
                    
                    <div class="card-more-actions">
                      <button class="card-more-toggle" data-product-id="<%= product._id %>">
                        <i class="fas fa-ellipsis-h"></i>
                      </button>
                      <div class="card-more-menu hidden">
                        <button class="card-more-item" data-action="duplicate" data-product-id="<%= product._id %>">
                          <i class="fas fa-copy"></i>
                          <%= t('manufacturer.products.actions.duplicate') %>
                        </button>
                        <button class="card-more-item" data-action="archive" data-product-id="<%= product._id %>">
                          <i class="fas fa-archive"></i>
                          <%= t('manufacturer.products.actions.archive') %>
                        </button>
                        <button class="card-more-item danger" data-action="delete" data-product-id="<%= product._id %>">
                          <i class="fas fa-trash"></i>
                          <%= t('manufacturer.products.actions.delete') %>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            <% }) %>
          </div>
        </div>

        <!-- TABLE VIEW -->
        <div class="products-view-container" id="tableView">
          <div class="products-table-container">
            <div class="products-table-header">
              <h3 class="products-table-title">
                <i class="fas fa-table"></i>
                <%= t('manufacturer.products.productsList') %>
              </h3>
              <div class="products-table-actions">
                        <button class="products-btn products-btn-sm products-btn-outline" id="selectAllProductsBtn">
          <i class="fas fa-check-square"></i>
          <%= t('manufacturer.products.actions.selectAll') %>
        </button>
                <button class="products-btn products-btn-sm products-btn-secondary" id="exportTableBtn">
                  <i class="fas fa-file-excel"></i>
                  <%= t('manufacturer.products.actions.export') %>
                </button>
              </div>
            </div>
            <div class="products-table-wrapper">
              <table class="products-table">
                <thead>
                  <tr>
                    <th class="table-cell-select">
                      <input type="checkbox" class="table-checkbox" id="selectAllCheckbox">
                    </th>
                    <th class="sortable" data-sort="name"><%= t('manufacturer.products.filters.name') %></th>
                    <th class="sortable" data-sort="status"><%= t('manufacturer.products.filters.status') %></th>
                    <th class="sortable" data-sort="category"><%= t('manufacturer.products.filters.category') %></th>
                    <th class="sortable" data-sort="pricing.basePrice"><%= t('manufacturer.products.filters.price') %></th>
                    <th class="sortable" data-sort="inventory.availableStock"><%= t('manufacturer.products.filters.inventory') %></th>
                    <th class="sortable" data-sort="analytics.views"><%= t('manufacturer.products.filters.views') %></th>
                    <th><%= t('manufacturer.products.filters.marketplace') %></th>  
                    <th><%= t('manufacturer.products.actions.actions') %></th>
                  </tr>
                </thead>
                <tbody>
                  <% products.forEach((product, index) => { %>
                    <tr data-product-id="<%= product._id %>">
                      <td>
                        <input type="checkbox" class="table-checkbox" data-product-id="<%= product._id %>">
                      </td>
                      <td>
                        <div class="table-product-info">
                          <div class="table-product-image">
                            <% if (product.images && product.images.length > 0) { %>
                              <img 
                                src="<%= product.images[0].url %>" 
                                alt="<%= product.name %>"
                                loading="lazy"
                                onerror="this.src='/images/placeholder-product.png'"
                              >
                            <% } else { %>
                              <i class="fas fa-image table-product-placeholder"></i>
                            <% } %>
                          </div>
                          <div class="table-product-details">
                            <h4 class="table-product-name"><%= product.name %></h4>
                            <span class="table-product-id">ID: <%= product._id.toString().slice(-8).toUpperCase() %></span>
                          </div>
                        </div>
                      </td>
                      <td>
                        <span class="table-status-badge status-<%= product.status %>">
                          <%= product.status === 'active' ? t('manufacturer.products.status.active') : 
                              product.status === 'draft' ? t('manufacturer.products.status.draft') : 
                              product.status === 'inactive' ? t('manufacturer.products.status.inactive') : t('manufacturer.products.status.discontinued') %>
                        </span>
                      </td>
                      <td>
                        <div class="table-category">
                          <i class="fas fa-tag"></i>
                          <%= product.category ? product.category.name : t('manufacturer.products.filters.noCategory') %>
                        </div>
                      </td>
                      <td>
                        <div class="table-price">
                          <span class="table-price-main">
                            <%= (product.pricing?.basePrice || 0).toFixed(2) %> 
                            <% 
                              const currency = product.pricing?.currency || 'UZS';
                              const currencyText = currency === 'UZS' ? 'UZS' : 
                                                  currency === 'USD' ? 'USD' : 
                                                  currency === 'EUR' ? 'EUR' : 
                                                  currency === 'CNY' ? 'CNY' : 
                                                  currency === 'KZT' ? 'KZT' : currency;
                            %>
                            <%= currencyText %>
                          </span>
                          <span class="table-price-unit">
                            <% 
                              const unit = product.inventory?.unit || 'pieces';
                              const unitText = unit === 'pieces' ? 'dona' : 
                                             unit === 'kg' ? 'kg' : 
                                             unit === 'tons' ? 'tonna' : 
                                             unit === 'liters' ? 'litr' : 
                                             unit === 'meters' ? 'metr' : 
                                             unit === 'boxes' ? 'quti' : 
                                             unit === 'pallets' ? 'pallet' : unit;
                            %>
                            /<%= unitText %>
                          </span>
                        </div>
                      </td>
                      <td>
                        <div class="table-stock">
                          <span class="table-stock-amount"><%= product.inventory?.availableStock || 0 %></span>
                          <span class="table-stock-level <%= product.lowStock ? 'low' : 'high' %>">
                            <%= product.lowStock ? t('manufacturer.products.stock.low') : t('manufacturer.products.stock.high') %>
                          </span>
                        </div>
                      </td>
                      <td>
                        <div class="table-metrics">
                          <div class="table-metric">
                            <span class="table-metric-value"><%= product.analytics?.views || 0 %></span>
                            <span class="table-metric-label"><%= t('manufacturer.products.filters.views') %></span>
                          </div>
                          <div class="table-metric">
                            <span class="table-metric-value"><%= product.analytics?.orders || 0 %></span>
                            <span class="table-metric-label"><%= t('manufacturer.products.filters.orders') %></span>
                          </div>
                        </div>
                      </td>
                      <td>
                        <% if (product.visibility === 'public') { %>
                          <span class="table-marketplace-badge published">
                            <i class="fas fa-check"></i>
                            <%= t('manufacturer.products.marketplace.published') %>
                          </span>
                        <% } else { %>
                          <span class="table-marketplace-badge unpublished">
                            <i class="fas fa-times"></i>
                            <%= t('manufacturer.products.marketplace.unpublished') %>
                          </span>
                        <% } %>
                      </td>
                      <td>
                        <div class="table-actions">
                          <button class="table-action-btn info" data-action="view" data-product-id="<%= product._id %>" title="<%= t('manufacturer.products.actions.view') %>">
                            <i class="fas fa-eye"></i>
                          </button>
                          <button class="table-action-btn primary" data-action="edit" data-product-id="<%= product._id %>" title="<%= t('manufacturer.products.actions.edit') %>">
                            <i class="fas fa-edit"></i>
                          </button>
                          <div class="table-more-actions">
                            <button class="table-action-btn dropdown-toggle" data-dropdown-trigger="<%= product._id %>" title="<%= t('manufacturer.products.actions.moreActions') %>">
                              <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="table-more-menu" data-dropdown-menu="<%= product._id %>">
                              <!-- Marketplace Actions -->
                              <% if (product.visibility === 'public') { %>
                                <button class="table-more-item warning" data-action="unpublish" data-product-id="<%= product._id %>">
                                  <i class="fas fa-eye-slash"></i>
                                  <%= t('manufacturer.products.actions.unpublish') %>
                                </button>
                              <% } else { %>
                                <% if (product.status === 'active') { %>
                                  <button class="table-more-item success" data-action="publish" data-product-id="<%= product._id %>">
                                    <i class="fas fa-globe"></i>
                                    <%= t('manufacturer.products.actions.publish') %>
                                  </button>
                                <% } else { %>
                                  <button class="table-more-item" data-action="publish" data-product-id="<%= product._id %>">
                                    <i class="fas fa-globe"></i>
                                    <%= t('manufacturer.products.actions.publish') %>
                                    <small class="text-muted">(avtomatik faollashtiriladi)</small>
                                  </button>
                                <% } %>
                              <% } %>
                              <div class="dropdown-divider"></div>
                              <!-- Other Actions -->
                              <button class="table-more-item" data-action="analytics" data-product-id="<%= product._id %>">
                                <i class="fas fa-chart-line"></i>
                                <%= t('manufacturer.products.actions.analytics') %>
                              </button>
                              <button class="table-more-item" data-action="duplicate" data-product-id="<%= product._id %>">
                                <i class="fas fa-copy"></i>
                                <%= t('manufacturer.products.actions.duplicate') %>
                              </button>
                              <button class="table-more-item" data-action="status-change" data-product-id="<%= product._id %>">
                                <i class="fas fa-toggle-on"></i>
                                <%= t('manufacturer.products.actions.statusChange') %>
                              </button>
                              <button class="table-more-item" data-action="archive" data-product-id="<%= product._id %>">
                                <i class="fas fa-archive"></i>
                                <%= t('manufacturer.products.actions.archive') %>
                              </button>
                              <div class="dropdown-divider"></div>
                              <button class="table-more-item danger" data-action="delete" data-product-id="<%= product._id %>">
                                <i class="fas fa-trash"></i>
                                <%= t('manufacturer.products.actions.delete') %>
                              </button>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <div class="table-pagination">
              <div class="table-pagination-info">
                <% 
                  const itemsPerPage = pagination.itemsPerPage || pagination.limit || 12;
                  const startItem = ((pagination.currentPage || 1) - 1) * itemsPerPage + 1;
                  const endItem = Math.min((pagination.currentPage || 1) * itemsPerPage, pagination.totalItems || 0);
                  const totalItems = pagination.totalItems || 0;
                  
                  // Smart display logic
                  let displayText;
                  if (totalItems === 0) {
                    displayText = t('manufacturer.products.pagination.noItems');
                  } else if (startItem === endItem) {
                    // Single item case: "1 dan 1 ta element"
                    displayText = `${startItem} dan ${totalItems} ta ${t('manufacturer.products.pagination.items')}`;
                  } else {
                    // Multiple items case: "1-12 dan 25 ta element"
                    displayText = `${startItem}-${endItem} dan ${totalItems} ta ${t('manufacturer.products.pagination.items')}`;
                  }
                %>
                <span><%= displayText %></span>
              </div>
              <div class="table-pagination-controls">
                <% 
                  const currentPage = pagination.currentPage || 1;
                  const totalPages = pagination.totalPages || 1;
                  const hasPrev = pagination.hasPrev || currentPage > 1;
                  const hasNext = pagination.hasNext || currentPage < totalPages;
                  
                  // Build query string helper
                  function buildQueryString(filters) {
                    const queryParams = [];
                    Object.keys(filters || {}).forEach(key => {
                      if (filters[key] && filters[key] !== 'all' && filters[key] !== '') {
                        queryParams.push(`${key}=${encodeURIComponent(filters[key])}`);
                      }
                    });
                    return queryParams.length > 0 ? '&' + queryParams.join('&') : '';
                  }
                  
                  const queryString = buildQueryString(filters);
                %>
                
                <% if (hasPrev) { %>
                  <a href="?page=<%= currentPage - 1 %><%= queryString %>" class="table-pagination-btn" title="<%= t('manufacturer.products.pagination.previous') %>">
                    <i class="fas fa-chevron-left"></i>
                  </a>
                <% } else { %>
                  <span class="table-pagination-btn disabled">
                    <i class="fas fa-chevron-left"></i>
                  </span>
                <% } %>
                
                <% 
                  // Smart pagination: show first page, last page, current page and 2 pages around it
                  const startPage = Math.max(1, currentPage - 2);
                  const endPage = Math.min(totalPages, currentPage + 2);
                  
                  // Always show first page if not in range
                  if (startPage > 1) { %>
                    <a href="?page=1<%= queryString %>" class="table-pagination-btn">1</a>
                    <% if (startPage > 2) { %>
                      <span class="table-pagination-ellipsis">...</span>
                    <% } %>
                  <% }
                  
                  // Show pages in range
                  for (let i = startPage; i <= endPage; i++) { %>
                    <a href="?page=<%= i %><%= queryString %>" 
                       class="table-pagination-btn <%= i === currentPage ? 'active' : '' %>">
                      <%= i %>
                    </a>
                  <% }
                  
                  // Always show last page if not in range
                  if (endPage < totalPages) { %>
                    <% if (endPage < totalPages - 1) { %>
                      <span class="table-pagination-ellipsis">...</span>
                    <% } %>
                    <a href="?page=<%= totalPages %><%= queryString %>" class="table-pagination-btn"><%= totalPages %></a>
                  <% } %>

                <% if (hasNext) { %>
                  <a href="?page=<%= currentPage + 1 %><%= queryString %>" class="table-pagination-btn" title="<%= t('manufacturer.products.pagination.next') %>">
                    <i class="fas fa-chevron-right"></i>
                  </a>
                <% } else { %>
                  <span class="table-pagination-btn disabled">
                    <i class="fas fa-chevron-right"></i>
                  </span>
                <% } %>
              </div>
            </div>
          </div>
        </div>

      <% } else { %>
        <!-- Empty State -->
        <div class="table-empty">
          <div class="table-empty-icon">
            <i class="fas fa-box-open"></i>
          </div>
          <h3 class="table-empty-title"><%= t('manufacturer.products.productsNotFound') %></h3>
          <p class="table-empty-description">
            <% if (filters.search || filters.status !== 'all' || filters.category !== 'all' || filters.marketplaceStatus !== 'all') { %>
              <%= t('manufacturer.products.productsNotFound.filter') %>
            <% } else { %>
              <%= t('manufacturer.products.productsNotFound.noProducts') %>
            <% } %>
          </p>
          <div class="table-empty-actions">
            <% if (filters.search || filters.status !== 'all' || filters.category !== 'all' || filters.marketplaceStatus !== 'all') { %>
              <button class="products-btn products-btn-outline" id="clearAllFiltersBtn">
                <i class="fas fa-filter"></i>
                <%= t('manufacturer.products.filters.reset') %>
              </button>
            <% } %>
            <button class="products-btn products-btn-primary" id="addFirstProductBtn">
              <i class="fas fa-plus"></i>
              <%= t('manufacturer.products.actions.addFirstProduct') %>
            </button>
          </div>
        </div>
      <% } %>
      
    </div>

  </div>
</main>

<!-- Bulk Actions Modal -->
<div class="modal-overlay hidden" id="bulkActionsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title"><%= t('manufacturer.products.actions.bulkActions') %></h2>
      <button class="modal-close" data-modal="bulkActionsModal">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="bulk-actions-list">
        <button class="bulk-action-item" data-action="publish-selected">
          <i class="fas fa-globe"></i>
          <div class="action-info">
            <h4><%= t('manufacturer.products.actions.publish') %></h4>
            <p><%= t('manufacturer.products.actions.publishDescription') %></p>
          </div>
        </button>
        <button class="bulk-action-item" data-action="unpublish-selected">
          <i class="fas fa-eye-slash"></i>
          <div class="action-info">
            <h4><%= t('manufacturer.products.actions.unpublish') %></h4>
            <p><%= t('manufacturer.products.actions.unpublishDescription') %></p>
          </div>
        </button>
        <button class="bulk-action-item" data-action="activate-selected">
          <i class="fas fa-play"></i>
          <div class="action-info">
            <h4><%= t('manufacturer.products.actions.activate') %></h4>
            <p><%= t('manufacturer.products.actions.activateDescription') %></p>
          </div>
        </button>
        <button class="bulk-action-item" data-action="deactivate-selected">
          <i class="fas fa-pause"></i>
          <div class="action-info">
            <h4><%= t('manufacturer.products.actions.deactivate') %></h4>
            <p><%= t('manufacturer.products.actions.deactivateDescription') %></p>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Success/Error Messages -->
<div class="toast-container" id="toastContainer"></div>

<!-- Server Data for JavaScript -->
<script type="application/json" id="products-data">
<%- JSON.stringify({
  products: products || [],
  pagination: pagination || {},
  filters: filters || {},
  stats: productStats || {},
  user: {
    id: user._id || '',
    name: user.name || 'Manufacturer',
    permissions: user.permissions || []
  }
}) %>
</script>

<!-- Dashboard Initialization - Theme & Core Functions -->
<script src="/js/manufacturer/dashboard-init.js"></script>

<!-- MARKETPLACE STYLE MODAL - SIMPLE AND WORKING -->
<div class="modal-overlay" id="productDetailsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title"><%= t('manufacturer.products.modal.productDetails') %></h2>
      <button class="modal-close" id="closeProductModal">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="productDetailsContent">
              <!-- <%= t('manufacturer.products.modal.dynamicContent') %> -->
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <p><%= t('manufacturer.products.modal.loading') %></p>
      </div>
    </div>
  </div>
</div>

<!-- Product Delete Confirmation Modal -->
<div class="modal fade" id="deleteProductModal" tabindex="-1" role="dialog" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteProductModalLabel">
          <i class="fas fa-trash-alt"></i>
          <%= t('manufacturer.products.modal.deleteProduct') %>
        </h5>
        <button type="button" class="btn-close btn-close-white" onclick="hideModal('deleteProductModal')" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong><%= t('manufacturer.products.modal.attention') %></strong> <%= t('manufacturer.products.modal.deleteProductDescription') %>
        </div>
        <p><%= t('manufacturer.products.modal.deleteProductQuestion') %></p>
        <div class="product-delete-info" id="deleteProductInfo">
          <!-- Product info will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideModal('deleteProductModal')">
          <i class="fas fa-times"></i>
          <%= t('manufacturer.products.modal.cancel') %>
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="fas fa-trash-alt"></i>
          <%= t('manufacturer.products.modal.delete') %>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Status Change Modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" role="dialog" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statusChangeModalLabel">
          <i class="fas fa-toggle-on"></i>
          <%= t('manufacturer.products.modal.statusChange') %>
        </h5>
        <button type="button" class="btn-close" onclick="hideModal('statusChangeModal')" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="statusChangeForm">
          <div class="mb-3">
            <label for="newStatus" class="form-label"><%= t('manufacturer.products.modal.newStatus') %>:</label>
            <select class="form-select" id="newStatus" name="status" required>
              <option value=""><%= t('manufacturer.products.modal.statusSelect') %></option>
              <option value="active">‚úÖ <%= t('manufacturer.products.status.active') %></option>
              <option value="inactive">‚è∏Ô∏è <%= t('manufacturer.products.status.inactive') %></option>
              <option value="draft">üìù <%= t('manufacturer.products.status.draft') %></option>
              <option value="archived">üì¶ <%= t('manufacturer.products.status.archived') %></option>
            </select>
          </div>
          <div class="mb-3">
            <label for="statusReason" class="form-label"><%= t('manufacturer.products.modal.statusReason') %>:</label>
            <textarea class="form-control" id="statusReason" name="reason" rows="3" placeholder="<%= t('manufacturer.products.modal.statusReasonPlaceholder') %>"></textarea>
          </div>
          <input type="hidden" id="statusProductId" name="productId">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideModal('statusChangeModal')">
          <i class="fas fa-times"></i>
          <%= t('manufacturer.products.modal.cancel') %>
        </button>
        <button type="submit" form="statusChangeForm" class="btn btn-primary" id="statusChangeSubmitBtn">
          <i class="fas fa-save"></i>
          <%= t('manufacturer.products.modal.save') %>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Marketplace Publish Modal -->
<div class="modal fade" id="marketplaceModal" tabindex="-1" role="dialog" aria-labelledby="marketplaceModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="marketplaceModalLabel">
          <i class="fas fa-store"></i>
          <%= t('manufacturer.products.modal.publish') %>
        </h5>
        <button type="button" class="btn-close" onclick="hideModal('marketplaceModal')" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="marketplaceForm">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong><%= t('manufacturer.products.modal.info') %>:</strong> <%= t('manufacturer.products.modal.publishDescription') %>
          </div>
          
          <div class="mb-3">
            <label for="marketplacePrice" class="form-label"><%= t('manufacturer.products.modal.price') %>:</label>
            <div class="input-group">
              <input type="number" class="form-control" id="marketplacePrice" name="price" step="0.01" min="0" required>
              <span class="input-group-text"><%= t('manufacturer.products.modal.currency') %></span>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="marketplaceQuantity" class="form-label"><%= t('manufacturer.products.modal.quantity') %>:</label>
            <input type="number" class="form-control" id="marketplaceQuantity" name="quantity" min="1" required>
          </div>
          
          <div class="mb-3">
            <label for="marketplaceDiscount" class="form-label"><%= t('manufacturer.products.modal.discount') %>:</label>
            <input type="number" class="form-control" id="marketplaceDiscount" name="discount" min="0" max="100" value="0">
          </div>
          
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="featuredProduct" name="featured">
            <label class="form-check-label" for="featuredProduct">
              ‚≠ê <%= t('manufacturer.products.modal.featured') %>
            </label>
          </div>
          
          <input type="hidden" id="marketplaceProductId" name="productId">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideModal('marketplaceModal')">
          <i class="fas fa-times"></i>
          <%= t('manufacturer.products.modal.cancel') %>
        </button>
        <button type="submit" form="marketplaceForm" class="btn btn-success" id="marketplaceSubmitBtn">
          <i class="fas fa-upload"></i>
          <%= t('manufacturer.products.modal.publish') %>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Duplicate Product Modal -->
<div class="modal fade" id="duplicateModal" tabindex="-1" role="dialog" aria-labelledby="duplicateModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="duplicateModalLabel">
          <i class="fas fa-copy"></i>
          <%= t('manufacturer.products.modal.duplicate') %>
        </h5>
        <button type="button" class="btn-close" onclick="hideModal('duplicateModal')" aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="duplicateForm">
          <div class="mb-3">
            <label for="duplicateName" class="form-label"><%= t('manufacturer.products.modal.name') %>:</label>
            <input type="text" class="form-control" id="duplicateName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="duplicateCode" class="form-label"><%= t('manufacturer.products.modal.code') %>:</label>
            <input type="text" class="form-control" id="duplicateCode" name="code" required>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="duplicateImages" name="includeImages" checked>
            <label class="form-check-label" for="duplicateImages">
              <%= t('manufacturer.products.modal.images') %>
            </label>
          </div>
          <input type="hidden" id="duplicateProductId" name="productId">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideModal('duplicateModal')">
          <i class="fas fa-times"></i>
          <%= t('manufacturer.products.modal.cancel') %>
        </button>
        <button type="submit" form="duplicateForm" class="btn btn-primary" id="duplicateSubmitBtn">
          <i class="fas fa-copy"></i>
          <%= t('manufacturer.products.modal.duplicate') %>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11;">
  <!-- Toasts will be dynamically added here -->
</div>

  <!-- Bootstrap 5 JavaScript -->
  <script src="/assets/js/bootstrap.bundle.min.js"></script>

  <!-- Real Data Loading Script -->
  <script>
    // Load real products statistics
    async function loadProductsData() {
      try {
        
        const response = await fetch('/api/manufacturer/products/stats', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getCookie('accessToken')}`
          },
          credentials: 'same-origin'
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Update KPI values
          updateProductsKPIs(data);
          
        } else {
          console.error('‚ùå Failed to load products data');
          // Use fallback static data
          updateProductsKPIs({
            totalProducts: 0,
            activeProducts: 0,
            marketplaceProducts: 0,
            draftProducts: 0
          });
        }
      } catch (error) {
        console.error('‚ùå Error loading products data:', error);
        // Use fallback static data
        updateProductsKPIs({
          totalProducts: 0,
          activeProducts: 0,
          marketplaceProducts: 0,
          draftProducts: 0
        });
      }
    }

    // Update products KPIs with real data
    function updateProductsKPIs(data) {
      // Update Total Products
      const totalProductsElement = document.getElementById('totalProductsValue');
      if (totalProductsElement) {
        totalProductsElement.innerHTML = data.totalProducts !== undefined ? data.totalProducts.toLocaleString() : '0';
      }
      
      // Update Active Products
      const activeProductsElement = document.getElementById('activeProductsValue');
      if (activeProductsElement) {
        activeProductsElement.innerHTML = data.activeProducts !== undefined ? data.activeProducts.toLocaleString() : '0';
      }
      
      // Update Marketplace Products
      const marketplaceProductsElement = document.getElementById('marketplaceProductsValue');
      if (marketplaceProductsElement) {
        marketplaceProductsElement.innerHTML = data.marketplaceProducts !== undefined ? data.marketplaceProducts.toLocaleString() : '0';
      }
      
      // Update Draft Products
      const draftProductsElement = document.getElementById('draftProductsValue');
      if (draftProductsElement) {
        draftProductsElement.innerHTML = data.draftProducts !== undefined ? data.draftProducts.toLocaleString() : '0';
      }
      
    }

    // Get cookie helper function
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    // Initialize products page functionality
    document.addEventListener('DOMContentLoaded', function() {
      
      // Load real products data
      loadProductsData();
      
    });
  </script>
  
  <!-- i18next Translation System -->
  <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>

  <!-- i18n Initialization Script -->
  <script>
    async function initializeTranslation() {
      try {
        // Get current language from cookies or default to 'uz'
        const currentLang = document.cookie
          .split('; ')
          .find(row => row.startsWith('i18next='))
          ?.split('=')[1] || 
          document.cookie
          .split('; ')
          .find(row => row.startsWith('selectedLanguage='))
          ?.split('=')[1] || 'uz';
        
        const response = await fetch(`/api/language/${currentLang}`, {
          headers: { 'Accept': 'application/json' }
        });
        const result = response.ok ? await response.json() : {};
        const translations = result.data || {};

        await i18next
          .use(i18nextBrowserLanguageDetector)
          .init({
            fallbackLng: 'uz',
            debug: false,
            detection: {
              order: ['cookie', 'localStorage', 'navigator', 'htmlTag'],
              caches: ['cookie', 'localStorage']
            },
            resources: {
              [currentLang]: {
                translation: translations
              }
            }
          });

        window.t = i18next.t.bind(i18next);
      } catch (error) {
        console.error('‚ùå Translation initialization failed:', error);
        // Fallback translation function
        window.t = function(key) {
          return key; // Return key as fallback - translations should come from uz.json
        };
      }
    }
    
    // Initialize translation when page loads
    initializeTranslation();
  </script>

  <!-- Professional Unified Header Management -->
  <script src="/js/manufacturer/manufacturer-header.js"></script>

  <!-- Enhanced Products Management JavaScript -->
  <script src="/js/manufacturer/products-management-enhanced.js"></script>

</body>
</html>