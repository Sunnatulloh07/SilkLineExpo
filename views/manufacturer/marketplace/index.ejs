<%- include('../partials/header', { title: title, lng: lng, user: user, t: t }) %>
<%- include('../partials/sidebar', { user: user, currentPage: 'marketplace', t: t }) %>
<style>
  .header-content{
    display: flex;
    justify-content: space-between;
    align-items: start;
  }
</style>

<!-- Main Content -->
<main class="admin-main">
  <div class="admin-content">
    
    <!-- B2B Marketplace Header -->
    <div class="marketplace-header animate-fade-in">
      <div class="header-content">
        <div class="header-title-section">
          <h1 class="page-title">
            <i class="fas fa-store-alt"></i>
            <%= t('manufacturer.marketplace.pageTitle') %>
          </h1>
          <p class="page-subtitle"><%= t('manufacturer.marketplace.pageSubtitle') %></p>
        </div>
        <div class="header-actions">
          <button class="btn-primary" id="addProductBtn">
            <i class="fas fa-plus"></i>
            <%= t('manufacturer.marketplace.actions.addProduct') %>
          </button>
          <button class="btn-outline" id="marketplaceAnalyticsBtn">
            <i class="fas fa-chart-bar"></i>
            <%= t('manufacturer.marketplace.actions.analytics') %>
          </button>
        </div>
      </div>
    </div>

    <!-- Marketplace Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-lg mb-lg">
      
      <!-- Total Views -->
      <div class="stat-card info animate-fade-in" data-metric="views">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.marketplace.metrics.totalViews') %></h3>
          <div class="stat-icon info">
            <i class="fas fa-eye"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="totalViewsValue">
            <span class="loading-placeholder">...</span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend">+<%= marketplaceMetrics?.growth?.views || 15 %>% <%= t('manufacturer.marketplace.metrics.thisMonth') %></span>
        </div>
      </div>

      <!-- Conversion Rate -->
      <div class="stat-card success animate-fade-in" data-metric="conversion">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.marketplace.metrics.conversionRate') %></h3>
          <div class="stat-icon success">
            <i class="fas fa-chart-line"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="conversionRateValue">
            <span class="loading-placeholder">...</span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend">+<%= marketplaceMetrics?.growth?.orders || 12 %>% <%= t('manufacturer.marketplace.metrics.growth') %></span>
        </div>
      </div>

      <!-- Inquiry Response Rate -->
      <div class="stat-card warning animate-fade-in" data-metric="response">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.marketplace.metrics.responseRate') %></h3>
          <div class="stat-icon warning">
            <i class="fas fa-reply"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="responseRateValue">
            <span class="loading-placeholder">...</span>
          </span>
        </div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up stat-change-icon"></i>
          <span class="metric-trend">+<%= marketplaceMetrics?.growth?.inquiries || 8 %>% <%= t('manufacturer.marketplace.metrics.improved') %></span>
        </div>
      </div>

      <!-- Marketplace Ranking -->
      <div class="stat-card primary animate-fade-in" data-metric="ranking">
        <div class="stat-header">
          <h3 class="stat-title"><%= t('manufacturer.marketplace.metrics.marketplaceRanking') %></h3>
          <div class="stat-icon primary">
            <i class="fas fa-trophy"></i>
          </div>
        </div>
        <div class="stat-value">
          <span class="metric-value" id="marketplaceRankingValue">
            <% if (typeof marketplaceMetrics !== 'undefined' && marketplaceMetrics.marketplaceRanking) { %>
              <%= marketplaceMetrics.marketplaceRanking %>
            <% } else { %>
              <span class="loading-placeholder">...</span>
            <% } %>
          </span>
        </div>
        <div class="stat-change neutral">
          <i class="fas fa-arrow-right stat-change-icon"></i>
          <span class="metric-trend"><%= t('manufacturer.marketplace.metrics.stablePosition') %></span>
        </div>
      </div>

    </div>

    <!-- Main Content Grid -->
    <div class="grid gap-lg mb-lg">
      
      <!-- Featured Products Section -->
      <div class="col-span-2">
        <div class="widget-card animate-fade-in">
          <div class="widget-header">
            <h3 class="widget-title">
              <i class="fas fa-star"></i>
              <%= t('manufacturer.marketplace.featuredProducts.title') %>
            </h3>
            <div class="widget-actions">
              <button class="btn-sm btn-ghost" id="refreshProductsBtn">
                <i class="fas fa-sync-alt"></i>
              </button>
              <a href="/manufacturer/products" class="widget-action-link">
                <%= t('manufacturer.marketplace.featuredProducts.viewAll') %>
              </a>
            </div>
          </div>
          <div class="widget-body">
            <div class="products-grid" id="featuredProductsGrid">
              
              <% if (typeof featuredProducts !== 'undefined' && featuredProducts.length > 0) { %>
                <% featuredProducts.forEach(function(product, index) { %>
                  <div class="b2b-product-card animate-slide-up" data-product="<%= product._id || '' %>" data-animation-delay="<%= index * 0.1 %>">
                    
                    <!-- Product Image Section - PROFESSIONAL RESPONSIVE DESIGN -->
                    <div class="product-image-section">
                      <div class="product-image">
                        <% 
                          // SENIOR SOFTWARE ENGINEER LOGIC - Robust Image URL Extraction
                          let hasValidImage = false;
                          let imageUrl = '';
                          
                          if (product.images && Array.isArray(product.images) && product.images.length > 0) {
                            const firstImage = product.images[0];
                            
                            if (typeof firstImage === 'string' && firstImage.trim() !== '') {
                              imageUrl = firstImage.trim();
                              hasValidImage = true;
                            } else if (typeof firstImage === 'object' && firstImage !== null) {
                              if (firstImage.url && firstImage.url.trim() !== '') {
                                imageUrl = firstImage.url.trim();
                                hasValidImage = true;
                              } else if (typeof firstImage === 'string' && firstImage.trim() !== '') {
                                imageUrl = firstImage.trim();
                                hasValidImage = true;
                              }
                            }
                          }
                          
                          // Server-side debugging will be handled in backend logs
                        %>
                        
                        <% if (hasValidImage) { %>
                          <!-- Real Product Image -->
                          <img 
                            src="<%= imageUrl %>" 
                            alt="<%= product.title || product.name || t('manufacturer.marketplace.featuredProducts.productImage') %>" 
                            class="product-real-image"
                            data-product-id="<%= product._id || '' %>"
                            data-product-name="<%= (product.title || product.name || t('manufacturer.marketplace.featuredProducts.unnamedProduct')).replace(/'/g, '').substring(0, 30) %>"
                            data-category="<%= typeof product.category === 'string' ? product.category : (product.category && product.category.name ? product.category.name : (product.category && product.category._id ? product.category._id : t('manufacturer.marketplace.featuredProducts.noCategory'))) %>"
                            data-image-type="real"
                            data-image-source="<%= imageUrl.substring(0, 30) %>..."
                            data-has-images="<%= product.images ? product.images.length : 0 %>"
                            onerror="handleImageError(this)" 
                            loading="lazy"
                          >
                        <% } else { %>
                          <!-- Mock Image for Products without Valid Images -->
                          <img 
                            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PGcgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+PHRleHQgeD0iNTAlIiB5PSI0NSUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZm9udC13ZWlnaHQ9IjUwMCI+TG9hZGluZy4uLjwvdGV4dD48L2c+PC9zdmc+" 
                            alt="<%= product.title || product.name || t('manufacturer.marketplace.featuredProducts.productImage') %>" 
                            class="mock-product-image loading-placeholder" 
                            data-category="<%= typeof product.category === 'string' ? product.category : (product.category && product.category.name ? product.category.name : (product.category && product.category._id ? product.category._id : t('manufacturer.marketplace.featuredProducts.noCategory'))) %>"
                            data-product-id="<%= product._id || '' %>"
                            data-product-name="<%= (product.title || product.name || t('manufacturer.marketplace.featuredProducts.unnamedProduct')).replace(/'/g, '').substring(0, 30) %>"
                            data-image-type="mock"
                            data-has-images="<%= product.images ? product.images.length : 0 %>"
                            data-needs-mock="true"
                            loading="lazy"
                          >
                        <% } %>
                      </div>
                      
                      <!-- Professional Badges - Top Left -->
                      <div class="product-badges">
                        <% if (product.badges && product.badges.length > 0) { %>
                          <% product.badges.slice(0, 2).forEach(function(badge) { %>
                            <div class="product-badge badge-<%= badge.color %>">
                              <i class="fas fa-<%= badge.type === 'featured' ? 'star' : badge.type === 'bestseller' ? 'crown' : badge.type === 'certified' ? 'certificate' : 'fire' %>"></i>
                              <%= badge.label %>
                            </div>
                          <% }) %>
                        <% } %>
                      </div>

                      <!-- View Details Button - Top Right -->
                      <button class="view-details-btn" data-action="view-details" data-product-id="<%= product._id || '' %>" title="<%= t('manufacturer.marketplace.featuredProducts.viewDetails') %>">
                        <i class="fas fa-eye"></i>
                      </button>

                      <!-- Stock Status - Bottom Right -->
                      <div class="stock-status stock-<%= product.availabilityInfo?.status || 'available' %>">
                        <i class="fas fa-<%= product.availabilityInfo?.status === 'available' ? 'check-circle' : product.availabilityInfo?.status === 'limited' ? 'exclamation-triangle' : 'times-circle' %>"></i>
                        <%= product.availabilityInfo?.message || t('manufacturer.marketplace.featuredProducts.available') %>
                      </div>
                    </div>

                    <!-- Essential Product Info - Clean & Simple -->
                    <div class="product-info-section">
                      
                      <!-- Product Header -->
                      <div class="product-header">
                        <h3 class="product-title" title="<%= product.title || product.name || t('manufacturer.marketplace.featuredProducts.unnamedProduct') %>">
                          <%= (product.title || product.name || t('manufacturer.marketplace.featuredProducts.unnamedProduct')) %>
                        </h3>
                        <div class="product-id">ID: <%= product._id.toString().slice(-8).toUpperCase() %></div>
                      </div>

                      <!-- Category -->
                      <div class="product-category-desc">
                        <div class="product-category">
                          <i class="fas fa-tag"></i>
                          <% 
                            let categoryName = typeof product.category === 'string' ? product.category : (product.category && product.category.name ? product.category.name : (product.category && product.category._id ? product.category._id : t('manufacturer.marketplace.featuredProducts.noCategory')));
                            if (typeof product.category === 'object' && product.category.translations && product.category.translations[req.language] && product.category.translations[req.language].name) {
                              categoryName = product.category.translations[req.language].name;
                            }
                          %>
                          <%= categoryName %>
                        </div>
                      </div>

                      <!-- Essential Pricing - Clean Display -->
                      <div class="product-pricing-section">
                        <div class="pricing-main">
                          <div class="price-display">
                            <% if (product.priceDisplay) { %>
                              <span class="price-amount price-<%= product.priceDisplay.type %>">
                                <%= product.priceDisplay.display %>
                              </span>
                            
                            <% } else { %>
                              <span class="price-amount price-quote"><%= t('manufacturer.marketplace.featuredProducts.priceOnRequest') %></span>
                            <% } %>
                          </div>
                          
                          <div class="pricing-details">
                            <div class="moq-info">
                              <span class="moq-label"><%= t('manufacturer.marketplace.featuredProducts.minimum') %>:</span>
                              <span class="moq-value"><%= (product.moq || 100).toLocaleString() %> <%= t('manufacturer.marketplace.featuredProducts.unit') %></span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Essential Metrics - 3 Key Stats -->
                      <div class="product-metrics">
                        <div class="metric-item">
                          <i class="fas fa-star <%= (product.rating && product.rating > 0) ? 'text-yellow-400' : 'text-gray-300' %>"></i>
                          <span><%= (product.rating && product.rating > 0) ? product.rating.toFixed(1) : '0.0' %></span>
                        </div>
                        <div class="metric-item">
                          <i class="fas fa-eye"></i>
                          <span><%= (product.views || 0) > 999 ? Math.floor((product.views || 0) / 1000) + 'K' : (product.views || 0) %></span>
                        </div>
                        <div class="metric-item">
                          <i class="fas fa-shopping-cart"></i>
                          <span><%= product.orderCount || 0 %></span>
                        </div>
                      </div>

                      <!-- Essential Action Buttons -->
                      <div class="product-actions">
                        <button class="btn-action btn-primary" data-action="edit" data-product-id="<%= product._id || '' %>">
                          <i class="fas fa-edit"></i>
                          <span><%= t('manufacturer.marketplace.featuredProducts.edit') %></span>
                        </button>
                        <button class="btn-action btn-secondary" data-action="stats" data-product-id="<%= product._id || '' %>">
                          <i class="fas fa-chart-line"></i>
                          <span><%= t('manufacturer.marketplace.featuredProducts.statistics') %></span>
                        </button>
                      </div>

                    </div>
                  </div>
                <% }) %>
              <% } else { %>
                <div class="empty-state">
                  <div class="empty-icon">
                    <i class="fas fa-box-open"></i>
                  </div>
                  <h3 class="empty-title"><%= t('manufacturer.marketplace.featuredProducts.noProducts') %></h3>
                  <p class="empty-description"><%= t('manufacturer.marketplace.featuredProducts.noProductsDesc') %></p>
                  <button class="btn-primary" onclick="window.location.href='/manufacturer/products/add';">
                    <i class="fas fa-plus"></i>
                    <%= t('manufacturer.marketplace.featuredProducts.addFirstProduct') %>
                  </button>
                </div>
              <% } %>
              
            </div>
          </div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="col-span-1">
        
        <!-- Recent Inquiries -->
        <div class="widget-card animate-fade-in mb-lg">
          <div class="widget-header">
            <h3 class="widget-title">
              <i class="fas fa-envelope-open"></i>
              <%= t('manufacturer.marketplace.recentInquiries.title') %>
            </h3>
            <a href="/manufacturer/inquiries" class="widget-action-link">
              <%= t('manufacturer.marketplace.recentInquiries.viewAll') %>
            </a>
          </div>
          <div class="widget-body">
            <div class="inquiries-list" id="recentInquiriesList">
              
              <% if (typeof recentInquiries !== 'undefined' && recentInquiries.length > 0) { %>
                <% recentInquiries.forEach(function(inquiry) { %>
                  <div class="inquiry-item priority-<%= inquiry.priority || 'medium' %>" data-inquiry="<%= inquiry.id || '' %>" onclick="window.location.href='/manufacturer/inquiries'" style="cursor: pointer;">
                    <div class="inquiry-header">
                      <div class="company-info">
                        <div class="company-avatar">
                          <%= (inquiry.company || 'U').charAt(0) %>
                        </div>
                        <div class="company-details">
                          <h4 class="company-name"><%= inquiry.company || t('manufacturer.marketplace.recentInquiries.unknownCompany') %></h4>
                          <span class="inquiry-time">
                            <%= inquiry.createdAt ? new Date(inquiry.createdAt).toLocaleDateString('uz-UZ') : t('manufacturer.marketplace.recentInquiries.today') %>
                          </span>
                        </div>
                      </div>
                      <div class="inquiry-priority priority-<%= inquiry.priority || 'medium' %>">
                        <% if (inquiry.priority === 'high') { %>
                          <i class="fas fa-exclamation-circle"></i>
                          <%= t('manufacturer.marketplace.recentInquiries.priority.high') %>
                        <% } else if (inquiry.priority === 'medium') { %>
                          <i class="fas fa-circle"></i>
                          <%= t('manufacturer.marketplace.recentInquiries.priority.medium') %>
                        <% } else { %>
                          <i class="fas fa-circle"></i>
                          <%= t('manufacturer.marketplace.recentInquiries.priority.low') %>
                        <% } %>
                      </div>
                    </div>
                    <div class="inquiry-content">
                      <p class="inquiry-product">
                        <i class="fas fa-cube"></i>
                        <%= inquiry.product || t('manufacturer.marketplace.recentInquiries.generalInquiry') %>
                      </p>
                      <div class="inquiry-details">
                        <span class="quantity">
                          <i class="fas fa-sort-numeric-up"></i>
                          <%= inquiry.quantity || t('manufacturer.marketplace.recentInquiries.toBeDiscussed') %>
                        </span>
                        <span class="budget">
                          <i class="fas fa-dollar-sign"></i>
                          <%= inquiry.budget || t('manufacturer.marketplace.recentInquiries.toBeDiscussed') %>
                        </span>
                      </div>
                      <p class="inquiry-message">
                        <%= inquiry.message ? (inquiry.message.length > 80 ? inquiry.message.substring(0, 80) + '...' : inquiry.message) : t('manufacturer.marketplace.recentInquiries.initialContact') %>
                      </p>
                    </div>
                  </div>
                <% }) %>
              <% } else { %>
                <div class="empty-inquiries">
                  <div class="empty-icon">
                    <i class="fas fa-inbox"></i>
                  </div>
                  <h4 class="empty-title"><%= t('manufacturer.marketplace.recentInquiries.emptyState.title') %></h4>
                  <p class="empty-description"><%= t('manufacturer.marketplace.recentInquiries.emptyState.description') %></p>
                  <p class="empty-action"><%= t('manufacturer.marketplace.recentInquiries.emptyState.action') %></p>
                </div>
              <% } %>
              
            </div>
          </div>
        </div>

        <!-- Marketplace Performance -->
        <div class="widget-card animate-fade-in">
          <div class="widget-header">
            <h3 class="widget-title">
              <i class="fas fa-chart-pie"></i>
              <%= t('manufacturer.marketplace.performance.title') %>
            </h3>
          </div>
          <div class="widget-body">
            <div class="performance-metrics">
              
              <div class="performance-item">
                <div class="performance-icon visibility">
                  <i class="fas fa-eye"></i>
                </div>
                <div class="performance-info">
                  <span class="performance-label"><%= t('manufacturer.marketplace.performance.visibility') %></span>
                  <span class="performance-value high">
                    <%= marketplaceMetrics?.visibility || t('manufacturer.marketplace.performance.high') %>
                  </span>
                </div>
              </div>

              <div class="performance-item">
                <div class="performance-icon competitive">
                  <i class="fas fa-medal"></i>
                </div>
                <div class="performance-info">
                  <span class="performance-label"><%= t('manufacturer.marketplace.performance.competitiveScore') %></span>
                  <span class="performance-value score">
                    <%= marketplaceMetrics?.competitiveScore || 75 %>/100
                  </span>
                </div>
              </div>

              <div class="performance-item">
                <div class="performance-icon growth">
                  <i class="fas fa-chart-line"></i>
                </div>
                <div class="performance-info">
                  <span class="performance-label"><%= t('manufacturer.marketplace.performance.growthRate') %></span>
                  <span class="performance-value positive">
                    +<%= marketplaceMetrics?.growth?.views || 15 %>%
                  </span>
                </div>
              </div>

            </div>
            
            <!-- Quick Analytics Chart -->
            <div class="mini-chart" id="performanceChart">
              <canvas id="performanceChartCanvas" width="280" height="120"></canvas>
            </div>
            
          </div>
        </div>

      </div>
    </div>

    <!-- Competitor Analysis Section -->
    <div class="widget-card animate-fade-in">
      <div class="widget-header">
        <h3 class="widget-title">
          <i class="fas fa-users-cog"></i>
          <%= t('manufacturer.marketplace.competitorAnalysis.title') %>
        </h3>
        <div class="widget-actions">
       
          <button class="btn-sm btn-outline" id="detailedAnalysisBtn">
            <i class="fas fa-chart-area"></i>
            <%= t('manufacturer.marketplace.competitorAnalysis.detailedAnalysis') %>
          </button>
        </div>
      </div>
      <div class="widget-body">
        <div class="competitor-grid">
          
          <!-- Market Position -->
          <div class="competitor-card">
            <div class="competitor-header">
              <h4 class="competitor-title"><%= t('manufacturer.marketplace.competitorAnalysis.marketPosition') %></h4>
              <div class="position-badge position-<%= (competitorAnalysis?.marketPosition || 'good').toLowerCase() %>">
                <%= t(`manufacturer.marketplace.competitorAnalysis.${competitorAnalysis?.marketPosition || 'good'}`) %>
              </div>
            </div>
            <div class="competitor-content">
              <div class="position-stats">
                <div class="stat-item">
                  <span class="stat-label"><%= t('manufacturer.marketplace.competitorAnalysis.competitors') %></span>
                  <span class="stat-value"><%= competitorAnalysis?.competitorCount || 20 %></span>
                </div>
                <div class="stat-item">
                  <span class="stat-label"><%= t('manufacturer.marketplace.competitorAnalysis.priceCompetitiveness') %></span>
                  <span class="stat-value"><%= t(`manufacturer.marketplace.competitorAnalysis.${competitorAnalysis?.priceCompetitiveness || 'average'}`) %></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Strengths -->
          <div class="competitor-card">
            <div class="competitor-header">
              <h4 class="competitor-title"><%= t('manufacturer.marketplace.competitorAnalysis.strengths') %></h4>
              <div class="strengths-count">
                <%= (competitorAnalysis?.strengths || []).length %> <%= t('manufacturer.marketplace.competitorAnalysis.items') %>
              </div>
            </div>
            <div class="competitor-content">
              <ul class="strengths-list">
                <% if (competitorAnalysis && competitorAnalysis.strengths) { %>
                  <% competitorAnalysis.strengths.forEach(function(strength) { %>
                    <li class="strength-item">
                      <i class="fas fa-check-circle"></i>
                      <%= t(`manufacturer.marketplace.competitorAnalysis.defaultStrengths.${strength}`) %>
                    </li>
                  <% }) %>
                <% } else { %>
                  <li class="strength-item">
                    <i class="fas fa-check-circle"></i>
                    <%= t('manufacturer.marketplace.competitorAnalysis.defaultStrengths.qualityProducts') %>
                  </li>
                  <li class="strength-item">
                    <i class="fas fa-check-circle"></i>
                    <%= t('manufacturer.marketplace.competitorAnalysis.defaultStrengths.fastDelivery') %>
                  </li>
                <% } %>
              </ul>
            </div>
          </div>

          <!-- Opportunities -->
          <div class="competitor-card">
            <div class="competitor-header">
              <h4 class="competitor-title"><%= t('manufacturer.marketplace.competitorAnalysis.opportunities') %></h4>
              <div class="opportunities-count">
                <%= (competitorAnalysis?.opportunities || []).length %> <%= t('manufacturer.marketplace.competitorAnalysis.items') %>
              </div>
            </div>
            <div class="competitor-content">
              <ul class="opportunities-list">
                <% if (competitorAnalysis && competitorAnalysis.opportunities) { %>
                  <% competitorAnalysis.opportunities.forEach(function(opportunity) { %>
                    <li class="opportunity-item">
                      <i class="fas fa-lightbulb"></i>
                      <%= t(`manufacturer.marketplace.competitorAnalysis.defaultOpportunities.${opportunity}`) %>
                    </li>
                  <% }) %>
                <% } else { %>
                  <li class="opportunity-item">
                    <i class="fas fa-lightbulb"></i>
                    <%= t('manufacturer.marketplace.competitorAnalysis.defaultOpportunities.expandAssortment') %>
                  </li>
                  <li class="opportunity-item">
                    <i class="fas fa-lightbulb"></i>
                    <%= t('manufacturer.marketplace.competitorAnalysis.defaultOpportunities.increaseMarketing') %>
                  </li>
                <% } %>
              </ul>
            </div>
          </div>


        </div>
      </div>
    </div>

  </div>
</main>

<!-- Product Details Modal -->
<div class="modal-overlay" id="productDetailsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title"><%= t('manufacturer.marketplace.modal.productDetails') %></h2>
      <button class="modal-close" id="closeModal">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Dinamik kontent shu yerga yuklanadi -->
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <p><%= t('manufacturer.marketplace.modal.loading') %></p>
      </div>
    </div>
  </div>
</div>

<!-- Server Data for JavaScript -->
<script type="application/json" id="marketplace-data">
<%- JSON.stringify({
  marketplaceMetrics: marketplaceMetrics || {},
  featuredProducts: featuredProducts || [],
  recentInquiries: recentInquiries || [],
  competitorAnalysis: competitorAnalysis || {},
  user: {
    id: user._id || '',
    name: user.name || t('manufacturer.marketplace.defaultUser.name'),
    companyName: user.companyName || t('manufacturer.marketplace.defaultUser.companyName')
  }
}) %>
</script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- i18next Translation System -->
<script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js"></script>

<!-- Core JavaScript Dependencies -->
<script src="/assets/js/jquery-3.7.1.min.js"></script>
<script src="/assets/js/boostrap.bundle.min.js"></script>

<!-- Manufacturer Dashboard Core (Primary sidebar handler) -->
<script src="/js/manufacturer/dashboard-init.js"></script>

<!-- Professional Unified Header Management (Secondary - defers to dashboard-init) -->
<script src="/js/manufacturer/manufacturer-header.js"></script>

<!-- Professional Marketplace Functionality (Sidebar handling delegated) -->
<script src="/js/manufacturer/manufacture-marketplace.js"></script>

<!-- i18n Initialization Script -->
<script>
  // Initialize i18next translation system
  async function initializeTranslation() {
    try {
      // Get current language from cookies or default to 'uz'
      const currentLang = document.cookie
        .split('; ')
        .find(row => row.startsWith('i18next='))
        ?.split('=')[1] || 
        document.cookie
        .split('; ')
        .find(row => row.startsWith('selectedLanguage='))
        ?.split('=')[1] || 'uz';
      
      // Load translations from server
      const response = await fetch(`/api/language/${currentLang}`, {
        headers: { 'Accept': 'application/json' }
      });
      const result = response.ok ? await response.json() : {};
      const translations = result.data || {};
      
      await i18next
        .use(i18nextBrowserLanguageDetector)
        .init({
          fallbackLng: 'uz',
          debug: false,
          detection: {
            order: ['cookie', 'localStorage', 'navigator', 'htmlTag'],
            caches: ['cookie', 'localStorage']
          },
          resources: {
            [currentLang]: {
              translation: translations
            }
          }
        });
      
      // Set global translation function
      window.t = i18next.t.bind(i18next);
      
    } catch (error) {
      // Fallback translation function with basic translations
      window.t = function(key) {
        const fallbackTranslations = {
          'manufacturer.marketplace.competitorAnalysis.average': 'O\'rtacha',
          'manufacturer.marketplace.competitorAnalysis.good': 'Yaxshi',
          'manufacturer.marketplace.competitorAnalysis.strong': 'Kuchli',
          'manufacturer.marketplace.competitorAnalysis.competitive': 'Raqobatbardosh',
          'manufacturer.marketplace.competitorAnalysis.defaultStrengths.establishedMarketPresence': 'O\'rnatilgan bozor mavjudligi',
          'manufacturer.marketplace.competitorAnalysis.defaultStrengths.productQualityFocus': 'Mahsulot sifatiga e\'tibor',
          'manufacturer.marketplace.competitorAnalysis.defaultOpportunities.expandProductRange': 'Mahsulot assortimentini kengaytirish',
          'manufacturer.marketplace.competitorAnalysis.defaultOpportunities.improveMarketingVisibility': 'Marketing ko\'rinishini yaxshilash',
          'manufacturer.marketplace.competitorAnalysis.defaultOpportunities.featureMoreProducts': 'Ko\'proq mahsulotlarni taqdim etish',
          'manufacturer.marketplace.competitorAnalysis.defaultOpportunities.marketExpansionOpportunity': 'Bozor kengaytirish imkoniyati',
          'manufacturer.marketplace.competitorAnalysis.defaultOpportunities.improveResponseTime': 'Javob berish vaqtini yaxshilash'
        };
        return fallbackTranslations[key] || key;
      };
    }
  }
  
  // Initialize translation before other scripts
  initializeTranslation();
</script>

<script>
  async function loadMarketplaceData() {
    try {
      const response = await fetch('/manufacturer/api/marketplace-metrics');
      if (response.ok) {
        const data = await response.json();
        updateMarketplaceKPIs(data);
      }
    } catch (error) {
      // Error handling
    }
  }

  function updateMarketplaceKPIs(data) {
    const totalViewsElement = document.getElementById('totalViewsValue');
    if (totalViewsElement) {
      totalViewsElement.innerHTML = data.totalViews !== undefined ? data.totalViews.toLocaleString() : '0';
    }
    
    const conversionRateElement = document.getElementById('conversionRateValue');
    if (conversionRateElement) {
      conversionRateElement.innerHTML = data.conversionRate || '0%';
    }
    
    const responseRateElement = document.getElementById('responseRateValue');
    if (responseRateElement) {
      responseRateElement.innerHTML = data.inquiryResponseRate || '0%';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    loadMarketplaceData();
  });
</script>

</body>
</html>