<%- include('../partials/header', { title: 'Messages - SLEX' }) %>
<%- include('../partials/navigation') %>

<!-- Buyer Messages Page - Alibaba Style -->
<main class="buyer-messages-wrapper">
  <div class="container container-two">
    <div class="row">
      <div class="col-lg-3">
        <!-- Buyer Sidebar -->
        <%- include('./partials/buyer-sidebar', { currentPage: 'messages' }) %>
      </div>
      
      <div class="col-lg-9">
        <!-- Messages Interface -->
        <div class="messages-container">
          <div class="messages-header">
            <h2 class="messages-title">
              <i class="las la-comments"></i>
              <%- t('messages.title') || 'Messages' %>
            </h2>
            <button class="btn btn-primary" onclick="startNewConversation()">
              <i class="las la-plus"></i>
              <%- t('messages.newMessage') || 'New Message' %>
            </button>
          </div>

          <div class="messages-content">
            <div class="conversations-list">
              <div class="conversations-header">
                <h4><%- t('messages.conversations') || 'Conversations' %></h4>
                <div class="search-conversations">
                  <input type="text" placeholder="<%- t('messages.searchConversations') || 'Search conversations...' %>" 
                         class="form-control" id="conversationSearch">
                </div>
              </div>

              <div class="conversations">
                <!-- Sample Conversation 1 -->
                <div class="conversation-item active" data-conversation-id="conv1" onclick="openConversation('conv1')">
                  <div class="supplier-avatar">
                    <img src="/assets/images/placeholder-product.svg" alt="Supplier">
                  </div>
                  <div class="conversation-info">
                    <h5 class="supplier-name">Textile Manufacturing Co.</h5>
                    <p class="last-message">Thank you for your inquiry about cotton t-shirts...</p>
                    <span class="message-time">2 hours ago</span>
                  </div>
                  <div class="conversation-meta">
                    <span class="unread-count">3</span>
                    <i class="las la-circle online-indicator"></i>
                  </div>
                </div>

                <!-- Sample Conversation 2 -->
                <div class="conversation-item" data-conversation-id="conv2" onclick="openConversation('conv2')">
                  <div class="supplier-avatar">
                    <img src="/assets/images/placeholder-product.svg" alt="Supplier">
                  </div>
                  <div class="conversation-info">
                    <h5 class="supplier-name">Fashion Apparel Ltd.</h5>
                    <p class="last-message">We can offer better pricing for bulk orders...</p>
                    <span class="message-time">Yesterday</span>
                  </div>
                  <div class="conversation-meta">
                    <i class="las la-circle offline-indicator"></i>
                  </div>
                </div>

                <!-- Sample Conversation 3 -->
                <div class="conversation-item" data-conversation-id="conv3" onclick="openConversation('conv3')">
                  <div class="supplier-avatar">
                    <img src="/assets/images/placeholder-product.svg" alt="Supplier">
                  </div>
                  <div class="conversation-info">
                    <h5 class="supplier-name">Denim Works Inc.</h5>
                    <p class="last-message">The samples have been shipped...</p>
                    <span class="message-time">2 days ago</span>
                  </div>
                  <div class="conversation-meta">
                    <i class="las la-circle offline-indicator"></i>
                  </div>
                </div>
              </div>
            </div>

            <div class="chat-area">
              <div class="chat-header">
                <div class="chat-supplier-info">
                  <img src="/assets/images/placeholder-product.svg" alt="Supplier" class="supplier-avatar-small">
                  <div class="supplier-details">
                    <h4>Textile Manufacturing Co.</h4>
                    <span class="supplier-status">
                      <i class="las la-circle online-indicator"></i>
                      <%- t('messages.online') || 'Online' %>
                    </span>
                  </div>
                </div>
                <div class="chat-actions">
                  <button class="btn btn-outline-primary btn-sm" onclick="viewSupplierProfile()">
                    <i class="las la-store"></i>
                    <%- t('messages.viewProfile') || 'View Profile' %>
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" onclick="requestQuote()">
                    <i class="las la-file-invoice-dollar"></i>
                    <%- t('messages.requestQuote') || 'Request Quote' %>
                  </button>
                </div>
              </div>

              <div class="chat-messages" id="chatMessages">
                <!-- Sample Messages -->
                <div class="message supplier-message">
                  <div class="message-content">
                    <p>Hello! Thank you for your interest in our cotton t-shirts. We can definitely help you with your order.</p>
                    <span class="message-time">Today, 2:30 PM</span>
                  </div>
                </div>

                <div class="message buyer-message">
                  <div class="message-content">
                    <p>Hi, I'm looking for 1000 pieces of cotton t-shirts. Can you provide a quote?</p>
                    <span class="message-time">Today, 2:25 PM</span>
                  </div>
                </div>

                <div class="message supplier-message">
                  <div class="message-content">
                    <p>For 1000 pieces, our price would be $5.50 per piece. This includes:</p>
                    <ul>
                      <li>100% Cotton material</li>
                      <li>Multiple size options (S, M, L, XL)</li>
                      <li>Custom colors available</li>
                      <li>Free shipping for orders over $5000</li>
                    </ul>
                    <span class="message-time">Today, 2:35 PM</span>
                  </div>
                </div>

                <div class="message supplier-message">
                  <div class="message-content">
                    <p>Would you like me to send you some samples first?</p>
                    <div class="message-attachments">
                      <div class="attachment">
                        <i class="las la-file-pdf"></i>
                        <span>Product_Catalog_2024.pdf</span>
                        <button class="btn-download"><i class="las la-download"></i></button>
                      </div>
                    </div>
                    <span class="message-time">Today, 2:40 PM</span>
                  </div>
                </div>

                <div class="message buyer-message">
                  <div class="message-content">
                    <p>Yes, please send samples. What's the minimum order quantity?</p>
                    <span class="message-time">Today, 3:15 PM</span>
                  </div>
                </div>

                <div class="message supplier-message">
                  <div class="message-content">
                    <p>Our MOQ is 500 pieces per color. For mixed colors, minimum 100 pieces per color.</p>
                    <span class="message-time">Today, 3:20 PM</span>
                  </div>
                </div>
              </div>

              <div class="chat-input">
                <div class="input-group">
                  <button class="btn btn-outline-secondary" type="button" onclick="attachFile()">
                    <i class="las la-paperclip"></i>
                  </button>
                  <input type="text" class="form-control" placeholder="<%- t('messages.typeMessage') || 'Type your message...' %>" 
                         id="messageInput" onkeypress="handleKeyPress(event)">
                  <button class="btn btn-primary" type="button" onclick="sendMessage()">
                    <i class="las la-paper-plane"></i>
                  </button>
                </div>
                <div class="quick-replies">
                  <button class="quick-reply-btn" onclick="insertQuickReply('Thank you for the information.')">
                    <%- t('messages.thankYou') || 'Thank you' %>
                  </button>
                  <button class="quick-reply-btn" onclick="insertQuickReply('Can you provide more details?')">
                    <%- t('messages.moreDetails') || 'More details' %>
                  </button>
                  <button class="quick-reply-btn" onclick="insertQuickReply('What is your best price?')">
                    <%- t('messages.bestPrice') || 'Best price' %>
                  </button>
                  <button class="quick-reply-btn" onclick="insertQuickReply('Please send samples.')">
                    <%- t('messages.sendSamples') || 'Send samples' %>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<style>
/* Buyer Messages Styles */
.buyer-messages-wrapper {
  padding: 60px 0;
  background: #f8f9fa;
  min-height: calc(100vh - 200px);
}

.messages-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  height: calc(100vh - 200px);
  max-height: 800px;
  display: flex;
  flex-direction: column;
}

.messages-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem 2rem;
  border-bottom: 1px solid #e9ecef;
}

.messages-title {
  margin: 0;
  color: #333;
  font-size: 1.5rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.messages-title i {
  color: #ff6a00;
}

.messages-content {
  display: flex;
  flex: 1;
  min-height: 0;
}

.conversations-list {
  width: 350px;
  border-right: 1px solid #e9ecef;
  display: flex;
  flex-direction: column;
}

.conversations-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #e9ecef;
}

.conversations-header h4 {
  margin: 0 0 1rem 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: #333;
}

.conversations {
  flex: 1;
  overflow-y: auto;
}

.conversation-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: background 0.3s ease;
}

.conversation-item:hover {
  background: #f8f9fa;
}

.conversation-item.active {
  background: #ff6a0010;
  border-right: 3px solid #ff6a00;
}

.supplier-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  overflow: hidden;
  position: relative;
}

.supplier-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.conversation-info {
  flex: 1;
  min-width: 0;
}

.supplier-name {
  margin: 0 0 0.25rem 0;
  font-size: 1rem;
  font-weight: 600;
  color: #333;
}

.last-message {
  margin: 0 0 0.25rem 0;
  color: #666;
  font-size: 0.9rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.message-time {
  color: #999;
  font-size: 0.8rem;
}

.conversation-meta {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
}

.unread-count {
  background: #ff6a00;
  color: white;
  font-size: 0.7rem;
  font-weight: 600;
  padding: 0.25rem 0.5rem;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
}

.online-indicator {
  color: #28a745;
  font-size: 0.8rem;
}

.offline-indicator {
  color: #ccc;
  font-size: 0.8rem;
}

.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.chat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #e9ecef;
  background: #f8f9fa;
}

.chat-supplier-info {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.supplier-avatar-small {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}

.supplier-details h4 {
  margin: 0 0 0.25rem 0;
  font-size: 1rem;
  font-weight: 600;
  color: #333;
}

.supplier-status {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  color: #666;
  font-size: 0.85rem;
}

.chat-actions {
  display: flex;
  gap: 0.5rem;
}

.chat-messages {
  flex: 1;
  padding: 1rem 1.5rem;
  overflow-y: auto;
  background: #f8f9fa;
}

.message {
  margin-bottom: 1rem;
  display: flex;
}

.supplier-message {
  justify-content: flex-start;
}

.buyer-message {
  justify-content: flex-end;
}

.message-content {
  max-width: 70%;
  background: white;
  padding: 1rem;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.buyer-message .message-content {
  background: #ff6a00;
  color: white;
}

.message-content p {
  margin: 0 0 0.5rem 0;
  line-height: 1.5;
}

.message-content ul {
  margin: 0.5rem 0;
  padding-left: 1.2rem;
}

.message-content li {
  margin-bottom: 0.25rem;
}

.message-time {
  display: block;
  font-size: 0.75rem;
  opacity: 0.7;
  margin-top: 0.5rem;
}

.message-attachments {
  margin-top: 0.5rem;
}

.attachment {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: rgba(0,0,0,0.1);
  padding: 0.5rem;
  border-radius: 6px;
}

.btn-download {
  background: none;
  border: none;
  color: inherit;
  cursor: pointer;
  padding: 0.25rem;
}

.chat-input {
  padding: 1rem 1.5rem;
  border-top: 1px solid #e9ecef;
  background: white;
}

.input-group {
  margin-bottom: 0.5rem;
}

.quick-replies {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.quick-reply-btn {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  color: #666;
  padding: 0.25rem 0.75rem;
  border-radius: 15px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.quick-reply-btn:hover {
  background: #ff6a00;
  color: white;
  border-color: #ff6a00;
}

/* Mobile Responsive */
@media (max-width: 992px) {
  .messages-content {
    flex-direction: column;
  }
  
  .conversations-list {
    width: 100%;
    max-height: 200px;
  }
  
  .chat-area {
    border-top: 1px solid #e9ecef;
  }
}

@media (max-width: 768px) {
  .buyer-messages-wrapper {
    padding: 30px 0;
  }
  
  .messages-container {
    height: calc(100vh - 150px);
  }
  
  .messages-header {
    padding: 1rem;
    flex-direction: column;
    gap: 1rem;
  }
  
  .chat-header {
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }
  
  .chat-actions {
    justify-content: center;
  }
  
  .message-content {
    max-width: 85%;
  }
  
  .quick-replies {
    justify-content: center;
  }
}
</style>

<script>
// Messages functionality
let currentConversationId = 'conv1';

function openConversation(conversationId) {
  // Remove active class from all conversations
  document.querySelectorAll('.conversation-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Add active class to selected conversation
  document.querySelector(`[data-conversation-id="${conversationId}"]`).classList.add('active');
  
  currentConversationId = conversationId;
  
  // Load conversation messages
  loadConversationMessages(conversationId);
}

function loadConversationMessages(conversationId) {
  // In a real application, this would fetch messages from the server
  console.log(`Loading messages for conversation: ${conversationId}`);
}

function sendMessage() {
  const messageInput = document.getElementById('messageInput');
  const message = messageInput.value.trim();
  
  if (message) {
    // Add message to chat
    const chatMessages = document.getElementById('chatMessages');
    const messageHtml = `
      <div class="message buyer-message">
        <div class="message-content">
          <p>${message}</p>
          <span class="message-time">Just now</span>
        </div>
      </div>
    `;
    chatMessages.innerHTML += messageHtml;
    
    // Clear input
    messageInput.value = '';
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Send to server
    fetch('/buyer/api/send-message', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        conversationId: currentConversationId,
        message: message
      })
    })
    .catch(error => {
      console.error('Error sending message:', error);
    });
  }
}

function handleKeyPress(event) {
  if (event.key === 'Enter') {
    sendMessage();
  }
}

function insertQuickReply(text) {
  const messageInput = document.getElementById('messageInput');
  messageInput.value = text;
  messageInput.focus();
}

function attachFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*,.pdf,.doc,.docx';
  input.onchange = function(event) {
    const file = event.target.files[0];
    if (file) {
      // Handle file upload
      console.log('File selected:', file.name);
      // Implement file upload logic
    }
  };
  input.click();
}

function startNewConversation() {
  // Open modal or redirect to supplier search
  window.location.href = '/all-product';
}

function viewSupplierProfile() {
  // Open supplier profile in new tab
  window.open('/supplier/profile', '_blank');
}

function requestQuote() {
  // Open quote request modal or page
  window.location.href = '/buyer/quote-request';
}

// Search conversations
document.getElementById('conversationSearch').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const conversations = document.querySelectorAll('.conversation-item');
  
  conversations.forEach(conversation => {
    const supplierName = conversation.querySelector('.supplier-name').textContent.toLowerCase();
    const lastMessage = conversation.querySelector('.last-message').textContent.toLowerCase();
    
    if (supplierName.includes(searchTerm) || lastMessage.includes(searchTerm)) {
      conversation.style.display = 'flex';
    } else {
      conversation.style.display = 'none';
    }
  });
});

// Auto-scroll to bottom of messages
document.addEventListener('DOMContentLoaded', function() {
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.scrollTop = chatMessages.scrollHeight;
});
</script>

<!-- Buyer Token Manager -->
<script src="/js/buyer/buyer-token-manager.js"></script>

<%- include('../partials/footer') %>
