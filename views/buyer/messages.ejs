<%- include('../partials/header', { title: t('messages.pageTitle'), lng: lng || 'uz', user: user }) %>
<%- include('../partials/navigation', { 
  cartItemsCount: cartItemsCount, 
  activeOrdersCount: activeOrdersCount, 
  unreadMessagesCount: unreadMessagesCount,
  favoritesCount: favoritesCount 
}) %>

<!-- Professional B2B Messages CSS -->
<link rel="stylesheet" href="/css/form-validation.css">
<link rel="stylesheet" href="/css/toast-notifications.css">

<style>
/* ===============================================
   PROFESSIONAL B2B MESSAGES - BUYER PROFILE STYLE
   =============================================== */

/* ===============================================
   SLEX DESIGN SYSTEM INTEGRATION - EXACT PROFILE MATCH
   =============================================== */

/* Profile page classes uchun moslashuv */
.admin-content .section-bg {
  background: hsl(var(--section-bg));
  padding: 0.5rem;
  border-radius: 20px;
  border: 1px solid hsl(var(--border-color));
  box-shadow: var(--box-shadow);
}

.text-heading {
  color: hsl(var(--heading-color));
}

.text-main {
  color: #ffffff !important;
}

.bg-main {
  background: hsl(var(--main));
}

.hover-bg-main:hover {
  background: hsla(var(--main), 0.1);
}

/* Professional B2B Chat Header Styles */
.b2b-business-header {
  margin-bottom: 0;
}

.b2b-header-breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
}

.b2b-breadcrumb-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 14px;
  color: hsl(var(--body-color));
  text-decoration: none;
  border: 1px solid hsl(var(--border-color));
  transition: all 0.3s ease;
}

.b2b-breadcrumb-item:hover {
  color: hsl(var(--main));
  border-color: hsl(var(--main));
}

.b2b-breadcrumb-separator {
  color: hsl(var(--body-color));
  opacity: 0.5;
}

.b2b-header-main {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 24px;
}

.b2b-business-info {
  display: flex;
  align-items: center;
  gap: 16px;
}

/* Telegram-style conversation hover effects */
.conversation-item {
  transition: all 0.3s ease;
}

.conversation-item:hover {
  background: #111827 !important;
}

.conversation-item.active {
  background: hsl(var(--main-l-100)) !important;
  border-left: 3px solid #ff6a00;
}

[data-theme="dark"] .conversation-item.active {
  background: hsl(var(--main-l-50)) !important;
}

.conversation-item.current-manufacturer {
  border-width: 2px !important;
  box-shadow: 0 4px 12px hsla(var(--main), 0.2) !important;
}

 .current-badge {
   background: hsl(var(--main));
   color: white;
   font-size: 10px;
   padding: 2px 6px;
   border-radius: 8px;
   margin-left: 8px;
   font-weight: 600;
   text-transform: uppercase;
   letter-spacing: 0.5px;
   flex-shrink: 0;
   white-space: nowrap;
 }

/* Quick action button hover effects */
.quick-action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px hsla(var(--main), 0.25);
}

.quick-action-btn:hover:not(:first-child) {
  border-color: hsl(var(--main));
  background: hsl(var(--main-l-50));
}

/* Telegram-style attachment menu hover effects */
.telegram-menu-item:hover {
  background: hsl(var(--section-bg)) !important;
  transform: translateX(4px);
}

.telegram-attachment-btn:hover {
  border-color: hsl(var(--main)) !important;
  color: hsl(var(--main)) !important;
  transform: scale(1.05);
}

 /* Professional Chat Layout - Fixed Structure */
 .telegram-chat-layout {
   display: grid;
   grid-template-columns: 380px 1fr;
   gap: 0;
   height: calc(100vh - 160px);
   min-height: 900px;
   border-radius: 16px;
   overflow: hidden;
   background: hsl(var(--white));
   box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
   border: 1px solid hsl(var(--border-color));
 }

 /* Responsive sidebar width */
 @media (max-width: 1200px) {
   .telegram-chat-layout {
     grid-template-columns: 300px 1fr;
   }
 }

 @media (max-width: 768px) {
   .telegram-chat-layout {
     grid-template-columns: 280px 1fr;
   }
 }

 /* Conversations Sidebar - Left Panel */
 .conversations-sidebar {
   background: hsl(var(--section-bg));
   border-right: 1px solid hsl(var(--border-color));
   display: flex;
   flex-direction: column;
   overflow: hidden;
  height: 100%;
 }

 .sidebar-header {
   padding: 20px;
   border-bottom: 1px solid hsl(var(--border-color));
 }

 .sidebar-search {
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}

 

 .conversations-list {
   flex: 1;
   overflow-y: auto;
   overflow-x: hidden;
   width: 100%;
   padding-right: 4px;
 }

/* Main Chat Area - Right Panel Structure */
.chat-main-area {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: hsl(var(--white));
  position: relative;
 }

.conversation-item {
   padding: 16px 20px;
   border-bottom: 1px solid hsl(var(--border-color));
   cursor: pointer;
   transition: all 0.3s ease;
   width: 100%;
   box-sizing: border-box;
   overflow: hidden;
 }

 .conversation-content {
   display: flex;
   align-items: flex-start;
   gap: 12px;
   width: 100%;
   min-width: 0;
 }

 .conversation-avatar {
  position: relative;
}

 .conversation-avatar img {
   width: 48px;
   height: 48px;
   border-radius: 12px;
  object-fit: cover;
}

 .conversation-status {
   width: 12px;
   height: 12px;
   border: 2px solid white;
  border-radius: 50%;
   position: absolute;
   bottom: -2px;
   right: -2px;
 }

 .conversation-status.online {
   background: #22c55e;
 }

 .conversation-status.away {
   background: #f59e0b;
 }

 .conversation-status.offline {
   background: #6b7280;
}

/* Logo Placeholder Styles */
.logo-placeholder {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: hsl(var(--border-color));
  display: flex;
  align-items: center;
  justify-content: center;
  color: hsl(var(--body-color));
  opacity: 0.6;
}

.logo-placeholder i {
  font-size: 18px;
}

.conversation-info {
  flex: 1;
  min-width: 0;
}

.conversation-details {
  flex: 1;
  min-width: 0;
  overflow: hidden;
}

 .conversation-header {
   display: flex;
   justify-content: space-between;
   align-items: center;
   margin-bottom: 4px;
   min-width: 0;
 }

 .conversation-name {
   margin: 0;
   font-size: 14px;
   font-weight: 600;
   white-space: nowrap;
   overflow: hidden;
   text-overflow: ellipsis;
   flex: 1;
   min-width: 0;
   margin-right: 8px;
 }

 .conversation-time {
   font-size: 12px;
   font-weight: 500;
   flex-shrink: 0;
   white-space: nowrap;
 }

 .conversation-time.active {
   color: hsl(var(--main));
 }

 .conversation-time.inactive {
   color: hsl(var(--body-color));
 }

 .conversation-preview {
   margin: 0;
   font-size: 13px;
   color: hsl(var(--body-color));
   white-space: nowrap;
   overflow: hidden;
   text-overflow: ellipsis;
   min-width: 0;
   flex: 1;
 }

 .conversation-footer {
   display: flex;
   justify-content: space-between;
   align-items: center;
   margin-top: 4px;
 }

 .conversation-meta {
   display: flex;
   justify-content: space-between;
   align-items: center;
   margin-top: 4px;
   min-width: 0;
   flex: 1;
 }

 .order-info {
   font-size: 11px;
   color: hsl(var(--body-color));
   opacity: 0.7;
   white-space: nowrap;
   overflow: hidden;
   text-overflow: ellipsis;
   flex: 1;
   min-width: 0;
   margin-right: 8px;
 }

 .status-badge {
   font-size: 10px;
   padding: 2px 6px;
   border-radius: 8px;
   font-weight: 500;
   flex-shrink: 0;
   white-space: nowrap;
 }

 .conversation-last-msg {
   font-size: 11px;
   color: hsl(var(--body-color));
   opacity: 0.7;
 }

 .conversation-unread {
   background: hsl(var(--main));
   color: white;
   border-radius: 10px;
   padding: 2px 6px;
   font-size: 11px;
   font-weight: 500;
 }

 .last-message-unread-badge {
   background: red;
   color: white;
   border-radius: 10px;
   padding: 2px 6px;
   font-size: 11px;
   font-weight: 500;
   margin-left: 8px;
   flex-shrink: 0;
 }

/* Chat Main Area - Override previous styles */
 .chat-main-area {
  background: hsl(var(--white)) !important;
  display: flex !important;
  flex-direction: column !important;
  height: 100% !important;
  position: relative !important;
}

/* Chat Header - Fixed at Top */
 .chat-header-enhanced {
   padding: 20px 24px;
   border-bottom: 1px solid hsl(var(--border-color));
  background: hsl(var(--white));
  flex-shrink: 0;
  z-index: 10;
 }

 .chat-header-content {
   display: flex;
  align-items: center;
   justify-content: space-between;
 }

 .chat-header-left {
   display: flex;
   align-items: center;
   gap: 16px;
 }

 .chat-header-avatar {
   position: relative;
 }

 .chat-header-avatar img {
   width: 48px;
   height: 48px;
   border-radius: 12px;
   object-fit: cover;
 }

 .chat-header-status {
   width: 12px;
   height: 12px;
   background: #22c55e;
   border: 2px solid white;
   border-radius: 50%;
   position: absolute;
   bottom: -2px;
   right: -2px;
 }

 .chat-header-title {
   margin: 0 0 4px 0;
   font-size: 18px;
  font-weight: 600;
 }

 .chat-header-meta {
   display: flex;
   align-items: center;
   gap: 16px;
   font-size: 13px;
   color: hsl(var(--body-color));
 }

 .chat-subtitle {
   font-size: 14px;
   color: hsl(var(--body-color));
   opacity: 0.8;
 }

 .chat-header-meta span {
   display: flex;
   align-items: center;
   gap: 4px;
}

.online-indicator {
   width: 6px;
   height: 6px;
   background: #22c55e;
   border-radius: 50%;
 }

 .chat-header-actions {
   display: flex;
   gap: 8px;
 }

 .chat-action-btn {
   padding: 8px 12px;
   border: 1px solid hsl(var(--border-color));
   background: hsl(var(--white));
   border-radius: 8px;
   cursor: pointer;
   display: flex;
   align-items: center;
   gap: 6px;
   color: hsl(var(--body-color));
   font-size: 13px;
 }

  /* Messages Container - Professional Chat Style */
 .messages-container {
  flex: 1;
   padding: 20px 0;
   overflow-y: auto;
   overflow-x: hidden;
   display: flex;
   flex-direction: column;
   background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
   position: relative;
   height: auto;
   min-height: 0;
 }

 .messages-container::before {
   content: '';
   position: absolute;
   top: 0;
   left: 0;
   right: 0;
   height: 1px;
   background: linear-gradient(90deg, transparent 0%, rgba(0, 0, 0, 0.05) 50%, transparent 100%);
   z-index: 1;
 }

 /* Dark mode support for messages container */
 [data-theme="light"] .messages-container {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
 }

 .welcome-state {
   text-align: center;
   max-width: 500px;
   padding: 40px 20px;
   position: absolute;
   top: 50%;
   left: 50%;
   transform: translate(-50%, -50%);
   width: 100%;
   backdrop-filter: blur(10px);
   border-radius: 20px;
   box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
   border: 1px solid rgba(255, 255, 255, 0.2);
 }

/* Production-Ready Enterprise-Grade Telegram-Style Professional Chat */
.telegram-chat-container {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  min-height: 100%;
  position: relative;
  overflow: hidden;
}

.telegram-chat-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, rgba(0, 0, 0, 0.05) 50%, transparent 100%);
  z-index: 1;
}

.telegram-chat-container::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, rgba(0, 0, 0, 0.03) 50%, transparent 100%);
  z-index: 1;
}

.telegram-date-separator {
  text-align: center;
  margin: 24px 0 16px 0;
  position: relative;
  z-index: 2;
  flex-shrink: 0;
}

.telegram-date-separator::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 24px;
  right: 24px;
  height: 1px;
  background: linear-gradient(90deg, transparent 0%, rgba(0, 0, 0, 0.08) 50%, transparent 100%);
}

.telegram-date-separator span {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  padding: 8px 16px;
  border-radius: 16px;
  font-size: 12px;
  font-weight: 600;
  color: #475569;
  position: relative;
  z-index: 2;
  border: 1px solid rgba(0, 0, 0, 0.06);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.telegram-date-separator span:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  border-color: rgba(0, 0, 0, 0.1);
}

.telegram-message {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
  padding: 0 20px;
  position: relative;
  animation: messageSlideIn 0.3s ease-out;
  flex-shrink: 0;
}

/* Manufacturer messages - with avatar on left */
.telegram-message:not(.own) {
  padding-left: 20px;
  padding-right: 60px; /* Extra space for better alignment */
}

@keyframes messageSlideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.telegram-message.own {
  flex-direction: row-reverse;
  padding-right: 20px;
  padding-left: 60px; /* Extra space since no avatar */
}

.telegram-message-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  flex-shrink: 0;
  overflow: hidden;
  border: 2px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.telegram-message-avatar::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: 50%;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.telegram-message-avatar:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.telegram-message-avatar:hover::before {
  opacity: 1;
}

.telegram-message-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: all 0.3s ease;
}

.telegram-message-content {
  max-width: 70%;
  position: relative;
  transition: all 0.3s ease;
}

/* Base message bubble styling - specific styles now in dark mode section above */
.telegram-message-bubble {
  border-radius: 20px;
  padding: 12px 16px;
  position: relative;
  word-wrap: break-word;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.telegram-message-bubble::before {
  content: '';
  position: absolute;
  width: 0;
  height: 0;
  transition: all 0.3s ease;
  z-index: 1;
}

/* Manufacturer message tail - yuqorida (logo tomon) */
.telegram-message:not(.own) .telegram-message-bubble::before {
  left: -8px;
  top: 14px;  /* Yuqori qismida */
  border-top: 8px solid transparent;
  border-bottom: 8px solid transparent;
  border-right: 8px solid #8fc7ff;  /* Triangle asosiy qismi */
}

/* Buyer message tail - pastda */
.telegram-message.own .telegram-message-bubble::before {
  right: -7px;
  bottom: 11px;  /* Pastki qismida */
  border-top: 8px solid transparent;
  border-bottom: 8px solid transparent;
  border-left: 8px solid #333740;  /* Triangle asosiy qismi */
}

.telegram-message-time {
  color: inherit;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 4px;
}

.telegram-message-time::before {
  content: '🕐';
  font-size: 10px;
  opacity: 0.7;
}

.telegram-message-status {
  display: flex;
  align-items: center;
  gap: 3px;
  transition: all 0.3s ease;
}

.telegram-message-status i {
  font-size: 11px;
  transition: all 0.3s ease;
}

.telegram-status-read {
  color: #10b981;
  animation: statusPulse 2s infinite;
}

.telegram-status-delivered {
  color: #f59e0b;
}

.telegram-status-sent {
  color: #9ca3af;
}

@keyframes statusPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* Advanced Message Grouping with Smart Spacing */
.telegram-message + .telegram-message {
  margin-top: 4px;
}

.telegram-message + .telegram-message.own {
  margin-top: 4px;
}

/* Keep avatars visible for all manufacturer messages */
.telegram-message + .telegram-message.own .telegram-message-avatar {
  visibility: hidden;
  opacity: 0;
  transition: all 0.3s ease;
}

/* Keep tails visible for all messages for Telegram authenticity */

/* Production-Ready Message Typing Indicator */
.telegram-typing-indicator {
  display: flex;
  gap: 4px;
  padding: 12px 20px;
  align-items: center;
  animation: typingSlideIn 0.3s ease-out;
}

@keyframes typingSlideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.typing-dots {
  display: flex;
  gap: 4px;
  align-items: center;
}

.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #9ca3af;
  animation: typingBounce 1.4s infinite ease-in-out;
  transition: all 0.3s ease;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
.typing-dot:nth-child(3) { animation-delay: 0s; }

@keyframes typingBounce {
  0%, 80%, 100% { 
    transform: scale(0.8); 
    opacity: 0.5; 
    background: #9ca3af;
  }
  40% { 
    transform: scale(1); 
    opacity: 1; 
    background: #6b7280;
  }
}

/* Responsive Design */
@media (max-width: 768px) {
  .telegram-message {
    padding: 0 12px;
    gap: 8px;
  }
  
  .telegram-message-content {
    max-width: 80%;
  }
  
  .telegram-date-separator span {
    padding: 6px 12px;
    font-size: 11px;
  }
}

/* ========================================
   PROFESSIONAL CHAT LAYOUT DEBUG FIXES
   ======================================== */

/* Ensure proper flex layout */
.chat-main-area {
  min-height: 0 !important;
  max-height: 100% !important;
}

.messages-container {
  /* Override any conflicting styles */
  overflow-y: auto !important;
  overflow-x: hidden !important;
  flex-grow: 1 !important;
  flex-shrink: 1 !important;
}

.b2b-message-input-area {
  /* Ensure input area stays at bottom */
  margin-top: auto !important;
  flex-shrink: 0 !important;
}

/* ========================================
   MESSAGE DATE GROUPS FOR SCROLLING
   ======================================== */

/* Message date group container */
.message-date-group {
  margin-bottom: 20px;
  flex-shrink: 0;
  width: 100%;
}

/* ========================================
   TELEGRAM-STYLE DARK MODE SUPPORT 
   Professional B2B Dark Theme
   ======================================== */

/* Dark Mode Container Backgrounds */
[data-theme="dark"] .telegram-chat-container {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  }
  
[data-theme="dark"] .messages-container::before {
  background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);
}

/* Dark Mode Date Separators */
[data-theme="light"] .telegram-date-separator span {
  background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
  color: #d1d5db;
  border-color: rgba(255, 255, 255, 0.15);
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
}

[data-theme="dark"] .telegram-date-separator::before {
  background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.08) 50%, transparent 100%);
}

/* ========================================
   MANUFACTURER MESSAGES (Received - Left side)
   Light Gray/White Theme - Chap tomonda manufacturer
   ======================================== */

/* Light Mode - Manufacturer Messages (kelayotgan xabarlar) */
.telegram-message:not(.own) .telegram-message-bubble {
  background: linear-gradient(135deg, #8fc7ff 0%, #91c8ff 100%);
  color: #1f2937;
  border: 1px solid rgba(0, 0, 0, 0.06);
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.telegram-message:not(.own) .telegram-message-bubble:hover {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
  transform: translateY(-1px);
}

/* Manufacturer tail color now set inline in main rule */

/* Dark Mode - Manufacturer Messages */
[data-theme="light"] .telegram-message:not(.own) .telegram-message-bubble {
  background: linear-gradient(135deg, #01307b 0%, #023d8e 100%);
  color: hsl(var(--body-color));
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
}

[data-theme="dark"] .telegram-message:not(.own) .telegram-message-bubble:hover {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  border-color: rgba(255, 255, 255, 0.15);
}

[data-theme="light"] .telegram-message:not(.own) .telegram-message-bubble::before {
  border-right: 8px solid #01307b !important;  /* Override light mode tail color */
  filter: drop-shadow(-2px 0 4px rgba(0, 0, 0, 0.3));
}

/* ========================================
   BUYER MESSAGES (Sent/Own - Right side)
   Blue Theme - O'ng tomonda buyer (o'zingiz)
   ======================================== */

/* Light Mode - Buyer Messages (yuborgan xabarlar - o'zingiz) */
.telegram-message.own .telegram-message-bubble {
  background: linear-gradient(135deg, #333740 0%, #222e3e 100%);
  border: 1px solid rgba(59, 130, 246, 0.2);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.25);
}

.telegram-message.own .telegram-message-bubble:hover {
  box-shadow: 0 6px 24px rgba(59, 130, 246, 0.35);
  transform: translateY(-1px) scale(1.01);
}

/* Buyer tail color now set inline in main rule */

/* Dark Mode - Buyer Messages */
[data-theme="dark"] .telegram-message.own .telegram-message-bubble {
  background: linear-gradient(135deg, #d9d9d9 0%, #e2e2e2 100%);
  border: 1px solid rgba(37, 99, 235, 0.3);
  box-shadow: 0 4px 16px rgba(37, 99, 235, 0.4);
}

[data-theme="dark"] .telegram-message.own .telegram-message-bubble:hover {
  box-shadow: 0 6px 24px rgba(37, 99, 235, 0.5);
  border-color: rgba(37, 99, 235, 0.4);
}

[data-theme="dark"] .telegram-message.own .telegram-message-bubble::before {
  border-left: 8px solid #d9d9d9 !important;  /* Override light mode tail color */
  filter: drop-shadow(2px 0 4px rgba(37, 99, 235, 0.4));
}

/* ========================================
   MESSAGE TEXT AND CONTENT
   ======================================== */

/* Message Text Colors */
.telegram-message-text {
  font-size: 14px;
  line-height: 1.5;
  margin: 0;
  font-weight: 400;
  letter-spacing: 0.01em;
}

/* Manufacturer message text (already inherit color from bubble) */
[data-theme="dark"] .telegram-message:not(.own) .telegram-message-text {
  color: rgba(0, 0, 0, 0.6);
}

/* ========================================
   MESSAGE FOOTER AND TIMESTAMPS
   ======================================== */

/* Message Footer */
.telegram-message-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 6px;
  font-size: 11px;
  opacity: 0.7;
  transition: opacity 0.3s ease;
}

.telegram-message-bubble:hover .telegram-message-footer {
  opacity: 0.9;
}

/* Time stamps for manufacturer messages */
.telegram-message:not(.own) .telegram-message-time {
  color: rgba(0, 0, 0, 0.6);
}

[data-theme="light"] .telegram-message:not(.own) .telegram-message-time {
  color: hsl(var(--body-color));
}

/* Time stamps for buyer messages */
.telegram-message.own .telegram-message-time {
  color: #ffffff;
}

[data-theme="dark"] .telegram-message.own .telegram-message-time {
  color: #4a4a4a;
}

/* ========================================
   MESSAGE ATTACHMENTS
   ======================================== */

/* Image Attachments */
.telegram-attachment-image {
  border-radius: 12px;
  overflow: hidden;
  margin-top: 8px;
  max-width: 300px;
  position: relative;
  cursor: pointer;
  transition: all 0.3s ease;
}

.telegram-attachment-image:hover {
  transform: scale(1.02);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.telegram-attachment-image img {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 12px;
}

.telegram-image-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
  border-radius: 12px;
}

.telegram-attachment-image:hover .telegram-image-overlay {
  opacity: 1;
}

.telegram-image-overlay i {
  color: white;
  font-size: 24px;
}

/* File Attachments */
.telegram-attachment-file {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: rgba(0, 0, 0, 0.05);
  border-radius: 12px;
  margin-top: 8px;
  transition: all 0.3s ease;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.telegram-attachment-file:hover {
  background: rgba(0, 0, 0, 0.08);
  transform: translateY(-1px);
}


[data-theme="dark"] .telegram-attachment-file:hover {
  background: rgba(255, 255, 255, 0.15);
}

.telegram-file-icon {
  width: 40px;
  height: 40px;
  border: 1px solid #c9c6c6;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(0, 0, 0, 0.6);
  font-size: 16px;
  flex-shrink: 0;
}

.telegram-file-details h6 {
  margin: 0;
  font-size: 13px;
  font-weight: 600;
  color: inherit;
}

.telegram-file-details p {
  margin: 0;
  font-size: 11px;
  opacity: 0.7;
  color: inherit;
}

.telegram-file-download {
  padding: 8px;
  background: rgba(0, 0, 0, 0.1);
  border-radius: 6px;
  color: inherit;
  text-decoration: none;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.telegram-file-download:hover {
  background: rgba(0, 0, 0, 0.2);
  transform: scale(1.1);
  color: inherit;
}


[data-theme="dark"] .telegram-file-download:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* ========================================
   MESSAGE AVATARS
   ======================================== */

/* Avatar styling for dark mode */
[data-theme="dark"] .telegram-message-avatar {
  border-color: rgba(255, 255, 255, 0.2);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

[data-theme="dark"] .telegram-message-avatar:hover {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
}

/* Fallback avatar colors */
.avatar-placeholder {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  font-weight: 600;
}

[data-theme="dark"] .avatar-placeholder {
  background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
}

/* ========================================
   RESPONSIVE DESIGN
   ======================================== */

/* Mobile responsiveness */
@media (max-width: 768px) {
  .telegram-message-content {
    max-width: 85%;
  }
  
  .telegram-attachment-image {
    max-width: 250px;
  }
  
  .telegram-message-text {
    font-size: 13px;
  }
  
  .telegram-message-bubble {
    padding: 10px 14px;
  }
  
  /* Reduced padding for mobile */
  .telegram-message:not(.own) {
    padding-right: 40px;
  }
  
  .telegram-message.own {
    padding-left: 40px;
  }
 }

  .welcome-icon {
   width: 120px;
   height: 120px;
   background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
   border-radius: 50%;
   display: flex;
   align-items: center;
   justify-content: center;
   margin: 0 auto 32px;
   box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
   border: 4px solid rgba(255, 255, 255, 0.2);
   position: relative;
   overflow: hidden;
 }

 .welcome-icon::before {
   content: '';
   position: absolute;
   top: -50%;
   left: -50%;
   width: 200%;
   height: 200%;
   background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
   animation: shimmer 3s infinite;
 }

 @keyframes shimmer {
   0% {
     transform: rotate(0deg);
   }
   100% {
     transform: rotate(360deg);
   }
 }

 .welcome-icon i {
   font-size: 48px;
   color: white;
   filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
   z-index: 2;
   position: relative;
 }

[data-theme="light"] .welcome-title {
  -webkit-text-fill-color: #ffffff !important;
}

 .welcome-title {
   margin: 0 0 16px 0;
   font-size: 28px;
   font-weight: 700;
   background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
   -webkit-background-clip: text;
   -webkit-text-fill-color: transparent;
   background-clip: text;
   color: transparent;
 }

 .welcome-description {
   color: #64748b;
   margin-bottom: 32px;
   font-size: 18px;
   line-height: 1.6;
   font-weight: 500;
   opacity: 0.95;
 }

 /* Dark mode support for welcome description */
 [data-theme="dark"] .welcome-description {
   opacity: 0.8;
 }



 .quick-actions-grid {
   display: grid;
   grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
   gap: 16px;
   margin-bottom: 32px;
 }

 .quick-action-btn {
   padding: 20px;
   border: none;
   border-radius: 12px;
   cursor: pointer;
   text-align: left;
   transition: all 0.3s ease;
 }

 .quick-action-btn.primary {
   background: hsl(var(--main));
   /* color: white; */
   box-shadow: 0 4px 12px hsla(var(--main), 0.2);
 }

 .quick-action-btn.secondary {
   background: hsl(var(--white));
   color: hsl(var(--heading-color));
   border: 2px solid hsl(var(--main));
   box-shadow: 0 2px 8px hsla(var(--main), 0.1);
 }

 .quick-action-btn.tertiary {
   background: hsl(var(--white));
   color: hsl(var(--heading-color));
   border: 2px solid hsl(var(--border-color));
   box-shadow: 0 2px 8px hsla(0, 0%, 0%, 0.05);
 }

 /* Dark mode support for quick action buttons */
 [data-theme="dark"] .quick-action-btn.secondary {
   background: hsl(var(--section-bg));
   color: hsl(var(--heading-color));
   border: 2px solid hsl(var(--main));
   box-shadow: 0 2px 8px hsla(var(--main), 0.2);
 }

 [data-theme="dark"] .quick-action-btn.tertiary {
   background: hsl(var(--section-bg));
   color: hsl(var(--heading-color));
   border: 2px solid hsl(var(--border-color));
   box-shadow: 0 2px 8px hsla(0, 0%, 0%, 0.3);
 }

 .quick-action-content {
  display: flex;
  align-items: center;
   gap: 12px;
   margin-bottom: 8px;
}

 .quick-action-icon {
  width: 40px;
  height: 40px;
   border-radius: 8px;
   display: flex;
   align-items: center;
   justify-content: center;
 }

 .quick-action-icon.primary {
   background: rgba(255,255,255,0.2);
 }

 .quick-action-icon.secondary,
 .quick-action-icon.tertiary {
   background: hsl(var(--main-l-100));
 }

 /* Dark mode support for quick action icons */
 [data-theme="dark"] .quick-action-icon.secondary,
 [data-theme="dark"] .quick-action-icon.tertiary {
   background: hsla(var(--main), 0.2);
 }

 .quick-action-icon i {
   font-size: 18px;
 }

 .quick-action-icon.primary i {
   color: white;
 }

 .quick-action-icon.secondary i,
 .quick-action-icon.tertiary i {
   color: hsl(var(--main));
 }

 .quick-action-title {
   margin: 0;
   font-size: 16px;
  font-weight: 600;
 }

 .quick-action-title.primary {
   color: white;
 }

 .quick-action-title.secondary,
 .quick-action-title.tertiary {
   color: hsl(var(--heading-color));
 }

 .quick-action-description {
   margin: 0;
   font-size: 14px;
   line-height: 1.4;
 }

 .quick-action-description.primary {
   color: rgba(255,255,255,0.9);
 }

 .quick-action-description.secondary,
 .quick-action-description.tertiary {
   color: hsl(var(--body-color));
 }

 /* Message Input Area - Fixed at Bottom */
 .b2b-message-input-area {
   padding: 16px 24px;
   border-top: 1px solid hsl(var(--border-color));
   background: hsl(var(--white));
   box-shadow: 0 -2px 8px hsla(0, 0%, 0%, 0.05);
   flex-shrink: 0;
   position: relative;
   z-index: 5;
 }

 /* Dark mode support for input area */
 [data-theme="dark"] .b2b-message-input-area {
   background: hsl(var(--section-bg));
   box-shadow: 0 -2px 8px hsla(0, 0%, 0%, 0.3);
 }

 .b2b-input-wrapper {
   position: relative;
   display: flex;
   align-items: flex-end;
   gap: 12px;
 }

 .message-input-container {
   flex: 1;
   position: relative;
 }

 .b2b-message-input {
   width: 100%;
   min-height: 44px;
   max-height: 120px;
   padding: 12px 16px;
   border: 1px solid hsl(var(--border-color));
   border-radius: 12px;
   background: hsl(var(--white));
   color: hsl(var(--heading-color));
   font-size: 14px;
   font-family: inherit;
   resize: none;
   line-height: 1.4;
   transition: all 0.3s ease;
   box-shadow: 0 2px 8px hsla(0, 0%, 0%, 0.05);
   overflow: hidden;
 }

 .b2b-message-input:focus {
   outline: none;
   border-color: hsl(var(--main));
   box-shadow: 0 4px 12px hsla(var(--main), 0.15);
   background: hsl(var(--white));
 }

 /* Dark mode support for message input */
 [data-theme="dark"] .b2b-message-input {
   background: hsl(var(--section-bg));
   border-color: hsl(var(--border-color));
   color: hsl(var(--heading-color));
   box-shadow: 0 2px 8px hsla(0, 0%, 0%, 0.3);
 }

 [data-theme="dark"] .b2b-message-input:focus {
   background: hsl(var(--section-bg));
   border-color: hsl(var(--main));
   box-shadow: 0 4px 12px hsla(var(--main), 0.25);
 }

 .input-actions {
   display: flex;
   gap: 8px;
 }

 .telegram-attachment-wrapper {
   position: relative;
 }

  .telegram-attachment-btn {
   width: 44px;
   height: 44px;
   border: 1px solid hsl(var(--border-color));
   background: hsl(var(--white));
   border-radius: 12px;
   display: flex;
   align-items: center;
   justify-content: center;
   cursor: pointer;
   color: hsl(var(--body-color));
   transition: all 0.3s ease;
   box-shadow: 0 2px 8px hsla(0, 0%, 0%, 0.05);
 }

 .telegram-attachment-btn:hover {
   border-color: hsl(var(--main));
   color: hsl(var(--main));
   transform: scale(1.05);
   box-shadow: 0 4px 12px hsla(var(--main), 0.2);
 }

 /* Dark mode support for attachment button */
 [data-theme="dark"] .telegram-attachment-btn {
   background: hsl(var(--section-bg));
   border-color: hsl(var(--border-color));
   box-shadow: 0 2px 8px hsla(0, 0%, 0%, 0.3);
 }

 [data-theme="dark"] .telegram-attachment-btn:hover {
   border-color: hsl(var(--main));
   color: hsl(var(--main));
   box-shadow: 0 4px 12px hsla(var(--main), 0.3);
 }

 .telegram-attachment-menu {
   position: absolute;
   bottom: 60px;
   left: -40px;
   background: hsl(var(--white));
   border: 1px solid hsl(var(--border-color));
   border-radius: 12px;
   box-shadow: 0 8px 32px hsla(0, 0%, 0%, 0.15);
   padding: 8px;
   min-width: 160px;
   opacity: 0;
   visibility: hidden;
   transform: translateY(10px);
   transition: all 0.3s ease;
   z-index: 10;
   backdrop-filter: blur(10px);
 }

 .telegram-attachment-menu.show {
   opacity: 1;
   visibility: visible;
   transform: translateY(0);
 }

 /* Dark mode support for attachment menu */
 [data-theme="dark"] .telegram-attachment-menu {
   background: hsl(var(--section-bg));
   border-color: hsl(var(--border-color));
   box-shadow: 0 8px 32px hsla(0, 0%, 0%, 0.5);
 }

  .telegram-menu-item {
   width: 100%;
   padding: 10px 12px;
   border: none;
   background: none;
   border-radius: 8px;
   cursor: pointer;
   display: flex;
   align-items: center;
   gap: 10px;
   font-size: 14px;
   color: hsl(var(--heading-color));
   transition: all 0.2s ease;
 }

 .telegram-menu-item:hover {
   background: hsl(var(--section-bg));
   transform: translateX(4px);
 }

 /* Dark mode support for menu items */
 [data-theme="dark"] .telegram-menu-item:hover {
   background: hsla(var(--main), 0.1);
 }

 .menu-item-icon {
   width: 32px;
   height: 32px;
   border-radius: 8px;
   display: flex;
   align-items: center;
   justify-content: center;
 }

 .menu-item-icon.file {
   background: #3b82f6;
 }

 .menu-item-icon.image {
   background: #10b981;
 }

 .menu-item-icon.emoji {
   background: #f59e0b;
 }

 .menu-item-icon i {
   color: white;
   font-size: 14px;
 }

  .b2b-send-button {
   width: 44px;
   height: 44px;
   background: hsl(var(--main));
   color: white;
   border: none;
   border-radius: 12px;
   display: flex;
   align-items: center;
   justify-content: center;
   cursor: pointer;
   opacity: 0.5;
   transition: all 0.3s ease;
   box-shadow: 0 2px 8px hsla(var(--main), 0.3);
 }

 .b2b-send-button:not(:disabled) {
   opacity: 1;
 }

 .b2b-send-button:not(:disabled):hover {
   transform: scale(1.05);
   box-shadow: 0 4px 16px hsla(var(--main), 0.4);
 }

 /* Dark mode support for send button */
 [data-theme="dark"] .b2b-send-button {
   box-shadow: 0 2px 8px hsla(var(--main), 0.4);
 }

 [data-theme="dark"] .b2b-send-button:not(:disabled):hover {
   box-shadow: 0 4px 16px hsla(var(--main), 0.5);
 }

 .b2b-input-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
   margin-top: 8px;
   padding: 0 4px;
}

 .b2b-char-counter {
  display: flex;
  align-items: center;
   gap: 4px;
   font-size: 11px;
   color: hsl(var(--body-color));
   opacity: 0.7;
 }

 .b2b-input-hints {
   display: flex;
   gap: 12px;
   font-size: 11px;
   color: hsl(var(--body-color));
   opacity: 0.7;
 }

 .hint-kbd {
   background: hsl(var(--section-bg));
   padding: 2px 4px;
   border-radius: 4px;
   font-size: 10px;
   border: 1px solid hsl(var(--border-color));
 }

 /* Dark mode support for hint keyboards */
 [data-theme="dark"] .hint-kbd {
   background: hsla(var(--main), 0.1);
   border-color: hsl(var(--border-color));
   color: hsl(var(--heading-color));
 }

 /* No conversations state */
 .no-conversations {
   text-align: center;
   padding: 40px 20px;
   color: hsl(var(--body-color));
 }

/* No search results state */
.no-search-results {
  text-align: center;
  padding: 40px 20px;
  color: hsl(var(--body-color));
}

.no-search-results-icon {
  width: 80px;
  height: 80px;
  background: hsl(var(--main-l-100));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
  font-size: 32px;
  color: hsl(var(--main));
}

.no-search-results h4 {
  margin: 0 0 12px 0;
  color: hsl(var(--heading-color));
  font-size: 18px;
}

.no-search-results p {
  margin: 0 0 20px 0;
  font-size: 14px;
  opacity: 0.8;
}

.clear-search-btn {
  background: hsl(var(--main));
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.clear-search-btn:hover {
  background: hsl(var(--main-dark));
}

 .no-conversations-icon {
   width: 80px;
   height: 80px;
   background: hsl(var(--main-l-100));
   border-radius: 50%;
   display: flex;
   align-items: center;
   justify-content: center;
   margin: 0 auto 20px;
   font-size: 32px;
   color: hsl(var(--main));
 }

 .no-conversations h4 {
   margin: 0 0 12px 0;
   color: hsl(var(--heading-color));
   font-size: 18px;
 }

 .no-conversations p {
   margin: 0;
   font-size: 14px;
   opacity: 0.8;
 }

 /* Dark mode support for no conversations */
 [data-theme="dark"] .no-conversations-icon {
   background: hsla(var(--main), 0.2);
 }

 /* Empty conversations state */
 .empty-conversations {
   text-align: center;
   padding: 20px;
   color: hsl(var(--body-color));
   opacity: 0.7;
 }

 .empty-icon {
  width: 40px;
  height: 40px;
   background: hsl(var(--main-l-100));
  border-radius: 50%;
   display: flex;
   align-items: center;
   justify-content: center;
   margin: 0 auto 12px;
   font-size: 18px;
   color: hsl(var(--main));
 }

 .empty-conversations p {
   margin: 0;
   font-size: 13px;
 }

/* ===== TELEGRAM STYLE MESSAGE ATTACHMENTS ===== */
.telegram-message-attachments {
  margin-top: 8px;
}

/* Image Attachment */
.telegram-attachment-image {
  position: relative;
  display: inline-block;
  max-width: 200px;
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.telegram-attachment-image:hover {
  transform: scale(1.02);
}

.telegram-attachment-image img {
  width: 100%;
  height: auto;
  display: block;
}

.telegram-image-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.telegram-attachment-image:hover .telegram-image-overlay {
  opacity: 1;
}

.telegram-image-overlay i {
  color: white;
  font-size: 18px;
}

/* File Attachment */
.telegram-attachment-file {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--telegram-bg-secondary);
  border-radius: 8px;
  border: 1px solid var(--telegram-border);
  max-width: 300px;
}

.telegram-file-details {
  flex: 1;
  min-width: 0;
}

.telegram-file-details h6 {
  margin: 0 0 4px 0;
  font-size: 14px;
  font-weight: 600;
  color: var(--telegram-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.telegram-file-details p {
  margin: 0;
  font-size: 12px;
  color: var(--telegram-text-secondary);
}

.telegram-file-actions {
  display: flex;
  align-items: center;
}

.telegram-file-download {
  width: 32px;
  height: 32px;
  background: var(--telegram-primary);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  transition: background 0.2s ease;
}

.telegram-file-download:hover {
  background: var(--telegram-primary-dark);
  color: white;
}

/* Image Expansion */
.telegram-image-expanded {
  max-width: 400px !important;
  transform: scale(1.1);
}

/* ===== IMAGE MODAL STYLES ===== */
.telegram-image-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(5px);
}





.telegram-modal-content {
  background: #ffffff;
  border-radius: 12px;
  max-width: 90vw;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
  border: 1px solid #e5e7eb;
}

.telegram-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
  position: relative;
}

.zoom-indicator {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
  backdrop-filter: blur(10px);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.zoom-indicator.visible {
  opacity: 1;
}

.telegram-modal-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #111827;
}

.telegram-modal-close {
  background: none;
  border: none;
  color: #6b7280;
  font-size: 18px;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.telegram-modal-close:hover {
  background: #f3f4f6;
  color: #3b82f6;
}

.telegram-modal-body {
  padding: 20px;
  text-align: center;
  max-height: 70vh;
  overflow: hidden;
  position: relative;
  background: #f8f9fa;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.telegram-modal-body img {
  max-width: 85%;
  max-height: 65vh;
  object-fit: contain;
  border-radius: 8px;
  cursor: zoom-in;
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  touch-action: none;
  -webkit-touch-callout: none;
  -webkit-tap-highlight-color: transparent;
}

.telegram-modal-body img.zoomed {
  max-width: none;
  max-height: none;
  width: auto;
  height: auto;
  cursor: grab;
  box-shadow: 0 12px 48px rgba(0, 0, 0, 0.25);
}

.telegram-modal-body img.zoomed:active {
  cursor: grabbing;
}

.telegram-modal-body img.dragging {
  transition: none !important;
  cursor: grabbing !important;
}

.telegram-modal-body img:hover {
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
}

.telegram-modal-body img.zoomed:hover {
  box-shadow: 0 16px 56px rgba(0, 0, 0, 0.3);
}

/* Image controls */
.image-controls {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 8px;
  z-index: 10;
}

.control-btn {
  width: 40px;
  height: 40px;
  border: none;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  backdrop-filter: blur(10px);
}

.control-btn:hover {
  background: rgba(0, 0, 0, 0.9);
  transform: scale(1.1);
}

.control-btn:active {
  transform: scale(0.95);
}

.control-btn i {
  font-size: 14px;
}

/* Dark mode support for controls */
@media (prefers-color-scheme: light) {
  .control-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
  }
  
  .control-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }
}

/* Control button colors */
.control-btn.fit-screen {
  background: rgba(168, 85, 247, 0.8);
}

.control-btn.zoom-in {
  background: rgba(34, 197, 94, 0.8);
}

.control-btn.zoom-out {
  background: rgba(239, 68, 68, 0.8);
}

.control-btn.reset {
  background: rgba(59, 130, 246, 0.8);
}



.telegram-modal-footer {
  padding: 16px 20px;
  border-top: 1px solid #e5e7eb;
  background: #f9fafb;
  text-align: center;
}

.telegram-modal-download {
  background: #3b82f6;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.telegram-modal-download:hover {
  background: #2563eb;
}

/* Modal Animation */
.telegram-image-modal {
  animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Dark Mode Modal Support */
[data-theme="dark"] .telegram-modal-content {
  background: #1f2937;
  border-color: #374151;
}

[data-theme="dark"] .telegram-modal-header {
  background: #111827;
  border-bottom-color: #374151;
}

[data-theme="dark"] .telegram-modal-header h3 {
  color: #f9fafb;
}

[data-theme="dark"] .zoom-indicator {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

[data-theme="dark"] .telegram-modal-close {
  color: #9ca3af;
}

[data-theme="dark"] .telegram-modal-close:hover {
  background: #374151;
  color: #60a5fa;
}

[data-theme="dark"] .telegram-modal-footer {
  background: #111827;
  border-top-color: #374151;
}

/* File-only message info */
.telegram-message-info {
  margin-top: 8px;
  text-align: center;
}

.telegram-file-only {
  color: var(--telegram-text-secondary);
  font-size: 12px;
  font-style: italic;
  opacity: 0.8;
 }

 /* Message image and file styles */
 .message-image img {
   max-width: 200px;
   border-radius: 8px;
   cursor: pointer;
 }

 .message-file {
  display: flex;
  align-items: center;
   gap: 12px;
   padding: 8px;
   background: hsl(var(--section-bg));
   border-radius: 8px;
   border: 1px solid hsl(var(--border-color));
 }

 .file-icon {
   width: 40px;
   height: 40px;
   background: hsl(var(--main));
   color: white;
   border-radius: 6px;
  display: flex;
   align-items: center;
   justify-content: center;
}

 .file-info {
  flex: 1;
 }

 .file-name {
   font-weight: 600;
   font-size: 14px;
   color: hsl(var(--heading-color));
 }

 .file-size {
   font-size: 12px;
   color: hsl(var(--body-color));
   opacity: 0.7;
 }

 .file-download {
   color: hsl(var(--main));
   text-decoration: none;
   padding: 8px;
   border-radius: 4px;
   transition: background 0.2s;
 }

 .file-download:hover {
   background: hsl(var(--main-l-100));
 }

 /* Loading and error states */
 .loading-state, .error-state {
   text-align: center;
   padding: 40px 20px;
   color: hsl(var(--body-color));
 }

 .loading-spinner, .error-icon {
   width: 60px;
   height: 60px;
   background: hsl(var(--main-l-100));
   border-radius: 50%;
  display: flex;
   align-items: center;
   justify-content: center;
   margin: 0 auto 20px;
   font-size: 24px;
   color: hsl(var(--main));
 }

 .error-icon {
   background: rgba(239, 68, 68, 0.1);
   color: #ef4444;
 }

 .loading-state p, .error-state h4 {
   margin: 0 0 12px 0;
   color: hsl(var(--heading-color));
 }

 .error-state p {
   margin: 0 0 20px 0;
   font-size: 14px;
   opacity: 0.8;
 }

 .retry-btn {
   background: hsl(var(--main));
   color: white;
   border: none;
   padding: 10px 20px;
   border-radius: 8px;
   cursor: pointer;
   font-size: 14px;
   display: inline-flex;
   align-items: center;
   gap: 8px;
   transition: background 0.2s;
 }

 .retry-btn:hover {
   background: hsl(var(--main-dark));
 }

 /* Toast notifications */
 .toast {
   position: fixed;
   top: 20px;
   right: 20px;
  background: white;
   border: 1px solid hsl(var(--border-color));
   border-radius: 8px;
   box-shadow: 0 4px 12px hsla(0, 0%, 0%, 0.15);
   padding: 16px;
   transform: translateX(400px);
   transition: transform 0.3s ease;
   z-index: 10000;
   max-width: 350px;
 }

 .toast.show {
   transform: translateX(0);
 }

 .toast-content {
   display: flex;
   align-items: center;
   gap: 12px;
 }

 .toast-success {
   border-left: 4px solid #10b981;
 }

 .toast-success i {
   color: #10b981;
 }

  .toast-warning {
    border-left: 4px solid #f59e0b;
  }

  .toast-warning i {
    color: #f59e0b;
  }

 .toast-error {
   border-left: 4px solid #ef4444;
 }

 .toast-error i {
   color: #ef4444;
 }

 /* Dark mode support */
 [data-theme="dark"] .loading-spinner {
   background: hsla(var(--main), 0.2);
 }

 [data-theme="dark"] .toast {
   background: hsl(var(--section-bg));
   border-color: hsl(var(--border-color));
   color: hsl(var(--heading-color));
 }

 /* Responsive design */
 @media (max-width: 768px) {
   .telegram-chat-layout {
     grid-template-columns: 1fr !important;
   }
   
   .conversations-sidebar {
     display: none;
   }
   
   .b2b-header-main {
     flex-direction: column;
     align-items: flex-start;
     gap: 16px;
   }
   
   .b2b-header-actions {
     width: 100%;
  justify-content: flex-start;
   }
 }

/* Messages uchun mo'ljallangan ranglar */
.messages-layout {
  display: grid;
  grid-template-columns: 380px 1fr;
  height: calc(100vh - 160px);
  min-height: 600px;
  gap: 24px;
}

/* Professional sections */
.messages-header {
  padding: 32px;
  background: hsl(var(--main-gradient));
  color: white;
  border-radius: 20px 20px 0 0;
  position: relative;
  overflow: hidden;
}

.messages-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, hsl(var(--main)) 0%, hsl(var(--main-two)) 100%);
}

.manufacturers-panel {
  background: hsl(var(--section-bg));
  border: 1px solid hsl(var(--border-color));
  border-radius: 20px;
  box-shadow: var(--box-shadow);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.chat-container {
  background: hsl(var(--section-bg));
  border: 1px solid hsl(var(--border-color));
  border-radius: 20px;
  box-shadow: var(--box-shadow);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Main Layout - Chat Layout Style */
.b2b-messages-container {
  font-family: var(--font-family);
  background: var(--background-color);
  min-height: calc(100vh - var(--header-height, 64px));
  padding: 20px;
}

.messages-wrapper {
  background: transparent;
  min-height: auto;
  padding: 0;
  font-family: var(--font-family);
}

/* Business Header - Chat Style */
.b2b-business-header {
  background: linear-gradient(135deg, var(--surface-color) 0%, var(--surface-color) 100%);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  padding: 24px 32px;
  margin-bottom: 24px;
  box-shadow: var(--buyer-shadow-lg);
  position: relative;
  overflow: hidden;
}

.b2b-business-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--buyer-gradient);
  border-radius: 20px 20px 0 0;
}

.b2b-header-breadcrumb {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  font-size: 14px;
}

.b2b-breadcrumb-item {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-secondary);
  text-decoration: none;
  padding: 8px 16px;
  border-radius: 12px;
  background: var(--background-color);
  border: 1px solid var(--border-light);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-weight: var(--font-weight-medium);
}

.b2b-breadcrumb-item:hover {
  color: var(--buyer-primary);
  background: var(--buyer-card-gradient);
  border-color: var(--buyer-primary);
  transform: translateY(-1px);
  box-shadow: var(--buyer-shadow);
}

.b2b-breadcrumb-item.active-breadcrumb {
  background: var(--buyer-gradient);
  color: white;
  border-color: var(--buyer-primary);
}

.b2b-breadcrumb-separator {
  color: var(--text-muted);
  font-size: 12px;
}

.b2b-header-main {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 24px;
  align-items: start;
}

.b2b-business-info {
  display: flex;
  gap: 20px;
  align-items: center;
}

.b2b-messages-icon {
  width: 64px;
  height: 64px;
  border-radius: 16px;
  background: var(--buyer-gradient);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 28px;
  box-shadow: var(--buyer-shadow);
}

.b2b-business-details h1 {
  font-size: 32px;
  font-weight: var(--font-weight-bold);
  color: var(--text-primary);
  margin: 0 0 8px 0;
  line-height: 1.2;
}

.b2b-business-subtitle {
  color: var(--text-secondary);
  font-size: 16px;
  font-weight: var(--font-weight-medium);
  margin: 0;
  line-height: 1.5;
}

.b2b-header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.b2b-action-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: var(--font-weight-semibold);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: var(--font-family);
}

.b2b-action-btn.primary {
  background: var(--buyer-gradient);
  color: white;
  box-shadow: var(--buyer-shadow);
}

.b2b-action-btn.primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--buyer-shadow-lg);
}

.b2b-action-btn.secondary {
  background: var(--surface-color);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.b2b-action-btn.secondary:hover {
  border-color: var(--buyer-primary);
  color: var(--buyer-primary);
  background: var(--buyer-card-gradient);
}

/* ===== REMOVED DUPLICATE MESSAGES CONTAINER ===== */

.messages-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--buyer-gradient);
  border-radius: 20px 20px 0 0;
}

.messages-header {
  padding: 24px 32px;
  background: var(--buyer-gradient);
  color: white;
  border-bottom: 1px solid var(--border-color);
  position: relative;
  overflow: hidden;
}

.messages-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #22d3ee 0%, #67e8f9 100%);
}

.header-title {
  font-size: 28px;
  font-weight: var(--font-weight-bold);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 12px;
  letter-spacing: -0.025em;
}

.header-subtitle {
  margin: 8px 0 0 0;
  opacity: 0.95;
  font-size: 16px;
  font-weight: var(--font-weight-medium);
}

/* Messages Layout */
.messages-layout {
  display: grid;
  grid-template-columns: 320px 1fr;
  height: 70vh;
  min-height: 600px;
}

/* Manufacturers Panel - Profile Style */
.manufacturers-panel {
  background: var(--surface-color);
  border-right: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  position: relative;
}

.manufacturers-panel::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: var(--buyer-gradient);
}

.manufacturers-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--buyer-card-gradient);
}

.panel-title {
  font-size: 18px;
  font-weight: var(--font-weight-bold);
  color: var(--text-primary);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.manufacturers-count {
  background: var(--buyer-primary);
  color: white;
  padding: 4px 10px;
  border-radius: 16px;
  font-size: 12px;
  font-weight: var(--font-weight-semibold);
  margin-left: 8px;
  box-shadow: var(--buyer-shadow-sm);
}

.add-manufacturer-btn {
  background: var(--buyer-gradient);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 13px;
  font-weight: var(--font-weight-semibold);
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--buyer-shadow);
}

.add-manufacturer-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--buyer-shadow-lg);
}

.manufacturers-search {
  padding: 16px;
  border-bottom: 1px solid var(--border-light);
}

.search-wrapper {
  position: relative;
  margin-bottom: 16px;
  transition: all 0.3s ease;
  border-radius: 12px;
  padding: 0;
}



.search-wrapper i {
  position: absolute;
  left: 16px;
  top: 32%;
  transform: translateY(-50%);
  color: #9ca3af;
  font-size: 16px;
  transition: color 0.3s ease;
  z-index: 2;
}

.search-wrapper.focused i {
  color: #3b82f6;
}

.search-wrapper.searching i {
  color: #10b981;
}

.search-wrapper input {
  width: 100%;
  padding: 14px 40px 14px 48px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 14px;
  background: #ffffff;
  color: #111827;
  font-family: inherit;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-sizing: border-box;
  backdrop-filter: blur(10px);
}

.search-wrapper input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  background: #fafbfc;
  backdrop-filter: blur(10px);
}

.search-wrapper input.searching {
  border-color: #10b981;
  background: #f0fdf4;
  backdrop-filter: blur(10px);
}

.search-wrapper input::placeholder {
  color: #9ca3af;
  font-size: 14px;
  font-weight: 400;
}

/* Search clear button */
.search-clear-btn {
  position: absolute;
  right: 12px;
  top: 20%;
  width: 20px;
  height: 20px;
  border: none;
  border-radius: 50%;
  background: #f3f4f6;
  color: #6b7280;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
  transition: all 0.2s ease;
  z-index: 3;
  line-height: 1;
  padding: 0;
  user-select: none;
}

.search-clear-btn:hover {
  background: #e5e7eb;
  color: #374151;
  transform: scale(1.1);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Search spinner */
.search-spinner {
  position: absolute;
  right: 80px;
  top: 20%;
  transform: translateY(-50%);
  color: #10b981;
  font-size: 14px;
  z-index: 2;
}

/* Search results count */
.search-results-count {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 8px 12px;
  margin-top: 4px;
  font-size: 12px;
  color: #64748b;
  text-align: center;
  z-index: 10;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.search-results-count .count-number {
  font-weight: 600;
  color: #10b981;
  margin-right: 4px;
}

.search-results-count .search-query {
  font-style: italic;
  color: #3b82f6;
  margin-left: 4px;
}

/* No search results */
.no-search-results {
  text-align: center;
  padding: 40px 20px;
  color: #6b7280;
}

.no-results-icon {
  font-size: 48px;
  color: #d1d5db;
  margin-bottom: 16px;
}

.no-results-title {
  font-size: 18px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
}

.no-results-description {
  font-size: 14px;
  margin-bottom: 20px;
  line-height: 1.5;
}

.no-results-suggestions {
  text-align: left;
  max-width: 300px;
  margin: 0 auto 20px;
}

.no-results-suggestions p {
  font-weight: 500;
  margin-bottom: 8px;
  color: #374151;
}

.no-results-suggestions ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.no-results-suggestions li {
  padding: 4px 0;
  font-size: 13px;
  color: #6b7280;
  position: relative;
  padding-left: 16px;
}

.no-results-suggestions li:before {
  content: '•';
  position: absolute;
  left: 0;
  color: #9ca3af;
}

.clear-search-btn {
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  color: #6b7280;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.clear-search-btn:hover {
  background: #e5e7eb;
  color: #374151;
  border-color: #d1d5db;
}

/* Search tips */
.search-tips {
  margin-top: 8px;
  text-align: center;
  padding: 0 4px;
}

.search-tips small {
  color: #6b7280;
  font-size: 12px;
  font-style: normal;
  opacity: 0.9;
  line-height: 1.4;
}

[data-theme="light"] {
  .sidebar-search {
    background: #111827;
    border-bottom-color: #374151;
  }

  
  .search-wrapper input {
    background: #1f2937;
    color: #f9fafb;
    border-color: #374151;
    backdrop-filter: blur(10px);
  }
  
  .search-wrapper input:focus {
    background: #111827;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    backdrop-filter: blur(10px);
  }
  
  .search-wrapper input.searching {
    background: #064e3b;
    border-color: #10b981;
    backdrop-filter: blur(10px);
  }
  
  .search-wrapper input::placeholder {
    color: #9ca3af;
  }

} 

/* Dark mode support for search */
@media (prefers-color-scheme: light) {

  

  
  .search-wrapper i {
    color: #9ca3af;
  }
  
  .search-wrapper.focused i {
    color: #3b82f6;
  }
  
  .search-wrapper.searching i {
    color: #10b981;
  }
  
  .search-clear-btn {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.7);
  }
  
  .search-clear-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }
  
  .search-tips small {
    color: #9ca3af;
  }
  
  .search-results-count {
    background: #1f2937;
    border-color: #374151;
    color: #9ca3af;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }
  
  .no-search-results {
    color: #9ca3af;
  }
  
  .no-results-title {
    color: #f9fafb;
  }
  
  .no-results-suggestions p {
    color: #f3f4f6;
  }
  
  .clear-search-btn {
    background: #374151;
    border-color: #4b5563;
    color: #d1d5db;
  }
  
  .clear-search-btn:hover {
    background: #4b5563;
    border-color: #6b7280;
    color: #f9fafb;
  }
}

.manufacturers-filters {
  display: flex;
  gap: 8px;
}

.filter-chip {
  padding: 8px 16px;
  border: 1px solid var(--border-color);
  border-radius: 20px;
  background: var(--surface-color);
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  gap: 6px;
}

.filter-chip.active {
  background: var(--buyer-gradient);
  color: white;
  border-color: var(--buyer-primary);
  box-shadow: var(--buyer-shadow);
  transform: translateY(-1px);
}

.filter-chip:hover:not(.active) {
  background: var(--buyer-card-gradient);
  border-color: var(--buyer-primary);
  color: var(--buyer-primary);
}

/* Manufacturers List */
.manufacturers-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px 0;
}

.manufacturer-card {
  display: flex;
  gap: 16px;
  padding: 16px 20px;
  cursor: pointer;
  border-bottom: 1px solid var(--border-light);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  background: var(--surface-color);
}

.manufacturer-card:hover {
  background: var(--buyer-card-gradient);
  transform: translateX(4px);
}

.manufacturer-card.active {
  background: var(--buyer-card-gradient);
  border-left: 4px solid var(--buyer-primary);
  padding-left: 16px;
  box-shadow: inset 0 0 0 1px rgba(6, 182, 212, 0.2);
}

.manufacturer-avatar {
  position: relative;
  width: 48px;
  height: 48px;
  flex-shrink: 0;
}

.manufacturer-avatar img {
    width: 100%;
  height: 100%;
  border-radius: 12px;
  object-fit: cover;
  border: 2px solid var(--border-light);
  transition: all 0.3s ease;
}

.manufacturer-card:hover .manufacturer-avatar img {
  border-color: var(--buyer-primary);
}

.status-indicator {
  position: absolute;
  bottom: -2px;
  right: -2px;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: 3px solid var(--surface-color);
  box-shadow: var(--buyer-shadow-sm);
}

.status-indicator.online { 
  background: var(--buyer-success); 
  animation: pulse-green 2s infinite;
}
.status-indicator.away { background: var(--buyer-warning); }
.status-indicator.offline { background: var(--text-muted); }

@keyframes pulse-green {
  0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
  70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
  100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}

.verified-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  width: 16px;
  height: 16px;
  background: var(--success);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  color: white;
  border: 2px solid var(--bg-primary);
}

.verified-badge.gold {
  background: var(--warning);
}

.manufacturer-info {
  flex: 1;
  min-width: 0;
}

.manufacturer-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0 0 4px 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.manufacturer-meta {
  display: flex;
  gap: 12px;
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 6px;
}

.last-activity {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 11px;
  color: var(--text-disabled);
}

.unread-badge {
  background: #ef4444;
  color: white;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 600;
}

/* ===== REMOVED DUPLICATE CHAT CONTAINER ===== */

.chat-breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 12px;
}

.breadcrumb-link {
  color: var(--text-secondary);
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 4px;
}

.breadcrumb-link:hover {
  color: var(--primary);
}

.current-manufacturer {
  color: var(--primary);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}

.manufacturer-info-header {
  display: flex;
  gap: 16px;
  align-items: center;
}

.manufacturer-avatar-large {
  position: relative;
  width: 56px;
  height: 56px;
  flex-shrink: 0;
}

.manufacturer-avatar-large img {
  width: 100%;
  height: 100%;
  border-radius: 12px;
  object-fit: cover;
  border: 3px solid var(--border);
}

.status-pulse {
  position: absolute;
  bottom: -2px;
  right: -2px;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 3px solid var(--bg-primary);
}

.status-pulse.online {
  background: var(--success);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(82, 196, 26, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(82, 196, 26, 0); }
  100% { box-shadow: 0 0 0 0 rgba(82, 196, 26, 0); }
}

.manufacturer-details h2 {
  margin: 0 0 8px 0;
  font-size: 18px;
  color: var(--text-primary);
}

.manufacturer-badges {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

.badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 4px;
}

.badge.verified {
  background: rgba(82, 196, 26, 0.1);
  color: var(--success);
}

.badge.iso {
  background: rgba(24, 144, 255, 0.1);
  color: var(--primary);
}

.badge.online {
  background: rgba(82, 196, 26, 0.1);
  color: var(--success);
}

.manufacturer-stats {
  display: flex;
  gap: 16px;
  font-size: 12px;
  color: var(--text-secondary);
  }
  
  .chat-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.action-btn {
  padding: 8px 16px;
  border-radius: var(--radius);
  border: none;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}

.action-btn.primary {
  background: var(--primary);
  color: white;
}

.action-btn.primary:hover {
  background: var(--primary-dark);
}

.action-btn.secondary {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border);
}

.action-btn.secondary:hover {
  border-color: var(--primary);
  color: var(--primary);
}

.action-btn.icon {
  padding: 8px;
  background: none;
  color: var(--text-secondary);
}

.action-btn.icon:hover {
  background: var(--bg-secondary);
  color: var(--primary);
}

/* Messages Area */
.messages-area {
  flex: 1;
  overflow-y: auto;
  padding: 16px 24px;
  background: var(--bg-secondary);
}

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
    justify-content: center;
  height: 100%;
  text-align: center;
  color: var(--text-secondary);
}

.empty-state i {
  font-size: 48px;
  color: var(--text-disabled);
  margin-bottom: 16px;
}

.empty-state h3 {
  margin: 0 0 8px 0;
  color: var(--text-primary);
}

.empty-state p {
  margin: 0 0 24px 0;
}

.quick-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  max-width: 600px;
}

.quick-action-card {
  padding: 16px;
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.quick-action-card:hover {
  border-color: var(--primary);
  box-shadow: var(--shadow);
}

.quick-action-card i {
  font-size: 24px;
  color: var(--primary);
  margin-bottom: 8px;
}

.quick-action-card h4 {
  margin: 0 0 4px 0;
  color: var(--text-primary);
  font-size: 14px;
}

.quick-action-card p {
  margin: 0;
  font-size: 12px;
  color: var(--text-secondary);
}

/* Message Input */
.message-input-area {
  padding: 16px 24px;
  background: var(--bg-primary);
  border-top: 1px solid var(--border);
}

.input-toolbar {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.toolbar-btn {
  padding: 8px 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  color: var(--text-secondary);
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}

.toolbar-btn:hover {
  border-color: var(--primary);
  color: var(--primary);
}

.message-composer {
  display: flex;
  gap: 12px;
  align-items: flex-end;
}

.message-input {
  flex: 1;
  min-height: 40px;
  max-height: 120px;
  padding: 12px 16px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  resize: none;
  font-family: inherit;
  font-size: 14px;
  background: var(--bg-primary);
  color: var(--text-primary);
}

.message-input:focus {
  outline: none;
  border-color: var(--primary);
}

.send-btn {
  padding: 12px 20px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}

.send-btn:hover {
  background: var(--primary-dark);
}

.send-btn:disabled {
  background: var(--text-disabled);
  cursor: not-allowed;
}

/* ===== ATTACHMENTS PREVIEW CONTAINER ===== */
.attachments-preview-container {
  position: absolute;
  bottom: 100%;
  left: 0;
  right: 0;
  padding: 12px;
  z-index: 10;
  display: none; /* Hidden by default */
}

.attachments-preview-container.has-attachments {
  display: block;
}

/* ===== IMAGE ATTACHMENTS PREVIEW ===== */
.image-attachments-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: flex-start;
  margin-bottom: 8px;
}

.image-attachment-preview {
  position: relative;
  width: 80px;
  height: 80px;
  border-radius: var(--radius);
  overflow: hidden;
  border: 2px solid hsl(var(--border));
  transition: all 0.2s ease;
  cursor: pointer;
}

.image-attachment-preview:hover {
  transform: scale(1.05);
  border-color: hsl(var(--primary));
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.preview-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: all 0.2s ease;
}

.image-remove-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.2s ease;
}

.image-attachment-preview:hover .image-remove-overlay {
  opacity: 1;
}

.image-remove-btn {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: hsl(var(--danger));
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
}

.image-remove-btn:hover {
  background: hsl(var(--danger-dark));
  transform: scale(1.1);
}

/* ===== FILE ATTACHMENTS PREVIEW ===== */
.file-attachments-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: flex-start;
}

/* File preview styling (same as image preview) */
.file-attachment-preview {
  position: relative;
  width: 80px;
  height: 80px;
  border-radius: var(--radius);
  overflow: hidden;
  border: 2px solid hsl(var(--border));
  transition: all 0.2s ease;
  cursor: pointer;
  background: hsl(var(--bg-secondary));
}

.file-attachment-preview:hover {
  transform: scale(1.05);
  border-color: hsl(var(--primary));
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.file-preview-icon {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: hsl(var(--text-secondary));
  background: hsl(var(--bg-secondary));
}

.file-remove-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.2s ease;
}

.file-attachment-preview:hover .file-remove-overlay {
  opacity: 1;
}

.file-remove-btn {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: hsl(var(--danger));
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
}

.file-remove-btn:hover {
  background: hsl(var(--danger-dark));
  transform: scale(1.1);
}

/* Old file attachment styles removed - now using preview style */

.file-attachment-remove:hover {
  background: hsl(var(--danger-dark));
  transform: scale(1.1);
}

/* Responsive */
@media (max-width: 768px) {
  .messages-layout {
    grid-template-columns: 1fr;
    height: auto;
  }
  
  .manufacturers-panel {
    height: 300px;
  }
  
  .messages-wrapper {
    padding: 12px;
  }
  
  .manufacturer-stats {
    flex-direction: column;
    gap: 4px;
  }
  
  .chat-actions {
    flex-direction: column;
    align-items: stretch;
  }
  
  .image-attachment-preview {
    width: 60px;
    height: 60px;
  }
  
  .file-attachment-preview {
    width: 60px;
    height: 60px;
  }
  
  .file-preview-icon {
    font-size: 20px;
  }
}
</style>

<!-- Main Content - Chat Layout Style -->
<main class="admin-main b2b-messages-container">
  <div class="admin-content">
         <!-- Professional Telegram-Style Chat Layout -->
     <div class="section-bg animate-fade-in" style="margin-top: 24px;">
       <div class="telegram-chat-layout">
         
         <!-- Telegram-Style Conversations Sidebar -->
         <div class="conversations-sidebar">
           
           <!-- Sidebar Header -->
           <div class="sidebar-header">
             <h3 class="text-heading">
               <i class="fas fa-comments text-main"></i>
              <%= t('messages.sidebar.title') %>
             </h3>
           </div>
           
           <!-- Professional Search Input -->
           <div class="sidebar-search">
             <div class="search-wrapper">
               <i class="fas fa-search"></i>
               <input type="text" 
                      class="search-input"
                     placeholder="<%= t('messages.sidebar.searchPlaceholder') %>" 
                     id="conversationSearchInput"
                      autocomplete="off"
                      spellcheck="false"
                      maxlength="100">
                             <div class="search-tips">
                <small><%= t('messages.sidebar.searchTips') %></small>
              </div>
             </div>
           </div>
          
                               <!-- Conversations List -->
          <div class="conversations-list">
            <!-- Conversations will be loaded dynamically from API -->
          </div>
        </div>
        
                 <!-- Main Chat Area - Right Panel -->
         <div class="chat-main-area">
           
           <!-- Enhanced Chat Header with Manufacturer Info -->
           <div class="chat-header-enhanced">
             <div class="chat-header-content">
               <div class="chat-header-left">
                 <div class="chat-header-avatar" style="display: none;">
                   <!-- Avatar will be shown when manufacturer is selected -->
                 </div>
                 <div class="chat-header-text">
                  <h3 class="text-heading chat-header-title"><%= t('messages.header.defaultTitle') %></h3>
                   <div class="chat-header-meta">
                                         <span class="chat-subtitle"><%= t('messages.header.defaultSubtitle') %></span>
                   </div>
                 </div>
               </div>
               
               <div class="chat-header-actions" style="display: none;">
                 <!-- Actions will be shown when manufacturer is selected -->
               </div>
             </div>
           </div>
          
                     <!-- Messages Container -->
           <div class="messages-container">
             <!-- Welcome State - shown when no manufacturer selected -->
             <div class="welcome-state">
               <div class="welcome-icon">
                 <i class="fas fa-comments text-main"></i>
               </div>
                             <h3 class="text-heading welcome-title"><%= t('messages.welcome.title') %></h3>
                              <p class="welcome-description"><%= t('messages.welcome.description') %></p>
               
               <!-- Quick Actions - only shown when manufacturer selected -->
               <div class="quick-actions-grid" style="display: none;">
                                 <button onclick="startConversationWithTemplate('greeting')" class="quick-action-btn secondary">
                   <div class="quick-action-content">
                     <div class="quick-action-icon secondary">
                       <i class="fas fa-wave-square"></i>
                     </div>
                    <h5 class="quick-action-title secondary"><%= t('messages.quickActions.greeting.title') %></h5>
                   </div>
                  <p class="quick-action-description secondary"><%= t('messages.quickActions.greeting.description') %></p>
                 </button>
                 
                 <button onclick="startConversationWithTemplate('price_inquiry')" class="quick-action-btn secondary">
                   <div class="quick-action-content">
                     <div class="quick-action-icon secondary">
                       <i class="fas fa-file-invoice-dollar text-main"></i>
                     </div>
                    <h5 class="quick-action-title secondary"><%= t('messages.quickActions.priceInquiry.title') %></h5>
                   </div>
                  <p class="quick-action-description secondary"><%= t('messages.quickActions.priceInquiry.description') %></p>
                 </button>
                 
                 <button onclick="startConversationWithTemplate('sample_request')" class="quick-action-btn tertiary">
                   <div class="quick-action-content">
                     <div class="quick-action-icon tertiary">
                       <i class="fas fa-cube text-main"></i>
                     </div>
                    <h5 class="quick-action-title tertiary"><%= t('messages.quickActions.sampleRequest.title') %></h5>
                   </div>
                  <p class="quick-action-description tertiary"><%= t('messages.quickActions.sampleRequest.description') %></p>
                 </button>
                 
                 <button onclick="startConversationWithTemplate('order_inquiry')" class="quick-action-btn tertiary">
                   <div class="quick-action-content">
                     <div class="quick-action-icon tertiary">
                       <i class="fas fa-shopping-cart text-main"></i>
                     </div>
                    <h5 class="quick-action-title tertiary"><%= t('messages.quickActions.orderInquiry.title') %></h5>
                   </div>
                  <p class="quick-action-description tertiary"><%= t('messages.quickActions.orderInquiry.description') %></p>
                 </button>
              </div>
            </div>
          </div>
          
                     <!-- Telegram-Style Message Input Area - Hidden by default -->
           <div class="b2b-message-input-area" style="display: none;">
             <div class="b2b-input-container">
               <!-- Telegram-Style Message Form -->
               <form class="b2b-message-input-form" id="messageForm">
                 
                 <div class="b2b-input-wrapper">
                   <!-- Attachments Preview Container (Absolute Position) -->
                   <div id="attachmentsPreviewContainer" class="attachments-preview-container">
                     <!-- Image Attachments Preview -->
                     <div id="imageAttachmentsPreview" class="image-attachments-preview"></div>
                     
                     <!-- File Attachments Preview -->
                     <div id="fileAttachmentsPreview" class="file-attachments-preview"></div>
                   </div>
                   
                   <div class="message-input-container">
                     <textarea id="messageInput" 
                               class="b2b-message-input"
                              placeholder="<%= t('messages.input.placeholder') %>"
                               rows="1"
                               maxlength="10000"
                               onkeydown="handleProfessionalKeyPress(event)"
                               oninput="handleProfessionalInputChange()"></textarea>
                   </div>
                   
                   <!-- Attachment and Send Buttons -->
                   <div class="input-actions">
                     <div class="telegram-attachment-wrapper">
                       <button type="button" class="telegram-attachment-btn" id="attachmentBtn" title="<%= t('messages.input.attachments') %>">
                         <i class="fas fa-paperclip"></i>
                       </button>
                       
                       <!-- Telegram-Style Dropdown Menu -->
                       <div class="telegram-attachment-menu" id="attachmentMenu">
                         <button type="button" class="telegram-menu-item" onclick="window.professionalBuyerMessages.triggerFileInput('file')">
                           <div class="menu-item-icon file">
                             <i class="fas fa-file-alt"></i>
                           </div>
                                                     <span><%= t('messages.input.file') %></span>
                         </button>
                         <button type="button" class="telegram-menu-item" onclick="window.professionalBuyerMessages.triggerFileInput('image')">
                           <div class="menu-item-icon image">
                             <i class="fas fa-image"></i>
                           </div>
                          <span><%= t('messages.input.image') %></span>
                         </button>
                         <button type="button" class="telegram-menu-item" onclick="insertEmoji()">
                           <div class="menu-item-icon emoji">
                             <i class="fas fa-smile"></i>
                           </div>
                          <span><%= t('messages.input.emoji') %></span>
                         </button>
                       </div>
                     </div>
                     
                     <button type="button" class="b2b-send-button" id="sendButton" disabled>
                       <i class="fas fa-paper-plane"></i>
                     </button>
                   </div>
                 </div>
                 
                 <!-- Input Footer with Character Counter -->
                 <div class="b2b-input-footer">
                   <div class="b2b-char-counter">
                     <i class="fas fa-keyboard"></i>
                      <span id="charCount"><%= t('messages.input.charCount') %></span>
                   </div>
                   <div class="b2b-input-hints">
                      <span><kbd class="hint-kbd">Enter</kbd> <%= t('messages.input.sendHint') %></span>
                      <span><kbd class="hint-kbd">Shift+Enter</kbd> <%= t('messages.input.newLineHint') %></span>
                   </div>
                 </div>
                 
                 <!-- Hidden file inputs -->
                  <input type="file" id="fileInput" style="display: none;" accept="*/*" multiple onchange="handleFileSelect(event)">
                  <input type="file" id="imageInput" style="display: none;" accept="image/*" multiple onchange="handleImageSelect(event)">
               </form>
             </div>
           </div>
        </div>
      </div>
    </div>

  </div>
</main>
<!-- Professional B2B Messaging JavaScript -->
<script>
// Localization variables
window.messageTranslations = {
  sidebar: {
    clearSearch: '<%= t("messages.sidebar.clearSearch") %>',
    noConversations: '<%= t("messages.sidebar.noConversations") %>',
    noConversationsDesc: '<%= t("messages.sidebar.noConversationsDesc") %>',
    allConversations: '<%= t("messages.sidebar.allConversations") %>',
    unreadConversations: '<%= t("messages.sidebar.unreadConversations") %>',
    pinnedConversations: '<%= t("messages.sidebar.pinnedConversations") %>',
    archivedConversations: '<%= t("messages.sidebar.archivedConversations") %>',
    filterAll: '<%= t("messages.sidebar.filterAll") %>',
    filterUnread: '<%= t("messages.sidebar.filterUnread") %>',
    filterPinned: '<%= t("messages.sidebar.filterPinned") %>',
    filterArchived: '<%= t("messages.sidebar.filterArchived") %>',
    sortByDate: '<%= t("messages.sidebar.sortByDate") %>',
    sortByName: '<%= t("messages.sidebar.sortByName") %>',
    sortByUnread: '<%= t("messages.sidebar.sortByUnread") %>',
    sortByRecent: '<%= t("messages.sidebar.sortByRecent") %>',
    conversationCount: '<%= t("messages.sidebar.conversationCount") %>',
    conversationCountOne: '<%= t("messages.sidebar.conversationCountOne") %>',
    conversationCountMany: '<%= t("messages.sidebar.conversationCountMany") %>',
    newMessage: '<%= t("messages.sidebar.newMessage") %>',
    newMessages: '<%= t("messages.sidebar.newMessages") %>',
    noNewMessages: '<%= t("messages.sidebar.noNewMessages") %>',
    loadMore: '<%= t("messages.sidebar.loadMore") %>',
    loadAll: '<%= t("messages.sidebar.loadAll") %>',
    refresh: '<%= t("messages.sidebar.refresh") %>',
    settings: '<%= t("messages.sidebar.settings") %>'
  },
  header: {
    defaultTitle: '<%= t("messages.header.defaultTitle") %>',
    defaultSubtitle: '<%= t("messages.header.defaultSubtitle") %>',
    onlineStatus: '<%= t("messages.header.onlineStatus") %>',
    offlineStatus: '<%= t("messages.header.offlineStatus") %>',
    callAction: '<%= t("messages.header.callAction") %>',
    profileAction: '<%= t("messages.header.profileAction") %>',
    title: '<%= t("messages.header.title") %>',
    subtitle: '<%= t("messages.header.subtitle") %>',
    statusOnline: '<%= t("messages.header.statusOnline") %>',
    statusOffline: '<%= t("messages.header.statusOffline") %>',
    statusAway: '<%= t("messages.header.statusAway") %>',
    statusBusy: '<%= t("messages.header.statusBusy") %>',
    lastSeen: '<%= t("messages.header.lastSeen") %>',
    typingIndicator: '<%= t("messages.header.typingIndicator") %>',
    callButton: '<%= t("messages.header.callButton") %>',
    videoCallButton: '<%= t("messages.header.videoCallButton") %>',
    profileButton: '<%= t("messages.header.profileButton") %>',
    moreActions: '<%= t("messages.header.moreActions") %>',
    muteConversation: '<%= t("messages.header.muteConversation") %>',
    unmuteConversation: '<%= t("messages.header.unmuteConversation") %>',
    pinConversation: '<%= t("messages.header.pinConversation") %>',
    unpinConversation: '<%= t("messages.header.unpinConversation") %>',
    archiveConversation: '<%= t("messages.header.archiveConversation") %>',
    unarchiveConversation: '<%= t("messages.header.unarchiveConversation") %>',
    deleteConversation: '<%= t("messages.header.deleteConversation") %>',
    blockUser: '<%= t("messages.header.blockUser") %>',
    unblockUser: '<%= t("messages.header.unblockUser") %>'
  },
  input: {
    sendButton: '<%= t("messages.input.sendButton") %>',
    sendButtonWithFiles: '<%= t("messages.input.sendButtonWithFiles") %>',
    sendButtonPlaceholder: '<%= t("messages.input.sendButtonPlaceholder") %>',
    charCountFormat: '<%= t("messages.input.charCountFormat") %>',
    charCountOverLimit: '<%= t("messages.input.charCountOverLimit") %>',
    inputPlaceholder: '<%= t("messages.input.inputPlaceholder") %>',
    inputPlaceholderWithAttachments: '<%= t("messages.input.inputPlaceholderWithAttachments") %>',
    inputPlaceholderEmpty: '<%= t("messages.input.inputPlaceholderEmpty") %>'
  },
  quickActions: {
    inquiry: {
      title: '<%= t("messages.quickActions.inquiry.title") %>',
      description: '<%= t("messages.quickActions.inquiry.description") %>'
    },
    orderStatus: {
      title: '<%= t("messages.quickActions.orderStatus.title") %>',
      description: '<%= t("messages.quickActions.orderStatus.description") %>'
    }
  },
  status: {
    read: '<%= t("messages.status.read") %>',
    delivered: '<%= t("messages.status.delivered") %>',
    sent: '<%= t("messages.status.sent") %>'
  },
  attachments: {
    download: '<%= t("messages.attachments.download") %>',
    maxFilesReached: '<%= t("messages.attachments.maxFilesReached") %>',
    maxImagesReached: '<%= t("messages.attachments.maxImagesReached") %>',
    invalidFileType: '<%= t("messages.attachments.invalidFileType") %>',
    fileLimitWarning: '<%= t("messages.attachments.fileLimitWarning") %>',
    imageLimitWarning: '<%= t("messages.attachments.imageLimitWarning") %>',
    fileTooLarge: '<%= t("messages.attachments.fileTooLarge") %>',
    imageTooLarge: '<%= t("messages.attachments.imageTooLarge") %>',
    unsupportedFileType: '<%= t("messages.attachments.unsupportedFileType") %>',
    uploadInProgress: '<%= t("messages.attachments.uploadInProgress") %>',
    uploadSuccess: '<%= t("messages.attachments.uploadSuccess") %>',
    uploadFailed: '<%= t("messages.attachments.uploadFailed") %>',
    fileSize: '<%= t("messages.attachments.fileSize") %>',
    fileSizeMB: '<%= t("messages.attachments.fileSizeMB") %>',
    fileSizeGB: '<%= t("messages.attachments.fileSizeGB") %>',
    bytes: '<%= t("messages.attachments.bytes") %>',
    kilobytes: '<%= t("messages.attachments.kilobytes") %>',
    megabytes: '<%= t("messages.attachments.megabytes") %>',
    gigabytes: '<%= t("messages.attachments.gigabytes") %>'
  },
  search: {
    searching: '<%= t("messages.search.searching") %>',
    resultsCount: '<%= t("messages.search.resultsCount") %>',
    noResults: '<%= t("messages.search.noResults") %>',
    noResultsDesc: '<%= t("messages.search.noResultsDesc") %>',
    errorMessage: '<%= t("messages.search.errorMessage") %>',
    apiError: '<%= t("messages.search.apiError") %>',
    searchFailed: '<%= t("messages.search.searchFailed") %>',
    searchPlaceholder: '<%= t("messages.search.searchPlaceholder") %>',
    searchHint: '<%= t("messages.search.searchHint") %>',
    clearSearch: '<%= t("messages.search.clearSearch") %>',
    searchHistory: '<%= t("messages.search.searchHistory") %>',
    recentSearches: '<%= t("messages.search.recentSearches") %>',
    popularSearches: '<%= t("messages.search.popularSearches") %>'
  },
  loading: {
    loading: '<%= t("messages.loading.loading") %>',
    conversations: '<%= t("messages.loading.conversations") %>',
    messages: '<%= t("messages.loading.messages") %>',
    searching: '<%= t("messages.loading.searching") %>',
    sending: '<%= t("messages.loading.sending") %>',
    uploading: '<%= t("messages.loading.uploading") %>',
    downloading: '<%= t("messages.loading.downloading") %>',
    processing: '<%= t("messages.loading.processing") %>',
    connecting: '<%= t("messages.loading.connecting") %>',
    syncing: '<%= t("messages.loading.syncing") %>',
    refreshing: '<%= t("messages.loading.refreshing") %>',
    pleaseWait: '<%= t("messages.loading.pleaseWait") %>',
    almostDone: '<%= t("messages.loading.almostDone") %>',
    loadingMore: '<%= t("messages.loading.loadingMore") %>',
    loadingAll: '<%= t("messages.loading.loadingAll") %>',
    loadingFailed: '<%= t("messages.loading.loadingFailed") %>',
    retryLoading: '<%= t("messages.loading.retryLoading") %>'
  },
  errors: {
    title: '<%= t("messages.errors.title") %>',
    manufacturerDataFailed: '<%= t("messages.errors.manufacturerDataFailed") %>',
    conversationDataFailed: '<%= t("messages.errors.conversationDataFailed") %>',
    manufacturerConnectionFailed: '<%= t("messages.errors.manufacturerConnectionFailed") %>',
    messagesLoadFailed: '<%= t("messages.errors.messagesLoadFailed") %>',
    messageSendFailed: '<%= t("messages.errors.messageSendFailed") %>',
    fileUploadFailed: '<%= t("messages.errors.fileUploadFailed") %>',
    networkError: '<%= t("messages.errors.networkError") %>',
    serverError: '<%= t("messages.errors.serverError") %>',
    loadMessagesFailed: '<%= t("messages.errors.loadMessagesFailed") %>',
    loadMessagesFailedEn: '<%= t("messages.errors.loadMessagesFailedEn") %>',
    sendMessageContent: '<%= t("messages.errors.sendMessageContent") %>',
    sendSuccess: '<%= t("messages.errors.sendSuccess") %>',
    sendSuccessWithFiles: '<%= t("messages.errors.sendSuccessWithFiles") %>',
    sendSuccessFilesOnly: '<%= t("messages.errors.sendSuccessFilesOnly") %>',
    sendFailed: '<%= t("messages.errors.sendFailed") %>',
    sendFailedGeneral: '<%= t("messages.errors.sendFailedGeneral") %>',
    clearSearchTitle: '<%= t("messages.errors.clearSearchTitle") %>',
    retry: '<%= t("messages.errors.retry") %>'
  },
  conversation: {
    startConversation: '<%= t("messages.conversation.startConversation") %>',
    selected: '<%= t("messages.conversation.selected") %>',
    newOrder: '<%= t("messages.conversation.newOrder") %>',
    noConversationsYet: '<%= t("messages.conversation.noConversationsYet") %>',
    noConversationsYetDesc: '<%= t("messages.conversation.noConversationsYetDesc") %>',
    conversationStarted: '<%= t("messages.conversation.conversationStarted") %>',
    conversationEnded: '<%= t("messages.conversation.conversationEnded") %>',
    messageCount: '<%= t("messages.conversation.messageCount") %>',
    messageCountOne: '<%= t("messages.conversation.messageCountOne") %>',
    messageCountMany: '<%= t("messages.conversation.messageCountMany") %>',
    unreadCount: '<%= t("messages.conversation.unreadCount") %>',
    unreadCountOne: '<%= t("messages.conversation.unreadCountOne") %>',
    unreadCountMany: '<%= t("messages.conversation.unreadCountMany") %>',
    activeConversation: '<%= t("messages.conversation.activeConversation") %>',
    inactiveConversation: '<%= t("messages.conversation.inactiveConversation") %>',
    pinnedConversation: '<%= t("messages.conversation.pinnedConversation") %>',
    archivedConversation: '<%= t("messages.conversation.archivedConversation") %>'
  },
  fileTypes: {
    unknown: '<%= t("messages.fileTypes.unknown") %>',
    sharedImage: '<%= t("messages.fileTypes.sharedImage") %>',
    modalImageAlt: '<%= t("messages.fileTypes.modalImageAlt") %>',
    manufacturer: '<%= t("messages.fileTypes.manufacturer") %>',
    company: '<%= t("messages.fileTypes.company") %>',
    product: '<%= t("messages.fileTypes.product") %>',
    document: '<%= t("messages.fileTypes.document") %>',
    image: '<%= t("messages.fileTypes.image") %>',
    file: '<%= t("messages.fileTypes.file") %>'
  },
  status: {
    pending: '<%= t("messages.status.pending") %>',
    confirmed: '<%= t("messages.status.confirmed") %>',
    in_production: '<%= t("messages.status.in_production") %>',
    shipped: '<%= t("messages.status.shipped") %>',
    delivered: '<%= t("messages.status.delivered") %>',
    cancelled: '<%= t("messages.status.cancelled") %>'
  },
  time: {
    now: '<%= t("messages.time.now") %>',
    minutesAgo: '<%= t("messages.time.minutesAgo") %>',
    hoursAgo: '<%= t("messages.time.hoursAgo") %>',
    daysAgo: '<%= t("messages.time.daysAgo") %>',
    weeksAgo: '<%= t("messages.time.weeksAgo") %>',
    monthsAgo: '<%= t("messages.time.monthsAgo") %>',
    yearsAgo: '<%= t("messages.time.yearsAgo") %>',
    today: '<%= t("messages.time.today") %>',
    yesterday: '<%= t("messages.time.yesterday") %>',
    thisWeek: '<%= t("messages.time.thisWeek") %>',
    thisMonth: '<%= t("messages.time.thisMonth") %>',
    thisYear: '<%= t("messages.time.thisYear") %>'
  },
  system: {
    name: '<%= t("messages.system.name") %>',
    message: '<%= t("messages.system.message") %>',
    notification: '<%= t("messages.system.notification") %>',
    update: '<%= t("messages.system.update") %>',
    maintenance: '<%= t("messages.system.maintenance") %>'
  },
  currency: {
    usd: '<%= t("messages.currency.usd") %>',
    uzs: '<%= t("messages.currency.uzs") %>',
    eur: '<%= t("messages.currency.eur") %>',
    rub: '<%= t("messages.currency.rub") %>',
    symbol: '<%= t("messages.currency.symbol") %>',
    format: '<%= t("messages.currency.format") %>'
  },
  imageModal: {
    title: '<%= t("messages.imageModal.title") %>',
    zoomIn: '<%= t("messages.imageModal.zoomIn") %>',
    zoomOut: '<%= t("messages.imageModal.zoomOut") %>',
    reset: '<%= t("messages.imageModal.reset") %>',
    fitScreen: '<%= t("messages.imageModal.fitScreen") %>',
    download: '<%= t("messages.imageModal.download") %>',
    close: '<%= t("messages.imageModal.close") %>',
    fullscreen: '<%= t("messages.imageModal.fullscreen") %>',
    exitFullscreen: '<%= t("messages.imageModal.exitFullscreen") %>',
    imageInfo: '<%= t("messages.imageModal.imageInfo") %>',
    imageSize: '<%= t("messages.imageModal.imageSize") %>',
    imageFormat: '<%= t("messages.imageModal.imageFormat") %>',
    imageDimensions: '<%= t("messages.imageModal.imageDimensions") %>',
    imageResolution: '<%= t("messages.imageModal.imageResolution") %>',
    imageDate: '<%= t("messages.imageModal.imageDate") %>',
    imageLocation: '<%= t("messages.imageModal.imageLocation") %>',
    imageDescription: '<%= t("messages.imageModal.imageDescription") %>',
    imageTags: '<%= t("messages.imageModal.imageTags") %>',
    imageMetadata: '<%= t("messages.imageModal.imageMetadata") %>',
    imageProperties: '<%= t("messages.imageModal.imageProperties") %>',
    imageHistory: '<%= t("messages.imageModal.imageHistory") %>',
    imageVersions: '<%= t("messages.imageModal.imageVersions") %>',
    imageShare: '<%= t("messages.imageModal.imageShare") %>',
    imageEdit: '<%= t("messages.imageModal.imageEdit") %>',
    imageDelete: '<%= t("messages.imageModal.imageDelete") %>',
    imageCopy: '<%= t("messages.imageModal.imageCopy") %>',
    imagePrint: '<%= t("messages.imageModal.imagePrint") %>',
    imageRotate: '<%= t("messages.imageModal.imageRotate") %>',
    imageFlip: '<%= t("messages.imageModal.imageFlip") %>',
    imageCrop: '<%= t("messages.imageModal.imageCrop") %>',
    imageFilter: '<%= t("messages.imageModal.imageFilter") %>',
    imageAdjust: '<%= t("messages.imageModal.imageAdjust") %>',
    imageEnhance: '<%= t("messages.imageModal.imageEnhance") %>'
  }
};

class ProfessionalBuyerMessages {
  constructor() {
    this.currentOrderId = null;
    this.currentManufacturerId = null;
    this.currentConversationId = null;
    this.conversations = [];
    this.messages = [];
    this.manufacturerDetails = null;
    this.isSending = false; // Prevent duplicate message sending
    this.attachments = []; // Store selected files
    this.maxFileSize = 10 * 1024 * 1024; // 10MB
    this.maxImageCount = 5; // Maximum 5 images
    this.maxFileCount = 1; // Maximum 1 file
    this.allowedFileTypes = {
      image: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
      document: ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'],
      spreadsheet: ['application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'],
      archive: ['application/zip', 'application/x-rar-compressed', 'application/x-7z-compressed']
    };
    this.searchQuery = '';
    this.searchTimeout = null;
    this.init();
  }

  init() {
    this.messageInput = document.getElementById('messageInput');
    this.sendButton = document.getElementById('sendButton');
    this.charCount = document.getElementById('charCount');
    this.attachmentBtn = document.getElementById('attachmentBtn');
    this.attachmentMenu = document.getElementById('attachmentMenu');
    
    if (this.messageInput) {
      this.messageInput.addEventListener('input', () => this.updateSendButton());
      this.messageInput.addEventListener('keydown', (e) => this.handleKeyPress(e));
    }
    
    // Send button click event
    if (this.sendButton) {
      this.sendButton.addEventListener('click', (e) => {
        e.preventDefault();
        this.sendMessage();
      });
    }
    
    // Attachment menu toggle
    if (this.attachmentBtn) {
      this.attachmentBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggleAttachmentMenu();
      });
    }
    
    // File input event listeners
    this.setupFileInputs();
    
    // Search input event listener
    this.setupSearchInput();
    
    // Close attachment menu when clicking outside
    document.addEventListener('click', (e) => {
      if (this.attachmentMenu && !this.attachmentMenu.contains(e.target) && !this.attachmentBtn.contains(e.target)) {
        this.hideAttachmentMenu();
      }
    });

    // Check for URL parameters and load appropriate content
    this.checkUrlParameters();
  }

  // Check URL parameters for manufacturer ID and order ID
  checkUrlParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    const manufacturerId = urlParams.get('manufacturer');
    const orderId = urlParams.get('order');
    
    if (manufacturerId) {
      // Validate manufacturer ID format
      if (!manufacturerId.match(/^[0-9a-fA-F]{24}$/)) {
        this.showErrorMessage('Invalid manufacturer ID format');
        this.loadConversations();
        return;
      }
      
      this.currentManufacturerId = manufacturerId;
      if (orderId) {
        // Validate order ID format
        if (!orderId.match(/^[0-9a-fA-F]{24}$/)) {
          this.showErrorMessage('Invalid order ID format');
          this.loadConversations();
          return;
        }
        
        // Order chat with specific manufacturer
        this.currentOrderId = orderId;
        this.conversationType = 'order';
        this.loadOrderConversation(manufacturerId, orderId);
      } else {
        // Product chat with manufacturer
        this.conversationType = 'inquiry';
        this.loadManufacturerConversation(manufacturerId);
      }
    } else {
      this.loadConversations();
    }
  }

  // Professional debounced search with enhanced functionality
  debouncedSearch() {
    if (this.searchTimeout) {
      clearTimeout(this.searchTimeout);
    }
    
    // Show search indicator
    this.showSearchIndicator();
    
    // Adjust delay based on query length
    const delay = this.searchQuery.length < 3 ? 500 : 300;
    
    this.searchTimeout = setTimeout(() => {
      this.performSearch();
    }, delay);
  }

  // Professional search with enhanced API integration and error handling
  async performSearch() {
    try {
      // Hide search indicator
      this.hideSearchIndicator();
      
      if (!this.searchQuery || this.searchQuery.length < 2) {
        // If no search query or too short, load all conversations
        await this.loadConversations();
        return;
      }
      
      this.showLoadingState('conversations');
      
      // Search conversations by company name, contact person, or order details
      const currentManufacturerId = this.getCurrentManufacturerId();
      const searchParams = new URLSearchParams({
        search: this.searchQuery,
        limit: '50', // Limit results for better performance
        include_orders: 'true' // Include order information in search
      });
      
      if (currentManufacturerId) {
        searchParams.append('manufacturer', currentManufacturerId);
      }
      
      const url = `/buyer/api/conversations-with-current?${searchParams.toString()}`;
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      if (!response.ok) {
        throw new Error(`Search API error: ${response.status} ${response.statusText}`);
      }
      
      const data = await response.json();
      
      if (data.success) {
        this.conversations = data.data.conversations;
        this.renderConversations();
        
        // Show search results count
        this.showSearchResultsCount(this.conversations.length, this.searchQuery);
        
        if (this.conversations.length === 0) {
          this.showNoSearchResults(this.searchQuery);
        }
      } else {
        throw new Error(data.message || window.messageTranslations.search.searchFailed);
      }
      
    } catch (error) {
      
      // Show appropriate error message
      if (error.message.includes('API error')) {
        this.showErrorMessage(window.messageTranslations.search.apiError);
      } else if (error.message.includes('Search failed')) {
        this.showErrorMessage(window.messageTranslations.search.searchFailed);
      } else {
        this.showErrorMessage(window.messageTranslations.search.errorMessage);
      }
      
      // Fallback to showing all conversations
      await this.loadConversations();
    } finally {
      this.hideLoadingState('conversations');
    }
  }

  // Load conversations from API with professional error handling
  async loadConversations() {
    try {
      this.showLoadingState('conversations');
      
      // Use conversations API endpoint
      const currentManufacturerId = this.getCurrentManufacturerId();
      const url = currentManufacturerId ? 
        `/buyer/api/conversations?manufacturer=${currentManufacturerId}` : 
        '/buyer/api/conversations';
      

      
      const response = await fetch(url);
      
      if (!response.ok) {
        console.warn(`API endpoint not available: ${response.status}`);
        // Silently handle API unavailability - show empty state
        this.conversations = [];
        this.renderEmptyConversations();
        this.showDefaultChatHeader();
        this.showWelcomeState();
        return;
      }
      
      const data = await response.json();
      
      if (data.success) {
        this.conversations = data.data.conversations;
        this.renderConversations();
        
        // If we have current manufacturer from URL, keep header active
        const currentManufacturerId = this.getCurrentManufacturerId();
        if (currentManufacturerId && this.manufacturerDetails) {
          this.updateChatHeader(this.manufacturerDetails);
        } else {
        // Show default chat header when showing all conversations
        this.showDefaultChatHeader();
        }
        
        // Show welcome state if no conversations
        if (this.conversations.length === 0) {
          this.showWelcomeState();
        }
      } else {
        // Handle API error gracefully
        this.conversations = [];
        this.renderEmptyConversations();
        this.showDefaultChatHeader();
        this.showWelcomeState();
      }
    } catch (error) {
      console.warn('Conversations API not available:', error);
      // Silently handle connection errors - show empty state
      this.conversations = [];
      this.renderEmptyConversations();
      this.showDefaultChatHeader();
      this.showWelcomeState();
    }
  }

  // Get current manufacturer ID from URL
  getCurrentManufacturerId() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('manufacturer');
  }

  // Show search indicator
  showSearchIndicator() {
    const searchInput = document.getElementById('conversationSearchInput');
    if (searchInput) {
      searchInput.classList.add('searching');
      // Add loading spinner
      const searchWrapper = searchInput.parentNode;
      if (!searchWrapper.querySelector('.search-spinner')) {
        const spinner = document.createElement('div');
        spinner.className = 'search-spinner';
        spinner.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        searchWrapper.appendChild(spinner);
      }
    }
  }

  // Hide search indicator
  hideSearchIndicator() {
    const searchInput = document.getElementById('conversationSearchInput');
    if (searchInput) {
      searchInput.classList.remove('searching');
      // Remove loading spinner
      const searchWrapper = searchInput.parentNode;
      const spinner = searchWrapper.querySelector('.search-spinner');
      if (spinner) {
        spinner.remove();
      }
    }
  }

  // Show search results count
  showSearchResultsCount(count, query) {
    const searchInput = document.getElementById('conversationSearchInput');
    if (searchInput) {
      const searchWrapper = searchInput.parentNode;
      
      // Remove existing count
      const existingCount = searchWrapper.querySelector('.search-results-count');
      if (existingCount) {
        existingCount.remove();
      }
      
      // Add new count
      const countElement = document.createElement('div');
      countElement.className = 'search-results-count';
      countElement.innerHTML = `
        <span class="count-number">${count}</span>
        <span class="count-text">natija topildi</span>
        <span class="search-query">"${query}"</span>
      `;
      
      searchWrapper.appendChild(countElement);
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        if (countElement.parentNode) {
          countElement.remove();
        }
      }, 3000);
    }
  }

  // Show no search results
  showNoSearchResults(query) {
    const conversationsList = document.querySelector('.conversations-list');
    if (conversationsList) {
      conversationsList.innerHTML = `
        <div class="no-search-results">
          <div class="no-results-icon">
            <i class="fas fa-search"></i>
          </div>
          <h4 class="no-results-title">Natija topilmadi</h4>
          <p class="no-results-description">
            "<strong>${query}</strong>" bilan hech qanday natija topilmadi
          </p>
          <div class="no-results-suggestions">
            <p>Keling, quyidagilarni sinab ko'ring:</p>
            <ul>
              <li>Boshqa kalit so'zlar bilan qidiring</li>
              <li>Kompaniya nomini to'liq yozing</li>
              <li>Ishonchli raqam yoki email bilan qidiring</li>
            </ul>
          </div>
          <button class="clear-search-btn" onclick="window.professionalBuyerMessages.clearSearch()">
            <i class="fas fa-times"></i>
            Qidiruvni tozalash
          </button>
        </div>
      `;
    }
  }

  // Clear search and reload conversations
  clearSearch() {
    const searchInput = document.getElementById('conversationSearchInput');
    if (searchInput) {
      searchInput.value = '';
      this.searchQuery = '';
      
      // Hide clear button
      const clearButton = searchInput.parentNode.querySelector('.search-clear-btn');
      if (clearButton) {
        clearButton.style.display = 'none';
      }
      
      // Remove search classes
      searchInput.classList.remove('searching');
      
      // Reload conversations
      this.loadConversations();
    }
  }

  // Format last message content for sidebar display
  formatLastMessageContent(lastMessage) {
    if (!lastMessage || !lastMessage.content) {
      // Handle different message types when content is null
      switch (lastMessage?.type) {
        case 'image':
          return '🖼️ Rasm';
        case 'file':
          return '📎 Fayl';
        case 'system':
          return 'ℹ️ Tizim xabari';
        case 'order_update':
          return '📋 Buyurtma yangilandi';
        default:
          return '💬 Xabar';
      }
    }
    
    // If content exists, return it
    return lastMessage.content;
  }

  // Load order conversation with manufacturer
  async loadOrderConversation(manufacturerId, orderId) {
    try {
      this.showLoadingState('conversations');
      this.showLoadingState('messages');
      
      // Get manufacturer details and order conversation
      const [detailsResponse, conversationResponse] = await Promise.all([
        fetch(`/buyer/api/manufacturer/${manufacturerId}/details`),
        fetch(`/buyer/api/manufacturer/${manufacturerId}/conversation?order=${orderId}`)
      ]);
      
      if (!detailsResponse.ok) {
        let errorMessage = 'Failed to load manufacturer details';
        try {
          const errorData = await detailsResponse.json();
          errorMessage = errorData?.error?.message || errorData?.message || errorMessage;
        } catch (e) {
          // If JSON parsing fails, use default message
        }
        throw new Error(errorMessage);
      }
      
      if (!conversationResponse.ok) {
        let errorMessage = 'Failed to load order conversation';
        try {
          const errorData = await conversationResponse.json();
          if (errorData?.error?.code === 'ORDER_NOT_FOUND') {
            errorMessage = 'Order not found or you do not have access to this order';
          } else if (errorData?.error?.code === 'INVALID_ORDER_ID') {
            errorMessage = 'Invalid order ID format';
          } else {
            errorMessage = errorData?.error?.message || errorData?.message || errorMessage;
          }
        } catch (e) {
          // If JSON parsing fails, use default message
        }
        throw new Error(errorMessage);
      }
      
      const detailsData = await detailsResponse.json();
      const conversationData = await conversationResponse.json();
      
      if (detailsData.success && conversationData.success) {
        this.manufacturerDetails = detailsData.data.manufacturer;
        
        // Order-based conversation - handle nested data structure
        const orderData = conversationData.data.data || conversationData.data;
        this.currentOrderId = orderData.orderId;
        this.currentInquiryId = null;
        this.conversationType = 'order';
        
        this.messages = orderData.messages;
        
        // Set current conversation ID for active state
        this.currentConversationId = this.currentOrderId ? this.currentOrderId.toString() : null;
        
        // Ensure conversation ID is properly set
        if (!this.currentConversationId) {
          throw new Error('Conversation data failed to load');
        }
        
        // Convert ObjectId to string if needed
        if (typeof this.currentOrderId === 'object' && this.currentOrderId._id) {
          this.currentConversationId = this.currentOrderId._id.toString();
        }
        
        // Update UI with conversation data
        this.updateConversationUI(orderData);
        
        // Mark messages as read when conversation is opened
        if (this.currentOrderId) {
          this.markMessagesAsRead(this.currentOrderId, this.conversationType);
        }
        
        // Show appropriate welcome message based on conversation type
        if (this.messages.length === 0) {
          if (this.conversationType === 'order') {
            this.showOrderWelcome(orderData);
          } else {
            this.showManufacturerWelcome(this.manufacturerDetails);
          }
        } else {
          // If messages exist, render them
          this.renderMessages();
        }
        
        this.hideLoadingState('conversations');
        this.hideLoadingState('messages');
        
      } else {
        throw new Error(conversationData.message || detailsData.message || 'Conversation data failed to load');
      }
      
    } catch (error) {
      this.logger.error('❌ Load order conversation error:', error);
      this.hideLoadingState('conversations');
      this.hideLoadingState('messages');
      this.showErrorMessage(error.message || 'Failed to load conversation');
    }
  }

  // Load manufacturer conversation with professional error handling
  async loadManufacturerConversation(manufacturerId) {
    try {
      this.showLoadingState('conversations');
      this.showLoadingState('messages');
      
      // Get manufacturer details and conversation
      const [detailsResponse, conversationResponse] = await Promise.all([
        fetch(`/buyer/api/manufacturer/${manufacturerId}/details`),
        fetch(`/buyer/api/manufacturer/${manufacturerId}/conversation`)
      ]);
      
      if (!detailsResponse.ok) {
        let errorMessage = 'Failed to load manufacturer details';
        try {
          const errorData = await detailsResponse.json();
          errorMessage = errorData?.error?.message || errorData?.message || errorMessage;
        } catch (e) {
          // If JSON parsing fails, use default message
        }
        throw new Error(errorMessage);
      }
      
      if (!conversationResponse.ok) {
        let errorMessage = 'Failed to load conversation';
        try {
          const errorData = await conversationResponse.json();
          errorMessage = errorData?.error?.message || errorData?.message || errorMessage;
        } catch (e) {
          // If JSON parsing fails, use default message
        }
        throw new Error(errorMessage);
      }
      
      const detailsData = await detailsResponse.json();
      const conversationData = await conversationResponse.json();
      
      if (detailsData.success && conversationData.success) {
        this.manufacturerDetails = detailsData.data.manufacturer;
        
        // Handle nested data structure
        const conversationInfo = conversationData.data.data || conversationData.data;
        
        // Handle both order and inquiry based conversations
        if (conversationInfo.orderId) {
          // Order-based conversation
          this.currentOrderId = conversationInfo.orderId;
          this.currentInquiryId = null;
          this.conversationType = 'order';
        } else if (conversationInfo.inquiryId) {
          // Inquiry-based conversation  
          this.currentInquiryId = conversationInfo.inquiryId;
          this.currentOrderId = null;
          this.conversationType = 'inquiry';
        }
        
        this.messages = conversationInfo.messages;
        
        // Set current conversation ID for active state
        const currentConversationId = this.currentOrderId || this.currentInquiryId;
        this.currentConversationId = currentConversationId ? currentConversationId.toString() : null;
        

        
        // Ensure conversation ID is properly set
        if (!currentConversationId) {
          throw new Error('Conversation data failed to load');
        }
        
        // Convert ObjectId to string if needed
        if (typeof currentConversationId === 'object' && currentConversationId._id) {
          this.currentConversationId = currentConversationId._id.toString();
        } else if (typeof currentConversationId === 'object') {
          this.currentConversationId = currentConversationId.toString();
        }
        

        
        // Load all conversations including current manufacturer
        await this.loadConversations();
        
        // If loadConversations failed or returned empty, create single conversation for sidebar
        if (this.conversations.length === 0) {
          const conversation = {
            id: this.currentConversationId,
            supplier: {
              id: this.manufacturerDetails.id,
              name: this.manufacturerDetails.companyName,
              email: this.manufacturerDetails.email,
              companyLogo: this.manufacturerDetails.companyLogo,
              phone: this.manufacturerDetails.phone
            },
            lastMessage: {
              content: this.messages.length > 0 ? 
                this.messages[this.messages.length - 1].content : 
                'Start conversation',
              timestamp: this.messages.length > 0 ? 
                this.messages[this.messages.length - 1].createdAt : 
                new Date(),
              sender: 'System',
              type: 'system'
            },
            unreadCount: conversationInfo.unreadCount || 0,
            isOnline: this.manufacturerDetails.isOnline
          };
          
          // Add conversation-specific fields based on type
          if (this.conversationType === 'order') {
            conversation.type = 'order';
            conversation.orderId = conversationInfo.orderId;
            conversation.orderNumber = conversationInfo.orderNumber;
            conversation.orderStatus = conversationInfo.orderStatus;
            conversation.orderValue = conversationInfo.orderValue || 0;
            conversation.currency = conversationInfo.currency || 'USD';
          } else if (this.conversationType === 'inquiry') {
            conversation.type = 'inquiry';
            conversation.inquiryId = conversationInfo.inquiryId;
            conversation.inquiryNumber = conversationInfo.inquiryNumber;
            conversation.inquiryStatus = conversationInfo.inquiryStatus;
            conversation.subject = 'Inquiry';
            conversation.priority = 'medium';
          }
          
          this.conversations = [conversation];
        }
        
        // renderConversations() is already called in loadConversations(), so no need to call it again
        this.renderMessages();
        this.updateChatHeader(this.manufacturerDetails);
        
        // Mark messages as read when conversation is opened
        const readConversationId = this.currentOrderId || this.currentInquiryId;
        if (readConversationId) {
          this.markMessagesAsRead(readConversationId, this.conversationType);
        }
        
        // Show manufacturer welcome and quick actions if no messages exist
        if (this.messages.length === 0) {
          this.showManufacturerWelcome(this.manufacturerDetails);
        } else {
          // Render messages and scroll to bottom
          this.renderMessages();
          setTimeout(() => {
            this.scrollToBottom();
          }, 100);
        }
        
        // Mark first conversation as active
        setTimeout(() => {
          const firstConversation = document.querySelector('.conversation-item');
          if (firstConversation) {
            firstConversation.classList.add('active');
          }
        }, 150);
        
      } else {
        this.showErrorState('conversations', window.messageTranslations.errors.manufacturerDataFailed);
        this.showErrorState('messages', window.messageTranslations.errors.conversationDataFailed);
      }
    } catch (error) {
              this.showErrorState('conversations', window.messageTranslations.errors.manufacturerConnectionFailed);
        this.showErrorState('messages', window.messageTranslations.errors.messagesLoadFailed);
    }
  }

  // Update chat header - Show manufacturer details when selected, default state otherwise
  updateChatHeader(manufacturerData = null) {
    const chatHeader = document.querySelector('.chat-header-enhanced');
    const avatar = document.querySelector('.chat-header-avatar');
    const title = document.querySelector('.chat-header-title');
    const meta = document.querySelector('.chat-header-meta');
    const actions = document.querySelector('.chat-header-actions');
    
    if (!chatHeader) return;
    
    // If no manufacturer data, show default state
    if (!manufacturerData && !this.manufacturerDetails) {
      this.showDefaultChatHeader();
      return;
    }
    
    const manufacturer = manufacturerData || this.manufacturerDetails;
    
    // Show manufacturer-specific header
    if (avatar) {
      avatar.style.display = 'block';
      
      // Use product details page approach for company logo
      if (manufacturer.companyLogo && manufacturer.companyLogo.url) {
      avatar.innerHTML = `
          <img src="${manufacturer.companyLogo.url}" alt="${manufacturer.companyName}" onerror="handleLogoError(this)">
          <div class="chat-header-status ${manufacturer.isOnline ? 'online' : 'offline'}"></div>
        `;
      } else {
        avatar.innerHTML = `
          <div class="logo-placeholder">
            <i class="fas fa-building"></i>
          </div>
        <div class="chat-header-status ${manufacturer.isOnline ? 'online' : 'offline'}"></div>
      `;
      }
    }
    
    if (title) {
      title.textContent = manufacturer.companyName;
    }
    
    if (meta) {
      meta.innerHTML = `
        <span>
          <div class="online-indicator ${manufacturer.isOnline ? 'online' : 'offline'}"></div>
          ${manufacturer.isOnline ? window.messageTranslations.header.onlineStatus : window.messageTranslations.header.offlineStatus}
        </span>
        ${manufacturer.email ? `
        <span>
          <i class="fas fa-envelope"></i>
          ${manufacturer.email}
        </span>
        ` : ''}
        ${manufacturer.phone ? `
        <span>
          <i class="fas fa-phone"></i>
          ${manufacturer.phone}
        </span>
        ` : ''}
      `;
    }
    
    if (actions) {
      actions.style.display = 'flex';
      actions.innerHTML = `
        ${manufacturer.phone ? `
        <button onclick="window.location.href='tel:${manufacturer.phone}'" class="chat-action-btn">
          <i class="fas fa-phone"></i>
          <span>${window.messageTranslations.header.callAction}</span>
        </button>
        ` : ''}
        <button onclick="window.location.href='/supplier/${manufacturer.id}'" class="chat-action-btn">
          <i class="fas fa-building"></i>
          <span>${window.messageTranslations.header.profileAction}</span>
        </button>
      `;
    }
    
    // Show input area and quick actions when manufacturer is selected
    const inputArea = document.querySelector('.b2b-message-input-area');
    const quickActions = document.querySelector('.quick-actions-grid');
    if (inputArea) inputArea.style.display = 'block';
    if (quickActions) quickActions.style.display = 'grid';
  }

  // Show default chat header state
  showDefaultChatHeader() {
    const avatar = document.querySelector('.chat-header-avatar');
    const title = document.querySelector('.chat-header-title');
    const meta = document.querySelector('.chat-header-meta');
    const actions = document.querySelector('.chat-header-actions');
    
    if (avatar) avatar.style.display = 'none';
          if (title) title.textContent = window.messageTranslations.header.defaultTitle;
    if (meta) {
              meta.innerHTML = `<span class="chat-subtitle">${window.messageTranslations.header.defaultSubtitle}</span>`;
    }
    if (actions) actions.style.display = 'none';
  }

  // Render conversations grouped by manufacturer
  renderConversationsGrouped() {
    const conversationsList = document.querySelector('.conversations-list');
    if (!conversationsList) return;

    if (this.conversations.length === 0) {
      conversationsList.innerHTML = `
        <div class="no-conversations">
          <div class="no-conversations-icon">
            <i class="fas fa-comments"></i>
          </div>
          <h4>${window.messageTranslations.sidebar.noConversations}</h4>
          <p>${window.messageTranslations.sidebar.noConversationsDesc}</p>
        </div>
      `;
      return;
    }

    let conversationsHTML = '';

    this.conversations.forEach((group, groupIndex) => {
      const manufacturer = group.manufacturer;
      const productChat = group.productChat;
      const orderChats = group.orderChats || [];
      
      // Manufacturer header
      conversationsHTML += `
        <div class="manufacturer-group">
          <div class="manufacturer-header">
            <div class="manufacturer-avatar">
              ${manufacturer.companyLogo && manufacturer.companyLogo.url ? 
                `<img src="${manufacturer.companyLogo.url}" alt="${manufacturer.companyName}" class="avatar-img" onerror="handleLogoError(this)">` :
                manufacturer.avatar && manufacturer.avatar !== '/assets/images/default-company.svg' ?
                  `<img src="${manufacturer.avatar}" alt="${manufacturer.companyName}" class="avatar-img" onerror="handleLogoError(this)">` :
                  `<div class="logo-placeholder"><i class="fas fa-building"></i></div>`
              }
              <div class="conversation-status ${group.isOnline ? 'online' : 'offline'}"></div>
            </div>
            <div class="manufacturer-info">
              <h4 class="manufacturer-name">${manufacturer.companyName}</h4>
              <div class="manufacturer-meta">
                <span class="manufacturer-orders-count">${orderChats.length} order${orderChats.length !== 1 ? 's' : ''}</span>
                ${group.unreadCount > 0 ? `<span class="unread-badge">${group.unreadCount}</span>` : ''}
              </div>
            </div>
          </div>
          
          <div class="manufacturer-chats">
      `;

      // Product chat (if exists)
      if (productChat) {
        const isActive = this.currentConversationId === productChat._id.toString() && this.conversationType === 'inquiry';
        conversationsHTML += `
          <div class="chat-item product-chat ${isActive ? 'active' : ''}" 
               data-conversation-id="${productChat._id}"
               data-conversation-type="inquiry"
               data-manufacturer-id="${manufacturer._id}"
               data-url="/buyer/messages?manufacturer=${manufacturer._id}">
            <div class="chat-content">
              <div class="chat-icon">
                <i class="fas fa-comment-dots"></i>
              </div>
              <div class="chat-details">
                <h5 class="chat-title">Product Chat</h5>
                <p class="chat-subtitle">General inquiry and product discussion</p>
              </div>
              <div class="chat-actions">
                ${productChat.unreadCount > 0 ? `<span class="unread-badge">${productChat.unreadCount}</span>` : ''}
                <div class="chat-arrow">
                  <i class="fas fa-chevron-right"></i>
                </div>
              </div>
            </div>
          </div>
        `;
      } else {
        // Create product chat link
        conversationsHTML += `
          <div class="chat-item product-chat" 
               data-manufacturer-id="${manufacturer._id}"
               data-url="/buyer/messages?manufacturer=${manufacturer._id}">
            <div class="chat-content">
              <div class="chat-icon">
                <i class="fas fa-comment-dots"></i>
              </div>
              <div class="chat-details">
                <h5 class="chat-title">Product Chat</h5>
                <p class="chat-subtitle">Start new product discussion</p>
              </div>
              <div class="chat-arrow">
                <i class="fas fa-chevron-right"></i>
              </div>
            </div>
          </div>
        `;
      }

      // Order chats
      orderChats.forEach((order, orderIndex) => {
        const isActive = this.currentConversationId === order._id.toString() && this.conversationType === 'order';
        conversationsHTML += `
          <div class="chat-item order-chat ${isActive ? 'active' : ''}" 
               data-conversation-id="${order._id}"
               data-conversation-type="order"
               data-manufacturer-id="${manufacturer._id}"
               data-order-id="${order._id}"
               data-url="/buyer/messages?manufacturer=${manufacturer._id}&order=${order._id}">
            <div class="chat-content">
              <div class="chat-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <div class="chat-details">
                <h5 class="chat-title">Order ${order.orderNumber}</h5>
                <p class="chat-subtitle">Status: ${order.status} | $${order.totalAmount} ${order.currency || 'USD'}</p>
              </div>
              <div class="chat-actions">
                ${order.unreadCount > 0 ? `<span class="unread-badge">${order.unreadCount}</span>` : ''}
                <div class="chat-arrow">
                  <i class="fas fa-chevron-right"></i>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      conversationsHTML += `
          </div>
        </div>
      `;
    });

    conversationsList.innerHTML = conversationsHTML;

    // Add click handlers
    this.setupConversationClickHandlers();
  }

  // Render conversations in simple list format
  renderConversations() {
    const conversationsList = document.querySelector('.conversations-list');
    if (!conversationsList) {
      return;
    }

    if (this.conversations.length === 0) {
      conversationsList.innerHTML = `
        <div class="no-conversations">
          <div class="no-conversations-icon">
            <i class="fas fa-comments"></i>
          </div>
          <h4>${window.messageTranslations.sidebar.noConversations}</h4>
          <p>${window.messageTranslations.sidebar.noConversationsDesc}</p>
        </div>
      `;
      return;
    }

    let conversationsHTML = '';

    this.conversations.forEach((conversation, index) => {
      const manufacturer = conversation.manufacturer;
      const isActive = this.currentConversationId === conversation._id.toString();
      const lastMessage = conversation.lastMessage;
      const lastMessageText = lastMessage ? 
        (lastMessage.content.length > 50 ? lastMessage.content.substring(0, 50) + '...' : lastMessage.content) : 
        'No messages yet';
      
      // Determine chat type and icon
      const chatType = conversation.type === 'product' ? 'Product Chat' : `Order ${conversation.orderNumber}`;
      const chatIcon = conversation.type === 'product' ? 'fa-comment-dots' : 'fa-shopping-cart';
      const chatSubtitle = conversation.type === 'product' ? 
        'General inquiry and product discussion' : 
        `Status: ${conversation.orderStatus} | $${conversation.orderAmount}`;
      
      // Generate URL
      const url = conversation.type === 'product' ? 
        `/buyer/messages?manufacturer=${manufacturer._id}` : 
        `/buyer/messages?manufacturer=${manufacturer._id}&order=${conversation._id}`;

      conversationsHTML += `
        <div class="conversation-item ${isActive ? 'active' : ''}" 
             data-conversation-id="${conversation._id}"
             data-manufacturer-id="${manufacturer._id}"
             data-type="${conversation.type}"
             data-url="${url}">
          <div class="conversation-avatar">
            ${manufacturer.companyLogo && manufacturer.companyLogo.url ? 
              `<img src="${manufacturer.companyLogo.url}" alt="${manufacturer.companyName}" class="avatar-img" onerror="handleLogoError(this)">` :
              manufacturer.avatar && manufacturer.avatar !== '/assets/images/default-company.svg' ?
                `<img src="${manufacturer.avatar}" alt="${manufacturer.companyName}" class="avatar-img" onerror="handleLogoError(this)">` :
                `<div class="logo-placeholder"><i class="fas fa-building"></i></div>`
            }
            <div class="conversation-status ${conversation.isOnline ? 'online' : 'offline'}"></div>
          </div>
          <div class="conversation-content">
            <div class="conversation-header">
              <h4 class="conversation-name">${manufacturer.companyName}</h4>
              <div class="conversation-meta">
                <span class="conversation-type">${chatType}</span>
                ${conversation.unreadCount > 0 ? `<span class="unread-badge">${conversation.unreadCount}</span>` : ''}
              </div>
            </div>
            <div class="conversation-preview">
              <p class="last-message">${lastMessageText}</p>
              <span class="message-time">${this.formatMessageTime(conversation.updatedAt)}</span>
            </div>
          </div>
          <div class="conversation-arrow">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
      `;
    });

      conversationsList.innerHTML = conversationsHTML;
    this.setupConversationClickHandlers();
  }

  // Setup click handlers for conversation items
  setupConversationClickHandlers() {
    // Use event delegation for better performance and reliability
    const conversationsList = document.querySelector('.conversations-list');
    if (!conversationsList) return;
    
    // Remove existing event listeners
    conversationsList.removeEventListener('click', this.handleConversationClick);
    
    // Add new event listener with bound context
    this.handleConversationClick = this.handleConversationClick.bind(this);
    conversationsList.addEventListener('click', this.handleConversationClick);
  }
  
  handleConversationClick(e) {
    const conversationItem = e.target.closest('.conversation-item');
    if (!conversationItem) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    const url = conversationItem.dataset.url;
    const conversationType = conversationItem.dataset.type;
    const manufacturerId = conversationItem.dataset.manufacturerId;
    const orderId = conversationItem.dataset.orderId;
    
    // Update active state
    const allItems = document.querySelectorAll('.conversation-item');
    allItems.forEach(ci => ci.classList.remove('active'));
    conversationItem.classList.add('active');
    
    // Navigate to the chat
    if (url) {
      window.location.href = url;
    } else if (conversationType === 'inquiry' && manufacturerId) {
      window.location.href = `/buyer/messages?manufacturer=${manufacturerId}`;
    } else if (conversationType === 'order' && manufacturerId && orderId) {
      window.location.href = `/buyer/messages?manufacturer=${manufacturerId}&order=${orderId}`;
    }
  }

  // Render conversations in sidebar
  renderConversations() {
    const conversationsList = document.querySelector('.conversations-list');
    if (!conversationsList) return;



    if (this.conversations.length === 0) {
      conversationsList.innerHTML = `
        <div class="no-conversations">
          <div class="no-conversations-icon">
            <i class="fas fa-comments"></i>
        </div>
          <h4>${window.messageTranslations.sidebar.noConversations}</h4>
          <p>${window.messageTranslations.sidebar.noConversationsDesc}</p>
      </div>
    `;
      return;
    }



    // Separate current manufacturer and other conversations
    const currentManufacturerId = this.getCurrentManufacturerId();
    const currentConversations = this.conversations.filter(conv => conv.manufacturer._id === currentManufacturerId);
    const otherConversations = this.conversations.filter(conv => conv.manufacturer._id !== currentManufacturerId);

    // Show current manufacturer at top if manufacturer is selected (regardless of message history)
    const shouldShowCurrentAtTop = currentConversations.length > 0 && currentManufacturerId;



    let conversationsHTML = '';

    // Show current manufacturer conversations at top if manufacturer is selected
    if (shouldShowCurrentAtTop) {
      currentConversations.forEach((currentConversation, index) => {
        conversationsHTML += `
          <div class="conversation-item current-manufacturer ${currentConversation._id === this.currentConversationId ? 'active' : ''}" 
               data-conversation-id="${currentConversation._id}"
               data-conversation-index="${index}"
               data-supplier-id="${currentConversation.manufacturer._id}"
               data-type="${currentConversation.type || 'product'}"
               data-manufacturer-id="${currentConversation.manufacturer._id}"
               data-order-id="${currentConversation.type === 'order' ? currentConversation._id : ''}"
               data-url="${currentConversation.type === 'order' ? `/buyer/messages?manufacturer=${currentConversation.manufacturer._id}&order=${currentConversation._id}` : `/buyer/messages?manufacturer=${currentConversation.manufacturer._id}`}">
          <div class="conversation-content">
            <div class="conversation-avatar">
              ${currentConversation.manufacturer.companyLogo && currentConversation.manufacturer.companyLogo.url ? 
                `<img src="${currentConversation.manufacturer.companyLogo.url}" alt="${currentConversation.manufacturer.companyName}" class="avatar-img" onerror="handleLogoError(this)">` :
                currentConversation.manufacturer.avatar && currentConversation.manufacturer.avatar !== '/assets/images/default-company.svg' ?
                  `<img src="${currentConversation.manufacturer.avatar}" alt="${currentConversation.manufacturer.companyName}" class="avatar-img" onerror="handleLogoError(this)">` :
                  `<div class="logo-placeholder"><i class="fas fa-building"></i></div>`
              }
              <div class="conversation-status ${currentConversation.isOnline ? 'online' : 'offline'}"></div>
            </div>
            <div class="conversation-details">
              <div class="conversation-header">
                <div class="conversation-title">
                  <h4 class="conversation-name">${currentConversation.manufacturer.companyName}</h4>
                  <div class="conversation-badges">
                    <span class="chat-type-badge ${currentConversation.type === 'product' ? 'product-chat' : 'order-chat'}">
                      ${currentConversation.type === 'product' ? 'Product Chat' : `Order Chat`}
                    </span>
                    ${currentConversation.unreadCount > 0 ? `<span class="unread-badge">${currentConversation.unreadCount}</span>` : ''}
                  </div>
                </div>
                <span class="conversation-time">${currentConversation.lastMessage ? this.formatTime(currentConversation.lastMessage.createdAt) : ''}</span>
              </div>
              <div class="conversation-preview">
                <p class="last-message">${currentConversation.lastMessage ? this.formatLastMessageContent(currentConversation.lastMessage) : 'No messages yet'}</p>
                ${currentConversation.unreadCount > 0 ? `<span class="unread-badge">${currentConversation.unreadCount}</span>` : ''}
              </div>
              <div class="conversation-meta">
                <span class="order-info">${currentConversation.orderNumber || ''}</span>
                <span class="status-badge ${currentConversation.orderStatus || ''}">${currentConversation.orderStatus ? this.formatStatus(currentConversation.orderStatus) : ''}</span>
              </div>
            </div>
          </div>
        </div>
      `;
      });
    }

    // Show other conversations (already filtered to exclude current manufacturer)
    const conversationsToShow = otherConversations;
    conversationsToShow.forEach((conv, index) => {
      const isCurrent = false; // Current manufacturer is already shown at top if needed
      conversationsHTML += `
        <div class="conversation-item ${isCurrent ? 'current-manufacturer' : ''} ${conv._id === this.currentConversationId ? 'active' : ''}" 
             data-conversation-id="${conv._id}"
             data-conversation-index="${index}"
             data-supplier-id="${conv.manufacturer._id}"
             data-type="${conv.type || 'product'}"
             data-manufacturer-id="${conv.manufacturer._id}"
             data-order-id="${conv.type === 'order' ? conv._id : ''}"
             data-url="${conv.type === 'order' ? `/buyer/messages?manufacturer=${conv.manufacturer._id}&order=${conv._id}` : `/buyer/messages?manufacturer=${conv.manufacturer._id}`}">
          <div class="conversation-content">
            <div class="conversation-avatar">
              ${conv.manufacturer.companyLogo && conv.manufacturer.companyLogo.url ? 
                `<img src="${conv.manufacturer.companyLogo.url}" alt="${conv.manufacturer.companyName}" class="avatar-img" onerror="handleLogoError(this)">` :
                conv.manufacturer.avatar && conv.manufacturer.avatar !== '/assets/images/default-company.svg' ?
                  `<img src="${conv.manufacturer.avatar}" alt="${conv.manufacturer.companyName}" class="avatar-img" onerror="handleLogoError(this)">` :
                  `<div class="logo-placeholder"><i class="fas fa-building"></i></div>`
              }
              <div class="conversation-status ${conv.isOnline ? 'online' : 'offline'}"></div>
            </div>
            <div class="conversation-details">
              <div class="conversation-header">
                <div class="conversation-title">
                  <h4 class="conversation-name">${conv.manufacturer.companyName}</h4>
                  <div class="conversation-badges">
                    <span class="chat-type-badge ${conv.type === 'product' ? 'product-chat' : 'order-chat'}">
                      ${conv.type === 'product' ? 'Product Chat' : `Order Chat`}
                    </span>
                    ${conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                  </div>
                </div>
                <span class="conversation-time">${conv.lastMessage ? this.formatTime(conv.lastMessage.createdAt) : ''}</span>
              </div>
              <div class="conversation-preview">
                <p class="last-message">${conv.lastMessage ? this.formatLastMessageContent(conv.lastMessage) : 'No messages yet'}</p>
                ${conv.unreadCount > 0 ? `<span class="last-message-unread-badge">${conv.unreadCount}</span>` : ''}
              </div>
              <div class="conversation-meta">
                <span class="order-info">${conv.orderNumber || ''}</span>
                <span class="status-badge ${conv.orderStatus || ''}">${conv.orderStatus ? this.formatStatus(conv.orderStatus) : ''}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    });

    conversationsList.innerHTML = conversationsHTML;
    this.setupConversationClickHandlers();
  }


  // Render empty conversations list (when there's an error or no data)
  renderEmptyConversations() {
    const conversationsList = document.querySelector('.conversations-list');
    if (conversationsList) {
      conversationsList.innerHTML = `
        <div class="no-conversations">
          <div class="no-conversations-icon">
            <i class="fas fa-comments"></i>
          </div>
          <h4>Hali suhbatlar yo'q</h4>
          <p>Manufacturer bilan suhbat boshlash uchun product details yoki supplier profile sahifasiga o'ting</p>
        </div>
      `;
    }
  }

  // Show no search results state
  showNoSearchResults() {
    const conversationsList = document.querySelector('.conversations-list');
    if (conversationsList) {
      conversationsList.innerHTML = `
        <div class="no-search-results">
          <div class="no-search-results-icon">
            <i class="fas fa-search"></i>
          </div>
          <h4>Qidiruv natijasi topilmadi</h4>
          <p>"${this.searchQuery}" bo'yicha hech qanday suhbat topilmadi</p>
          <button class="clear-search-btn" onclick="this.clearSearch()">
            <i class="fas fa-times"></i>
            Qidiruvni tozalash
          </button>
        </div>
      `;
    }
  }

  // Clear search and show all conversations
  clearSearch() {
    const searchInput = document.getElementById('conversationSearchInput');
    if (searchInput) {
      searchInput.value = '';
      this.searchQuery = '';
    }
    this.loadConversations();
  }

  // Load messages for specific order with professional error handling
  async loadMessages(orderId) {
    try {
      this.showLoadingState('messages');
      
      const response = await fetch(`/buyer/api/orders/${orderId}/messages`);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      
      if (data.success) {
        this.messages = data.data.messages;
        this.renderMessages();
        
        // Mark messages as read when conversation is loaded
        if (orderId) {
          this.markMessagesAsRead(orderId, 'order');
        }
        
        // Auto scroll to bottom after loading messages
        setTimeout(() => {
          this.scrollToBottom();
        }, 50);
      } else {
        this.showErrorState('messages', data.message || window.messageTranslations.errors.loadMessagesFailedEn);
      }
    } catch (error) {
      this.showErrorState('messages', window.messageTranslations.errors.loadMessagesFailed);
    }
  }

  // Render messages in chat area with manufacturer chat style
  renderMessages() {
    const messagesContainer = document.querySelector('.messages-container');
    if (!messagesContainer) return;

    if (this.messages.length === 0) {
      // Show welcome state
      this.showWelcomeState();
      return;
    }

    // Group messages by date
    const messagesByDate = this.groupMessagesByDate(this.messages);
    
    messagesContainer.innerHTML = Object.entries(messagesByDate).map(([date, messages]) => `
      <div class="message-date-group">
        <div class="telegram-date-separator">
          <span>${date}</span>
        </div>
        ${messages.map(msg => this.renderMessage(msg)).join('')}
      </div>
    `).join('');
    
    // Enhanced scroll to bottom with smooth behavior
    this.scrollToBottom(messagesContainer);
  }
  
  // Smooth scroll to bottom functionality
  scrollToBottom(container = null, smooth = true) {
    const messagesContainer = container || document.querySelector('.messages-container');
    if (!messagesContainer) return;
    
    // Use requestAnimationFrame for better performance
    requestAnimationFrame(() => {
      if (smooth) {
        messagesContainer.scrollTo({
          top: messagesContainer.scrollHeight,
          behavior: 'smooth'
        });
      } else {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    });
  }



  // Open image modal (class method)
  openImageModal(imageUrl, imageTitle) {
    
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalImageTitle');
    
    if (!modal) {
      return;
    }
    
    modalImage.src = imageUrl;
    modalTitle.textContent = imageTitle || 'Image';
    modal.style.display = 'flex';
    
    // Store current image URL for download
    window.currentModalImageUrl = imageUrl;
    window.currentModalImageName = imageTitle || 'image';
    
    // Initialize image zoom and drag functionality
    this.initImageZoomAndDrag(modalImage);
    
  }

  // Initialize image zoom and drag functionality
  initImageZoomAndDrag(imageElement) {
    let isZoomed = false;
    let isDragging = false;
    let startX, startY, translateX = 0, translateY = 0;
    let currentScale = 1;
    let lastTouchDistance = 0;
    let lastTouchCenter = { x: 0, y: 0 };
    
    // Store references for external access
    this.currentImageElement = imageElement;
    this.imageState = { isZoomed, isDragging, translateX, translateY, currentScale };
    
    // Reset image state
    imageElement.classList.remove('zoomed');
    imageElement.style.transform = 'scale(1) translate(0px, 0px)';
    
    // Apply smooth transitions
    imageElement.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
    
    // Click to zoom in/out
    imageElement.addEventListener('click', (e) => {
      if (!isDragging && !e.ctrlKey) {
        if (!isZoomed) {
          // Zoom in to fit screen
          this.zoomToFit(imageElement);
        } else {
          // Zoom out
          this.resetImage();
        }
      }
    });
    
    // Mouse wheel zoom
    imageElement.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      this.zoomByFactor(delta, e.offsetX, e.offsetY);
    });
    
    // Mouse events for dragging
    imageElement.addEventListener('mousedown', (e) => {
      if (isZoomed) {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        imageElement.style.cursor = 'grabbing';
        imageElement.style.transition = 'none';
        this.imageState.isDragging = true;
        
        // Add event listeners to document for better drag handling
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      }
    });
    
    const handleMouseMove = (e) => {
      if (isDragging && isZoomed) {
        e.preventDefault();
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        
        // Apply bounds to prevent dragging too far
        const bounds = this.calculateDragBounds(imageElement, currentScale);
        translateX = Math.max(bounds.minX, Math.min(bounds.maxX, translateX));
        translateY = Math.max(bounds.minY, Math.min(bounds.maxY, translateY));
        
        imageElement.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
        this.imageState.translateX = translateX;
        this.imageState.translateY = translateY;
        
        // Add dragging class for visual feedback
        imageElement.classList.add('dragging');
      }
    };
    
    const handleMouseUp = () => {
      if (isDragging) {
        isDragging = false;
        imageElement.style.cursor = 'grab';
        imageElement.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        this.imageState.isDragging = false;
        
        // Remove dragging class
        imageElement.classList.remove('dragging');
        
        // Remove document event listeners
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      }
    };
    

    
    // Touch events for mobile
    imageElement.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        // Single touch - start dragging
        if (isZoomed) {
          e.preventDefault();
          isDragging = true;
          const touch = e.touches[0];
          startX = touch.clientX - translateX;
          startY = touch.clientY - translateY;
          imageElement.style.transition = 'none';
          this.imageState.isDragging = true;
        }
      } else if (e.touches.length === 2) {
        // Two touches - start pinch zoom
        e.preventDefault();
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        lastTouchDistance = this.getTouchDistance(touch1, touch2);
        lastTouchCenter = this.getTouchCenter(touch1, touch2);
      }
    });
    
    imageElement.addEventListener('touchmove', (e) => {
      e.preventDefault();
      
      if (e.touches.length === 1 && isDragging) {
        // Single touch - continue dragging
        const touch = e.touches[0];
        translateX = touch.clientX - startX;
        translateY = touch.clientY - startY;
        
        const bounds = this.calculateDragBounds(imageElement, currentScale);
        translateX = Math.max(bounds.minX, Math.min(bounds.maxX, translateX));
        translateY = Math.max(bounds.minY, Math.min(bounds.maxY, translateY));
        
        imageElement.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
        this.imageState.translateX = translateX;
        this.imageState.translateY = translateY;
        
        // Add dragging class for visual feedback
        imageElement.classList.add('dragging');
      } else if (e.touches.length === 2) {
        // Two touches - pinch zoom
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const distance = this.getTouchDistance(touch1, touch2);
        const center = this.getTouchCenter(touch1, touch2);
        
        if (lastTouchDistance > 0) {
          const scaleFactor = distance / lastTouchDistance;
          const newScale = Math.max(0.3, Math.min(5, currentScale * scaleFactor));
          
          if (newScale !== currentScale) {
            currentScale = newScale;
            isZoomed = newScale > 1.1;
            
            // Calculate new position to zoom towards center
            const rect = imageElement.getBoundingClientRect();
            const centerX = center.x - rect.left;
            const centerY = center.y - rect.top;
            
            translateX = centerX - (centerX - translateX) * scaleFactor;
            translateY = centerY - (centerY - translateY) * scaleFactor;
            
            const bounds = this.calculateDragBounds(imageElement, currentScale);
            translateX = Math.max(bounds.minX, Math.min(bounds.maxX, translateX));
            translateY = Math.max(bounds.minY, Math.min(bounds.maxY, translateY));
            
            imageElement.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
            this.imageState = { isZoomed, isDragging, translateX, translateY, currentScale };
          }
        }
        
        lastTouchDistance = distance;
        lastTouchCenter = center;
      }
    });
    
    imageElement.addEventListener('touchend', (e) => {
      if (e.touches.length === 0) {
        isDragging = false;
        lastTouchDistance = 0;
        imageElement.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        this.imageState.isDragging = false;
        
        // Remove dragging class
        imageElement.classList.remove('dragging');
      }
    });
    
    // Double click to reset
    imageElement.addEventListener('dblclick', () => {
      this.resetImage();
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (this.currentImageElement === imageElement) {
        switch(e.key) {
          case 'Escape':
            this.resetImage();
            break;
          case '+':
          case '=':
            e.preventDefault();
            this.zoomByFactor(1.2);
            break;
          case '-':
            e.preventDefault();
            this.zoomByFactor(0.8);
            break;
          case '0':
            e.preventDefault();
            this.resetImage();
            break;
        }
      }
    });
  }

  // Helper methods for zoom and drag
  getTouchDistance(touch1, touch2) {
    const dx = touch1.clientX - touch2.clientX;
    const dy = touch1.clientY - touch2.clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  getTouchCenter(touch1, touch2) {
    return {
      x: (touch1.clientX + touch2.clientX) / 2,
      y: (touch1.clientY + touch2.clientY) / 2
    };
  }

  calculateDragBounds(imageElement, scale) {
    const rect = imageElement.getBoundingClientRect();
    const modalBody = document.querySelector('.telegram-modal-body');
    
    if (!modalBody) {
      return { minX: -1000, maxX: 1000, minY: -1000, maxY: 1000 };
    }
    
    const modalRect = modalBody.getBoundingClientRect();
    
    // Calculate scaled dimensions
    const scaledWidth = rect.width * scale;
    const scaledHeight = rect.height * scale;
    
    // Calculate maximum allowed translation
    const maxTranslateX = Math.max(0, (scaledWidth - modalRect.width) / 2);
    const maxTranslateY = Math.max(0, (scaledHeight - modalRect.height) / 2);
    
    // Add some padding to prevent image from going too far
    const padding = 20;
    
    return {
      minX: -maxTranslateX - padding,
      maxX: maxTranslateX + padding,
      minY: -maxTranslateY - padding,
      maxY: maxTranslateY + padding
    };
  }

  zoomToFit(imageElement) {
    const modalBody = document.querySelector('.telegram-modal-body');
    const modalRect = modalBody.getBoundingClientRect();
    const imageRect = imageElement.getBoundingClientRect();
    
    const scaleX = modalRect.width / imageRect.width;
    const scaleY = modalRect.height / imageRect.height;
    const scale = Math.min(scaleX, scaleY, 2); // Max 2x zoom for fit
    
    this.applyZoom(scale);
  }

  zoomByFactor(factor, centerX = null, centerY = null) {
    if (!this.currentImageElement) return;
    
    const { currentScale, translateX, translateY } = this.imageState;
    let newScale = Math.max(0.3, Math.min(5, currentScale * factor));
    
    // If zooming towards a specific point
    if (centerX !== null && centerY !== null) {
      const rect = this.currentImageElement.getBoundingClientRect();
      const imageCenterX = rect.width / 2;
      const imageCenterY = rect.height / 2;
      
      const newTranslateX = centerX - (centerX - translateX) * factor;
      const newTranslateY = centerY - (centerY - translateY) * factor;
      
      this.imageState.translateX = newTranslateX;
      this.imageState.translateY = newTranslateY;
    }
    
    this.applyZoom(newScale);
  }

  applyZoom(scale) {
    if (!this.currentImageElement) return;
    
    this.imageState.currentScale = scale;
    this.imageState.isZoomed = scale > 1.1;
    
    if (scale > 1.1) {
      this.currentImageElement.classList.add('zoomed');
    } else {
      this.currentImageElement.classList.remove('zoomed');
    }
    
    // Apply bounds to prevent image from going too far
    const bounds = this.calculateDragBounds(this.currentImageElement, scale);
    this.imageState.translateX = Math.max(bounds.minX, Math.min(bounds.maxX, this.imageState.translateX));
    this.imageState.translateY = Math.max(bounds.minY, Math.min(bounds.maxY, this.imageState.translateY));
    
    this.currentImageElement.style.transform = `scale(${scale}) translate(${this.imageState.translateX}px, ${this.imageState.translateY}px)`;
    
    // Update zoom indicator
    this.updateZoomIndicator(scale);
  }

  updateZoomIndicator(scale) {
    const indicator = document.getElementById('zoomIndicator');
    const percentage = document.getElementById('zoomPercentage');
    
    if (indicator && percentage) {
      const zoomPercent = Math.round(scale * 100);
      percentage.textContent = `${zoomPercent}%`;
      
      // Show indicator when zoomed
      if (scale > 1.1) {
        indicator.classList.add('visible');
        // Hide after 2 seconds
        setTimeout(() => {
          indicator.classList.remove('visible');
        }, 2000);
      } else {
        indicator.classList.remove('visible');
      }
    }
  }

  // Zoom image method
  zoomImage(direction) {
    if (!this.currentImageElement) return;
    
    const factor = direction === 'in' ? 1.3 : 0.8;
    this.zoomByFactor(factor);
  }

  // Reset image method
  resetImage() {
    if (!this.currentImageElement) return;
    
    this.currentImageElement.classList.remove('zoomed');
    this.currentImageElement.classList.remove('dragging');
    this.currentImageElement.style.transform = 'scale(1) translate(0px, 0px)';
    this.imageState = {
      isZoomed: false,
      isDragging: false,
      translateX: 0,
      translateY: 0,
      currentScale: 1
    };
  }

  // Render single message with Telegram style
  renderMessage(message) {
    const currentUserId = '<%= user._id %>'; // Get current user ID from EJS
    const isOwn = message.senderId._id === currentUserId;
    
    return `
      <div class="telegram-message ${isOwn ? 'own' : ''}">
        ${!isOwn ? `
          <div class="telegram-message-avatar">
            <img src="${this.manufacturerDetails?.companyLogo?.url || '/assets/images/avatars/default-company.png'}" 
                 alt="${this.manufacturerDetails?.companyName || window.messageTranslations.fileTypes.manufacturer}"
                 onerror="this.src='/assets/images/avatars/default-company.png'">
        </div>
        ` : ''}
        
        <div class="telegram-message-content">
          <div class="telegram-message-bubble">
            ${message.content ? `
              <div class="telegram-message-text">
                ${message.content.replace(/\n/g, '<br>')}
        </div>
            ` : ''}
            
            ${message.attachments && message.attachments.length > 0 ? `
              <div class="telegram-message-attachments">
                ${message.attachments.map(attachment => this.renderAttachment(attachment)).join('')}
              </div>
            ` : ''}
            
            ${!message.content && message.attachments && message.attachments.length > 0 ? `
              <div class="telegram-message-info">
                <small class="telegram-file-only"></small>
              </div>
            ` : ''}
            
            <div class="telegram-message-footer">
              <div class="telegram-message-time">
                ${this.formatTime(message.createdAt)}
              </div>
              ${isOwn ? `
                <div class="telegram-message-status">
                  ${message.status === 'read' ? 
                    `<i class="fas fa-check-double telegram-status-read" title="${window.messageTranslations.status.read}"></i>` : 
                    message.status === 'delivered' ? 
                    `<i class="fas fa-check-double telegram-status-delivered" title="${window.messageTranslations.status.delivered}"></i>` : 
                    `<i class="fas fa-check telegram-status-sent" title="${window.messageTranslations.status.sent}"></i>`
                  }
                </div>
              ` : ''}
            </div>
          </div>
        </div>
        
        ${/* Buyer messages (own) don't show avatar in professional chat */ ''}
      </div>
    `;
  }

  // Render attachment with professional styling
  renderAttachment(attachment) {
    // Check if it's an image based on file extension or mimeType
    const isImage = (attachment.mimeType && attachment.mimeType.startsWith('image/')) || 
                   (attachment.originalName && /\.(jpg|jpeg|png|gif|webp)$/i.test(attachment.originalName));
    
    if (isImage) {
      return `
        <div class="telegram-attachment-image" onclick="if(window.professionalBuyerMessages) { window.professionalBuyerMessages.openImageModal('${attachment.url}', '${attachment.originalName || 'Image'}'); } else { alert('Messages system not available'); }">
          <img src="${attachment.url}" 
                               alt="${attachment.originalName || window.messageTranslations.fileTypes.unknown}" 
               data-image-url="${attachment.url}"
                               data-image-title="${attachment.originalName || window.messageTranslations.fileTypes.unknown}"
               onerror="this.src='/assets/images/no-image.png'; this.onerror=null;">
          <div class="telegram-image-overlay">
            <i class="fas fa-search-plus"></i>
          </div>
        </div>
      `;
    } else {
      return `
        <div class="telegram-attachment-file">
          <div class="telegram-file-icon">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="telegram-file-details">
            <h6>${attachment.originalName || window.messageTranslations.fileTypes.file}</h6>
            <p>${(attachment.size / 1024).toFixed(1)} KB</p>
          </div>
          <div class="telegram-file-actions">
            <a href="${attachment.url}" download="${attachment.originalName}" class="telegram-file-download" title="${window.messageTranslations.attachments.download}">
              <i class="fas fa-download"></i>
            </a>
          </div>
        </div>
      `;
    }
  }

  // Send message with professional error handling and typing indicator
  async sendMessage(event) {
    // Prevent duplicate submissions
    if (event) {
    event.preventDefault();
    }
    
    // Check if already sending
    if (this.isSending) {
      return;
    }
    
    const messageContent = this.messageInput.value.trim();
    const hasAttachments = this.attachments.length > 0;
    
    // Allow sending if there's text OR attachments
    const conversationId = this.currentOrderId || this.currentInquiryId;
    if ((!messageContent && !hasAttachments) || !conversationId) {
      if (!messageContent && !hasAttachments) {
        this.showErrorMessage(window.messageTranslations.errors.sendMessageContent);
      }
      return;
    }

    try {
      // Set sending state to prevent duplicates
      this.isSending = true;
      
      // Disable send button during sending
      this.setSendingState(true);
      
      // Show typing indicator
      this.showTypingIndicator();
      
      
      // Validate conversation ID
      if (!conversationId) {
        this.showErrorMessage('Suhbat ma\'lumotlari topilmadi. Iltimos, sahifani yangilang');
        return;
      }
      
      // Create FormData for file upload
      const formData = new FormData();
      
      // Add conversation-specific fields
      if (this.conversationType === 'order') {
        formData.append('orderId', conversationId);
      } else if (this.conversationType === 'inquiry') {
        formData.append('inquiryId', conversationId);
      }
      
      formData.append('context', this.conversationType || 'order');
      
      // Only append message if user typed something
      if (messageContent && messageContent.trim()) {
        formData.append('message', messageContent.trim());
      }
      
      // Add attachments if any
      this.attachments.forEach((attachment, index) => {
        formData.append('attachments', attachment.file);
      });
      
      
      const response = await fetch('/buyer/api/send-message', {
      method: 'POST',
        body: formData // Send as FormData for file upload
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      
      if (data.success) {
        
        // Hide typing indicator
        this.hideTypingIndicator();
        
        // Clear input and attachments
        this.messageInput.value = '';
        this.attachments = [];
        this.renderAttachments();
        this.updateSendButton();
        
        // Reload messages
        if (this.conversationType === 'order' && this.currentOrderId) {
          await this.loadMessages(this.currentOrderId);
        } else {
          // For inquiries, reload the entire conversation
          await this.loadManufacturerConversation(this.currentManufacturerId);
        }
        
        // Update conversations list
        await this.loadConversations();
        
        // Scroll to bottom to show new message
        setTimeout(() => {
          this.scrollToBottom();
        }, 100);
        
        // Show appropriate success message
        if (messageContent && this.attachments.length > 0) {
          this.showSuccessMessage(window.messageTranslations.errors.sendSuccessWithFiles);
        } else if (this.attachments.length > 0) {
          this.showSuccessMessage(window.messageTranslations.errors.sendSuccessFilesOnly);
        } else {
        this.showSuccessMessage(window.messageTranslations.errors.sendSuccess);
        }
      } else {
        this.hideTypingIndicator();
        this.showErrorMessage(data.message || window.messageTranslations.errors.sendFailed);
      }
    } catch (error) {
      this.hideTypingIndicator();
      this.showErrorMessage(window.messageTranslations.errors.sendFailedGeneral);
    } finally {
      // Reset sending state
      this.isSending = false;
      this.setSendingState(false);
    }
  }

  // Setup file input event listeners
  setupFileInputs() {
    const fileInput = document.getElementById('fileInput');
    const imageInput = document.getElementById('imageInput');
    
    if (fileInput) {
      fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
    }
    
    if (imageInput) {
      imageInput.addEventListener('change', (e) => this.handleImageSelect(e));
    }
  }

  // Setup search input with professional search functionality
  setupSearchInput() {
    const searchInput = document.getElementById('conversationSearchInput');
    
    if (searchInput) {
             // Clear search button
       const clearButton = document.createElement('button');
       clearButton.className = 'search-clear-btn';
       clearButton.innerHTML = '×';
       clearButton.style.display = 'none';
       clearButton.title = window.messageTranslations.errors.clearSearchTitle;
      
      // Insert clear button after search input
      searchInput.parentNode.insertBefore(clearButton, searchInput.nextSibling);
      
      // Input event with enhanced search
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        this.searchQuery = query;
        
        // Show/hide clear button
        clearButton.style.display = query ? 'block' : 'none';
        
        // Update search placeholder
        if (query) {
          searchInput.classList.add('searching');
        } else {
          searchInput.classList.remove('searching');
        }
        
        // Debounced search
        this.debouncedSearch();
      });
      
      // Clear button click
      clearButton.addEventListener('click', () => {
        searchInput.value = '';
        this.searchQuery = '';
        clearButton.style.display = 'none';
        searchInput.classList.remove('searching');
        searchInput.focus();
        this.performSearch(); // Reload all conversations
      });
      
      // Enter key search
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.performSearch();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          searchInput.value = '';
          this.searchQuery = '';
          clearButton.style.display = 'none';
          searchInput.classList.remove('searching');
          this.performSearch(); // Reload all conversations
        }
      });
      
      // Focus and blur events
      searchInput.addEventListener('focus', () => {
        searchInput.parentNode.classList.add('focused');
      });
      
      searchInput.addEventListener('blur', () => {
        searchInput.parentNode.classList.remove('focused');
      });
      
      // Initial state
      this.searchQuery = '';
      clearButton.style.display = 'none';
    }
  }

  // Handle file selection with validation
  async handleFileSelect(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    let addedCount = 0;
    for (const file of files) {
      if (this.validateFile(file)) {
        await this.addAttachment(file);
        addedCount++;
      }
    }
    
    if (addedCount > 0) {
      this.showSuccessMessage(`${addedCount} ta fayl muvaffaqiyatli qo'shildi`);
    }
    
    // Clear input for next selection
    event.target.value = '';
    this.hideAttachmentMenu();
  }

  // Handle image selection with validation
  async handleImageSelect(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    let addedCount = 0;
    for (const file of files) {
      if (this.validateFile(file, 'image')) {
        await this.addAttachment(file);
        addedCount++;
      }
    }
    
    if (addedCount > 0) {
      this.showSuccessMessage(`${addedCount} ta rasm muvaffaqiyatli qo'shildi`);
    }
    
    // Clear input for next selection
    event.target.value = '';
    this.hideAttachmentMenu();
  }

  // Validate file before adding
  validateFile(file, type = null) {
    // Check file size
    if (file.size > this.maxFileSize) {
      this.showErrorMessage(`Fayl hajmi juda katta: ${(file.size / 1024 / 1024).toFixed(1)}MB. Maksimal: 10MB`);
      return false;
    }
    
    // Check file type
    if (type === 'image') {
      if (!this.allowedFileTypes.image.includes(file.type)) {
        this.showErrorMessage(`Rasm formati noto'g'ri: ${file.type}. Faqat: JPEG, PNG, GIF, WebP`);
        return false;
      }
      
      // Check image count limit
      const currentImageCount = this.attachments.filter(att => att.type.startsWith('image/')).length;
      if (currentImageCount >= this.maxImageCount) {
        this.showErrorMessage(window.messageTranslations.attachments.maxImagesReached.replace('{max}', this.maxImageCount));
        return false;
      }
    } else {
      const isValidType = Object.values(this.allowedFileTypes).flat().includes(file.type);
      if (!isValidType) {
        this.showErrorMessage(window.messageTranslations.attachments.invalidFileType.replace('{type}', file.type));
        return false;
      }
      
      // Check file count limit
      const currentFileCount = this.attachments.filter(att => !att.type.startsWith('image/')).length;
      if (currentFileCount >= this.maxFileCount) {
        this.showErrorMessage(window.messageTranslations.attachments.maxFilesReached.replace('{max}', this.maxFileCount));
        return false;
      }
    }
    
    return true;
  }

  // Add file to attachments list
  async addAttachment(file) {
    const attachment = {
      id: `att_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      file: file,
      name: file.name,
      size: file.size,
      type: file.type,
      preview: null
    };
    
    // Create preview for images
    if (file.type.startsWith('image/')) {
      attachment.preview = await this.createFilePreview(file);
    }
    
    this.attachments.push(attachment);
    this.renderAttachments();
    this.updateSendButton();
    
  }

  // Create file preview
  createFilePreview(file) {
    if (file.type.startsWith('image/')) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
      });
    }
    return null;
  }

  // Render attachments list
  renderAttachments() {
    // Render image attachments preview
    this.renderImageAttachments();
    
    // Render file attachments preview
    this.renderFileAttachments();
    
    // Show/hide attachments preview container
    this.toggleAttachmentsPreview();
  }

  // Render image attachments preview (above input)
  renderImageAttachments() {
    const imageContainer = document.getElementById('imageAttachmentsPreview');
    if (!imageContainer) return;
    
    const imageAttachments = this.attachments.filter(att => att.type.startsWith('image/'));
    
    if (imageAttachments.length === 0) {
      imageContainer.innerHTML = '';
      return;
    }
    
    const imagesHTML = imageAttachments.map(attachment => `
      <div class="image-attachment-preview" data-id="${attachment.id}">
        <img src="${attachment.preview}" alt="${attachment.name}" class="preview-image">
        <div class="image-remove-overlay">
          <button class="image-remove-btn" onclick="window.professionalBuyerMessages.removeAttachment('${attachment.id}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    `).join('');
    
    imageContainer.innerHTML = imagesHTML;
  }

  // Render file attachments preview (above input)
  renderFileAttachments() {
    const fileContainer = document.getElementById('fileAttachmentsPreview');
    if (!fileContainer) return;
    
    const fileAttachments = this.attachments.filter(att => !att.type.startsWith('image/'));
    
    if (fileAttachments.length === 0) {
      fileContainer.innerHTML = '';
      return;
    }
    
    const filesHTML = fileAttachments.map(attachment => `
      <div class="file-attachment-preview" data-id="${attachment.id}">
        <div class="file-preview-icon">
          <i class="fas fa-${this.getFileIcon(attachment.type)}"></i>
        </div>
        <div class="file-remove-overlay">
          <button class="file-remove-btn" onclick="window.professionalBuyerMessages.removeAttachment('${attachment.id}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    `).join('');
    
    fileContainer.innerHTML = filesHTML;
  }

  // Toggle attachments preview container visibility
  toggleAttachmentsPreview() {
    const container = document.getElementById('attachmentsPreviewContainer');
    if (!container) return;
    
    if (this.attachments.length > 0) {
      container.classList.add('has-attachments');
    } else {
      container.classList.remove('has-attachments');
    }
    
    // Update attachment count display
    this.updateAttachmentCount();
  }

  // Update attachment count display
  updateAttachmentCount() {
    const imageCount = this.attachments.filter(att => att.type.startsWith('image/')).length;
    const fileCount = this.attachments.filter(att => !att.type.startsWith('image/')).length;
    
    // Update attachment button text to show count
    if (this.attachmentBtn) {
      let countText = '';
      if (imageCount > 0 || fileCount > 0) {
        countText = ` (${imageCount + fileCount})`;
      }
      this.attachmentBtn.title = `${window.messageTranslations.input.attachments}${countText}`;
    }
    
    // Show limit warnings if needed
    if (imageCount >= this.maxImageCount) {
      this.showWarningMessage(window.messageTranslations.attachments.imageLimitWarning.replace('{max}', this.maxImageCount));
    }
    
    if (fileCount >= this.maxFileCount) {
      this.showWarningMessage(window.messageTranslations.attachments.fileLimitWarning.replace('{max}', this.maxFileCount));
    }
  }

  // Get file icon based on type
  getFileIcon(mimeType) {
    if (mimeType.startsWith('image/')) return 'image';
    if (mimeType.includes('pdf')) return 'file-pdf';
    if (mimeType.includes('word') || mimeType.includes('document')) return 'file-word';
    if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'file-excel';
    if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('7z')) return 'file-archive';
    return 'file-alt';
  }

  // Remove attachment
  removeAttachment(attachmentId) {
    const index = this.attachments.findIndex(att => att.id === attachmentId);
    if (index > -1) {
      this.attachments.splice(index, 1);
      this.renderAttachments();
      this.updateSendButton();
    }
  }

  // Mark messages as read for specific conversation
  async markMessagesAsRead(conversationId, conversationType = 'order') {
    try {
      let endpoint;
      if (conversationType === 'inquiry') {
        endpoint = `/buyer/api/inquiries/${conversationId}/mark-read`;
      } else {
        endpoint = `/buyer/api/orders/${conversationId}/mark-read`;
      }
      
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          // Update conversations list to reflect read status
          setTimeout(() => {
            this.loadConversations();
          }, 500);
          
          // Update navigation badge count
          this.updateNavigationBadge();
        }
      }
    } catch (error) {
      // Don't show error to user, this is a background operation
    }
  }

  // Update navigation unread messages badge
  async updateNavigationBadge() {
    try {
      // Get fresh unread count from server
      const response = await fetch('/buyer/api/unread-messages-count');
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          const unreadCount = data.count || 0;
          
          // Update all navigation badge elements
          const badgeElements = document.querySelectorAll('.dropdown-badge.badge-danger');
          badgeElements.forEach(badge => {
            const parentLink = badge.closest('a[href="/buyer/messages"]');
            if (parentLink) {
              if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
              } else {
                badge.style.display = 'none';
              }
            }
          });
        }
      }
    } catch (error) {
    }
  }

  // Trigger file input based on type
  triggerFileInput(type) {
    const inputId = type === 'image' ? 'imageInput' : 'fileInput';
    const input = document.getElementById(inputId);
    
    if (input) {
      input.click();
    } else {
    }
    
    this.hideAttachmentMenu();
  }

  // Show welcome state when no manufacturer selected
  showWelcomeState() {
    const messagesContainer = document.querySelector('.messages-container');
    const welcomeState = document.querySelector('.welcome-state');
    const quickActions = document.querySelector('.quick-actions-grid');
    const inputArea = document.querySelector('.b2b-message-input-area');
    
    // Show existing welcome state and hide input/actions
    if (welcomeState) {
      welcomeState.style.display = 'block';
    }
    if (quickActions) quickActions.style.display = 'none';
    if (inputArea) inputArea.style.display = 'none';
    
    // Clear messages and show welcome
    if (messagesContainer && !welcomeState) {
      messagesContainer.innerHTML = `
        <div class="welcome-state">
          <div class="welcome-icon">
            <i class="fas fa-comments text-main"></i>
          </div>
          <h3 class="welcome-title text-heading">Xabar almashish</h3>
          <p class="welcome-description">Professional B2B muloqot uchun manufacturerni tanlang</p>
        </div>
      `;
    }
  }

  // Update conversation UI with conversation data
  updateConversationUI(conversationData) {
    // Update conversation header with order or inquiry information
    const conversationHeader = document.querySelector('.conversation-header');
    if (conversationHeader && conversationData) {
      if (conversationData.type === 'order') {
        conversationHeader.innerHTML = `
          <div class="conversation-info">
            <h3 class="conversation-title">Order ${conversationData.orderNumber}</h3>
            <p class="conversation-subtitle">Status: ${conversationData.orderStatus} | Value: $${conversationData.orderValue} ${conversationData.currency}</p>
          </div>
        `;
      } else if (conversationData.type === 'inquiry') {
        conversationHeader.innerHTML = `
          <div class="conversation-info">
            <h3 class="conversation-title">${conversationData.subject || 'Product Inquiry'}</h3>
            <p class="conversation-subtitle">Inquiry #${conversationData.inquiryNumber}</p>
          </div>
        `;
      }
    }
  }

  // Show order-specific welcome state
  showOrderWelcome(orderData) {
    const messagesContainer = document.querySelector('.messages-container');
    const quickActions = document.querySelector('.quick-actions-grid');
    const inputArea = document.querySelector('.b2b-message-input-area');
    
    // Show input for order chat
    if (inputArea) inputArea.style.display = 'block';
    
    if (messagesContainer) {
      messagesContainer.innerHTML = `
        <div class="welcome-state">
          <div class="welcome-icon">
            <i class="fas fa-shopping-cart text-main"></i>
          </div>
          <h3 class="welcome-title text-heading">Order ${orderData.orderNumber} - ${orderData.manufacturer.companyName}</h3>
          <p class="welcome-description">Order holati: <strong>${orderData.orderStatus}</strong> | Qiymat: <strong>$${orderData.orderValue} ${orderData.currency}</strong></p>
          <p class="welcome-subtitle">Bu order haqida ishlab chiqaruvchi bilan suhbat qiling</p>
          
          <div class="order-info-card">
            <div class="order-info-item">
              <i class="fas fa-hashtag"></i>
              <span>Order raqami: ${orderData.orderNumber}</span>
            </div>
            <div class="order-info-item">
              <i class="fas fa-info-circle"></i>
              <span>Holat: ${orderData.orderStatus}</span>
            </div>
            <div class="order-info-item">
              <i class="fas fa-dollar-sign"></i>
              <span>Qiymat: $${orderData.orderValue} ${orderData.currency}</span>
            </div>
          </div>
        </div>
      `;
  }
}


  // Show manufacturer-specific welcome state with quick actions
  showManufacturerWelcome(manufacturer) {
    const messagesContainer = document.querySelector('.messages-container');
    const quickActions = document.querySelector('.quick-actions-grid');
    const inputArea = document.querySelector('.b2b-message-input-area');
    
    // Show quick actions and input for manufacturer chat
    if (quickActions) quickActions.style.display = 'grid';
    if (inputArea) inputArea.style.display = 'block';
    
    if (messagesContainer) {
      messagesContainer.innerHTML = `
        <div class="welcome-state">
          <div class="welcome-icon">
            <i class="fas fa-handshake text-main"></i>
          </div>
          <h3 class="welcome-title text-heading">${manufacturer.companyName} bilan suhbat</h3>
          <p class="welcome-description">Professional B2B aloqa tizimi orqali ishlab chiqaruvchi bilan bevosita muloqot qiling</p>
          
          <div class="quick-actions-grid">
          <button onclick="startConversationWithTemplate('greeting')" class="quick-action-btn secondary">
            <div class="quick-action-content">
              <div class="quick-action-icon secondary">
                <i class="fas fa-wave-square"></i>
              </div>
              <h5 class="quick-action-title secondary">Salomlashish</h5>
            </div>
            <p class="quick-action-description secondary">Professional salomlashish va tanishish xabari yuborish</p>
          </button>
          
          <button onclick="startConversationWithTemplate('inquiry')" class="quick-action-btn tertiary">
            <div class="quick-action-content">
              <div class="quick-action-icon tertiary">
                <i class="fas fa-question-circle"></i>
              </div>
                             <h5 class="quick-action-title tertiary">${window.messageTranslations.quickActions.inquiry.title}</h5>
            </div>
             <p class="quick-action-description tertiary">${window.messageTranslations.quickActions.inquiry.description}</p>
          </button>
          
          <button onclick="startConversationWithTemplate('order_status')" class="quick-action-btn tertiary">
            <div class="quick-action-content">
              <div class="quick-action-icon tertiary">
                <i class="fas fa-truck"></i>
              </div>
                             <h5 class="quick-action-title tertiary">${window.messageTranslations.quickActions.orderStatus.title}</h5>
            </div>
             <p class="quick-action-description tertiary">${window.messageTranslations.quickActions.orderStatus.description}</p>
          </button>
        </div>
      </div>
    `;
    }
  }

  // Show typing indicator
  showTypingIndicator() {
    const messagesContainer = document.querySelector('.messages-container');
    if (messagesContainer) {
      const typingIndicator = document.createElement('div');
      typingIndicator.className = 'telegram-typing-indicator';
      typingIndicator.innerHTML = `
        <div class="telegram-message-avatar">
          <img src="${this.manufacturerDetails?.companyLogo?.url || '/assets/images/avatars/default-company.png'}" 
                               alt="${this.manufacturerDetails?.companyName || window.messageTranslations.fileTypes.manufacturer}"
               onerror="this.src='/assets/images/avatars/default-company.png'">
        </div>
        <div class="telegram-message-content">
          <div class="telegram-message-bubble">
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        </div>
      `;
      messagesContainer.appendChild(typingIndicator);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
  }

  // Hide typing indicator
  hideTypingIndicator() {
    const typingIndicator = document.querySelector('.telegram-typing-indicator');
    if (typingIndicator) {
      typingIndicator.remove();
    }
  }

  // Utility methods
  formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return window.messageTranslations.time.now;
    if (diffMins < 60) return `${diffMins} ${window.messageTranslations.time.minutesAgo}`;
    if (diffHours < 24) return `${diffHours} ${window.messageTranslations.time.hoursAgo}`;
    if (diffDays < 7) return `${diffDays} ${window.messageTranslations.time.daysAgo}`;
    return date.toLocaleDateString('uz-UZ');
  }

  formatStatus(status) {
    const statusMap = {
      'pending': window.messageTranslations.status.pending,
      'confirmed': window.messageTranslations.status.confirmed,
      'in_production': window.messageTranslations.status.in_production,
      'shipped': window.messageTranslations.status.shipped,
      'delivered': window.messageTranslations.status.delivered,
      'cancelled': window.messageTranslations.status.cancelled
    };
    return statusMap[status] || status;
  }

  groupMessagesByDate(messages) {
    const groups = {};
    messages.forEach(msg => {
      const date = new Date(msg.createdAt).toLocaleDateString('uz-UZ');
      if (!groups[date]) groups[date] = [];
      groups[date].push(msg);
    });
    return groups;
  }

  updateSendButton() {
    const text = this.messageInput ? this.messageInput.value.trim() : '';
    const charLength = text.length;
    const hasAttachments = this.attachments.length > 0;
    
    // Update character count
    if (this.charCount) {
      this.charCount.textContent = charLength;
    }
    
    // Enable/disable send button (allow sending if text OR attachments exist)
    if (this.sendButton) {
      const canSend = (charLength > 0 || hasAttachments) && charLength <= 10000;
      this.sendButton.disabled = !canSend;
      this.sendButton.style.opacity = this.sendButton.disabled ? '0.5' : '1';
      
      // Update send button text based on content
      if (this.sendButton.querySelector('i')) {
        if (hasAttachments && charLength === 0) {
          // Only attachments, no text
          this.sendButton.querySelector('i').className = 'fas fa-paper-plane';
          this.sendButton.title = window.messageTranslations.input.sendButtonWithFiles;
        } else if (charLength > 0 && hasAttachments) {
          // Both text and attachments
          this.sendButton.querySelector('i').className = 'fas fa-paper-plane';
          this.sendButton.title = window.messageTranslations.input.sendButtonWithFiles;
        } else if (charLength > 0) {
          // Only text
          this.sendButton.querySelector('i').className = 'fas fa-paper-plane';
          this.sendButton.title = window.messageTranslations.input.sendButton;
        } else {
          // Nothing to send
          this.sendButton.querySelector('i').className = 'fas fa-paper-plane';
          this.sendButton.title = window.messageTranslations.input.sendButtonPlaceholder;
        }
      }
    }
    
    // Auto-resize textarea
    if (this.messageInput) {
    this.messageInput.style.height = 'auto';
    this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
    }
  }

  handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      this.sendMessage();
    }
  }

  // Missing image and file render methods
  renderImageMessage(message) {
    return `<div class="message-image">
      <img src="${message.attachments[0]?.url || ''}" alt="${window.messageTranslations.fileTypes.sharedImage}" onclick="openImageModal(this.src)">
    </div>`;
  }

  renderFileMessage(message) {
    const file = message.attachments[0];
    return `<div class="message-file">
      <div class="file-icon"><i class="fas fa-file"></i></div>
      <div class="file-info">
        <div class="file-name">${file?.originalName || window.messageTranslations.fileTypes.unknown}</div>
        <div class="file-size">${this.formatFileSize(file?.size || 0)}</div>
      </div>
      <a href="${file?.url || '#'}" download class="file-download">
        <i class="fas fa-download"></i>
      </a>
    </div>`;
  }

  formatFileSize(bytes) {
    if (bytes === 0) return `0 ${window.messageTranslations.attachments.bytes}`;
    const k = 1024;
    const sizes = [
      window.messageTranslations.attachments.bytes,
      window.messageTranslations.attachments.kilobytes,
      window.messageTranslations.attachments.megabytes,
      window.messageTranslations.attachments.gigabytes
    ];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Select conversation by index (redirects to manufacturer chat)
  selectConversationByIndex(index) {
    try {
      const conversation = this.conversations[index];
      if (!conversation) {
        return;
      }
      
      // Redirect to manufacturer chat page
      const redirectUrl = `/buyer/messages?manufacturer=${conversation.manufacturer._id}`;
      window.location.href = redirectUrl;
      
    } catch (error) {
    }
  }

  // Select conversation and update UI
  selectConversation(orderId, supplierId) {
    try {
      // Update current conversation ID
      this.currentConversationId = orderId;
      
      // Update active conversation in sidebar
      document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Find and activate the clicked conversation
      const clickedConversation = document.querySelector(`[data-conversation-id="${orderId}"]`);
      if (clickedConversation) {
        clickedConversation.classList.add('active');
      }
      
      // Redirect to manufacturer conversation
      const redirectUrl = `/buyer/messages?manufacturer=${supplierId}`;
      window.location.href = redirectUrl;
      
    } catch (error) {
    }
  }

  // Professional UI state management
  showLoadingState(area) {
    const container = area === 'conversations' ? 
      document.querySelector('.conversations-list') : 
      document.querySelector('.messages-container');
    
    if (container) {
      container.innerHTML = `
        <div class="loading-state">
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
          <p>${window.messageTranslations.loading.loading}</p>
        </div>
      `;
    }
  }

  showErrorState(area, message) {
    const container = area === 'conversations' ? 
      document.querySelector('.conversations-list') : 
      document.querySelector('.messages-container');
    
    if (container) {
      container.innerHTML = `
        <div class="error-state">
          <div class="error-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <h4>${window.messageTranslations.errors.title}</h4>
          <p>${message}</p>
          <button onclick="window.location.reload()" class="retry-btn">
            <i class="fas fa-redo"></i>
            ${window.messageTranslations.errors.retry}
          </button>
        </div>
      `;
    }
  }

  setSendingState(isSending) {
    if (this.sendButton) {
      this.sendButton.disabled = isSending;
      this.sendButton.innerHTML = isSending ? 
        '<i class="fas fa-spinner fa-spin"></i>' : 
        '<i class="fas fa-paper-plane"></i>';
    }
  }

  showSuccessMessage(message) {
    this.showToast(message, 'success');
  }

  showErrorMessage(message) {
    this.showToast(message, 'error');
  }

  showWarningMessage(message) {
    this.showToast(message, 'warning');
  }

  showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    let icon = 'exclamation-circle';
    if (type === 'success') icon = 'check-circle';
    else if (type === 'warning') icon = 'exclamation-triangle';
    
    toast.innerHTML = `
      <div class="toast-content">
        <i class="fas fa-${icon}"></i>
        <span>${message}</span>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }

  toggleAttachmentMenu() {
    if (this.attachmentMenu) {
      this.attachmentMenu.classList.toggle('show');
    }
  }

  showAttachmentMenu() {
    if (this.attachmentMenu) {
      this.attachmentMenu.classList.add('show');
    }
  }

  hideAttachmentMenu() {
    if (this.attachmentMenu) {
      this.attachmentMenu.classList.remove('show');
    }
  }
}

// ============================================
// GLOBAL FUNCTIONS - Outside of Class Scope
// ============================================

// Handle logo error for both chat header and sidebar
function handleLogoError(imgElement) {
  imgElement.parentElement.innerHTML = '<div class="logo-placeholder"><i class="fas fa-building"></i></div>';
}

// Conversation selection
function selectConversation(manufacturerId) {
  // Remove active class from all conversations
  const conversations = document.querySelectorAll('.conversation-item');
  conversations.forEach(conv => conv.classList.remove('active'));
  
  // Add active class to selected conversation
  const selectedConv = document.querySelector(`.conversation-item[onclick="selectConversation('${manufacturerId}')"]`);
  if (selectedConv) {
    selectedConv.classList.add('active');
  }
  
  // Here you would load the conversation messages
}

// Template functions with conversation starter
function startConversationWithTemplate(type) {
  const templates = {
    greeting: "Assalomu alaykum! Men sizning kompaniyangiz bilan hamkorlik qilishdan manfaatdorman. Iltimos, mahsulotlaringiz va xizmatlaringiz haqida ko'proq ma'lumot bering.",
    price_inquiry: "Sizning katalogingizdan quyidagi mahsulotlar uchun narx so'rovini yubormoqchiman:\n\n- Mahsulot nomi: Paxta ko'ylaklar\n- Miqdor: 1,000 dona\n- Xususiyatlar: Yuqori sifat, turli ranglar\n\nIltimos, eng yaxshi narxlaringizni va yetkazib berish shartlarini taklif qiling.",
    sample_request: "Sizning mahsulotlaringizdan namunalar olishni istardim. Quyidagi mahsulotlar bo'yicha:\n\n- Mahsulot turlari\n- Sifat sertifikatlari\n- Yetkazib berish muddat va narxlari\n\nIltimos, ma'lumot bering.",
    order_inquiry: "Sizdan katta hajmli buyurtma berish bo'yicha quyidagi ma'lumotlarni bilishni istardim:\n\n- Minimal buyurtma miqdori\n- Yetkazib berish muddatlari\n- To'lov shartlari\n- Sifat kafolati\n\nRahmat!"
  };
  
  const messageInput = document.getElementById('messageInput');
  if (messageInput && templates[type]) {
    messageInput.value = templates[type];
  messageInput.focus();
    
    // Trigger input event to update send button
    const event = new Event('input', { bubbles: true });
    messageInput.dispatchEvent(event);
    
    // Scroll to message input
    messageInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

// Focus message input
function focusMessageInput() {
  const messageInput = document.getElementById('messageInput');
  if (messageInput) {
    messageInput.focus();
    messageInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

// File attachment functions - DEPRECATED, use class methods instead
function attachFile() {
  console.warn('⚠️ attachFile is deprecated, use class methods instead');
  if (window.professionalBuyerMessages) {
    window.professionalBuyerMessages.hideAttachmentMenu();
  }
}

function attachImage() {
  console.warn('⚠️ attachImage is deprecated, use class methods instead');
  if (window.professionalBuyerMessages) {
    window.professionalBuyerMessages.hideAttachmentMenu();
  }
}

function insertEmoji() {
  // Simple emoji insertion - you can expand this with a proper emoji picker
  const messageInput = document.getElementById('messageInput');
  if (messageInput) {
    const emojis = ['😊', '👍', '🤝', '💼', '📦', '🚚', '💰', '✅', '❓', '📞'];
    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
    
    const currentValue = messageInput.value;
    const cursorPosition = messageInput.selectionStart;
    const newValue = currentValue.slice(0, cursorPosition) + randomEmoji + currentValue.slice(cursorPosition);
    
    messageInput.value = newValue;
    messageInput.setSelectionRange(cursorPosition + randomEmoji.length, cursorPosition + randomEmoji.length);
    messageInput.focus();
    
    // Trigger input event to update send button
    const event = new Event('input', { bubbles: true });
    messageInput.dispatchEvent(event);
  }
  
  // Hide attachment menu
  if (window.professionalBuyerMessages) {
    window.professionalBuyerMessages.hideAttachmentMenu();
  }
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
    // This function is deprecated, use class methods instead
  }
}

function handleImageSelect(event) {
  const file = event.target.files[0];
  if (file) {
    // This function is deprecated, use class methods instead
  }
}

// Professional message form submission - DEPRECATED, use button click instead
function sendProfessionalMessage(event) {
  event.preventDefault();
  if (window.professionalBuyerMessages) {
    window.professionalBuyerMessages.sendMessage();
  }
}

function handleProfessionalKeyPress(event) {
  if (window.professionalBuyerMessages) {
    window.professionalBuyerMessages.handleKeyPress(event);
  }
}

function handleProfessionalInputChange() {
  if (window.professionalBuyerMessages) {
    window.professionalBuyerMessages.updateSendButton();
  }
}

// Action functions
function requestQuoteFromManufacturer() {
}

function viewManufacturerProfile() {
}

function sendMessage() {
  const messagesClass = window.professionalBuyerMessages;
  if (messagesClass) {
    messagesClass.sendMessage();
  }
}

function requestNewQuote() {
}

function requestSample() {
}

function downloadCatalog() {
}

function callManufacturer() {
}

function emailManufacturer() {
}

function viewQuoteDetails() {
}

function viewProfile() {
}

// Image Modal Functions - Global functions for modal controls

function closeImageModal() {
  const modal = document.getElementById('imageModal');
  modal.style.display = 'none';
  
  // Reset image state when closing modal
  if (window.professionalBuyerMessages && window.professionalBuyerMessages.currentImageElement) {
    window.professionalBuyerMessages.resetImage();
  }
  
  // Clear stored data
  window.currentModalImageUrl = null;
  window.currentModalImageName = null;
}

function downloadModalImage() {
  if (window.currentModalImageUrl) {
    const link = document.createElement('a');
    link.href = window.currentModalImageUrl;
    link.download = window.currentModalImageName || 'image';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('imageModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeImageModal();
      }
    });
  }
});

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  window.professionalBuyerMessages = new ProfessionalBuyerMessages();
  
  // Add hover effects to quick action buttons
  const quickActionBtns = document.querySelectorAll('.quick-action-btn');
  quickActionBtns.forEach(btn => {
    btn.addEventListener('mouseenter', function() {
      if (!this.style.background.includes('hsl(var(--main))')) {
        this.style.borderColor = 'hsl(var(--main))';
        this.style.background = 'hsl(var(--main-l-50))';
      }
    });
    
    btn.addEventListener('mouseleave', function() {
      if (!this.style.background.includes('hsl(var(--main))')) {
        this.style.borderColor = 'hsl(var(--border-color))';
        this.style.background = 'hsl(var(--white))';
    }
  });
});

  // Add hover effects to action buttons
  const actionButtons = document.querySelectorAll('button[onclick]');
  actionButtons.forEach(button => {
    if (!button.id || button.id !== 'sendButton') {
      button.addEventListener('mouseenter', function() {
        if (!this.disabled) {
          this.style.transform = 'translateY(-1px)';
        }
      });
      
      button.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
      });
    }
  });
});
</script>

<style>

  /* Order Info Card Styles */
  .order-info-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .order-info-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.9rem;
  }
  
  .order-info-item:last-child {
    margin-bottom: 0;
  }
  
  .order-info-item i {
    width: 20px;
    color: hsl(var(--main));
    font-size: 1rem;
  }
  
  /* Manufacturer Group Styles */
  .manufacturer-group {
    margin-bottom: 1.5rem;
    border: 1px solid var(--bs-gray-200);
    border-radius: 12px;
    overflow: hidden;
    background: var(--bs-white);
  }
  
  .manufacturer-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bs-gray-50);
    border-bottom: 1px solid var(--bs-gray-200);
  }
  
  .manufacturer-avatar {
    position: relative;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
  }
  
  .manufacturer-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .manufacturer-info {
    flex: 1;
    min-width: 0;
  }
  
  .manufacturer-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--bs-dark);
    margin: 0 0 0.25rem 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .manufacturer-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .manufacturer-orders-count {
    font-size: 0.8rem;
    color: var(--bs-gray-600);
    background: var(--bs-gray-100);
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
  }
  
  .unread-badge {
    background: hsl(var(--main));
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.2rem 0.5rem;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
  }
  
  .manufacturer-chats {
    padding: 0.5rem;
  }
  
  .chat-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }
  
  .chat-item:hover {
    background: var(--bs-gray-50);
    border-color: var(--bs-gray-300);
  }
  
  .chat-item.active {
    background: hsl(var(--main) / 0.1);
    border-color: hsl(var(--main));
  }
  
  .chat-item:last-child {
    margin-bottom: 0;
  }
  
  .chat-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
  }
  
  .chat-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }
  
  .chat-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  
  .product-chat .chat-icon {
    background: hsl(var(--main) / 0.1);
    color: hsl(var(--main));
  }
  
  .order-chat .chat-icon {
    background: hsl(var(--success) / 0.1);
    color: hsl(var(--success));
  }
  
  .chat-details {
    flex: 1;
    min-width: 0;
  }
  
  .chat-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--bs-dark);
    margin: 0 0 0.25rem 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .chat-subtitle {
    font-size: 0.8rem;
    color: var(--bs-gray-600);
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .chat-arrow {
    color: var(--bs-gray-400);
    font-size: 0.8rem;
    flex-shrink: 0;
  }
  
  .chat-item:hover .chat-arrow {
    color: var(--bs-gray-600);
  }
  
  .chat-item.active .chat-arrow {
    color: hsl(var(--main));
  }

  /* Simple Conversation List Styles */
  .conversation-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
    background: var(--bs-white);
  }

  .conversation-item:hover {
    background: var(--bs-gray-50);
    border-color: var(--bs-gray-300);
  }

  .conversation-item.active {
    background: hsl(var(--main) / 0.1);
    border-color: hsl(var(--main));
    border-left: 6px solid hsl(var(--main));
    position: relative;
  }

  .conversation-avatar {
    position: relative;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    margin-right: 1rem;
  }

  .conversation-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .conversation-content {
    flex: 1;
    min-width: 0;
  }

  .conversation-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.25rem;
  }



  .conversation-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .conversation-type {
    font-size: 0.8rem;
    color: var(--bs-gray-600);
    background: var(--bs-gray-100);
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
  }

  .conversation-preview {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .last-message {
    font-size: 0.9rem;
    color: var(--bs-gray-600);
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }

  .message-time {
    font-size: 0.8rem;
    color: var(--bs-gray-500);
    margin-left: 0.5rem;
    flex-shrink: 0;
  }

  .conversation-arrow {
    color: var(--bs-gray-400);
    font-size: 0.8rem;
    flex-shrink: 0;
    margin-left: 0.5rem;
  }

  .conversation-item:hover .conversation-arrow {
    color: var(--bs-gray-600);
  }

  .conversation-item.active .conversation-arrow {
    color: hsl(var(--main));
  }

  /* Conversation Title and Badges */
  .conversation-title {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .conversation-badges {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .chat-type-badge {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.2rem 0.5rem;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .chat-type-badge.product-chat {
    background: hsl(var(--main) / 0.1);
    color: hsl(var(--main));
    border: 1px solid hsl(var(--main) / 0.2);
  }

  .chat-type-badge.order-chat {
    background: hsl(var(--success) / 0.1);
    color: hsl(var(--success));
    border: 1px solid hsl(var(--success) / 0.2);
  }


  /* Dark Mode Styles */
  [data-theme="light"] .conversation-item{
    background: transparent;
    border-color: var(--bs-gray-700);
    color: var(--bs-light) !important;
  } 

  /* Dark mode class-based styling */
  .dark-mode .conversation-item {
    background: var(--bs-dark);
    border-color: var(--bs-gray-700);
  }

  .dark-mode .conversation-item:hover {
    background: var(--bs-gray-800);
    border-color: var(--bs-gray-600);
  }

  .dark-mode .conversation-item.active {
    background: hsl(var(--main) / 0.2);
    border-color: hsl(var(--main));
    border-left: 6px solid hsl(var(--main));
  }

  .dark-mode .conversation-name {
    color: var(--bs-light);
  }

  .dark-mode .last-message {
    color: var(--bs-gray-400);
  }

  .dark-mode .conversation-time {
    color: var(--bs-gray-500);
  }

  .dark-mode .chat-type-badge.product-chat {
    background: hsl(var(--main) / 0.2);
    color: hsl(var(--main));
    border-color: hsl(var(--main) / 0.3);
  }

  .dark-mode .chat-type-badge.order-chat {
    background: hsl(var(--success) / 0.2);
    color: hsl(var(--success));
    border-color: hsl(var(--success) / 0.3);
  }


  .dark-mode .unread-badge {
    background: hsl(var(--danger));
    color: white;
  }
  </style>
<!-- Image Modal -->
<div id="imageModal" class="telegram-image-modal">
  <div class="telegram-modal-content">
    <div class="telegram-modal-header">
      <h3 id="modalImageTitle"><%= t('messages.imageModal.title') %></h3>
      <div class="zoom-indicator" id="zoomIndicator">
        <span id="zoomPercentage">100%</span>
      </div>
      <button class="telegram-modal-close" onclick="closeImageModal()">
        <i class="fas fa-times"></i>
                </button>
              </div>
    <div class="telegram-modal-body">
      <img id="modalImage" src="" alt="<%= t('messages.fileTypes.modalImageAlt') %>">
      <div class="image-controls">
        <button class="control-btn fit-screen" onclick="window.professionalBuyerMessages.zoomToFit(window.professionalBuyerMessages.currentImageElement)" title="<%= t('messages.imageModal.fitScreen') %>">
          <i class="fas fa-expand-arrows-alt"></i>
        </button>
        <button class="control-btn zoom-in" onclick="window.professionalBuyerMessages.zoomImage('in')" title="<%= t('messages.imageModal.zoomIn') %>">
          <i class="fas fa-search-plus"></i>
        </button>
        <button class="control-btn zoom-out" onclick="window.professionalBuyerMessages.zoomImage('out')" title="<%= t('messages.imageModal.zoomOut') %>">
          <i class="fas fa-search-minus"></i>
        </button>
        <button class="control-btn reset" onclick="window.professionalBuyerMessages.resetImage()" title="<%= t('messages.imageModal.reset') %>">
          <i class="fas fa-undo"></i>
        </button>
      </div>
            </div>
    <div class="telegram-modal-footer">
      <button class="telegram-modal-download" onclick="downloadModalImage()">
        <i class="fas fa-download"></i>
        <%= t('messages.imageModal.download') %>
                </button>
        </div>
        </div>
    </div>

<%- include('../partials/footer') %>