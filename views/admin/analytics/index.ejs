<!DOCTYPE html>
<html lang="<%= currentLang || 'uz' %>" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - SLEX Admin</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/line-awesome.min.css" rel="stylesheet">
    <link href="/admin/css/admin-dashboard.css" rel="stylesheet">
    <link href="/admin/css/dashboard-components.css" rel="stylesheet">
    <link href="/admin/css/analytics-dashboard.css" rel="stylesheet">
</head>
<body class="admin-layout theme-transition" data-theme="light">
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <%- include('../partials/sidebar', { currentPage: 'analytics', user: user }) %>
        
        <!-- Main Content -->
        <div class="admin-main">
            <!-- Header -->
            <%- include('../partials/header', { 
                user: user, 
                title: 'Analytics Dashboard',
                breadcrumb: [
                    { title: 'Dashboard', url: '/admin' },
                    { title: 'Analytics' }
                ],
                currentLang: typeof currentLang !== 'undefined' ? currentLang : 'uz'
            }) %>
            
            <!-- Content -->
            <div class="admin-content">
                <div class="container-fluid">
                    <!-- Page Header -->
                    <div class="page-header animate-fade-in">
                        <div class="page-header-content">
                            <div class="page-title-section">
                                <h1 class="page-title">
                                    <i class="las la-chart-line"></i>
                                    Analytics Dashboard
                                </h1>
                                <p class="page-subtitle">Advanced analytics and insights for your B2B marketplace</p>
                            </div>
                            
                            <div class="page-actions">
                                <div class="time-range-selector">
                                    <select id="timeRange" class="form-select">
                                        <option value="7d">Last 7 Days</option>
                                        <option value="30d" selected>Last 30 Days</option>
                                        <option value="90d">Last 90 Days</option>
                                        <option value="1y">Last Year</option>
                                    </select>
                                </div>
                                <button class="btn btn-outline-primary" onclick="exportAnalytics()">
                                    <i class="las la-download"></i>
                                    Export Report
                                </button>
                                <button class="btn btn-primary" onclick="refreshAnalytics()">
                                    <i class="las la-sync-alt"></i>
                                    Refresh Data
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- KPI Cards Grid -->
                    <div class="metrics-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-lg mb-lg animate-fade-in">
                        <!-- Total Revenue -->
                        <div class="metric-card metric-primary">
                            <div class="metric-content">
                                <div class="metric-icon">
                                    <i class="las la-dollar-sign"></i>
                                </div>
                                <div class="metric-details">
                                    <h3 class="metric-value" id="totalRevenue" data-metric="totalRevenue">Loading...</h3>
                                    <p class="metric-label">Total Revenue</p>
                                    <span class="metric-trend positive" data-growth="revenue">
                                        <i class="las la-arrow-up"></i>
                                        Loading...
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Active Users -->
                        <div class="metric-card metric-success">
                            <div class="metric-content">
                                <div class="metric-icon">
                                    <i class="las la-users"></i>
                                </div>
                                <div class="metric-details">
                                    <h3 class="metric-value" id="activeUsers" data-metric="activeUsers">Loading...</h3>
                                    <p class="metric-label">Active Users</p>
                                    <span class="metric-trend positive" data-growth="users">
                                        <i class="las la-arrow-up"></i>
                                        Loading...
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Order Volume -->
                        <div class="metric-card metric-warning">
                            <div class="metric-content">
                                <div class="metric-icon">
                                    <i class="las la-shopping-cart"></i>
                                </div>
                                <div class="metric-details">
                                    <h3 class="metric-value" id="orderVolume" data-metric="totalOrders">Loading...</h3>
                                    <p class="metric-label">Total Orders</p>
                                    <span class="metric-trend positive" data-growth="orders">
                                        <i class="las la-arrow-up"></i>
                                        Loading...
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Conversion Rate -->
                        <div class="metric-card metric-info">
                            <div class="metric-content">
                                <div class="metric-icon">
                                    <i class="las la-percentage"></i>
                                </div>
                                <div class="metric-details">
                                    <h3 class="metric-value" id="conversionRate" data-metric="conversionRate">Loading...</h3>
                                    <p class="metric-label">Conversion Rate</p>
                                    <span class="metric-trend positive" data-growth="conversion">
                                        <i class="las la-arrow-up"></i>
                                        Loading...
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-lg mb-lg">
                        <!-- Revenue Chart -->
                        <div class="col-span-2">
                            <div class="chart-container animate-fade-in">
                                <div class="chart-header">
                                    <h3 class="chart-title">Revenue Analytics</h3>
                                    <div class="chart-actions">
                                        <div class="chart-filters">
                                            <button class="filter-btn active" data-filter="revenue">Revenue</button>
                                            <button class="filter-btn" data-filter="orders">Orders</button>
                                            <button class="filter-btn" data-filter="users">Users</button>
                                        </div>
                                        <button class="btn-icon btn-sm" title="Fullscreen">
                                            <i class="las la-expand"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="chart-body">
                                    <div id="revenueChart" class="chart-area"></div>
                                </div>
                            </div>
                        </div>

                        <!-- User Activity -->
                        <div class="col-span-1">
                            <div class="chart-container animate-fade-in">
                                <div class="chart-header">
                                    <h3 class="chart-title">User Activity</h3>
                                    <div class="chart-actions">
                                        <button class="btn-icon btn-sm" title="Settings">
                                            <i class="las la-cog"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="chart-body">
                                    <div id="userActivityChart" class="chart-area"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-lg mb-lg">
                        <!-- Product Performance Chart -->
                        <div class="chart-container animate-fade-in">
                            <div class="chart-header">
                                <h3 class="chart-title">Product Performance</h3>
                                <div class="chart-actions">
                                    <button class="btn-icon btn-sm" title="Settings">
                                        <i class="las la-cog"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-body">
                                <div id="productChart" class="chart-area"></div>
                            </div>
                        </div>

                        <!-- Geographic Distribution Chart -->
                        <div class="chart-container animate-fade-in">
                            <div class="chart-header">
                                <h3 class="chart-title">Geographic Distribution</h3>
                                <div class="chart-actions">
                                    <button class="btn-icon btn-sm" title="Settings">
                                        <i class="las la-cog"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-body">
                                <div id="geographicChart" class="chart-area"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Tables Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-lg mb-lg">
                        <!-- Top Products -->
                        <div class="analytics-table-container animate-fade-in">
                            <div class="table-header">
                                <h3 class="table-title">
                                    <i class="las la-trophy"></i>
                                    Top Performing Products
                                </h3>
                                <div class="table-actions">
                                    <button class="btn-icon btn-sm" title="View All">
                                        <i class="las la-external-link-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-body">
                                <table class="analytics-table">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Revenue</th>
                                            <th>Orders</th>
                                            <th>Growth</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topProductsTableBody">
                                        <tr>
                                            <td colspan="4" class="text-center">
                                                <div class="loading-skeleton" style="height: 20px; margin: 10px 0;"></div>
                                                <small class="text-muted">Loading product data...</small>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Geographic Distribution -->
                        <div class="analytics-table-container animate-fade-in">
                            <div class="table-header">
                                <h3 class="table-title">
                                    <i class="las la-globe"></i>
                                    Geographic Distribution
                                </h3>
                                <div class="table-actions">
                                    <button class="btn-icon btn-sm" title="View Map">
                                        <i class="las la-map"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-body">
                                <table class="analytics-table">
                                    <thead>
                                        <tr>
                                            <th>Country</th>
                                            <th>Users</th>
                                            <th>Revenue</th>
                                            <th>Share</th>
                                        </tr>
                                    </thead>
                                    <tbody id="geographicTableBody">
                                        <tr>
                                            <td colspan="4" class="text-center">
                                                <div class="loading-skeleton" style="height: 20px; margin: 10px 0;"></div>
                                                <small class="text-muted">Loading geographic data...</small>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Real-time Activities -->
                    <div class="realtime-activities animate-fade-in">
                        <div class="activities-header">
                            <h3 class="activities-title">
                                <i class="las la-bolt"></i>
                                Real-time Activities
                                <span class="live-indicator">
                                    <span class="live-dot"></span>
                                    LIVE
                                </span>
                            </h3>
                            <div class="activities-actions">
                                <button class="btn btn-sm btn-ghost" onclick="pauseRealtime()">
                                    <i class="las la-pause"></i>
                                    Pause
                                </button>
                            </div>
                        </div>
                        <div class="activities-list" id="realtimeActivities">
                            <div class="activity-item">
                                <div class="activity-avatar info">
                                    <i class="las la-sync-alt"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-text">
                                        Loading real-time activities...
                                    </div>
                                    <div class="activity-meta">
                                        <span class="activity-badge info">LOADING</span>
                                        <span class="activity-time">Just now</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/jquery-3.7.1.min.js"></script>
    <script src="/assets/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/apexchart.js"></script>
    
    <!-- Admin Dashboard Core Scripts -->
    <script src="/admin/js/dashboard.js"></script>
    <script src="/admin/js/analytics-charts.js"></script>
    
    <script>
        // Analytics Page Initialization - Enhanced with Debug
        document.addEventListener('DOMContentLoaded', function() {
            
            // Debug current state
            const adminWrapper = document.querySelector('.admin-wrapper');
            const adminMain = document.querySelector('.admin-main');
             
            // Initialize admin dashboard core FIRST (critical for sidebar)
            if (typeof SLEXDashboard !== 'undefined') {
                window.SLEXDashboard = new SLEXDashboard();
                window.SLEXDashboard.init();
            }
            
            // Small delay for DOM to stabilize
            setTimeout(() => {
                // Initialize admin header dropdowns
                if (typeof AdminHeaderDropdownFix !== 'undefined') {
                    window.adminHeaderDropdownFix = new AdminHeaderDropdownFix();
                     }
                
                // Initialize responsive handlers (enhanced)
                initializeResponsiveHandlers();
                
                            // PROFESSIONAL MIGRATION: Convert old inconsistent keys
            migrateOldSidebarState();
            
            // Force apply saved sidebar state (DASHBOARD CONSISTENT)
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            
            const sidebar = document.querySelector('.admin-sidebar');
            const adminMain = document.querySelector('.admin-main');
            const adminHeader = document.querySelector('.admin-header');
            
            if (sidebarCollapsed) {
                sidebar?.classList.add('collapsed');
                adminMain?.classList.add('sidebar-collapsed');
                adminHeader?.classList.add('sidebar-collapsed');
                console.log('📁 Restored collapsed sidebar state (Dashboard Consistent)');
            } else {
                sidebar?.classList.remove('collapsed');
                adminMain?.classList.remove('sidebar-collapsed');  
                adminHeader?.classList.remove('sidebar-collapsed');
                console.log('📂 Restored expanded sidebar state (Dashboard Consistent)');
            }
                
            }, 100);
            
            // Initialize theme toggle
            initializeThemeToggle();
            
            // Initialize analytics charts (can be parallel)
            if (typeof AnalyticsCharts !== 'undefined') {
                window.analyticsCharts = new AnalyticsCharts();
                console.log('✅ Analytics Charts initialized');
                
                // Cleanup on page unload to prevent memory leaks
                window.addEventListener('beforeunload', function() {
                    if (window.analyticsCharts) {
                        window.analyticsCharts.destroy();
                    }
                });
            }
            
        });

        // Global functions for analytics buttons (called from UI)
        function exportAnalytics() {
            if (window.analyticsCharts) {
                window.analyticsCharts.exportAnalytics();
            } else {
                console.warn('Analytics charts not initialized yet');
            }
        }

        function refreshAnalytics() {
            if (window.analyticsCharts) {
                window.analyticsCharts.refreshAllCharts();
            } else {
                console.warn('Analytics charts not initialized yet');
            }
        }

        function pauseRealtime() {
            if (window.analyticsCharts && window.analyticsCharts.realtimeInterval) {
                clearInterval(window.analyticsCharts.realtimeInterval);
                console.log('Real-time updates paused');
                
                // Update button text
                const pauseBtn = document.querySelector('[onclick="pauseRealtime()"]');
                if (pauseBtn) {
                    pauseBtn.innerHTML = '<i class="las la-play"></i> Resume';
                    pauseBtn.setAttribute('onclick', 'resumeRealtime()');
                }
            }
        }

        function resumeRealtime() {
            if (window.analyticsCharts) {
                window.analyticsCharts.startRealTimeUpdates();
                console.log('Real-time updates resumed');
                
                // Update button text
                const resumeBtn = document.querySelector('[onclick="resumeRealtime()"]');
                if (resumeBtn) {
                    resumeBtn.innerHTML = '<i class="las la-pause"></i> Pause';
                    resumeBtn.setAttribute('onclick', 'pauseRealtime()');
                }
            }
        }

        // Initialize Theme Toggle
        function initializeThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const currentTheme = localStorage.getItem('dashboard-theme') || 'light';
            
            document.documentElement.setAttribute('data-theme', currentTheme);
            updateThemeIcon(currentTheme);
            
            themeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('dashboard-theme', newTheme);
                updateThemeIcon(newTheme);
                
                // Update charts theme
                updateChartsTheme(newTheme);
            });
        }

        // Update Theme Icon
        function updateThemeIcon(theme) {
            const icon = document.querySelector('#themeToggle i');
            icon.className = theme === 'light' ? 'las la-moon' : 'las la-sun';
        }

        // Update Charts Theme
        function updateChartsTheme(theme) {
            // Implementation for updating chart themes
            console.log('Updating charts theme to:', theme);
        }

        // Initialize Dashboard-Compatible Responsive Handlers
        /**
         * Professional Migration Function - Convert Inconsistent localStorage Keys
         */
        function migrateOldSidebarState() {
            const oldKey = 'admin_sidebar_state';
            const newKey = 'sidebarCollapsed';
            
            const oldValue = localStorage.getItem(oldKey);
            const newValue = localStorage.getItem(newKey);
            
            // If old key exists but new key doesn't, migrate
            if (oldValue && !newValue) {
                const migratedValue = oldValue === 'collapsed' ? 'true' : 'false';
                localStorage.setItem(newKey, migratedValue);
                localStorage.removeItem(oldKey); // Clean up old key
                console.log(`🔄 Migrated localStorage: ${oldKey}="${oldValue}" → ${newKey}="${migratedValue}"`);
            }
            
            // Clean up any remaining old keys for consistency
            if (oldValue && newValue) {
                localStorage.removeItem(oldKey);
                console.log(`🧹 Cleaned up inconsistent localStorage key: ${oldKey}`);
            }
        }

        function initializeResponsiveHandlers() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.admin-sidebar');
            const adminMain = document.querySelector('.admin-main');
            const adminHeader = document.querySelector('.admin-header');
            
            if (!sidebarToggle || !sidebar || !adminMain) {
                console.warn('⚠️ Sidebar elements not found');
                return;
            }
            
            console.log('🔧 Setting up sidebar toggle - DASHBOARD CONSISTENT...');
            
            // Restore sidebar state from localStorage (EXACT Dashboard approach)
            const isSidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            
            // Apply EXACT Dashboard-style classes
            if (isSidebarCollapsed) {
                sidebar.classList.add('collapsed');
                adminMain.classList.add('sidebar-collapsed');
                adminHeader?.classList.add('sidebar-collapsed');
                console.log('📁 Restored collapsed sidebar state (Dashboard Consistent)');
            } else {
                sidebar.classList.remove('collapsed');
                adminMain.classList.remove('sidebar-collapsed');
                adminHeader?.classList.remove('sidebar-collapsed');
                console.log('📂 Restored expanded sidebar state (Dashboard Consistent)');
            }
            
            // Remove any existing event listeners by cloning
            const newSidebarToggle = sidebarToggle.cloneNode(true);
            sidebarToggle.parentNode.replaceChild(newSidebarToggle, sidebarToggle);
            
            // Add Dashboard-compatible event listener
            newSidebarToggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('📱 Sidebar toggle clicked (Dashboard Compatible)');
                
                const isCurrentlyCollapsed = sidebar.classList.contains('collapsed');
                console.log('🔍 Currently collapsed:', isCurrentlyCollapsed);
                
                if (isCurrentlyCollapsed) {
                    // Expand sidebar - EXACT Dashboard approach
                    sidebar.classList.remove('collapsed');
                    adminMain.classList.remove('sidebar-collapsed');
                    adminHeader?.classList.remove('sidebar-collapsed');
                    localStorage.setItem('sidebarCollapsed', 'false');
                    console.log('📂 Sidebar expanded (Dashboard Consistent)');
                } else {
                    // Collapse sidebar - EXACT Dashboard approach
                    sidebar.classList.add('collapsed');
                    adminMain.classList.add('sidebar-collapsed');
                    adminHeader?.classList.add('sidebar-collapsed');
                    localStorage.setItem('sidebarCollapsed', 'true');
                    console.log('📁 Sidebar collapsed (Dashboard Consistent)');
                }
                
                // Debug final computed styles
                setTimeout(() => {
                    const computedStyle = window.getComputedStyle(adminMain);
                    console.log('🔍 Final margin-left:', computedStyle.marginLeft);
                    console.log('🔍 Final width:', computedStyle.width);
                    console.log('🔍 Sidebar classes:', sidebar.className);
                    console.log('🔍 Main classes:', adminMain.className);
                }, 100);
            });
            
            // Handle mobile responsiveness (Dashboard approach)
            if (window.innerWidth <= 1024) {
                console.log('📱 Mobile mode detected - Dashboard mobile behavior');
                // Mobile logic will be handled by existing CSS media queries
                // No additional mobile event listeners needed - dashboard approach
            }
            
            console.log('✅ Dashboard-compatible sidebar functionality initialized');
        }
    </script>
</body>
</html>