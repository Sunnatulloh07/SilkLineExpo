<%- include('../partials/header', { 
    title: 'Buyurtmalar boshqaruvi - SLEX Admin Dashboard',
    lng: typeof currentLang !== 'undefined' ? currentLang : 'uz',
    admin: admin, 
    user: user,
    breadcrumb: [
        { title: 'Boshqaruv paneli', url: '/admin' },
        { title: 'Buyurtmalar' }
    ]
}) %>

    <!-- Professional Orders CSS -->
    <link rel="stylesheet" href="/admin/css/orders-management.css">
    <link rel="stylesheet" href="/admin/css/orders-professional.css">
    <link rel="stylesheet" href="/admin/css/orders-modal.css">

<%- include('../partials/sidebar', { 
    admin: admin, 
    user: user, 
    currentPage: 'orders',
    stats: typeof stats !== 'undefined' ? stats : {}
}) %>
    
    <!-- Main Content -->
    <main class="admin-main">
        <div class="admin-content">
            
            <!-- Orders Management Content -->
            <div class="orders-container">
                
                <!-- Page Header -->
                <div class="page-header animate-fade-in">
                    <div class="page-header-content">
                        <div class="page-title-section">
                            <h1 class="page-title">
                                <i class="las la-shopping-cart text-primary"></i>
                                Buyurtmalar boshqaruvi
                            </h1>
                            <p class="page-subtitle">
                                Keng qamrovli B2B buyurtma boshqaruvi, ilg'or kuzatish, to'lov jarayoni va logistika koordinatsiyasi bilan
                            </p>
                        </div>
                        <div class="page-actions">
                            <button class="btn btn-outline-primary" onclick="exportOrders()">
                                <i class="las la-download"></i>
                                Ma'lumotlarni eksport qilish
                            </button>
                            <button class="btn btn-outline-secondary" onclick="refreshData()">
                                <i class="las la-sync-alt"></i>
                                Yangilash
                            </button>
                            <button class="btn btn-primary" onclick="openCreateOrderModal()">
                                <i class="las la-plus"></i>
                                Buyurtma yaratish
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistics Dashboard -->
                <div class="metrics-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-lg mb-lg animate-fade-in">
                    <div class="stat-card primary">
                        <div class="stat-content">
                            <div class="stat-icon">
                                <i class="las la-shopping-cart"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-value" id="totalOrdersCount"><%= statistics?.total || 0 %></div>
                                <div class="stat-label">Jami buyurtmalar</div>
                                <div class="stat-trend positive">
                                    <i class="las la-arrow-up"></i>
                                    +12%
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card success">
                        <div class="stat-content">
                            <div class="stat-icon success">
                                <i class="las la-check-circle"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-value" id="completedOrdersCount"><%= statistics?.statusCounts?.completed || 0 %></div>
                                <div class="stat-label">Tugallangan buyurtmalar</div>
                                <div class="stat-trend positive">
                                    <i class="las la-arrow-up"></i>
                                    +8%
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card warning">
                        <div class="stat-content">
                            <div class="stat-icon warning">
                                <i class="las la-clock"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-value" id="pendingOrdersCount"><%= statistics?.statusCounts?.pending || 0 %></div>
                                <div class="stat-label">Kutilayotgan buyurtmalar</div>
                                <div class="stat-trend negative">
                                    <i class="las la-arrow-down"></i>
                                    -5%
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card info">
                        <div class="stat-content">
                            <div class="stat-icon info">
                                <i class="las la-dollar-sign"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-value" id="totalRevenue">$<%= statistics?.totalRevenue ? Math.round(statistics.totalRevenue).toLocaleString() : '0' %></div>
                                <div class="stat-label">Jami daromad</div>
                                <div class="stat-trend positive">
                                    <i class="las la-arrow-up"></i>
                                    +15%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Card -->
                <div class="main-card animate-fade-in">
                    
                    <!-- Tab Navigation -->
                    <div class="tabs-navigation">
                        <button class="tab-item active" data-status="" data-tab="all">
                            <i class="las la-list"></i>
                                Barcha buyurtmalar
                            <span class="tab-badge" id="allOrdersTab"><%= statistics?.total || 0 %></span>
                        </button>
                        <button class="tab-item" data-status="pending" data-tab="pending">
                            <i class="las la-clock"></i>
                                Kutilmoqda
                            <span class="tab-badge warning" id="pendingOrdersTab"><%= statistics?.statusCounts?.pending || 0 %></span>
                        </button>
                        <button class="tab-item" data-status="confirmed" data-tab="confirmed">
                            <i class="las la-check"></i>
                                Tasdiqlangan
                            <span class="tab-badge success" id="confirmedOrdersTab"><%= statistics?.statusCounts?.confirmed || 0 %></span>
                        </button>
                        <button class="tab-item" data-status="processing" data-tab="processing">
                            <i class="las la-cog"></i>
                                Jarayonda
                            <span class="tab-badge info" id="processingOrdersTab"><%= statistics?.statusCounts?.processing || 0 %></span>
                        </button>
                        <button class="tab-item" data-status="shipped" data-tab="shipped">
                            <i class="las la-shipping-fast"></i>
                                Yuborilgan
                            <span class="tab-badge primary" id="shippedOrdersTab"><%= statistics?.statusCounts?.shipped || 0 %></span>
                        </button>
                        <button class="tab-item" data-status="completed" data-tab="completed">
                            <i class="las la-check-double"></i>
                                Tugallangan
                            <span class="tab-badge success" id="completedOrdersTab"><%= statistics?.statusCounts?.completed || 0 %></span>
                        </button>
                    </div>

                    <!-- Filters Section -->
                    <div class="filters-section">
                        <div class="filters-header">
                            <h3 class="filters-title">
                                <i class="las la-filter"></i>
                                Ilg'or filtrlash
                            </h3>
                            <div class="filter-actions">
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearAllFilters()">
                                    <i class="las la-times"></i>
                                    Tozalash
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="applyFilters()">
                                    <i class="las la-search"></i>
                                    Qidirish
                                </button>
                            </div>
                        </div>
                        
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label class="filter-label">Buyurtmalarni qidirish</label>
                                <div class="search-input">
                                    <i class="las la-search search-icon"></i>
                                    <input type="text" class="filter-input" id="searchInput" placeholder="Buyurtma raqami, xaridor, sotuvchi...">
                                </div>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">Xaridor mamlakat</label>
                                <select class="filter-input" id="countryFilter">
                                    <option value="">Barcha mamlakatlar</option>
                                    <option value="Uzbekistan">Uzbekistan</option>
                                    <option value="Kazakhstan">Kazakhstan</option>
                                    <option value="China">China</option>
                                    <option value="Tajikistan">Tajikistan</option>
                                    <option value="Turkmenistan">Turkmenistan</option>
                                    <option value="Afghanistan">Afghanistan</option>
                                    <option value="Kyrgyzstan">Kyrgyzstan</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">Buyurtma qiymati (USD)</label>
                                <select class="filter-input" id="valueRangeFilter">
                                    <option value="">Barcha qiymatlar</option>
                                    <option value="0-1000">$0 - $1,000</option>
                                    <option value="1000-5000">$1,000 - $5,000</option>
                                    <option value="5000-25000">$5,000 - $25,000</option>
                                    <option value="25000-100000">$25,000 - $100,000</option>
                                    <option value="100000-">$100,000+</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">To'lov holati</label>
                                <select class="filter-input" id="paymentStatusFilter">
                                    <option value="">Barcha to'lov holatlari</option>
                                    <option value="pending">To'lov kutilmoqda</option>
                                    <option value="partial">Qisman to'langan</option>
                                    <option value="paid">To'liq to'langan</option>
                                    <option value="overdue">Muddati o'tgan</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">Sana oralig'i</label>
                                <select class="filter-input" id="dateRangeFilter">
                                    <option value="">Barcha vaqt</option>
                                    <option value="today">Bugun</option>
                                    <option value="week">Bu hafta</option>
                                    <option value="month">Bu oy</option>
                                    <option value="quarter">Bu chorak</option>
                                    <option value="year">Bu yil</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">Yetkazib berish usuli</label>
                                <select class="filter-input" id="shippingFilter">
                                    <option value="">Barcha usullar</option>
                                    <option value="air_freight">Havo yuk tashish</option>
                                    <option value="sea_freight">Dengiz yuk tashish</option>
                                    <option value="land_transport">Quruqlik transporti</option>
                                    <option value="express">Tezkor yetkazib berish</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Table Section -->
                    <div class="table-section">
                        <div class="table-header">
                            <div class="table-title">
                                <i class="las la-table"></i>
                                Buyurtmalar katalogi
                                <span class="result-count" id="tableResultsCount">(0 natija)</span>
                            </div>
                            
                            <div class="bulk-actions hidden" id="bulkActions">
                                <span class="selected-count" id="selectedCount">0 tanlangan</span>
                                <button class="btn btn-success btn-sm" onclick="bulkConfirmOrders()" id="bulkConfirmBtn">
                                    <i class="las la-check"></i>
                                    Tasdiqlash
                                </button>
                                <button class="btn btn-info btn-sm" onclick="bulkShipOrders()" id="bulkShipBtn">
                                    <i class="las la-shipping-fast"></i>
                                    Yuborish
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="bulkExportOrders()" id="bulkExportBtn">
                                    <i class="las la-download"></i>
                                    Eksport
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="bulkCancelOrders()" id="bulkCancelBtn">
                                    <i class="las la-times"></i>
                                    Bekor qilish
                                </button>
                            </div>
                        </div>
                        
                        <div class="professional-table-container" id="tableContainer">
                            <!-- Desktop Table View -->
                            <div class="desktop-table-view">
                                <table class="professional-orders-table">
                                    <thead class="table-header-sticky">
                                        <tr class="header-row">
                                            <th class="th-select" data-column="select">
                                                <div class="th-content">
                                                    <label class="modern-checkbox">
                                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)">
                                                        <span class="checkbox-mark"></span>
                                                    </label>
                                                </div>
                                            </th>
                                            <th class="th-order" data-column="order" onclick="sortTable('orderNumber')">
                                                <div class="th-content sortable">
                                                    <span class="th-label">Buyurtma ma'lumotlari</span>
                                                    <span class="sort-indicator">
                                                        <i class="las la-sort sort-icon"></i>
                                                    </span>
                                                </div>
                                            </th>
                                            <th class="th-parties" data-column="parties">
                                                <div class="th-content">
                                                    <span class="th-label">Xaridor va sotuvchi</span>
                                                </div>
                                            </th>
                                            <th class="th-items" data-column="items">
                                                <div class="th-content">
                                                    <span class="th-label">Buyurtma elementlari</span>
                                                </div>
                                            </th>
                                            <th class="th-value" data-column="value" onclick="sortTable('totalAmount')">
                                                <div class="th-content sortable">
                                                    <span class="th-label">Buyurtma qiymati</span>
                                                    <span class="sort-indicator">
                                                        <i class="las la-sort sort-icon"></i>
                                                    </span>
                                                </div>
                                            </th>
                                            <th class="th-status" data-column="status" onclick="sortTable('status')">
                                                <div class="th-content sortable">
                                                    <span class="th-label">Holat</span>
                                                    <span class="sort-indicator">
                                                        <i class="las la-sort sort-icon"></i>
                                                    </span>
                                                </div>
                                            </th>
                                            <th class="th-payment" data-column="payment">
                                                <div class="th-content">
                                                    <span class="th-label">To'lov</span>
                                                </div>
                                            </th>
                                            <th class="th-date" data-column="date" onclick="sortTable('createdAt')">
                                                <div class="th-content sortable">
                                                    <span class="th-label">Buyurtma sanasi</span>
                                                    <span class="sort-indicator">
                                                        <i class="las la-sort sort-icon"></i>
                                                    </span>
                                                </div>
                                            </th>
                                            <th class="th-actions" data-column="actions">
                                                <div class="th-content">
                                                    <span class="th-label">Amallar</span>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="ordersTableBody" class="table-body-modern">
                                        <!-- Orders data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Mobile Card View -->
                            <div class="mobile-cards-view" id="mobileCardsView">
                                <!-- Mobile cards will be rendered here -->
                            </div>

                            <!-- Table Loading Overlay -->
                            <div class="table-loading-overlay" id="tableLoadingOverlay">
                                <div class="loading-content">
                                    <div class="modern-spinner"></div>
                                    <p class="loading-text">Buyurtmalar yuklanmoqda...</p>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div class="table-empty-state hidden" id="tableEmptyState">
                                <div class="empty-state-content">
                                    <div class="empty-state-icon">
                                        <i class="las la-shopping-cart"></i>
                                    </div>
                                    <h3 class="empty-state-title">Buyurtmalar topilmadi</h3>
                                    <p class="empty-state-description">Hozirgi filtr mezonlaringizga mos buyurtmalar yo'q.</p>
                                    <button class="btn btn-primary" onclick="clearAllFilters()">
                                        <i class="las la-refresh"></i>
                                        Filtrlarni qayta tiklash
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pagination Section -->
                    <div class="pagination-section" id="paginationSection">
                        <div class="pagination-info">
                            <span id="paginationStart">0</span>-<span id="paginationEnd">0</span> ko'rsatilmoqda (jami <span id="paginationTotal">0</span> buyurtma)
                        </div>
                        <div class="pagination-controls" id="paginationControls">
                            <!-- Pagination buttons will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-content">
            <div class="modern-spinner"></div>
            <div class="loading-text" id="loadingText">Qayta ishlanmoqda...</div>
        </div>
    </div>

<!-- Scripts -->
<script src="/assets/js/jquery-3.7.1.min.js"></script>
<script src="/assets/js/bootstrap.bundle.min.js"></script>

<!-- Admin Dashboard Core Scripts -->
<script src="/admin/js/dashboard.js"></script>

<!-- Orders Management JavaScript -->
<script src="/admin/js/orders-management.js"></script>

<!-- Orders Management Configuration -->
<script>
   // Initialize Orders Management
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof OrdersManagement !== 'undefined') {
            try {
                window.ordersManager = new OrdersManagement();
                window.ordersManager.init();
            } catch (error) {
                console.error('Buyurtmalar boshqaruvini ishga tushirishda xatolik:', error);
            }
        } else {
            console.error('OrdersManagement sinfi topilmadi');
        }
    });

    // Global order management functions
    function openCreateOrderModal() {
        if (window.ordersManager) {
            window.ordersManager.showCreateModal();
        } else {
            console.error('Buyurtmalar boshqaruvchisi ishga tushirilmagan');
        }
    }

    function exportOrders() {
        if (window.ordersManager) {
            window.ordersManager.exportOrders();
        }
    }

    function refreshData() {
        if (window.ordersManager) {
            window.ordersManager.refreshData();
        }
    }

    function clearAllFilters() {
        if (window.ordersManager) {
            window.ordersManager.clearAllFilters();
        }
    }

    function applyFilters() {
        if (window.ordersManager) {
            window.ordersManager.applyFilters();
        }
    }

    function toggleSelectAll(checked) {
        if (window.ordersManager) {
            window.ordersManager.toggleSelectAll(checked);
        }
    }

    function sortTable(column) {
        if (window.ordersManager) {
            window.ordersManager.sortTable(column);
        }
    }

    function bulkConfirmOrders() {
        if (window.ordersManager) {
            window.ordersManager.bulkAction('confirm');
        }
    }

    function bulkShipOrders() {
        if (window.ordersManager) {
            window.ordersManager.bulkAction('ship');
        }
    }

    function bulkExportOrders() {
        if (window.ordersManager) {
            window.ordersManager.bulkExport();
        }
    }

    function bulkCancelOrders() {
        if (window.ordersManager) {
            window.ordersManager.bulkAction('cancel');
        }
    }
</script>

</body>
</html>